---
title: "Cluster_integration"
author: "Max J Karlsson & María Bueno Álvez"
date: "10/18/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Set up
## Load libraries

```{r}

library(tidyverse)
library(magrittr)
library(GOSemSim)
library(readxl)
library(pheatmap)
library(tidygraph)
library(ggraph)
library(ggrepel)
library(multidplyr)
library(clusterProfiler)
library(ggthemes)
library(scales)
library(plotly)
library(ggupset)
library(patchwork)
library(vroom)
library(rrvgo)
library(treemapify)
library(viridis)
library(ggrastr)
library(scatterpie)
library(ggnewscale)
library(ggdendro)
library(stringr)
library(ggbeeswarm)

source("scripts/functions_utility.R")
source("scripts/functions_annotation.R")
source("scripts/functions_dimensionalityreduction.R")
source("scripts/generate_gene_clusters.R")

select <- dplyr::select
rename <- dplyr::rename
rename <- dplyr::rename

```

## File structure

```{r}

dataset_metadata <- read_csv("run_settings/20220222_settings.csv")

data_paths <- read_csv("run_settings/20211012 all_datasets.csv")

file_structure <-
  create_folder_structure(dataset_id = dataset_metadata$dataset_id,
                          dataset_run_id = dataset_metadata$version,
                          main_folder = "results/Clustering_results",
                          folders = c("data" = "data", 
                                      "UMAP" = "UMAP",
                                      "svg" = "svg",
                                      "bubbleheatmap" = "svg/bubble",
                                      "treemap" = "svg/treemap",
                                      "heatmap" = "svg/heatmap",
                                      "enrichment" = "enrichment",
                                      "clustering" = "clustering"))

```


## Load clustering data

```{r}

clustering_data <- 
  file_structure %>% 
  map(function(x) x$clustering) %>% 
  map(function(x) {
    file_ <- paste(x, "final_consensus.tsv", sep = "/")
    if(file.exists(file_)) {
      read_tsv(file_)
    } else {
      NULL
    }
  }) %>% 
  bind_rows(.id = "dataset_id") %>% 
  mutate(cluster = as.character(cluster)) 

memberships <- 
  file_structure %>% 
  map(function(x)x$clustering) %>% 
  lapply(function(filename_) read_tsv(paste(filename_, "cluster_memberships.tsv", sep = "/"))) %>% 
  bind_rows(.id = "dataset_id")

```

## Load clustering enrichments

```{r}

enrichment_data <- 
  file_structure %>% 
  map(function(x) x$enrichment) %>% 
  map(function(x) {
    file_ <- paste(x, "enrichment_results.tsv", sep = "/")
    if(file.exists(file_)) {
      read_tsv(file_)
    } else {
      NULL
    }
  }) %>% 
  bind_rows(.id = "dataset_id") %>% 
  mutate(cluster = as.character(cluster)) 


```

## Load clustering annotations

```{r}

annotation_data <- 
  clustering_data %>%  
  pull(dataset_id) %>% 
  unique() %>% 
  map(function(x) {
    file_ <- paste0("results/Clustering_annotation/20220404 ", x, ".xlsx", sep = "") #20211124
    if(file.exists(file_)) {
      file <- read_excel(file_) 
      file %>% 
        as_tibble() %>% 
        mutate(dataset_id = x)
    } else {
      NULL
    }
  })  %>% 
  bind_rows() %>% 
  select(dataset_id, 
         cluster = `Cluster ID`,
         ngenes = `Num genes`,
         reliability = Reliability,
         Specificity,
         Function)  %>%   
  mutate(cluster = as.character(cluster))

cluster_annotation <- annotation_data %>% 
  mutate(full_annotation = paste(Specificity, 
                                 Function, 
                                 sep = " - ")) 

```

```{r}
# clustering_data %>% 
#   left_join(cluster_annotation) %>% 
#   filter(dataset_id == "singlecell") %>% 
#   left_join(gene_info %>% 
#               mutate(gene = ensg_id))
# 
# gene_info <- read_tsv("data/meta/geneinfo_103.tsv")
# prev_28 <- c("CLEC2A", "PLA2G4E", "PPP1R14C")

```

## Load UMAPs

```{r}

umap_data <- 
  file_structure %>% 
  map(function(x) x$UMAP) %>% 
  map(function(x) {
    file_ <- paste(x, "UMAP.tsv", sep = "/")
    if(file.exists(file_)) {
      read_tsv(file_)
    } else {
      NULL
    }
  }) %>% 
  bind_rows(.id = "dataset_id") 

umap_polygons <- 
  file_structure %>% 
  map(function(x) x$UMAP) %>% 
  map(function(x) {
    file_ <- paste(x, "UMAP_polygons.tsv", sep = "/")
    if(file.exists(file_)) {
      read_tsv(file_)
    } else {
      NULL
    }
  }) %>% 
  bind_rows(.id = "dataset_id") 

umap_centers <- 
  file_structure %>% 
  map(function(x) x$UMAP) %>% 
  map(function(x) {
    file_ <- paste(x, "cluster_centers.tsv", sep = "/")
    if(file.exists(file_)) {
      read_tsv(file_)
    } else {
      NULL
    }
  }) %>% 
  bind_rows(.id = "dataset_id") 

```

s## Load specificity databases

```{r}

# Get gene class
enrichment_settings <- 
  read_csv("run_settings/20211013_enrichment_settings.csv")

gene_classification <- 
  enrichment_settings %>% 
  filter(grepl("specificity", id)) %>% 
  group_by(id) %>% 
  do({
    g_data <<- .
    
    get_specificity_db(enrichment_settings, g_data$id)
    
  }) %>% 
  ungroup()

# Get long gene class
## Alt 1
specificity_long <- 
  enrichment_settings %>% 
  filter(grepl("specificity", id)) %>% 
  group_by(id) %>% 
  do({
    g_data <<- .
    
    get_db(enrichment_settings, g_data$id)
    
    
  }) %>% 
  ungroup()

## Alt 2
specificity_long2 <- 
  gene_classification %>% 
  mutate(enhanced_tissues = gsub(", ", ";", enhanced_tissues)) %>% 
  separate_rows(enhanced_tissues, sep = ",") %>% 
  mutate(enhanced_tissues = gsub(";", ", ", enhanced_tissues)) 

```

## Color data & themes

```{r}
colors_consensus <-
  read_tsv("data/colors/colors_consensus.tsv") 

old_dataset_palette <- c("tissue" = "#0083C4",  "brain" = "#FFDD00", "blood" = "#CF161A", "singlecell" = "#6AA692", "celline" = "#97CF16") 

dataset_palette <- 
  c(celline = "#ED446D",
    blood = "#FFA93A",
    tissue = "#20639A",
    singlecell = "#3BAEA1")

new_dataset_palette <- 
  c("Tissue" = "#20639A",
    "Single cell type" = "#3BAEA1",
    "Cell line" = "#ED446D",
    "Immune cell" = "#FFA93A")

reliability_palette <- c("High" = "#122740", "Medium" = "#568F8B", "Low" = "#F4F6CC") 

all_HPA_colors <-
  read_tsv("data/meta/HPA21_colors.txt",
           col_names = c("organ_name", "tissue_name", "color"))

organ_palette <-
  all_HPA_colors %>%
  select(organ_name, color) %>%
  distinct() %>%
  deframe()

tissue_palette <-
  all_HPA_colors %>%
  filter(organ_name != "Brain") %>%
  gather(tissue_type, tissue, 1, 2) %>%
  select(tissue, color) %>%
  distinct() %>%
  bind_rows(mutate(.,
                   tissue = str_to_sentence(tissue))) %>%
  bind_rows(cluster_annotation %>%
              select(Specificity) %>%
              distinct() %>%
              filter(grepl("^Low.*specificity$", Specificity)) %>%
              rename(tissue = 1) %>%
              mutate(color = "darkgray")) %>%
  bind_rows(all_HPA_colors %>%
              filter(organ_name == "Brain") %>%
              select(tissue = organ_name, color) %>%
              distinct())

cluster_color_pal <-
  tableau_color_pal(palette = "Classic Cyclic",
                    type = 'regular')(13) %>%
  colorRampPalette()

plot_pal <-
  complete_palette(pal_terms = unique(cluster_annotation$Specificity),
                   pal = deframe(tissue_palette),
                   default_pal = cluster_color_pal)
plot_pal <-
  complete_palette_neighbor(pal_terms = unique(cluster_annotation$Specificity),
                            pal = deframe(tissue_palette))


ontology_pal <- 
  c("MF" = "#FF6F00",
    "CC" = "#C71B00",
    "BP" = "#018EA0")


blood_colors <- 
  read_csv("data/meta/Blood cell colors.csv")

sc_colors <- 
  read_tsv("data/meta/HPA_colors/Single cell type.txt", col_names = F)

gene_category_pal <-
  c("Tissue enriched" = "#e41a1c",
    "Group enriched" = "#FF9D00",
    "Tissue enhanced" = "#984ea3",
    "Low tissue specificity" = "grey40",
    "Not detected" = "grey")


cluster_sp_pal <- c("Specific" = "#CBD4EF", 
                    "Non-specific" = "#2A428C")

theme_simple <- 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
theme_simple <- 
  theme_bw() + 
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())

theme_1 <- 
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
theme_2 <- 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())
```



# 1. Clustering overview 

## UMAPs 

```{r}

cluster_color_dict <-
  clustering_data %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  group_by(dataset_id) %>% 
  do({
    dat <- .
    nclust <<- dat %>% pull(cluster) %>% length()
    pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(nclust)
    
    dat %>% 
      arrange(as.numeric(cluster)) %>% 
      mutate(cluster_color = pal)
  })

# Only UMAP (no cluster colors)
umap_plots <- 
  clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id != "brain") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  facet_wrap(~dataset_id) +
  coord_fixed() 


umap_plots +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 left_join(cluster_color_dict) %>% 
                 filter(dataset_id != "brain") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = as.factor(cluster_color)),
               color= "grey20",
               show.legend = F, alpha = 0.9)+ 
  facet_wrap(~dataset_id, ncol = 4) +
  scale_fill_identity()

ggsave(savepath("allumaps.pdf"))


# Single cell clustering
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.01) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 left_join(cluster_color_dict) %>% 
                 filter(dataset_id == "singelcell") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = as.factor(cluster_color)),
               color= "grey20",
               show.legend = F, alpha = 0.9)+ 
  scale_fill_identity()

ggsave(savepath("sc_umap_grey.pdf"))

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F, color = "grey80", size = 0.01) + 
  theme_void() +
  coord_fixed() 

ggsave(savepath("tissue_umap_grey.pdf"))

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F, color = "grey80", size = 0.01) + 
  theme_void() +
  coord_fixed() 

ggsave(savepath("sc_umap_grey.pdf"))

```


## Summary plots
```{r}

# CLuster size, number of genes
vio <- 
  annotation_data %>% 
  filter(dataset_id != "brain") %>% 
  select(dataset_id, cluster, ngenes) %>% 
  ggplot(aes(dataset_id, ngenes, fill=dataset_id)) +
  geom_violin(draw_quantiles = 0.5, scale = "width", color = "grey20", show.legend = F) +
  geom_jitter(width=0.15, alpha=0.5, color = "grey20", show.legend = F) +
  theme_simple +
  scale_fill_manual(values = dataset_palette) +
  coord_flip() +
  ylab("Cluster size (number of genes)")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())


bar_genes <- 
  clustering_data %>%
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  summarise(n = n_distinct(gene)) %>% 
  ggplot(aes(dataset_id, n, fill=dataset_id)) +
  geom_bar(stat = "identity", show.legend = F, width = 0.5) +
  theme_simple +
  scale_fill_manual(values = dataset_palette) +
  geom_text(aes(label = n), hjust = -0.2) +
  ylim(c(0,23000)) +
  coord_flip() +
  xlab("Dataset") +
  ylab("Number of expressed genes")+
  theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())

bar <- 
  annotation_data %>%
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  summarise(k = max(as.numeric(cluster))) %>% 
  ggplot(aes(dataset_id, k, fill=dataset_id)) +
  geom_bar(stat = "identity", show.legend = F, width = 0.5) +
  theme_simple +
  scale_fill_manual(values = dataset_palette) +
  geom_text(aes(label = k), hjust = -0.2) +
  ylim(c(0,100)) +
  coord_flip() +
  xlab("Dataset") +
  ylab("Number of clusters")


bar + bar_genes + vio + 
  plot_layout(widths = c(1, 1.5, 2))

#ggsave(savepath("cluster_overview.png"))


# Summary annotations 
totals <- cluster_annotation %>%
  group_by(dataset_id) %>%
  summarise(total=n_distinct(cluster))

annotation_pal <- 
  c("Unknown function" = "#E9DE9C",
    "Mixed function" = "#A4DFAD",
    "Annotated function" = "#4A9E8E", 
    "Non-specific" = "#2A428C",
    "Specific" = "#CBD4EF")

annotation_data %>% 
  mutate(cluster_specificity = case_when(grepl("Non-specific", Specificity) ~ "Non-specific",
                                         TRUE ~ "Specific"),
         cluster_function = case_when(grepl("Unknown", Function) ~ "Unknown function",
                                      grepl("Mixed", Function) ~ "Mixed function",
                                      TRUE ~ "Annotated function")) %>% 
  select(dataset_id, cluster_specificity, cluster_function) %>% 
  gather(class, type, -dataset_id) %>% 
  mutate(type = factor(type, levels = names(annotation_pal))) %>% 
  group_by(dataset_id, class, type) %>% 
  add_count(type) %>% distinct() %>% 
  ggplot(aes(fill=type, y=n, x=dataset_id)) + 
  geom_bar(position="stack", stat="identity") +
  coord_flip() +
  theme_classic() +
  scale_fill_manual(values = annotation_pal)+
  facet_grid(~class)


```


## Clustering visualization (annotations)

```{r}

# TISSUE CLUSTERING

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87)

# Clustering with annotations
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.1, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  geom_point(data = umap_centers %>%  
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"),
             aes(x,y,fill= cluster, size = 5),
             color = "grey30",
             shape = 21,
             stroke =1.5, 
             show.legend = F) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_text(data = umap_centers %>% 
              filter(dataset_id == "tissue"),
            aes(x,y, label = as.character(cluster)),
            color = "white", 
            inherit.aes = F)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "tissue"), aes(x, y, label = full_annotation))


ggsave(savepath("tissue_umap.pdf"))


# Without annotations
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.05, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) 


ggsave(savepath("tissue_umap_noann.pdf"))

# SINGLE CELL CLUSTERING

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.05, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) 


ggsave(savepath("singlecell_umap_noann.pdf"))


```

### Alternatives for clustering visualization (tissue)

```{r}


# Alternatives for clustering visualization

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")



ggsave(savepath("tissue_thesis.pdf"))



clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey70",
               show.legend = F, 
               alpha = 0.4) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")



ggsave(savepath("tissue_pol.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F,   color = "grey", size = 1, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster),
               color = "grey70",
               show.legend = F, 
               alpha = 0.6) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")


ggsave(savepath("tissue_pol_grey.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey70",
               show.legend = F, 
               alpha = 0.4) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")



ggsave(savepath("tissue_pol.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "white",
               show.legend = F, 
               alpha = 0.4) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")

ggsave(savepath("tissue_M_whiteborders.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 0.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster),
               color = "white",
               show.legend = F) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")

ggsave(savepath("tissue_M_noalpha.pdf"))

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F,  color = "black", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "white",
               show.legend = F, 
               alpha = 0.7) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "tissue"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "tissue"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")

ggsave(savepath("tissue_M_blackpoints.pdf"))

```

### Alternatives for clustering visualization (tissue)

```{r}

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87)

# Clustering with annotations
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.1, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  geom_point(data = umap_centers %>%  
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "tissue"),
             aes(x,y,fill= cluster, size = 5),
             color = "grey30",
             shape = 21,
             stroke =1.5, 
             show.legend = F) +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_text(data = umap_centers %>% 
              filter(dataset_id == "tissue"),
            aes(x,y, label = as.character(cluster)),
            color = "white", 
            inherit.aes = F)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "tissue"), aes(x, y, label = full_annotation))


ggsave(savepath("tissue_umap.pdf"))


# Without annotations
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.05, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) 


ggsave(savepath("tissue_umap_noann_3.pdf"))


# Single cell
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, fill = cluster)) +
  geom_point(show.legend = F,  size = 0.05, alpha = 0.8) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                                        TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey50",
               show.legend = F, 
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) 


ggsave(savepath("singlecell_umap_noann_3.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "singlecell"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "singlecell"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "singlecell"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")



ggsave(savepath("singlecell_thesis.pdf"))




clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   alpha = 0.7),
               color = "grey70",
               show.legend = F, 
               alpha = 0.4) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "singlecell"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "singlecell"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "singlecell"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")



ggsave(savepath("singlecell_pol.pdf"))


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F,   color = "grey", size = 1, alpha = 0.3, stroke = 0) + 
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster),
               color = "grey70",
               show.legend = F, 
               alpha = 0.6) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "singlecell"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40",
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "singlecell"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>% 
                    mutate(cluster = as.character(cluster)) %>% 
                    left_join(cluster_annotation) %>% 
                    filter(dataset_id == "singlecell"), 
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black")


ggsave(savepath("singlecell_pol_grey.pdf"))



clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   color = cluster, 
                   alpha = 0.7),
               #  color = "white", #grey70
               show.legend = F, 
               alpha = 0.4) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               filter(dataset_id == "singlecell"), 
             inherit.aes = F, aes(x,y, fill = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             color = "grey40", #grey40
             show.legend = F) +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              filter(dataset_id == "singlecell"), 
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  theme_void() +
  coord_fixed() +
  scale_fill_manual(values = pal) +
  scale_color_manual(values = pal) 


ggsave(savepath("singlecell_colorpol.pdf"))


pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(68)

pal3 <- 
  sapply(colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(68),
         function(x){
           ramp_color_bias(x, "black", bias = 0.4)})

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell") ,#%>% 
               #left_join(dark_pal), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   color = cluster),
               show.legend = F, 
               alpha = 0.4,
               inherit.aes = F) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  new_scale_color() +
  geom_point(data = umap_centers %>%
               mutate(cluster = as.character(cluster)) %>%
               filter(dataset_id == "singlecell"),
             inherit.aes = F, aes(x,y, fill = cluster, color = cluster),
             size = 4.5,
             shape = 21,
             stroke= 0.8,
             #color = "grey40", #grey40
             show.legend = F) +
  scale_color_manual(values = pal3 %>% as.character()) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>%
              filter(dataset_id == "singlecell"),
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text_repel(data = umap_centers %>%
                    mutate(cluster = as.character(cluster)) %>%
                    left_join(cluster_annotation) %>%
                    filter(dataset_id == "singlecell"),
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black") +
  theme_void() +
  coord_fixed() 


ggsave(savepath("singlecell_colorpol_no_annotations.pdf"))


```

### Miniatures
```{r}
## Tissue

#clustering_data %>% filter(dataset_id == "tissue") %>%  pull(cluster) %>% as.numeric() %>% max()

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87)

pal3 <- 
  sapply(colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87),
         function(x){
           ramp_color_bias(x, "black", bias = 0.7)})

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue") %>% 
                 left_join(dark_pal), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   color = cluster),
               show.legend = F, 
               alpha = 0.4,
               inherit.aes = F) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  new_scale_color() +
  geom_text_repel(data = umap_centers %>%
                    mutate(cluster = as.character(cluster)) %>%
                    left_join(cluster_annotation) %>%
                    filter(dataset_id == "tissue"),
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black") +
  theme_void() +
  coord_fixed() 


ggsave(savepath("tissue_miniature.pdf"))



## Blood

clustering_data %>% filter(dataset_id == "blood") %>%  pull(cluster) %>% as.numeric() %>% max()

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(52)

pal3 <- 
  sapply(colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(52),
         function(x){
           ramp_color_bias(x, "black", bias = 0.7)})

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "blood")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "blood") %>% 
                 aes(X,Y, group = polygon_id, 
                     fill = cluster,
                     color = cluster),
               show.legend = F, 
               alpha = 0.4,
               inherit.aes = F) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  new_scale_color() +
  geom_text_repel(data = umap_centers %>%
                    mutate(cluster = as.character(cluster)) %>%
                    left_join(cluster_annotation) %>%
                    filter(dataset_id == "blood"),
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black") +
  theme_void() +
  coord_fixed() 


ggsave(savepath("blood_miniature.pdf"))


## Cellline

clustering_data %>% filter(dataset_id == "celline") %>%  pull(cluster) %>% as.numeric() %>% max()

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(44)

pal3 <- 
  sapply(colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(44),
         function(x){
           ramp_color_bias(x, "black", bias = 0.7)})

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "celline")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster)) +
  geom_point_rast(show.legend = F,   size = 1.5, alpha = 0.3, stroke = 0)  +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "celline") %>% 
                 left_join(dark_pal), 
               aes(X,Y, group = polygon_id, 
                   fill = cluster,
                   color = cluster),
               show.legend = F, 
               alpha = 0.4,
               inherit.aes = F) +
  scale_color_manual(values = pal) +
  scale_fill_manual(values = pal) +
  new_scale_color() +
  geom_text_repel(data = umap_centers %>%
                    mutate(cluster = as.character(cluster)) %>%
                    left_join(cluster_annotation) %>%
                    filter(dataset_id == "celline"),
                  inherit.aes = F, aes(x,y, label = full_annotation),
                  size = 3,
                  color = "black") +
  theme_void() +
  coord_fixed() 


ggsave(savepath("celline_miniature.pdf"))
```

### New cluster centers (based on subcluster)

```{r}
get_density <- 
  function(x, y, h = 0.5, n = 100, lims = c(range(x),
                                            range(y))) {
    g_density <- 
      MASS::kde2d(x, y, h = h, n = n, 
                  lims = lims) 
    
    
    g_density$z %>%
      as_tibble(rownames = "x") %>%
      gather(y, z, -x) %>% 
      mutate(y = gsub("V", "", y)) %>% 
      mutate_at(vars(x,y), as.integer) %>%
      left_join(enframe(g_density$x, "x", "x_coord"),
                by = "x") %>% 
      left_join(enframe(g_density$y, "y", "y_coord"),
                by = "y")
  }

new_centers <- 
  lapply(c("singlecell", "tissue"),
         
         function(dataset) {
           dat <- 
             umap_data %>% 
             left_join(clustering_data) %>% 
             filter(dataset_id == dataset)
           
           V1 = dat %>% 
             pull(UMAP_1_scaled)
           
           V2 = dat %>% 
             pull(UMAP_2_scaled)
           
           element_id =  dat %>% 
             pull(gene)
           
           cluster_membership =  dat %>% 
             pull(cluster)
           
           n = 1000
           poly_concavity = 2
           poly_smoothing = 1.25
           relative_bandwidth = 1/150
           cum_z_lim = 0.95
           frac_lim = 0.05
           plot_range = rep(c(min(c(V1, V2)), max(c(V1, V2))),2) * 1.05
           # relative_bandwidth = 1/200) {
           #     require(tidyverse)
           #     require(magrittr)
           #     require(sf)
           #     require(sp)
           #     require(concaveman)
           
           # Compile indata
           cluster_data <- 
             tibble(V1, V2, 
                    element_id,
                    cluster = cluster_membership)
           
           # Calculate plot range
           plot_range_tb <- 
             set_names(plot_range,
                       c("xmin", 
                         "xmax",
                         "ymin", 
                         "ymax")) %>% 
             enframe() %>% 
             spread(name, value)
           
           # Calculate diagonal length
           plot_diagonal <- 
             sqrt((plot_range_tb$xmax - plot_range_tb$xmin)^2 + 
                    (plot_range_tb$ymax - plot_range_tb$ymin)^2)
           
           # Set bandwidth to fraction of diagonal
           plot_bandwidth <- 
             relative_bandwidth * plot_diagonal
           
           # Find subclusters
           subclusters <-
             cluster_data %>%
             group_by(cluster) %>%
             mutate(n_cluster_genes = n_distinct(element_id), 
                    sub_cluster = data.frame(V1, V2) %>%
                      fpc::dbscan(eps = plot_bandwidth) %$%
                      cluster) %>%
             ungroup() %>% 
             group_by(cluster, sub_cluster) %>%
             mutate(n_sub_genes = n_distinct(element_id)) %>% 
             ungroup() 
           
           # Classify subclusters
           subclusters_classes <- 
             subclusters %>% 
             select(cluster, sub_cluster, n_cluster_genes, n_sub_genes) %>% 
             distinct() %>% 
             group_by(cluster) %>%
             mutate(sub_type = case_when(sub_cluster == 0 ~ "outlier",
                                         n_sub_genes / n_cluster_genes < frac_lim ~ "outlier",
                                         rank(-n_sub_genes, 
                                              ties.method = "first") == 1 ~ "primary",
                                         T ~ "secondary")) %>% 
             select(cluster, sub_cluster, sub_type)
           
           subclusters_classed <- 
             subclusters %>% 
             left_join(subclusters_classes,
                       by = c("cluster", "sub_cluster"))
           
           
           # Calculate plot density
           plot_all_density <- 
             subclusters_classed %>% 
             filter(sub_type != "outlier") %>%
             group_by(cluster, sub_cluster, sub_type) %>%
             do({
               get_density(.$V1, 
                           .$V2, 
                           h = plot_bandwidth, 
                           n = n, 
                           lims = plot_range) 
             }) 
           
           plot_density <-
             plot_all_density %>% 
             ungroup() %>% 
             filter(z > 1e-200) %>% 
             group_by(cluster, sub_cluster) %>% 
             mutate(z = z / sum(z)) %>% 
             arrange(cluster, sub_cluster, -z) %>% 
             mutate(cum_z = cumsum(z)) %>% 
             ungroup()
           
           plot_density_center <- 
             plot_density %>% 
             #filter(sub_type == "primary") %>% 
             group_by(cluster, sub_cluster) %>% 
             top_n(1, z) %>% 
             slice(1) %>% 
             ungroup() %>% 
             mutate(dataset_id = dataset) %>% 
             select(dataset_id, cluster, sub_cluster, x = x_coord, y = y_coord)
         }) %>% 
  bind_rows()




```


### UMAP - colored by specificity

### Palette for single cell & tissue

```{r}

# 51 SPECIFICITIES
# 26 in palette

#muscle_samples <- 
  
specificity_pal_singlecell <- 
  annotation_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(colors_consensus %>% 
               filter(dataset_id %in% c("tissue","singlecell")) %>% 
               mutate(color = case_when(color == "#DE6C7D" ~ "#B38C6D",
                                        color == "#A1A8AA" ~ "#DE6C7D",
                                        TRUE ~ color)), 
             by = c("Specificity" = "sample")) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "singlecell") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% colors_consensus$sample) %>% 
              mutate(color = c(
                "#5b6b9c", #Pancreatic cells  -> from https://www.colorhexa.com/5b6b9c
                "grey", #Non-specific 
                mix_colors("#FFDD00","#f9a666", 0.5), #Neurons & Oligodendrocytes
                "#FFDD00", #Photoreceptor cells  
                "#5191B2", #Alveolar cells
                "#95D4F5", #Spermatocytes & Spermatogonia 
                mix_colors("#A7DACD","#B26996", 0.5), #Adipocytes & Endothelial cells
                "#7F6A9C", #Intestinal endocrine cells
                "#b30000", #Monocytes & Neutrophils
                "#95D4F5",#Spermatogonia & Spermatocytes
                "#4269B0", #Epithelial cell types
                "#95D4F5", #Spermatids
                "#4269B0", #Respiratory epithelial cells
                "#404785", #Mucus-secreting cells
                "#4269B0", #Keratinocytes
                "#404785", #Mammary glandular cells
                "#404785", #Glandular cells
                "#66bd63", #Stromal cells
                "#F8BDD7", #Endometrium
                "#404785", #Enterocytes
                "#404785", #Ciliated cells
                "#b30000", #Myeloid cells
                "#4269B0", #Intestinal epithelial cells
                "#b30000", #NK-cells & T-cells
                "#b30000"))) %>% #Plasmacytoid DCs
  select(-dataset_id) %>% 
  mutate(dataset_id = "singlecell") %>% 
  ungroup() 


a <- colors_consensus %>%  mutate(sample = str_to_sentence(sample)) %>% pull(sample)

# 44 SPECIFICITIES
#28

specificity_pal_tissue <- 
  annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  mutate(Specificity = str_to_sentence(Specificity)) %>% 
  inner_join(colors_consensus %>% 
               mutate(sample = str_to_sentence(sample)) %>% 
               mutate(color = case_when(color == "#DE6C7D" ~ "#B38C6D",
                                        color == "#A1A8AA" ~ "#DE6C7D",
                                        TRUE ~ color)), 
             by = c("Specificity" = "sample")) %>% 
  select(-dataset_id) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "tissue") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% a) %>% 
 #             mutate(Specificity = case_when(Specificity %in% c("Intestine & #Liver", "Bone marrow & Brain") ~ Specificity,
  #                                           TRUE ~ str_to_sentence(Specificity))) %>% 
              mutate(color = c(
                "#b30000", #Immune cells
                "grey", #Non-specific  
                "#B38C6D", #Smooth muscle tissue       
                "#B38C6D", #Striated muscle
                mix_colors("#FFEF78","#DF6B7D", 0.5), #Retina & Lymphoid tissues 
                mix_colors("#FCCAB3","#FFDD00", 0.5), #Skin & Brain
                mix_colors("#DF6B7D","#FFDD00", 0.5), #Lymphoid tissue & Brain
                "#B38C6D", #Heart
                "#b30000", #Neutrophils   
                mix_colors("#1280C4","#D1CBE5", 0.5), #Intestine & Liver
                "#404785", #Ciliated cells
                "#FFDD00", #Cerebellum
                mix_colors("#DF6B7D","#FFDD00", 0.5), #Bone marrow & Brain  
                mix_colors("#F9A266","#D1CBE5", 0.5), #Kidney & Liver
                mix_colors("#D1CBE5","#F8BDD7", 0.5), #Liver & Placenta
                mix_colors("#404785","#5191B2", 0.5) #Enterocytes & Tubular cells
                ))) %>% 
  mutate(dataset_id = "tissue") %>% 
  ungroup()

specificity_pals <- 
  specificity_pal_singlecell %>% 
  bind_rows(specificity_pal_tissue)

cluster_pal_sp <- 
  cluster_annotation %>% 
  filter(dataset_id %in% c("singlecell", "tissue")) %>% 
  full_join(specificity_pals)

cluster_pal_sp %>% 
  View()
  select(dataset_id,cluster,Scolor)

write_tsv(cluster_pal_sp, "tissue_sc_new_cluster_colors_20220404.tsv")
```


### Generate UMAPs

```{r}

# SINGLE CELL

specificity_pal <- 
  annotation_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(colors_consensus, by = c("Specificity" = "sample")) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "singlecell") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% colors_consensus$sample) %>% 
              mutate(color = c(
                "#96C08E",
                "grey",
                "#FFDD00",
                "#FFDD00",
                "#5191B2",
                "#95D4F5",
                mix_colors("#A7DACD","#B26996", 0.5),
                "#7F6A9C",
                "#b30000",
                "#95D4F5",
                "#4269B0",
                "#95D4F5",
                "#4269B0",
                "#404785",
                "#4269B0",
                "#404785",
                "#404785",
                "#66bd63",
                "#F8BDD7",
                "#404785",
                "#404785",
                "#199985",
                "#4269B0",
                "#b30000",
                "#b30000"))) %>% 
  ungroup() %>% 
  select(-dataset_id) %>% 
  deframe()


specificity_pal_dark  <-
  annotation_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(colors_consensus, by = c("Specificity" = "sample")) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "singlecell") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% colors_consensus$sample) %>% 
              mutate(color = c(
                "#96C08E",
                "grey",
                "#FFDD00",
                "#FFDD00",
                "#5191B2",
                "#95D4F5",
                mix_colors("#A7DACD","#B26996", 0.5),
                "#7F6A9C",
                "#b30000",
                "#95D4F5",
                "#4269B0",
                "#95D4F5",
                "#4269B0",
                "#404785",
                "#4269B0",
                "#404785",
                "#404785",
                "#66bd63",
                "#F8BDD7",
                "#404785",
                "#404785",
                "#199985",
                "#4269B0",
                "#b30000",
                "#b30000"))) %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  group_by_all() %>% 
  mutate(color_dark = ramp_color_bias(color, "black", bias = 0.4)) %>% 
  ungroup() %>% 
  select(-color) %>% 
  deframe()

# library(extrafont)
# font_import(paths = "fonts")
# loadfonts("fonts")
# fonttable()
# extrafont::font_import("Arial Narrow", paths = "font")

umap_polygons

umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = Specificity)) +
  geom_point_rast(show.legend = F, 
                  size = 0.08,
                  alpha = 0.5) + #, color = "grey80"
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 filter(dataset_id == "singlecell") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = Specificity, 
                   color = Specificity),
               alpha = 0.7,
             show.legend = F)+
  scale_fill_manual(values = specificity_pal %>% sort()) +
  geom_point_rast(data = umap_centers %>%
               mutate(cluster = as.character(cluster)) %>%
               filter(dataset_id == "singlecell") %>% 
               inner_join(cluster_annotation),
             inherit.aes = F, aes(x,y, color = Specificity),
             size = 4.5,
             stroke= 0.8,
             show.legend = F) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>%
              filter(dataset_id == "singlecell"),
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell"),
            aes(x, y, label = full_annotation), 
            #family = "serif", 
            inherit.aes = F,
            show.legend = F) +
  scale_color_manual(values = specificity_pal_dark) +
#  theme(text=element_text(family="Helvetica-Narrow")) +
  theme_void() 

ggsave(savepath("singlecell_color_specificity_clusternum.pdf"))


# TISSUE

annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(tissue_palette, by = c("Specificity" = "tissue")) %>% 
  full_join(umap_data %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "tissue") %>% 
              left_join(specificity_pal) %>% 
              filter(is.na(color)) %>% 
              pull(Specificity) %>% 
              unique() %>% 
              enframe() %>% 
              mutate() %>% 
              rename(Specificity = value) %>% 
              select(-name))


a <- colors_consensus %>%  mutate(sample = str_to_title(sample)) %>% pull(sample)

specificity_pal <- 
  annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  mutate(Specificity = str_to_title(Specificity)) %>% 
  inner_join(colors_consensus %>% 
               mutate(sample = str_to_title(sample)), 
             by = c("Specificity" = "sample")) %>% 
  select(-dataset_id) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "tissue") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              mutate(Specificity = str_to_title(Specificity)) %>% 
              filter(!Specificity %in% a) %>% 
              mutate(color = c(
                "#1280C4",
                "grey",
                "#DE6C7D",
                "#b30000",
                "#404785",
                "#b30000",
                "#DE6C7D",
                mix_colors("#A1A8AA","#FFDD00", 0.5),
                mix_colors("#1280C4", "#D1CBE5", 0.5)))) %>% 
  ungroup() %>% 
  deframe()


specificity_pal_dark  <-
  annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  mutate(Specificity = str_to_title(Specificity)) %>% 
  inner_join(colors_consensus %>% 
               mutate(sample = str_to_title(sample)), 
             by = c("Specificity" = "sample")) %>% 
  select(-dataset_id) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "tissue") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              mutate(Specificity = str_to_title(Specificity)) %>% 
              filter(!Specificity %in% a) %>% 
              mutate(color = c(
                "#1280C4",
                "grey",
                "#DE6C7D",
                "#b30000",
                "#404785",
                "#b30000",
                "#DE6C7D",
                mix_colors("#A1A8AA","#FFDD00", 0.5),
                mix_colors("#1280C4", "#D1CBE5", 0.5)))) %>% 
  ungroup()  %>%
  group_by_all() %>% 
  mutate(color_dark = ramp_color_bias(color, "black", bias = 0.4)) %>% 
  ungroup() %>% 
  select(-color) %>% 
  deframe()


umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "tissue") %>% 
  mutate(Specificity = str_to_title(Specificity)) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 mutate(Specificity = str_to_title(Specificity)) %>% 
                 filter(dataset_id == "tissue") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = Specificity, 
                   color = Specificity),
               alpha = 0.7)+ 
  scale_fill_manual(values = specificity_pal %>%  sort()) +
  geom_point(data = umap_centers %>%
               mutate(cluster = as.character(cluster)) %>%
               filter(dataset_id == "tissue") %>% 
               inner_join(cluster_annotation   %>% 
                            mutate(Specificity = str_to_title(Specificity))),
             inherit.aes = F, aes(x,y, color = Specificity),
             size = 4.5,
             stroke= 0.8,
             show.legend = F) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>%
              filter(dataset_id == "tissue"),
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "tissue"),
            aes(x, y, label = full_annotation), 
            inherit.aes = F,
            show.legend = F) +
  scale_color_manual(values = specificity_pal_dark) 

ggsave(savepath("tissue_color_specificity_clusternum.pdf"))


# IMMUNE CELLS

specificity_pal <- 
  c("Neutrophils"   =  "#F39B7F",        
    "Granulocytes"   =   "#F39B7F",      
    "Plasmacytoid DCs" =  "#199985",      
    "T-regs" =  "#7D8DAF",   
    "Non-specific" =  "grey",         
    "Monocytes" =  "#E64B35",          
    "Basophils" =  "#F39B7F",           
    "T-cells" =   "#7D8DAF",          
    "NK-cells" =  "#AD1D78",             
    "MAIT-cells" =  "#7D8DAF",           
    "B-cells" = "#66287F",
    "Antigen presenting cells" = "grey30",
    "Myeloid DCs" = "#199985",
    "GdT-cells" = "#7D8DAF",          
    "Eosinophils" = "#F39B7F")  


specificity_pal_dark  <-
  c("Neutrophils"   =  "#F39B7F",        
    "Granulocytes"   =   "#F39B7F",      
    "Plasmacytoid DCs" =  "#199985",      
    "T-regs" =  "#7D8DAF",   
    "Non-specific" =  "grey",         
    "Monocytes" =  "#E64B35",          
    "Basophils" =  "#F39B7F",           
    "T-cells" =   "#7D8DAF",          
    "NK-cells" =  "#AD1D78",             
    "MAIT-cells" =  "#7D8DAF",           
    "B-cells" = "#66287F",
    "Antigen presenting cells" = "grey30",
    "Myeloid DCs" = "#199985",
    "GdT-cells" = "#7D8DAF",          
    "Eosinophils" = "#F39B7F")  %>% 
  sapply( function(x) {
    ramp_color_bias(x, "black", bias = 0.4)
  })



umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "blood") %>% 
  # mutate(Specificity = str_to_title(Specificity)) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 #mutate(Specificity = str_to_title(Specificity)) %>% 
                 filter(dataset_id == "blood") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = Specificity, 
                   color = Specificity),
               # show.legend = F, 
               alpha = 0.7)+ 
  scale_fill_manual(values = specificity_pal %>% sort() ) +
  geom_point(data = umap_centers %>%
               mutate(cluster = as.character(cluster)) %>%
               filter(dataset_id == "blood") %>% 
               inner_join(cluster_annotation) ,  #%>% 
             # mutate(Specificity = str_to_title(Specificity))),
             inherit.aes = F, aes(x,y, color = Specificity),
             size = 4.5,
             stroke= 0.8,
             show.legend = F) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>%
              filter(dataset_id == "blood"),
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "blood"),
            aes(x, y, label = full_annotation), 
            inherit.aes = F,
            show.legend = F) +
  scale_color_manual(values = specificity_pal_dark) 

ggsave(savepath("blood_color_specificity_clusternum.pdf"))


# CELL LINES

specificity_pal <- 
  annotation_data %>% 
  filter(dataset_id == "celline") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(colors_consensus ,
             by = c("Specificity" = "sample")) %>% 
  select(-dataset_id) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "celline") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% colors_consensus$sample) %>% 
              mutate(color = c(
                "#66BD63",
                "#F8BDD7",
                mix_colors("#66bd63","#66bd63", 0.5),
                mix_colors("#FFEF78","#FFDD00", 0.5),
                "#FFDD00",
                "#A1A8AA",
                mix_colors("#F9A266","#95D4F5",0.5),
                "#A1A8AA",
                "grey",
                mix_colors("#A1A8AA","#A1A8AA", 0.5),
                "#FCCAB3", #Epithelial (now is skin)
                "#66bd63",
                "#F9A266",
                mix_colors("#B26996","#B26996", 0.5)))) %>% 
  ungroup() %>% 
  deframe()


specificity_pal_dark  <-
  annotation_data %>% 
  filter(dataset_id == "celline") %>% 
  select(Specificity) %>% 
  distinct() %>% 
  inner_join(colors_consensus ,
             by = c("Specificity" = "sample")) %>% 
  select(-dataset_id) %>% 
  full_join(annotation_data %>% 
              filter(dataset_id == "celline") %>% 
              select(Specificity) %>% 
              distinct() %>% 
              filter(!Specificity %in% colors_consensus$sample) %>% 
              mutate(color = c(
                "#66BD63",
                "#F8BDD7",
                mix_colors("#66bd63","#66bd63", 0.5),
                mix_colors("#FFEF78","#FFDD00", 0.5),
                "#FFDD00",
                "#A1A8AA",
                mix_colors("#F9A266","#95D4F5",0.5),
                "#A1A8AA",
                "grey",
                mix_colors("#A1A8AA","#A1A8AA", 0.5),
                "#FCCAB3", #Epithelial (now is skin)
                "#66bd63",
                "#F9A266",
                mix_colors("#B26996","#B26996", 0.5)))) %>% 
  ungroup()  %>%
  group_by_all() %>% 
  mutate(color_dark = ramp_color_bias(color, "black", bias = 0.4)) %>% 
  ungroup() %>% 
  select(-color) %>% 
  deframe()


umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "celline") %>% 
  # mutate(Specificity = str_to_title(Specificity)) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>%
                 #mutate(Specificity = str_to_title(Specificity)) %>% 
                 filter(dataset_id == "celline") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = Specificity, 
                   color = Specificity),
               #   show.legend = F, 
               alpha = 0.7)+ 
  scale_fill_manual(values = specificity_pal %>% sort()) +
  geom_point(data = umap_centers %>%
               mutate(cluster = as.character(cluster)) %>%
               filter(dataset_id == "celline") %>% 
               inner_join(cluster_annotation),   #%>% 
             #mutate(Specificity = str_to_title(Specificity))),
             inherit.aes = F, 
             aes(x,y, color = Specificity),
             size = 4.5,
             stroke= 0.8,
             show.legend = F) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>%
              filter(dataset_id == "celline"),
            inherit.aes = F, aes(x,y, label = cluster),
            color = "white") +
  geom_text(data = umap_centers %>% 
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "celline"),
            aes(x, y, label = full_annotation), 
            inherit.aes = F,
            show.legend = F) +
  scale_color_manual(values = specificity_pal_dark) 

ggsave(savepath("celline_color_specificity_clusternum.pdf"))

```

### Specificity clustering - new centers
```{r}

mult_clust <- 
  new_centers %>% 
  group_by(dataset_id, cluster) %>% 
  summarise(n = n_distinct(sub_cluster)) %>% 
  mutate(multiple = case_when(n == 1 ~ "NO",
                   TRUE ~ "YES")) %>% 
  ungroup() %>%
  select(-n)

new_centers_all <- 
  new_centers %>% 
  left_join(mult_clust) %>% 
  mutate(subcluster = case_when((multiple == "YES" & sub_cluster == 1) ~ "A",
                                sub_cluster == 2 ~ "B",
                                sub_cluster == 3 ~ "C",
                                sub_cluster == 4 ~ "D",
                                TRUE ~ ""))

new_centers_main <-
  new_centers %>% 
  filter(sub_cluster == 1)

# SINGLE CELL

# specificity_pal <- 
#   annotation_data %>% 
#   filter(dataset_id == "singlecell") %>% 
#   select(Specificity) %>% 
#   distinct() %>% 
#   inner_join(colors_consensus, by = c("Specificity" = "sample")) %>% 
#   full_join(annotation_data %>% 
#               filter(dataset_id == "singlecell") %>% 
#               select(Specificity) %>% 
#               distinct() %>% 
#               filter(!Specificity %in% colors_consensus$sample) %>% 
#               mutate(color = c(
#                 "#96C08E",
#                 "grey",
#                 "#FFDD00",
#                 "#FFDD00",
#                 "#5191B2",
#                 "#95D4F5",
#                 mix_colors("#A7DACD","#B26996", 0.5),
#                 "#7F6A9C",
#                 "#b30000",
#                 "#95D4F5",
#                 "#4269B0",
#                 "#95D4F5",
#                 "#4269B0",
#                 "#404785",
#                 "#4269B0",
#                 "#404785",
#                 "#404785",
#                 "#66bd63",
#                 "#F8BDD7",
#                 "#404785",
#                 "#404785",
#                 "#199985",
#                 "#4269B0",
#                 "#b30000",
#                 "#b30000"))) %>% 
#   ungroup() %>% 
#   select(-dataset_id) %>% 
#   deframe()
# 
# 
# specificity_pal_dark  <-
#   annotation_data %>% 
#   filter(dataset_id == "singlecell") %>% 
#   select(Specificity) %>% 
#   distinct() %>% 
#   inner_join(colors_consensus, by = c("Specificity" = "sample")) %>% 
#   full_join(annotation_data %>% 
#               filter(dataset_id == "singlecell") %>% 
#               select(Specificity) %>% 
#               distinct() %>% 
#               filter(!Specificity %in% colors_consensus$sample) %>% 
#               mutate(color = c(
#                 "#96C08E",
#                 "grey",
#                 "#FFDD00",
#                 "#FFDD00",
#                 "#5191B2",
#                 "#95D4F5",
#                 mix_colors("#A7DACD","#B26996", 0.5),
#                 "#7F6A9C",
#                 "#b30000",
#                 "#95D4F5",
#                 "#4269B0",
#                 "#95D4F5",
#                 "#4269B0",
#                 "#404785",
#                 "#4269B0",
#                 "#404785",
#                 "#404785",
#                 "#66bd63",
#                 "#F8BDD7",
#                 "#404785",
#                 "#404785",
#                 "#199985",
#                 "#4269B0",
#                 "#b30000",
#                 "#b30000"))) %>% 
#   ungroup() %>% 
#   select(-dataset_id) %>%
#   group_by_all() %>% 
#   mutate(color_dark = ramp_color_bias(color, "black", bias = 0.4)) %>% 
#   ungroup() %>% 
#   select(-color) %>% 
#   deframe()

specificity_pal <- 
  cluster_pal_sp %>% 
  filter(dataset_id == "singlecell") %>% 
  select(Specificity,color) %>% 
  deframe()

specificity_pal_dark <- 
  specificity_pal %>% 
  lapply(function(color) {
    ramp_color_bias(color, "black", bias = 0.4)
  }) %>% 
  unlist()

umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) + #, color = Specificity
  geom_point_rast(show.legend = F, 
                  shape = 16,
                  size = 0.4,
                  color = "grey",
                  alpha = 0.4) + #, color = "grey80"
  coord_fixed() +
  geom_polygon(data = umap_polygons %>%
                 mutate(cluster = as.character(cluster)) %>%
                 left_join(annotation_data) %>%
                 filter(dataset_id == "singlecell") ,
               aes(X,Y, group = paste(cluster, sub_cluster, landmass),
                   fill = Specificity,
                   color = Specificity),
               size = 0.4,
               alpha = 0.7,
             show.legend = F)+
  scale_fill_manual(values = specificity_pal %>% sort()) +
  geom_point_rast(data = new_centers_all %>%
               filter(dataset_id == "singlecell") %>%
               inner_join(cluster_annotation),
             inherit.aes = F, aes(x,y, color = Specificity),
             size = 5,
             shape = 16,
             stroke= 0.5,
             show.legend = F) +
  # geom_text(data = new_centers_all %>%
  #             filter(dataset_id == "singlecell"),
  #           inherit.aes = F, aes(x,y, label = cluster),
  #           color = "white") +
  # geom_text(data = new_centers_all %>%
  #             filter(dataset_id == "singlecell") %>%
  #             inner_join(cluster_annotation),
  #           inherit.aes = F, aes(x,y, label = subcluster, color = Specificity),
  #           show.legend = F,
  #           size = 3,
  #           vjust = 1,
  #           hjust = -1) +
  # geom_text(data = new_centers_main %>%
  #             mutate(cluster = as.character(cluster)) %>%
  #             left_join(cluster_annotation) %>%
  #             filter(dataset_id == "singlecell"),
  #           aes(x, y, label = full_annotation),
  #           #family = "serif",
  #           size = 3,
  #           inherit.aes = F,
  #           show.legend = F) +
 #   geom_text(data = new_centers_main %>%
 #              mutate(cluster = as.character(cluster)) %>%
 #              left_join(cluster_annotation) %>%
 #              filter(dataset_id == "singlecell"),
 #            aes(x, y, label = Specificity), #, color = Specificity
 #            #family = "serif",
 #            size = 3,
 #            fontface = "bold",
 #            hjust = 0,
 #            inherit.aes = F,
 #            show.legend = F) +
 # geom_text(data = new_centers_main %>%
 #              mutate(cluster = as.character(cluster)) %>%
 #              left_join(cluster_annotation) %>%
 #              filter(dataset_id == "singlecell"),
 #            aes(x, y, label = Function),
 #            #family = "serif",
 #            size = 3,
 #           vjust = 2,
 #           hjust = 0,
 #            inherit.aes = F,
 #            show.legend = F) +
   scale_color_manual(values = specificity_pal_dark) +
  theme_void() 

ggsave(savepath("singlecell_annotation_2.pdf"), height = 9, width = 9)
ggsave(savepath("singlecell_annotation_specificity.pdf"), height = 9, width = 9)
ggsave(savepath("singlecell_noannotation_2.pdf"), height = 9, width = 9)
ggsave(savepath("singlecell_noannotation_nonumbers_2.pdf"), height = 9, width = 9)
ggsave(savepath("singlecell_points_black.pdf"), height = 9, width = 9)


# TISSUE

# annotation_data %>% 
#   filter(dataset_id == "tissue") %>% 
#   select(Specificity) %>% 
#   distinct() %>% 
#   inner_join(tissue_palette, by = c("Specificity" = "tissue")) %>% 
#   full_join(umap_data %>% 
#               left_join(cluster_annotation) %>% 
#               filter(dataset_id == "tissue") %>% 
#               left_join(specificity_pal) %>% 
#               filter(is.na(color)) %>% 
#               pull(Specificity) %>% 
#               unique() %>% 
#               enframe() %>% 
#               mutate() %>% 
#               rename(Specificity = value) %>% 
#               select(-name))
# 
# 
# a <- colors_consensus %>%  mutate(sample = str_to_title(sample)) %>% pull(sample)
# 
# specificity_pal <- 
#   annotation_data %>% 
#   filter(dataset_id == "tissue") %>% 
#   select(Specificity) %>% 
#   distinct() %>% 
#   mutate(Specificity = str_to_title(Specificity)) %>% 
#   inner_join(colors_consensus %>% 
#                mutate(sample = str_to_title(sample)), 
#              by = c("Specificity" = "sample")) %>% 
#   select(-dataset_id) %>% 
#   full_join(annotation_data %>% 
#               filter(dataset_id == "tissue") %>% 
#               select(Specificity) %>% 
#               distinct() %>% 
#               mutate(Specificity = str_to_title(Specificity)) %>% 
#               filter(!Specificity %in% a) %>% 
#               mutate(color = c(
#                 "#1280C4",
#                 "grey",
#                 "#DE6C7D",
#                 "#b30000",
#                 "#404785",
#                 "#b30000",
#                 "#DE6C7D",
#                 mix_colors("#A1A8AA","#FFDD00", 0.5),
#                 mix_colors("#1280C4", "#D1CBE5", 0.5)))) %>% 
#   ungroup() %>% 
#   deframe()
# 
# 
# specificity_pal_dark  <-
#   annotation_data %>% 
#   filter(dataset_id == "tissue") %>% 
#   select(Specificity) %>% 
#   distinct() %>% 
#   mutate(Specificity = str_to_title(Specificity)) %>% 
#   inner_join(colors_consensus %>% 
#                mutate(sample = str_to_title(sample)), 
#              by = c("Specificity" = "sample")) %>% 
#   select(-dataset_id) %>% 
#   full_join(annotation_data %>% 
#               filter(dataset_id == "tissue") %>% 
#               select(Specificity) %>% 
#               distinct() %>% 
#               mutate(Specificity = str_to_title(Specificity)) %>% 
#               filter(!Specificity %in% a) %>% 
#               mutate(color = c(
#                 "#1280C4",
#                 "grey",
#                 "#DE6C7D",
#                 "#b30000",
#                 "#404785",
#                 "#b30000",
#                 "#DE6C7D",
#                 mix_colors("#A1A8AA","#FFDD00", 0.5),
#                 mix_colors("#1280C4", "#D1CBE5", 0.5)))) %>% 
#   ungroup()  %>%
#   group_by_all() %>% 
#   mutate(color_dark = ramp_color_bias(color, "black", bias = 0.4)) %>% 
#   ungroup() %>% 
#   select(-color) %>% 
#   deframe()

specificity_pal <- 
  cluster_pal_sp %>% 
  filter(dataset_id == "tissue") %>% 
  select(Specificity,color) %>% 
  deframe()

specificity_pal_dark <- 
  specificity_pal %>% 
  lapply(function(color) {
    ramp_color_bias(color, "black", bias = 0.4)
  }) %>% 
  unlist()

umap_data %>% 
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "tissue") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) + #color = Specificity
  geom_point_rast(show.legend = F, 
                  shape = 16,
                  size = 0.4,
                  color ="grey",
                  alpha = 0.4) + #, color = "grey80"
  coord_fixed() +
 geom_polygon(data = umap_polygons %>%
                mutate(cluster = as.character(cluster)) %>%
                left_join(annotation_data) %>%
                filter(dataset_id == "tissue") ,
              aes(X,Y, group = paste(cluster, sub_cluster, landmass),
                  fill = Specificity,
                  color = Specificity),
              size = 0.4,
              alpha = 0.7,
            show.legend = F)+
 scale_fill_manual(values = specificity_pal %>% sort()) +
 geom_point_rast(data = new_centers_all %>%
              filter(dataset_id == "tissue") %>%
              inner_join(cluster_annotation),
            inherit.aes = F, aes(x,y, color = Specificity),
            size = 5,
            shape = 16,
            stroke= 0.5,
            show.legend = F) +
 geom_text(data = new_centers_all %>%
             filter(dataset_id == "tissue"),
           inherit.aes = F, aes(x,y, label = cluster),
           color = "white") +
 geom_text(data = new_centers_all %>%
             filter(dataset_id == "tissue") %>%
             inner_join(cluster_annotation),
           inherit.aes = F, aes(x,y, label = subcluster, color = Specificity),
           show.legend = F,
           size = 3,
           vjust = 1,
           hjust = -1) +
 # # geom_text(data = new_centers_main %>%
 # #             mutate(cluster = as.character(cluster)) %>%
 # #             left_join(cluster_annotation) %>%
 # #             filter(dataset_id == "tissue"),
 # #           aes(x, y, label = full_annotation),
 # #           #family = "serif",
 # #           size = 3,
 # #           inherit.aes = F,
 # #          show.legend = F) +
 #   geom_text(data = new_centers_main %>%
 #              mutate(cluster = as.character(cluster)) %>%
 #              left_join(cluster_annotation) %>%
 #              filter(dataset_id == "tissue"),
 #            aes(x, y, label = Specificity),#, color = Specificity
 #            #family = "serif",
 #            size = 3,
 #            hjust = 0,
 #            fontface = "bold",
 #            inherit.aes = F,
 #            show.legend = F) +
 # geom_text(data = new_centers_main %>%
 #              mutate(cluster = as.character(cluster)) %>%
 #              left_join(cluster_annotation) %>%
 #              filter(dataset_id == "tissue"),
 #            aes(x, y, label = Function),
 #            #family = "serif",
 #            size = 3,
 #           vjust = 2,
 #           hjust = 0,
 #            inherit.aes = F,
 #            show.legend = F) +
   scale_color_manual(values = specificity_pal_dark) +
  theme_void() 

ggsave(savepath("tissue_annotation.pdf"), height = 9, width = 9)
ggsave(savepath("tissue_annotation_specificity.pdf"), height = 9, width = 9)
ggsave(savepath("tissue_noannotation.pdf"), height = 9, width = 9)
ggsave(savepath("tissue_noannotation_nonumbers.pdf"), height = 9, width = 9)
ggsave(savepath("tissue_points.pdf"), height = 9, width = 9)

```


### Comparison UMAPs

```{r}

plots <- 
  clustering_data %>% 
  pull(dataset_id) %>% 
  unique() %>% 
  lapply(function(id){
    
    
    plot_data <<- clustering_data %>%
      filter(dataset_id == id) 
    
    color_dict <- data.frame(cluster = unique(sort(as.numeric(plot_data$cluster))),
                             cluster_color = colorRampPalette(ggthemes::tableau_color_pal(
                               palette = "Classic Cyclic")(13))(max(as.numeric(plot_data$cluster))))
 dat <- plot_data %>% 
   left_join(color_dict %>% 
               mutate(cluster = as.character(cluster)))

 umap_data %>%
   left_join(dat %>%
               select(-dataset_id)) %>%
   ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster_color)) +
   geom_point(show.legend = F, size = 0.05) +
   coord_fixed() +
   theme_void() +
   scale_color_identity() +
   facet_grid(~dataset_id)
 
 
 
  })
  
plots[[3]] /  plots[[2]] / plots[[4]] / plots[[5]] / plots[[1]]

ggsave(savepath("all_UMAP_comparisons.pdf"))

```

## Distribution classification

```{r}

# All clusters

dat <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 


dat %>% 
  ggplot(aes(x = as.factor(cluster), y = n, fill = specificity_category)) +
  geom_bar(poistion = "stack", stat = "identity") +
  scale_fill_manual(values = gene_category_pal) +
  geom_text(data = dat %>% 
              group_by(dataset_id, cluster) %>% 
              summarise(cum = sum(n)),
            aes(x = cluster, y = cum + 60, label = cum),
            size = 2,
            show.legend = F,
            inherit.aes = F#,
            #position = "center"
  ) +
  ylab("Number of genes") +
  xlab("Cluster") +
  facet_wrap(~dataset_id, ncol = 4, scales = "free") + 
  coord_flip()+
  theme_classic()

ggsave(savepath("specificity_classification_2.pdf"))

# Specificity, cluster annotation
dat <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) %>%
  mutate(cluster = as.character(cluster)) %>%
  filter(dataset_id != "brain") %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id != "brain")) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustering_datasets <- 
  data.frame(dataset_id = c("blood", "celline", "singlecell", "tissue"),
             type = c("sample", "consensus", "sample", "region"))

heatmap_d <- 
  heatmap_data_scaled_cluster %>% 
  inner_join(clustering_datasets)


c("tissue", "singlecell", "blood", "celline") %>% 
  lapply(function(dataset) {
    
    g_cluster_data_wide <- 
      heatmap_d %>% 
      select(-ensg_id, -value, -value_scaled, -value_zscore) %>% 
      distinct() %>% 
      filter(dataset_id == dataset) %>%
      #filter(type == "consensus") %>% 
      inner_join(cluster_annotation ) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep ="_")) %>% 
      select(annotation, sample, avg_value_zscore) %>% 
      distinct() %>% 
      spread(sample, avg_value_zscore) %>% 
      column_to_rownames("annotation") 
    
    gene_hclust <- 
      g_cluster_data_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    
    d <- dendro_data(gene_hclust, type = "rectangle")
    
    label_data <- bind_cols(filter(segment(d), x == xend & x%%1 == 0), label(d))
    
    
    dendrogram <- 
      ggplot(segment(d)) + 
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
      scale_y_reverse(expand = expansion(0)) + 
      coord_flip() +
      scale_x_continuous(expand = expansion(0.01)) +
      theme_dendro()
    
    
    specificity_annotation_pal <- c("High" = "#CBD4EF", 
                                    "Low" = "#2A428C")
    
    cluster_sp <- 
      data.frame(annotation = factor((gene_hclust$labels[gene_hclust$order]), 
                                     levels = (gene_hclust$labels[gene_hclust$order]))) %>% 
      mutate(specificity = case_when(grepl("Low", annotation)& grepl( "specificity", annotation) ~ "Low",
                                     TRUE ~ "High"))%>% 
      arrange(annotation) %>% 
      ggplot(aes("Specificity", annotation, fill = specificity)) + 
      geom_tile_rast(color = "white") +
      theme_void() +
      scale_fill_manual(values = specificity_annotation_pal) +
      theme(axis.text.x = element_text(angle = -90, face = "bold"), 
            legend.position = "top") + 
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0))
    
    
    clust_data <- 
      cluster_annotation %>% 
      filter(dataset_id == dataset) %>% 
      select(cluster, full_annotation) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
      mutate(annotation = factor(annotation, 
                                 levels = gene_hclust$labels[gene_hclust$order])) %>% 
      arrange(annotation) 
    
    cluster_barplot <- 
      clust_data %>%
      ggplot(aes("Cluster", annotation, fill = cluster)) + 
      geom_tile_rast(color = "white", show.legend = F) +
      theme_void() +
      geom_text(aes(label=cluster), size = 2, color = "white") +
      scale_fill_manual(values = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(clust_data$cluster)))) +
      theme(axis.text.x = element_text(angle = -90, face = "bold"), 
            legend.position = "top",
            axis.text.y = element_text(size = 6, hjust = 0.5)) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0))
    
    
    
    barplot <- 
      dat %>% 
      mutate(cluster = as.character(cluster)) %>% 
      filter(dataset_id == dataset) %>% 
      inner_join(cluster_annotation ) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep ="_"))  %>% 
      mutate(annotation = factor(annotation, 
                                 (gene_hclust$labels[gene_hclust$order]))) %>% 
      arrange(annotation) %>% 
      ggplot(aes(x = annotation, y = n, fill = specificity_category)) +
      geom_bar(poistion = "stack", stat = "identity") +
      scale_fill_manual(values = gene_category_pal) +
      scale_y_continuous(expand = expansion(0.05)) +
      geom_text(data = . %>% 
                  ungroup() %>% 
                  group_by(annotation) %>% 
                  summarise(cum = sum(n)) %>% 
                  distinct() %>% 
                  arrange(annotation),
                aes(x = annotation, y = cum + 60, label = cum),
                size = 3,
                show.legend = F,
                inherit.aes = F) +
      ylab("Number of genes") +
      xlab("Cluster") +
      coord_flip()+
      theme_classic()+ theme(
        plot.title = element_blank(),
        axis.title.y = element_blank(),
        axis.text.y = element_blank())
    
    
    
    
    dendrogram + cluster_barplot + cluster_sp + barplot +
      plot_layout(widths = c(2,1, 1, 3), guides = "collect")
    
    ggsave(savepath(paste(dataset, "_barplot.pdf", sep = "_")))
  })

```

## Scatterpie plot 

```{r}

# SINGLE CELL
# All clusters

dat <- 
  specificity_long2 %>% 
  filter(id == "specificity_singlecell") %>% 
  select(ensg_id,specificity_category) %>% 
  left_join(clustering_data %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene"))  %>%
  group_by(cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  spread(key = specificity_category, value = n, fill = 0) %>% 
  left_join(umap_centers %>% 
              filter(dataset_id == "singlecell") %>% 
              mutate(cluster = as.character(cluster)) %>% 
              select(-dataset_id))

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(68)

gene_number <- 
  clustering_data %>% 
  filter(dataset_id == "singlecell") %>%
  group_by(cluster) %>% 
  summarise(n_genes = n_distinct(gene) / 10000)

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>%
  left_join(cluster_annotation) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = as.factor(cluster)),
               color = "grey50",
               show.legend = F, alpha = 0.5)+ 
  scale_fill_manual(values = pal)  +
  new_scale_fill() +
  geom_scatterpie(aes(x=x, y=y, group=cluster, r = 0.03), 
                  data=dat,
                  cols= c("Group enriched","Tissue enriched", "Tissue enhanced", 
                          "Low tissue specificity", "Not detected"),
                  color=NA, alpha=.9) +
  scale_fill_manual(values = gene_category_pal) 

ggsave(savepath("scatterpie_singlecell_uniform.pdf"))



# Low specificity clusters

low_clust <- 
  annotation_data %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(!grepl("Non-specific", Specificity)) %>% 
  inner_join(umap_centers %>% 
               mutate(cluster = as.character(cluster))) %>% 
  mutate(full_annotation = paste(Specificity, Function, sep =" - ")) %>% 
  select(Function, Specificity, Function, full_annotation, x, y)

pal <- c("Annotated specificity" = "#CBD4EF", 
         "Non-specific" = "#2A428C")

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell")%>%
  left_join(cluster_annotation) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "singlecell")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Non-specific", Specificity) ~ "Non-specific",
                                   TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = Cluster_specificity),
               color = "grey50",
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  new_scale_fill() +
  geom_scatterpie(aes(x=x, y=y, group=cluster, r = 0.03), 
                  data=dat %>% 
                    inner_join(annotation_data %>% 
                             filter(dataset_id == "singlecell") %>% 
                               filter(!grepl("Non-", Specificity))),
                  cols= c("Group enriched","Tissue enriched", "Tissue enhanced", 
                          "Low tissue specificity", "Not detected"),
                  color=NA, alpha=.9) +
  scale_fill_manual(values = gene_category_pal)  +
  geom_text(data = low_clust, aes(x, y, label = Specificity), fontface = "bold", size = 3, 
            hjust = 0, vjust = 0) +
  geom_text(data = low_clust, aes(x, y, label = Function), size = 3, 
            hjust = 0, vjust = 1)

ggsave(savepath("scatterpie_singlecell_specificity.pdf"),
       width = 9,
       height = 9) 


# TISSUE
# All clusters

dat <- 
  specificity_long2 %>% 
  filter(id == "specificity_tissue") %>% 
  select(ensg_id,specificity_category) %>% 
  left_join(clustering_data %>% 
              filter(dataset_id == "tissue"),
            by = c("ensg_id" = "gene"))  %>%
  group_by(cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  spread(key = specificity_category, value = n, fill = 0) %>% 
  left_join(umap_centers %>% 
              filter(dataset_id == "tissue") %>% 
              mutate(cluster = as.character(cluster)) %>% 
              select(-dataset_id))

pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87)


clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue") %>%
  left_join(cluster_annotation) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue"), 
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = as.factor(cluster)),
               color = "grey50",
               show.legend = F, alpha = 0.5)+ 
  scale_fill_manual(values = pal)  +
  new_scale_fill() +
  geom_scatterpie(aes(x=x, y=y, group=cluster, r = 0.02), 
                  data=dat,
                  cols= c("Group enriched","Tissue enriched", "Tissue enhanced", 
                          "Low tissue specificity", "Not detected"),
                  color=NA, alpha=.9) +
  scale_fill_manual(values = gene_category_pal) 

ggsave(savepath("scatterpie_tissue_uniform.pdf"))

# Low specificity clusters
low_clust <- 
  annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  filter(grepl("Low", Specificity)) %>% 
  inner_join(umap_centers %>% 
               mutate(cluster = as.character(cluster)))

dat <- 
  specificity_long2 %>% 
  filter(id == "specificity_tissue") %>% 
  select(ensg_id,specificity_category) %>% 
  left_join(clustering_data %>% 
              filter(dataset_id == "tissue"),
            by = c("ensg_id" = "gene"))  %>%
  group_by(cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  spread(key = specificity_category, value = n, fill = 0) %>% 
  left_join(umap_centers %>% 
              filter(dataset_id == "tissue") %>% 
              mutate(cluster = as.character(cluster)) %>% 
              select(-dataset_id)) %>% 
  filter(cluster %in% low_clust$cluster)


pal <- c("Annotated specificity" = "#CBD4EF", 
         "Low specificity" = "#2A428C")

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                   TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = Cluster_specificity),
               color = "grey50",
               #show.legend = F, 
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
#  scale_fill_manual(values = pal)  +
  new_scale_fill() +
  geom_scatterpie(aes(x=x, y=y, group=cluster, r = 0.02), #r=0.04, n_genes
                  data=dat %>% 
                    left_join(cluster_annotation %>% 
                                filter(dataset_id == "singlecell")) %>% 
                    filter(grepl("Non-", Specificity)),# %>% 
                   # left_join(gene_number), 
                  cols= c("Group enriched","Tissue enriched", "Tissue enhanced", 
                          "Low tissue specificity", "Not detected"),
                  color=NA, alpha=.9) +
  scale_fill_manual(values = gene_category_pal)  +
  geom_text(data = low_clust, aes(x, y, label = Function))
  #scale_color_manual(values = gene_category_pal)  

ggsave(savepath("scatterpie_tissue_low_specificity.pdf")) 


# High specificity clusters
high_clust <- 
  annotation_data %>% 
  filter(dataset_id == "tissue") %>% 
  filter(!grepl("Low", Specificity)) %>% 
  inner_join(umap_centers %>% 
               mutate(cluster = as.character(cluster)))

dat <- 
  specificity_long2 %>% 
  filter(id == "specificity_tissue") %>% 
  select(ensg_id,specificity_category) %>% 
  left_join(clustering_data %>% 
              filter(dataset_id == "tissue"),
            by = c("ensg_id" = "gene"))  %>%
  group_by(cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  spread(key = specificity_category, value = n, fill = 0) %>% 
  left_join(umap_centers %>% 
              filter(dataset_id == "tissue") %>% 
              mutate(cluster = as.character(cluster)) %>% 
              select(-dataset_id)) %>% 
  filter(cluster %in% high_clust$cluster)


pal <- c("Annotated specificity" = "#CBD4EF", 
         "Low specificity" = "#2A428C")

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "tissue")%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  == "tissue")  %>%
                 mutate(Cluster_specificity = case_when(grepl("Low", Specificity) ~ "Low specificity",
                                   TRUE ~ "Annotated specificity")) , 
               aes(X,Y, group = polygon_id, 
                   fill = Cluster_specificity),
               color = "grey50",
               alpha = 0.5)+
  scale_fill_manual(values = pal) +
  new_scale_fill() +
  geom_scatterpie(aes(x=x, y=y, group=cluster, r = 0.02), 
                  data=dat, 
                  cols= c("Group enriched","Tissue enriched", "Tissue enhanced", 
                          "Low tissue specificity", "Not detected"),
                  color=NA, alpha=.9) +
  scale_fill_manual(values = gene_category_pal)  +
  geom_text(data = high_clust, aes(x, y, label = paste(Specificity, Function, sep = " - ")))

ggsave(savepath("scatterpie_tissue_high_specificity_2.pdf")) 

```

## UMAPs - genes colored by specificity

```{r}

umap_data %>% 
  left_join(specificity_long2 %>% 
              mutate(dataset_id = gsub("specificity_", "", id)) %>% 
              rename(gene = ensg_id)) %>% 
  #filter(dataset_id != "brain") %>% 
  filter(dataset_id %in% c("singlecell","tissue")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = specificity_category)) +
  geom_point_rast(size = 0.001, shape = 16, raster.dpi = 600) +
  facet_wrap(~dataset_id, ncol = 4) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = gene_category_pal)  

ggsave(savepath("umaps_specificity.pdf"), 
       height = 5,
       width  = 15,
       dpi = 600)



umap_data %>% 
  left_join(specificity_long2 %>% 
              mutate(dataset_id = gsub("specificity_", "", id)) %>% 
              rename(gene = ensg_id)) %>% 
  filter(dataset_id == "singlecell",
         specificity_category == "Tissue enriched",
         enhanced_tissues != "NA") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = enhanced_tissues)) +
  geom_point_rast(size = 0.001, 
                  data = umap_data %>% 
                    filter(dataset_id == "singlecell"),
                  aes(UMAP_1_scaled, UMAP_2_scaled),
                  color = "grey",
                  inherit.aes = F)+
  geom_point_rast(size = 0.001, show.legend = F) +
  facet_wrap(~enhanced_tissues) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = colors_consensus %>% filter(dataset_id == "singlecell") %>% 
                       select(-dataset_id) %>% 
                       deframe())  

ggsave(savepath("umaps_enhanced.pdf"))


```


# 2. Tau 

```{r}

# Read expression data
expression_data <-
  readRDS("data/processed/combined_HPA_expression_data.RDS")

# Scale data for heatmap
heatmap_data_scaled  <- 
  expression_data %>%
  map(. %>% 
        gather(sample, value, -1) %>% 
        group_by(ensg_id) %>% 
        mutate(value_scaled = value / max(value),
               value_zscore = (value - mean(value, na.rm = T)) / 
                 sd(value, na.rm = T)) %>% 
        ungroup()) %>% 
  bind_rows(.id = "id") %>% 
  separate(id, into = c("dataset_id", "type")) %>% 
  inner_join(clustering_data %>% 
               select(dataset_id, gene, cluster),
             by = c("dataset_id",
                    "ensg_id" = "gene"))  


heatmap_data_scaled_cluster <- 
  heatmap_data_scaled %>% 
  na.omit() %>% 
  group_by(dataset_id, type, sample, cluster) %>% 
  mutate(avg_value_scaled = mean(value_scaled),
         avg_value_zscore = mean(value_zscore)) %>% 
  ungroup()


# Calculate tau
tau_scores <-
  expression_data %>%
  map(~ .x %>% 
        column_to_rownames("ensg_id") %>% 
  calculate_tau_score()) %>% 
  bind_rows(.id = "dataset_id")
  
write_tsv(tau_scores, "data/processed/tau_scores.tsv")
  
current_data <- c("blood_consensus", "tissue_consensus", "singlecell_consensus", "celline_consensus")
  
all_tau <- 
  tau_scores %>% 
  filter(dataset_id %in% current_data) %>%
  mutate(dataset_id = gsub("_sample", "", dataset_id),
         dataset_id = gsub("_region", "", dataset_id),
         dataset_id = gsub("_consensus", "", dataset_id)) %>% 
  inner_join(clustering_data %>% 
              filter(dataset_id != "brain")) %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, ngenes, reliability, full_annotation)) %>% 
  group_by(dataset_id, cluster) 

# consensus_tau <- 
#   tau_scores %>% 
#   filter(dataset_id %in% current_data) %>%
#   mutate(dataset_id = gsub("_sample", "", dataset_id),
#          dataset_id = gsub("_region", "", dataset_id),
#          dataset_id = gsub("_consensus", "", dataset_id)) %>% 
#   inner_join(gene_classification %>% 
#   mutate(dataset_id = gsub("specificity_", "", id)) %>% 
#   filter(specificity_category != "Not detected") %>% 
#   select(dataset_id, gene = ensg_id))

consensus_data <- 
  expression_data[which(grepl("consensus$", names(expression_data)))] %>% 
  set_names(gsub("_consensus", "", names(.)))

gene_consensus_tau <- 
  consensus_data %>% 
  map(. %>% 
        column_to_rownames("ensg_id") %>% 
        {log10(. + 1)} %>% 
        calculate_tau_score()) %>% 
  bind_rows(.id = "dataset_id") #%>% 
#  inner_join(gene_classification %>% 
 #              filter(specificity_category != "Not detected") %>% 
  #             select(dataset_id, 
   #                   gene = ensg_id))



consensus_tau %>% 
  ggplot(aes(fill = dataset_id, dataset_id, tau_score)) +
  geom_violin(draw_quantiles = 0.5) +
  theme_bw()

tau <- 
  all_tau %>% 
  summarise(avg_tau = mean(tau_score), ngenes, reliability, full_annotation) %>% 
  distinct() %>% 
  arrange(avg_tau)


# Violin plot
violin_tau_specificity_classification <-
  gene_classification %>% 
  mutate(dataset_id = gsub("specificity_", "", id)) %>% 
  select(dataset_id, gene = ensg_id, specificity_category) %>% 
  inner_join(tau_scores %>% 
  filter(dataset_id %in% current_data) %>%
  mutate(dataset_id = gsub("_consensus", "", dataset_id))) %>% 
  mutate(specificity_category = factor(specificity_category, levels = rev(names(gene_category_pal)))) %>%
  filter(specificity_category != "Not detected") %>% 
  ggplot(aes(x = specificity_category, y = tau_score, fill = specificity_category)) +
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_bw() +
  coord_flip() +
  facet_wrap(~dataset_id, ncol = 4, scale = "free_x") + 
  scale_fill_manual(values = gene_category_pal[1:4]) +
  theme(panel.grid = element_blank())

ggsave(savepath("tau_specificity_category_consensus.pdf"))

# Violin plot low specificity clusters
specificity_annotation_pal <- c("High" = "#DFA371",
                                "Low" = "#9DBABF")
violin_tau_specificity_annotation <-
  annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(specificity_annotation = case_when(grepl("Low", Specificity) ~ "Low",
                                   TRUE ~ "High")) %>% 
  inner_join(tau_scores %>% 
  filter(dataset_id %in% current_data) %>%
  mutate(dataset_id = gsub("_consensus", "", dataset_id))) %>% 
  ggplot(aes(x = specificity_annotation, y = tau_score, fill = specificity_annotation)) +
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_bw() +
  coord_flip() +
  facet_wrap(~dataset_id, ncol = 4, scale = "free_x") + 
  scale_fill_manual(values = specificity_annotation_pal)


violin_tau_specificity_classification / violin_tau_specificity_annotation + 
  plot_layout(heights = c(2, 1.5))

ggsave(savepath("specificities_tau.png"))

#UMAPs by average tau 
plot_tau <- 
  clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id != "brain") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point_rast(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 left_join(tau) %>% 
                 filter(dataset_id != "brain"), 
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = avg_tau),
                   color= "grey20", 
               alpha = 0.9)+ 
  facet_wrap(~dataset_id, ncol = 4) +
  scale_fill_viridis_c() +
  theme(plot.title = element_text(hjust = 0.5))+
  ggtitle("Average cluster tau") 

ggsave(savepath("average_tau.pdf"))

# UMAP with gene tau
clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id %in% c("singlecell", "tissue")) %>% 
  #filter(dataset_id != "brain") %>% 
  inner_join(gene_consensus_tau) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = tau_score)) +
  geom_point_rast(shape = 16, size = 0.001, raster.dpi = 600) + 
  theme_void() +
  coord_fixed() +
  facet_wrap(~dataset_id, ncol = 4) +
  scale_color_viridis_c(begin  = 1, end = 0) #+
 # theme(plot.title = element_text(hjust = 0.5))+
  #ggtitle("Gene tau") 

ggsave(savepath("gene_tau.pdf"))
ggsave(savepath("gene_tau.pdf"), 
       height = 5,
       width  = 15,
       dpi = 600)

# Specificity tau (binary)
spec_palette <- c("Low" = "#440154", "High" = "#FDE725") 

plot_specificity_tau <- 
  annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(umap_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#440154",
                                   TRUE ~ "#FDE725"))%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(size = 0.05, color = "grey80") +
  facet_grid(~dataset_id) + 
  coord_fixed() +
  scale_color_identity() +
  theme_void() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(tau) %>% 
                 filter(dataset_id  != "brain") %>% 
                 mutate(specificity_tau_0.8_threshold = case_when(avg_tau < 0.8 ~ "Low",
                                                  TRUE ~ "High")),
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = specificity_tau_0.8_threshold,             
                   color = "black")) +
  scale_fill_manual(values = spec_palette) 

cluster_memberships <- 
  file_structure %>% 
  map(function(x)x$clustering) %>% 
  lapply(function(filename_) read_tsv(paste(filename_, "cluster_memberships.tsv", sep = "/")))
  
plot_specificity <- 
  annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(umap_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#440154",
                                   TRUE ~ "#FDE725"))%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(size = 0.05, color = "grey80") +
  facet_grid(~dataset_id) + 
  coord_fixed() +
  scale_color_identity() +
  theme_void() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  != "brain") %>% 
                 mutate(specificity_annotation = case_when(grepl("Low", Specificity) ~ "Low",
                                                  TRUE ~ "High")),
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = specificity_annotation,             
                   color = "black")) +
  scale_fill_manual(values = spec_palette) 

avg_memberships <- 
  cluster_memberships %>% 
  bind_rows(.id = "dataset_id") %>%
  mutate(cluster = as.character(cluster)) %>% 
  inner_join(clustering_data) %>% 
  group_by(dataset_id, cluster) %>% 
  summarise(avg_membership = mean(membership))

plot_membership <- 
  annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(umap_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#440154",
                                   TRUE ~ "#FDE725"))%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(size = 0.05, color = "grey80") +
  facet_grid(~dataset_id) + 
  coord_fixed() +
  scale_color_identity() +
  theme_void() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  != "brain") %>% 
                 left_join(avg_memberships ),
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = avg_membership,             
                   color = "black")) +
  scale_fill_viridis_c()

plot_tau / plot_specificity_tau / plot_specificity / plot_membership

ggsave(savepath("tau_specificity_membership_UMAP.png"))

```

## Housekeeping

```{r}

genes_tau_0_3 <- 
  gene_consensus_tau %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(tau_score < 0.3)

genes_tau_0_4 <- 
  gene_consensus_tau %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(tau_score < 0.4)

genes_tau_0_5 <- 
  gene_consensus_tau %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(tau_score < 0.5)

consensus_data$singlecell %>% 
  gather(sample, ntpm, -1) %>% 
  inner_join(clustering_data %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  group_by(ensg_id) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T),
         ntpm = ifelse(!is.finite(ntpm), 
                       0, 
                       ntpm)) %>% 
  filter(ensg_id %in% genes_tau_0_5$gene) %>% 
  select(-dataset_id,-cluster) %>% 
  spread(sample,ntpm) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(show_rownames = F,
           cluster_rows = F)

```

### Houskeeping lists

```{r}

hpa_hk <- read_tsv("data/gene_lists/HK_2352_HPA_singlecell_SD1_MFC2_ensg.txt") %>% deframe()
eisen_hk <- read_tsv("data/gene_lists/HK_3537_of_3804_Eisenberg_ensg.txt")%>% deframe()
hrt_hk <- read_tsv("data/gene_lists/HK_2142_of_2176_HRT_ensg.txt")%>% deframe()

#geneinfo <- read_tsv("data/meta/geneinfo_103.tsv")

all_sets <- 
  hpa_hk %>% 
  enframe(name = "set", value = "gene") %>% 
  mutate(set = "hpa") %>% 
  bind_rows(eisen_hk %>% 
  enframe(name = "set", value = "gene") %>% 
  mutate(set = "eisen")) %>% 
  bind_rows(hrt_hk %>% 
  enframe(name = "set", value = "gene") %>% 
  mutate(set = "hrt")) %>%
  #left_join(geneinfo %>% 
   #           select(gene = gene_name, ensg_id)) %>% 
  #select(-gene) %>% 
  bind_rows(clustering_data %>% 
              filter(dataset_id =="singlecell") %>% 
              mutate(set = "all") %>% 
              select(set, gene)) %>% 
  left_join(gene_consensus_tau %>% 
              select(gene, tau_score)) 

all_sets %>% 
  ggplot(aes(set, tau_score, color = tau_score)) +
  geom_quasirandom(size = 0.3) +
  scale_color_viridis_c(begin = 1, end = 0) +
  theme_simple

ggsave(savepath("hk_tau.png"))

all_sets %>% 
  ggplot(aes(x = tau_score, group = set, color = set, fill = set)) +
  geom_density(alpha = 0.3) +
  theme_simple

ggsave(savepath("hk_tau_density.png"))

## Overlaps
install.packages("eulerr")
library(eulerr)

ab <- intersect(hpa_hk, eisen_hk) %>% length()
bc <- intersect(eisen_hk, hrt_hk) %>% length()
ac <- intersect(hpa_hk, hrt_hk) %>%  length()
a_b_c <- intersect(hrt_hk, intersect(hpa_hk, eisen_hk)) %>% length()

a <- length(hpa_hk) - ab - ac + a_b_c
b <- length(eisen_hk) - ab - bc + a_b_c
c <- length(hrt_hk) - ac - bc + a_b_c

a_b <- ab - a_b_c
a_c <- ac - a_b_c
b_c <- cb - a_b_c
  
combo <- c(HPA =a, Eisen = b, HRT = c,
           "HPA&Eisen" = a_b , 
           "HPA&HRT" = a_c , 
           "Eisen&HRT" = b_c ,
           "HPA&Eisen&HRT" = a_b_c
           #"A&B&C" = a_b_c %>% len#gth()
           )

plot(euler(combo),
     quantities = TRUE)

```

## tau UMAP annotations
```{r}

cluster_tau <- 
  all_tau %>% 
  group_by(dataset_id, cluster) %>% 
  summarise(avg_tau = mean(tau_score), full_annotation) %>% 
  distinct()

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(cluster_tau) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = polygon_id, 
                   fill = avg_tau), color = "grey50",
               alpha = 0.85) +
  scale_fill_viridis_c(option = "magma") +
  geom_text(data = cluster_tau %>%
              filter(dataset_id == "singlecell") %>% 
              inner_join(umap_centers %>% 
                           mutate(cluster = as.character(cluster))) %>% 
              filter(avg_tau > 0.9), aes(x,y, label = full_annotation)) +
  ggtitle("Average tau > 0.9")

ggsave(savepath("singlecell_tau_high.pdf"))

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(show.legend = F, color = "grey80", size = 0.05) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(cluster_tau) %>% 
                 filter(dataset_id  == "singlecell"), 
               aes(X,Y, group = polygon_id, 
                   fill = avg_tau), color = "grey50",
               alpha = 0.85) +
  scale_fill_viridis_c(option = "magma") +
  geom_text(data = cluster_tau %>%
              filter(dataset_id == "singlecell") %>% 
              inner_join(umap_centers %>% 
                           mutate(cluster = as.character(cluster))) %>% 
              filter(avg_tau < 0.9), aes(x,y, label = full_annotation)) +
  ggtitle("Average tau < 0.9")

ggsave(savepath("singlecell_tau_low.pdf"))



# TAU individual genes

clustering_data %>% 
  left_join(umap_data) %>% 
  filter(dataset_id == "singlecell") %>% 
  left_join(all_tau) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = tau_score, fill = tau_score)) +
  geom_point(size = 1, 
             alpha = 0.6, 
            #stroke = 0,
            # color = NA,
             pch = 21) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>%
                 mutate(cluster = as.character(cluster))%>%
                 filter(dataset_id  == "singlecell"),
               aes(X,Y, group = polygon_id),#,fill = avg_tau
               color = "grey50",
               fill = NA,
               size = 1, 
               alpha = 0.85) +
  #scale_color_viridis_c(option = "magma") +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               left_join(all_tau %>% 
                           group_by(dataset_id, cluster) %>% 
                           summarise(avg_tau = mean(tau_score))) %>% 
               filter(dataset_id == "singlecell") %>% 
               distinct(), 
             aes(x=x, y=y, fill=avg_tau),
             size = 5,
             stroke = 1.5,
             colour = "gray50",
             pch=21,
             inherit.aes = F) +
  geom_text(data = umap_centers %>%
              filter(dataset_id == "singlecell") %>% 
              distinct(),
            aes(x,y, label= cluster),
            size = 3,
            color = "white",
            show.legend = F,
            inherit.aes = F) +
  scale_fill_viridis_c(begin = 1, end = 0) +
  scale_color_viridis_c(begin = 1, end = 0) 

clustering_data %>% 
  left_join(umap_data) %>% 
  left_join(all_tau) %>% 
  filter(dataset_id != "brain") %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = tau_score, fill = tau_score)) +
  geom_point(size = 1, 
             alpha = 0.6, 
             pch = 21) + 
  theme_void() +
  coord_fixed() +
  geom_polygon(data = umap_polygons %>%
                 mutate(cluster = as.character(cluster))%>% 
                 filter(dataset_id != "brain"),
               aes(X,Y, group = polygon_id),
               color = "grey50",
               fill = NA,
               size = 1, 
               alpha = 0.85) +
  geom_point(data = umap_centers %>% 
               mutate(cluster = as.character(cluster)) %>% 
               left_join(all_tau %>% 
                           group_by(dataset_id, cluster) %>% 
                           summarise(avg_tau = mean(tau_score)))  %>% 
               distinct() %>% 
               filter(dataset_id != "brain"), 
             aes(x=x, y=y, fill=avg_tau),
             size = 5,
             stroke = 1.5,
             colour = "gray50",
             pch=21,
             inherit.aes = F) +
  geom_text(data = umap_centers %>%
              distinct() %>% 
              filter(dataset_id != "brain"),
            aes(x,y, label= cluster),
            size = 3,
            color = "white",
            show.legend = F,
            inherit.aes = F) +
  scale_fill_viridis_c(begin = 1, end = 0, values = c(0.4,1)) +
  scale_color_viridis_c(begin = 1, end = 0, values = c(0.4,1)) +
  facet_wrap(~dataset_id)

ggsave(savepath("tau_clusters.pdf"))

```


# 3. Cluster similarity - expression

## Heatmap per clustering

```{r}

dataset <- "singlecell"
type_dataset <- "consensus"

g_cluster_data <- heatmap_data_scaled_cluster %>% 
  filter(dataset_id == dataset,
         type == type_dataset) %>% 
  na.omit()

g_dataset_id <- unique(g_cluster_data$dataset_id)

g_heatmap_type <- unique(g_cluster_data$type)


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(ensg_id, sample, avg_value_zscore) %>% 
  spread(sample, avg_value_zscore) %>% 
  column_to_rownames("ensg_id") 

tissues <- #plot_data %>% 
  g_cluster_data %>% 
  filter(dataset_id == dataset) %>% 
  pull(sample) %>% 
  unique()

pal <-  
  all_HPA_colors%>% 
  filter(organ_name %in% tissues) %>% 
  distinct() %>% 
  select(-tissue_name)

annotation_rows <-     
  clustering_data %>% 
  filter(dataset_id == dataset) %>% 
  left_join(cluster_annotation %>%
              filter(dataset_id == dataset) %>% 
              group_by(cluster) %>% 
              summarise(annotation = paste(cluster, full_annotation, sep = " - "))) %>% 
  select(gene, annotation) %>% 
  column_to_rownames("gene")

annotation_cols <- 
  g_cluster_data %>% 
  filter(dataset_id == dataset) %>% 
  select(sample) %>% 
  mutate(annotation = sample) %>% 
  distinct() %>% 
  column_to_rownames("sample")



pal_blood <- 
  blood_colors %>% 
  select(celltype, celltype_color) 


pal <- sc_colors %>% 
  select(2,3) %>% 
  filter(X2 %in%  tissues)

pal_singlecell <-

clustering_ <- cluster_annotation %>%
              filter(dataset_id == dataset) %>% 
              group_by(cluster) %>% 
              mutate(annotation = paste(cluster, full_annotation, sep = " - "))
  
annotation_rows <- 
  clustering_ %>%
  ungroup() %>% 
  arrange(as.numeric(cluster))  %>%
#  mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(clustering_$cluster)))) %>% 
 # select(annotation, cluster_color) %>% 
  #deframe()
  select(annotation) %>% 
  mutate(cluster_annotation  = annotation) %>% 
  column_to_rownames("annotation")
ann_colors <- list("cluster_annotation" = clustering_ %>%
  ungroup() %>% 
  arrange(as.numeric(cluster))  %>%
  mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(clustering_$cluster)))) %>% 
  select(annotation, cluster_color) %>% 
  deframe())
# Cluster heatmap
#plot_data %>% 
g_cluster_data %>% 
  left_join(clustering_ %>% 
              select(cluster, annotation)) %>%
  select(annotation, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(key = sample, value = avg_value_zscore) %>% 
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 7,
           fontsize_col = 7,
#           annotation_row = annotation_rows,
           #annotation_colors = ann_colors,
           #annotation_names_row = F,
           #legend = F,
 #          annotation_col = annotation_cols,
#           annotation_colors = list("annotation" = pal %>% unique() %>% deframe())
           )

# Gene heatmap
plot_data %>% 
  select(ensg_id, sample, value_zscore) %>% 
  distinct() %>% 
  spread(key = sample, value = value_zscore) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           cluster_rows = F,
           show_rownames = F)
```

## Heatmap - extended
```{r}

g_heatmap_type <- "consensus"

heatmap_data_scaled_cluster %>% 
  filter(type == "consensus",
         dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  do({
    dat <- .
    g_dataset_id <- unique(dat$dataset_id)  
    
    
    ann <- 
      cluster_annotation %>% 
      filter(dataset_id == g_dataset_id) %>% 
      select(cluster, full_annotation) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep = "_"))# %>% 
     # select(-full_annotation) 
    
    clustered_genes <- 
      clustering_data %>% 
      filter(dataset_id == g_dataset_id) %>% 
      pull(gene)
    
    g_cluster_data <- 
      heatmap_data_scaled_cluster %>% 
      filter(dataset_id == g_dataset_id,
             type == g_heatmap_type) %>% 
      filter(ensg_id %in% clustered_genes) %>% 
      na.omit()
    
    
    g_cluster_data_wide <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      distinct() %>% 
      spread(sample, avg_value_zscore) %>% 
      left_join(cluster_annotation %>% 
                  filter(dataset_id == g_dataset_id) %>% 
                  select(cluster, full_annotation)) %>% 
      mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
      select(-cluster, - full_annotation) %>% 
      column_to_rownames("a") 
    
    
    row_hclust <- 
      g_cluster_data_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    col_hclust <- 
      g_cluster_data_wide %>%
      t() %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
#    ggdendrogram(row_hclust, rotate = T, size = 2) + 
 #     coord_flip()
    
    d <- dendro_data(row_hclust, type = "rectangle")
    
    plot_dendrogram <- 
      ggplot(segment(d)) + 
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
      coord_flip() + 
      scale_y_reverse(expand = c(0.2, 0)) +
      scale_x_reverse(expand = expansion(0.01)) +
      theme_dendro()
    
    plot_cluster <- 
      ann  %>% 
      arrange(as.numeric(cluster)) %>% 
      mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(ann$cluster)))) %>% 
      ungroup() %>% 
      mutate(annotation = factor(annotation, 
                              levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
      arrange(annotation) %>% 
      ggplot(aes("Cluster", annotation, fill = cluster_color, label = full_annotation)) + 
      geom_tile_rast(color = "white", show.legend = F) +
      theme_void() +
      geom_text(aes(label=cluster), size = 2, color = "white") +
      scale_fill_identity() +
      theme(axis.text.x = element_text(angle = -90, face = "bold"), 
            legend.position = "top",
            axis.text.y = element_text(size = 6, hjust = 0.5)) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0))
     
     
     
    plot_data <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      left_join(ann %>% 
                  select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(cluster = factor(annotation, 
                              rev(row_hclust$labels[row_hclust$order])),
             sample = factor(sample, 
                             col_hclust$labels[col_hclust$order])) %>% 
      select(-annotation)
    # 
    # plot_avg_confidence <- 
    #   annotation %>%
    #   filter(cluster %in% row_hclust$labels) %>% 
    #   mutate(cluster = factor(cluster, 
    #                           rev(col_hclust$labels[col_hclust$order]))) %>% 
    #   ggplot(aes("Confidence", cluster, fill = avg_membership)) + 
    #   geom_tile_rast() +
    #   theme_void() +
    #   scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
    #                       
    #                       limits = c(0.2, 1), # before limit to 0.5
    #                       breaks = c(0.5, 0.75, 1),
    #                       name = "Confidence") +
    #   theme(axis.text.x = element_text(angle = -90, face = "bold"), 
    #         legend.position = "top")
    # 
    # plot_confidence <- 
    #   cluster_memberships[[g_dataset_id]] %>%
    #   mutate(cluster = as.character(cluster)) %>% 
    #   inner_join(clustering_data %>% 
    #                filter(dataset_id == g_dataset_id)) %>% 
    #   filter(cluster %in% col_hclust$labels) %>% 
    #   mutate(cluster = factor(cluster, 
    #                           rev(col_hclust$labels[col_hclust$order]))) %>% 
    #   group_by(cluster) %>% 
    #   mutate(avg_membership = mean(membership)) %>% 
    #   ungroup() %>% 
    #   arrange(cluster) %>% 
    #   ggplot(aes( membership,cluster,  fill = avg_membership)) + 
    #   geom_violin(draw_quantiles = 0.5, scale = "width") +
    #   theme_minimal() + 
    #   theme( axis.text.y = element_blank(),
    #          axis.title.y = element_blank()) +
    #   scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
    #                       limits = c(0.2, 1), # before limit to 0.5
    #                       breaks = c(0.5, 0.75, 1),
    #                       name = "avg_membership") +
    #   theme(legend.position = "top")
    # 
    # plot_avg_tau <- 
    #   ann %>%
    #   filter(cluster %in% row_hclust$labels) %>% 
    #   mutate(cluster = factor(cluster, 
    #                           rev(col_hclust$labels[col_hclust$order]))) %>% 
    #   ggplot(aes("Confidence", cluster, fill = avg_tau )) + 
    #   geom_tile_rast() +
    #   theme_void() +
    #   scale_fill_gradient(low = "#ABD0AD", high = "#17491A",
    #                       limits = c(0.2, 1), # before limit to 0.5
    #                       breaks = c(0.5, 0.75, 1),
    #                       name = "Tau") +
    #   theme(axis.text.x = element_text(angle = -90, face = "bold"), 
    #         legend.position = "left")
    # 
    # 
    plot_tau <-
      all_tau %>%
      filter(dataset_id == g_dataset_id) %>%
      left_join(ann) %>% 
      filter(annotation %in% row_hclust$labels) %>%
      mutate(annotation = factor(annotation,
                              rev(row_hclust$labels[row_hclust$order]))) %>%
      group_by(annotation) %>%
      mutate(avg_tau = mean(tau_score)) %>%
      ungroup() %>%
      arrange(annotation) %>%
      ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
      geom_violin(draw_quantiles = 0.5, scale = "width") +
      theme_minimal() +
      theme( axis.text.y = element_blank(),
             axis.title.y = element_blank()) +
     # scale_fill_gradient(low = "#FEDEBE", high = "#B84A00",
     #                     limits = c(0.4, 1), # before limit to 0.5
       #                   breaks = c(0.5, 0.75, 1),
         #                 name = "avg_tau") +
      theme(legend.position = "top")


    plot_heat_zscore <- 
      plot_data %>% 
      ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
      geom_tile_rast() +
      scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                           name = "Z-score") +
      theme_void() +
      theme(axis.text.x = element_text(angle = -90,
                                       hjust = 0, 
                                       size = 6),
            legend.position = "top")
    
    
    # plot_dendrogram + plot_cluster + plot_heat_zscore + plot_confidence + plot_tau +
    #   plot_layout(widths = c(1,0.5,3,1,1), nrow = 1)
    # 
    
    plot <- 
      plot_dendrogram + plot_cluster + plot_heat_zscore+plot_tau +
      plot_layout(widths = c(1,0.5,5, 2), nrow = 1)
  ggsave(savepath(paste(g_dataset_id, "heatmap.pdf", sep = "_")))  
    
  })

##############

ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-full_annotation) 
  
clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(sample, avg_value_zscore) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")

ggdendrogram(row_hclust, rotate = T, size = 2) + 
  coord_flip()


dhc <- as.dendrogram(model)
# Rectangular lines
d <- dendro_data(row_hclust, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
  coord_flip() + 
  scale_y_reverse(expand = c(0.2, 0)) +
  theme_dendro()



plot_cluster <- 
  ann  %>% 
  arrange(as.numeric(cluster)) %>% 
  mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(ann$cluster)))) %>% 
  ungroup() %>% 
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order])))   %>% 
  arrange(cluster) %>% 
  ggplot(aes("Cluster", annotation, fill = cluster_color)) + 
  geom_tile_rast(color = "white") +
  theme_void() +
  scale_fill_identity() +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "left",
        axis.text.y = element_text(size = 6, hjust = 1)) +
  coord_equal()
  

plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order])),
         sample = factor(sample, 
                         row_hclust$labels[row_hclust$order])) 

plot_avg_confidence <- 
  annotation %>%
  #filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% col_hclust$labels) %>% 
  #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order]))) %>% 
  ggplot(aes("Confidence", cluster, fill = avg_membership)) + 
  geom_tile_rast() +
  theme_void() +
  scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
                      
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "Confidence") +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "top")

plot_confidence <- 
  cluster_memberships[[g_dataset_id]] %>%
  mutate(cluster = as.character(cluster)) %>% 
  inner_join(clustering_data %>% 
                 filter(dataset_id == g_dataset_id)) %>% 
  filter(cluster %in% col_hclust$labels) %>% 
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order]))) %>% 
  group_by(cluster) %>% 
  mutate(avg_membership = mean(membership)) %>% 
  ungroup() %>% 
  arrange(cluster) %>% 
  ggplot(aes( membership,cluster,  fill = avg_membership)) + 
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_minimal() + 
  theme( axis.text.y = element_blank(),
  axis.title.y = element_blank()) +
  scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "avg_membership") +
    theme(legend.position = "top")
plot_avg_tau <- 
  ann %>%
  #filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% row_hclust$labels) %>% 
  #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order]))) %>% 
  ggplot(aes("Confidence", cluster, fill = avg_tau )) + 
  geom_tile_rast() +
  theme_void() +
  scale_fill_gradient(low = "#ABD0AD", high = "#17491A",
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "Tau") +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "left")


plot_tau <- 
  all_tau %>% 
  filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% col_hclust$labels) %>% 
  mutate(cluster = factor(cluster, 
                          rev(col_hclust$labels[col_hclust$order]))) %>% 
  group_by(cluster) %>% 
  mutate(avg_tau = mean(tau_score)) %>% 
  ungroup() %>% 
  arrange(cluster) %>% 
  ggplot(aes( tau_score,cluster,  fill = avg_tau)) + 
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_minimal() + 
  theme( axis.text.y = element_blank(),
         axis.title.y = element_blank()) +
  scale_fill_gradient(low = "#FEDEBE", high = "#B84A00",
                      limits = c(0.4, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "avg_tau") +
  theme(legend.position = "top")


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
  geom_tile_rast() +
  scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                       name = "Z-score") +
  theme_void() +
  theme(axis.text.x = element_text(angle = -90,
                                   hjust = 0, 
                                   size = 6),
        legend.position = "top")


# column_width <- (1/53)
# plot_n <- length(sample_hclust$labels)
# plot_scaling_factor <- column_width * plot_n
# 
# plot_widths <- 
#   c(3, 2,  plot_n) %>% 
#   {. * column_width} %>% 
#   {. / max(.)}


plot_dendrogram + plot_cluster + plot_heat_zscore + plot_confidence + plot_tau +
  plot_layout(widths = c(1,0.5,3,1,1), nrow = 1)


```


## Heatmap - extended v2
```{r}

g_heatmap_type <- "consensus"

heatmap_data_scaled_cluster %>% 
  filter(type == "consensus",
         dataset_id != "brain") %>% 
  #dataset_id == "singlecell") %>% 
  group_by(dataset_id) %>% 
  do({
    dat <- .
    
    dat <- 
      heatmap_data_scaled_cluster %>% 
  filter(type == "consensus",
         dataset_id == "singlecell") 
    
    g_dataset_id <- unique(dat$dataset_id)  
    
    
    ann <- 
      cluster_annotation %>% 
      filter(dataset_id == g_dataset_id) %>% 
      select(cluster, full_annotation) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep = "_"))
    
    clustered_genes <- 
      clustering_data %>% 
      filter(dataset_id == g_dataset_id) %>% 
      pull(gene)
    
    g_cluster_data <- 
      heatmap_data_scaled_cluster %>% 
      filter(dataset_id == g_dataset_id,
             type == g_heatmap_type) %>% 
      filter(ensg_id %in% clustered_genes) %>% 
      na.omit()
    
    
    g_cluster_data_wide <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      distinct() %>% 
      spread(sample, avg_value_zscore) %>% 
      left_join(cluster_annotation %>% 
                  filter(dataset_id == g_dataset_id) %>% 
                  select(cluster, full_annotation)) %>% 
      mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
      select(-cluster, - full_annotation) %>% 
      column_to_rownames("a") 
    
    
    row_hclust <- 
      g_cluster_data_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    col_hclust <- 
      g_cluster_data_wide %>%
      t() %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    
    d <- dendro_data(row_hclust, type = "rectangle")
    
    plot_dendrogram <- 
      ggplot(segment(d)) + 
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
      #coord_flip() + 
      scale_y_continuous(expand = expansion(0)) + #c(0.2, 0)) +
      scale_x_reverse(expand = expansion(c(0.01,0.02))) +
      theme_dendro()
    
    plot_cluster <- 
      ann  %>% 
      arrange(as.numeric(cluster)) %>% 
      mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(ann$cluster)))) %>% 
      ungroup() %>% 
      mutate(annotation = factor(annotation, 
                                 levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
      arrange(annotation) %>% 
      ggplot(aes("Cluster", x = annotation, fill = cluster_color, label = full_annotation)) + 
      geom_tile_rast(color = "white", show.legend = F) +
      theme_void() +
      geom_text(aes(label=cluster), size = 2, color = "white") +
      scale_fill_identity() +
      #theme(#axis.text.x = element_text(angle = -90), 
      #     legend.position = "top",
      #    axis.text.x = element_text(size = 6, hjust = 0.5, angle = -90)
      #   ) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0))  +
      scale_x_discrete(expand = expansion(c(0,0.015)))
    
    
    
    plot_sample <-
      tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                              levels = (col_hclust$labels[col_hclust$order]))) %>% 
      arrange(samples) %>% 
      ggplot(aes("Sample", y = samples, fill = samples, label = samples)) + 
      geom_tile_rast(color = "white", show.legend = F) +
      theme_void() +
      #geom_text(size = 2, color = "white") +
      scale_fill_manual(values = colors_consensus %>% 
                          filter(dataset_id == g_dataset_id) %>% 
                          select(-dataset_id) %>%  
                          deframe()) +
      theme(#axis.text.x = element_text(angle = -90), 
        legend.position = "top",
        axis.text.y = element_text(size = 6, hjust = 0.5)
      ) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0)) 
    
    plot_data <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      left_join(ann %>% 
                  select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(cluster = factor(annotation, 
                              rev(row_hclust$labels[row_hclust$order])),
             sample = factor(sample, 
                             col_hclust$labels[col_hclust$order])) %>% 
      select(-annotation)
    
    plot_tau <-
      all_tau %>%
      filter(dataset_id == g_dataset_id) %>%
      left_join(ann) %>% 
      filter(annotation %in% row_hclust$labels) %>%
      mutate(annotation = factor(annotation,
                                 rev(row_hclust$labels[row_hclust$order]))) %>%
      group_by(annotation) %>%
      mutate(avg_tau = mean(tau_score)) %>%
      ungroup() %>%
      arrange(annotation) %>%
      ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
      geom_violin(draw_quantiles = 0.5, scale = "width") +
      theme_minimal() +
      theme(axis.text.x = element_blank(),
            axis.title.x = element_blank()) +
      # theme( axis.text.y = element_blank(),
      #        axis.title.y = element_blank()) +
      coord_flip() +
      theme(legend.position = "right") +
      scale_fill_viridis_c() +
      scale_y_discrete(expand = expansion(c(0,0.02))) +
      scale_x_continuous(expand = expansion(0)) +
      xlab("Tau score")
    
    
    
    plot_heat_zscore <- 
      plot_data %>% 
      ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
      geom_tile_rast() +
      scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                           name = "Z-score") +
      theme_void() +
      theme(axis.text.x = element_text(angle = -90,
                                       hjust = 0.5, 
                                       size = 6),
            legend.position = "right") +
      coord_flip()
    
    
    dat <- 
      gene_classification %>% 
      mutate(id = gsub("specificity_","",id)) %>% 
      rename(dataset_id = id)%>% 
      select(dataset_id, ensg_id, specificity_category) %>% 
      inner_join(clustering_data %>% 
                   rename(ensg_id = gene)) %>% 
      filter(dataset_id != "brain") %>% 
      group_by(dataset_id, cluster, specificity_category) %>% 
      summarise(n = n_distinct(ensg_id)) %>% 
      mutate(cluster = as.numeric(cluster),
             specificity_category = factor(specificity_category, 
                                           levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 
    
    
    
    sp_plot <- 
      dat %>% 
      filter(dataset_id == g_dataset_id) %>%
      mutate(cluster = as.character(cluster)) %>% 
      left_join(ann %>% 
                  select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(cluster = factor(annotation, 
                              rev(row_hclust$labels[row_hclust$order]))) %>% 
      ggplot(aes(fill= specificity_category, y=n, x=cluster)) + 
      geom_bar(position="fill", stat="identity")+
      scale_fill_manual(values = gene_category_pal) +
      theme_minimal()+
      theme(axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "right") +
      scale_x_discrete(expand = expansion(c(0,0.02))) +
      scale_y_continuous(expand = expansion(0)) +
      ylab("Proportion")
    
    
    
    
    # plot <- 
    heat <- plot_heat_zscore + plot_sample
    
    plot_dendrogram / plot_cluster / heat / plot_tau / sp_plot +
      plot_layout(heights = c(1,0.5,9, 2, 2), nrow = 5, 
                  guides = 'collect' )
    
    
    
    
    
    
    ggsave(savepath(paste(g_dataset_id, "heatmap_sp_test.pdf", sep = "_")))  
    
  })

#########

theme_tracks <- 
  theme_classic() +
  theme(#axis.line.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "right")


#Alternative annottion
heatmap_data_scaled_cluster %>% 
  filter(type == "consensus",
         dataset_id != "brain") %>% 
  # dataset_id == "singlecell") %>% 
  group_by(dataset_id) %>% 
  do({
    
    dat <- heatmap_data_scaled_cluster %>%
      filter(type == "consensus",
             dataset_id == "tissue")
    dat <- .
    
    g_dataset_id <- unique(dat$dataset_id)  
    
    
    ann <- 
      cluster_annotation %>% 
      filter(dataset_id == g_dataset_id) %>% 
      select(cluster, full_annotation) %>% 
      mutate(annotation = paste(cluster, full_annotation, sep = "_"))
    
    clustered_genes <- 
      clustering_data %>% 
      filter(dataset_id == g_dataset_id) %>% 
      pull(gene)
    
    g_cluster_data <- 
      heatmap_data_scaled_cluster %>% 
      filter(dataset_id == g_dataset_id,
             type == g_heatmap_type) %>% 
      filter(ensg_id %in% clustered_genes) %>% 
      na.omit()
    
    
    g_cluster_data_wide <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      distinct() %>% 
      spread(sample, avg_value_zscore) %>% 
      left_join(cluster_annotation %>% 
                  filter(dataset_id == g_dataset_id) %>% 
                  select(cluster, full_annotation)) %>% 
      mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
      select(-cluster, - full_annotation) %>% 
      column_to_rownames("a") 
    
    
    row_hclust <- 
      g_cluster_data_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    col_hclust <- 
      g_cluster_data_wide %>%
      t() %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    
    d <- dendro_data(row_hclust, type = "rectangle")
    
    plot_dendrogram <- 
      ggplot(segment(d)) + 
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend), size = 0.3) + 
      #coord_flip() + 
      scale_y_continuous(expand = expansion(0)) + #c(0.2, 0)) +
      scale_x_reverse(expand = expansion(c(0.01,0.02))) +
      theme_dendro()
    
    # to_plot_cluster <- 
    #   cluster_annotation %>% 
    #   filter(dataset_id == g_dataset_id) %>% 
    #   #select(cluster,Specificity,Function) %>% 
    #   mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
    #   arrange(as.numeric(cluster)) %>% 
    #   mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(ann$cluster)))) %>%
    #   ungroup() %>% 
    #   mutate(annotation = factor(annotation, 
    #                              levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
    #   arrange(annotation) 
    
    to_plot_cluster <- 
      cluster_pal_sp %>% 
      rename(cluster_color = color) %>% 
      filter(dataset_id == g_dataset_id) %>% 
      select(cluster,Specificity,Function,cluster_color, full_annotation) %>% 
            mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
      mutate(annotation = factor(annotation, 
                                 levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
      arrange(annotation)
    
    plot_cluster_1 <- 
      to_plot_cluster %>% 
      ggplot(aes("Cluster", x = annotation, fill = cluster_color, label = full_annotation)) + 
      geom_tile_rast(color = "black", show.legend = F) +
      theme_void() +
      geom_text(aes(label=cluster, angle = 90), size = 1.5, color = "white") +
      scale_fill_identity() +
      #theme(#axis.text.x = element_text(angle = -90), 
      #     legend.position = "top",
      #    axis.text.x = element_text(size = 6, hjust = 0.5, angle = -90)
      #   ) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0))  +
      scale_x_discrete(expand = expansion(c(0,0.015)))+
      ylab("Cluster") +
      theme(axis.text.x = element_blank(),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            axis.ticks = element_blank(),
            axis.title.x.bottom = element_blank(),
            axis.title.y.left = element_blank())
    
    plot_cluster_2 <- 
      to_plot_cluster %>% 
      arrange(annotation) %>% 
      ggplot(aes("Specificity", x = annotation, label = Specificity)) + 
      geom_tile(color = "white", show.legend = F, fill = "grey80") +
      theme_void() +
      geom_text(aes(label=Specificity, angle = 90),  color = "black", size = 1.5) +
      scale_y_discrete(position = "left", expand = expansion(0))  +
      scale_x_discrete(expand = expansion(c(0,0.015))) #+
    # ylab("Specificity") +
    # theme(axis.text.x = element_blank(),
    #       panel.grid.major = element_blank(),
    #       panel.grid.minor = element_blank(),
    #       axis.ticks = element_blank(),
    #       axis.title.x.bottom = element_blank(),
    #       axis.title.y.left = element_blank())
    
    plot_cluster_3 <- 
      to_plot_cluster %>% 
      arrange(annotation) %>% 
      ggplot(aes("Function", x = annotation, label = Function)) + 
      geom_tile(color = "white", show.legend = F, fill = "grey80") +
      theme_void() +
      geom_text(aes(label=Function, angle = 90), size = 1.5, color = "black") +
      scale_y_discrete(position = "right", expand = expansion(0))  +
      scale_x_discrete(expand = expansion(c(0,0.015))) #+
    # ylab("Function") +
    # theme(axis.text.x = element_blank(),
    #       panel.grid.major = element_blank(),
    #       panel.grid.minor = element_blank(),
    #       axis.ticks = element_blank(),
    #       axis.title.x.bottom = element_blank(),
    #       axis.title.y.left = element_blank())
    
    #plot_cluster_1 / plot_cluster_2 / plot_cluster_3
    
    plot_sample <-
      tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                              levels = (col_hclust$labels[col_hclust$order]))) %>% 
      arrange(samples) %>% 
      ggplot(aes("Sample", y = samples, fill = samples, label = samples)) + 
      geom_tile_rast(color = "black", show.legend = F) +
      theme_void() +
      #geom_text(size = 2, color = "white") +
      scale_fill_manual(values = colors_consensus %>% 
                          filter(dataset_id == g_dataset_id) %>% 
                          select(-dataset_id) %>%  
                          deframe()) +
      theme(#axis.text.x = element_text(angle = -90), 
        legend.position = "top",
        axis.text.y = element_text(size = 4.5, hjust = 0)
      ) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0)) 
    
    plot_data <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      left_join(ann %>% 
                  select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(cluster = factor(annotation, 
                              rev(row_hclust$labels[row_hclust$order])),
             sample = factor(sample, 
                             col_hclust$labels[col_hclust$order])) %>% 
      select(-annotation)
    
    plot_tau <-
      consensus_tau %>%
      left_join(clustering_data) %>% 
      left_join(cluster_annotation) %>% 
      filter(dataset_id == g_dataset_id) %>%
      left_join(ann) %>% 
      filter(annotation %in% row_hclust$labels) %>%
      mutate(annotation = factor(annotation,
                                 rev(row_hclust$labels[row_hclust$order]))) %>%
      group_by(annotation) %>%
      mutate(avg_tau = mean(tau_score)) %>%
      ungroup() %>%
      arrange(annotation) %>%
      ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
      geom_violin(draw_quantiles = 0.5, scale = "width") +
      theme_tracks +
      coord_flip() +
      scale_fill_viridis_c(begin = 1, end = 0) +
      scale_y_discrete(expand = expansion(c(0,0.02))) +
      scale_x_continuous(expand = expansion(0)) +
      xlab("Tau score")
    
    
    
    plot_heat_zscore <- 
      plot_data %>% 
      ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
      geom_tile_rast() +
      scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                           name = "Z-score") +
      theme_void() +
      theme(axis.text.x = element_blank(),
            legend.position = "right") +
      coord_flip()
    
    
    dat_sp <- 
      gene_classification %>% 
      mutate(id = gsub("specificity_","",id)) %>% 
      rename(dataset_id = id)%>% 
      select(dataset_id, ensg_id, specificity_category) %>% 
      inner_join(clustering_data %>% 
                   rename(ensg_id = gene)) %>% 
      filter(dataset_id != "brain") %>% 
      group_by(dataset_id, cluster, specificity_category) %>% 
      summarise(n = n_distinct(ensg_id)) %>% 
      mutate(cluster = as.numeric(cluster),
             specificity_category = factor(specificity_category, 
                                           levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 
    
    
    
    sp_plot <- 
      dat_sp %>% 
      filter(dataset_id == g_dataset_id) %>%
      mutate(cluster = as.character(cluster)) %>% 
      left_join(ann %>% 
                  select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(cluster = factor(annotation, 
                              rev(row_hclust$labels[row_hclust$order]))) %>% 
      ggplot(aes(fill= specificity_category, y=n, x=cluster)) + 
      geom_bar(position="fill", stat="identity")+
      scale_fill_manual(values = gene_category_pal) +
      theme_tracks +
      scale_x_discrete(expand = expansion(c(0,0.02))) +
      scale_y_continuous(expand = expansion(0)) +
      ylab("Proportion")
    
    n_genes <- 
      clustering_data %>% 
      filter(dataset_id == g_dataset_id) %>% 
      group_by(cluster) %>% 
      summarise(n_genes = n_distinct(gene))   %>%
      left_join(ann) %>% 
      filter(annotation %in% row_hclust$labels) %>%
      mutate(annotation = factor(annotation,
                                 rev(row_hclust$labels[row_hclust$order]))) %>% 
      arrange(annotation) %>% 
      ggplot(aes(annotation,n_genes)) +
      geom_bar(stat = "identity")+
      theme_tracks 
    
    
    # plot <- 
    heat <- plot_heat_zscore + plot_sample
    
    # 
    plot_cluster <-
      plot_cluster_1 / plot_cluster_2 / plot_cluster_3 +
      plot_layout(heights = c(0.25,1.2,1.2))

    
#    a <- 
      plot_dendrogram / heat / plot_cluster / n_genes / sp_plot / plot_tau +
      plot_layout(heights = c(1,9,3,1, 1, 1), nrow = 6, 
                  guides = 'collect' )
    
    
    ggsave(savepath(paste(g_dataset_id, "complete_heatmap.pdf", sep = "_")),
           height = 10,
           width = 10)  
    
  })


```


### Fig 5
```{r}

theme_tracks <- 
  theme_classic() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "right")

dat <- 
  heatmap_data_scaled_cluster %>%
  filter(type == "consensus",
         dataset_id == "singlecell")

g_dataset_id <- unique(dat$dataset_id)  

g_heatmap_type <- "consensus"

ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  group_by(dataset_id, ensg_id) %>% 
  mutate(value_max_scale = value / max(value, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(dataset_id,sample,cluster) %>% 
  mutate(avg_value_max_scale = mean(value_max_scale)) %>% 
  ungroup() %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_max_scale) %>% 
  distinct() %>% 
  spread(sample, avg_value_max_scale) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")


d <- dendro_data(row_hclust, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), size = 0.3) + 
  #coord_flip() + 
  scale_y_reverse(expand = expansion(0)) + #c(0.2, 0)) +
  scale_x_reverse(expand = expansion(0,c(0,1))) +
  theme_dendro()

to_plot_cluster <- 
  cluster_pal_sp %>% 
  rename(cluster_color = color) %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster,Specificity,Function,cluster_color, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  mutate(annotation = factor(annotation, 
                             levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
  arrange(annotation)

# plot_cluster_1 <- 
#   to_plot_cluster %>% 
#   ggplot(aes("Cluster", x = annotation, fill = cluster_color, label = full_annotation)) + 
#   geom_tile_rast(color = "black", show.legend = F) +
#   theme_void() +
#   geom_text(aes(label=cluster, angle = 0), size = 1.75, color = "white") +
#   scale_fill_identity() +
#   #theme(#axis.text.x = element_text(angle = -90), 
#   #     legend.position = "top",
#   #    axis.text.x = element_text(size = 6, hjust = 0.5, angle = -90)
#   #   ) +
#   coord_equal() +
#   scale_y_discrete(position = "right", expand = expansion(0))  +
#   scale_x_discrete(expand = expansion(0, c(0,1)))+
#   ylab("Cluster") +
#   theme(axis.text.x = element_blank(),
#         panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.ticks = element_blank(),
#         axis.title.x.bottom = element_blank(),
#         axis.title.y.left = element_blank())

plot_cluster_1 <- 
  to_plot_cluster %>% 
  ggplot(aes(x = annotation, 1, fill = cluster_color, label = full_annotation)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  geom_text(aes(y = 0.5, label=cluster, angle = 0), size = 1.75, color = "black",
            angle = 90,
            hjust = 0) +
  # geom_text(data = . %>% 
  #             mutate(y = 1 + rnorm(nrow(.), sd = 0.1)),
  #           aes(y = y, label=cluster, angle = 0), size = 1.75, color = "white") +
  scale_fill_identity() +
  #theme(#axis.text.x = element_text(angle = -90), 
  #     legend.position = "top",
  #    axis.text.x = element_text(size = 6, hjust = 0.5, angle = -90)
  #   ) +
  coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0, c(0,1)))+
  ylab("Cluster") +
  theme(axis.text.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x.bottom = element_blank(),
        axis.title.y.left = element_blank())

plot_cluster_2 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Specificity", x = annotation, label = Specificity)) + 
  geom_tile(color = "white", show.legend = F, fill = "#EEEBEB") +
  theme_void() +
  geom_text(aes(label=Specificity, angle = 90),  color = "black", size = 1.75) +
  scale_y_discrete(position = "left", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0, c(0,1))) 


plot_cluster_3 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Function", x = annotation, label = Function)) + 
  geom_tile(color = "white", show.legend = F, fill = "#EEEBEB") +
  theme_void() +
  geom_text(aes(label=Function, angle = 90), size = 1.75, color = "black") +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0,c(0,1))) 

plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_max_scale) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order])),
         sample = factor(sample, 
                         col_hclust$labels[col_hclust$order])) %>% 
  select(-annotation)

plot_tau <-
  gene_consensus_tau %>%
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == g_dataset_id) %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust$labels) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust$labels[row_hclust$order]))) %>%
  group_by(annotation) %>%
  mutate(avg_tau = mean(tau_score)) %>%
  ungroup() %>%
  arrange(annotation) %>%
  ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_tracks +
  coord_flip() +
  scale_fill_viridis_c(begin = 1, end = 0) +
  scale_y_discrete(expand = expansion(0, c(0,1))) +
  scale_x_continuous(expand = expansion(0)) +
  xlab("Tau score")
###

max_clusters <-
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  nrow()

plot_samples_data <- 
  tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                          levels = (col_hclust$labels[col_hclust$order]))) %>% 
  arrange(samples) %>% 
  mutate(y = unclass(samples),
         x = max_clusters+1,
         xmin = x - 0.5,
         xmax = x + 0.5,
         ymin = y - 0.5, 
         ymax = y + 0.5) %>% 
         # x = number_of_clusters + 1)
  left_join(colors_consensus %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(-dataset_id),
            by = c("samples" = "sample"))
###
plot_sample <-
  tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                          levels = (col_hclust$labels[col_hclust$order]))) %>% 
  arrange(samples) %>% 
  ggplot(aes("Sample", y = samples, fill = samples, label = samples)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  #geom_text(size = 2, color = "white") +
  scale_fill_manual(values = colors_consensus %>% 
                      filter(dataset_id == g_dataset_id) %>% 
                      select(-dataset_id) %>%  
                      deframe()) +
  theme(#axis.text.x = element_text(angle = -90), 
    legend.position = "top",
    axis.text.y = element_text(size = 4.5, hjust = 0)
  ) +
  #coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0, c(0,1))) 


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(cluster, sample, fill = avg_value_max_scale)) +
  geom_tile_rast() +
  geom_rect(data = plot_samples_data,
            ymin = plot_samples_data$ymin,
            ymax = plot_samples_data$ymax,
            xmin = plot_samples_data$xmin,
            xmax = plot_samples_data$xmax,
            fill = plot_samples_data$color,
            color = "black",
            inherit.aes = F) +
    # geom_text(data = plot_samples_data,
    #           aes(y = x+3,
    #               x = y,
    #               label = samples),
    #           inherit.aes = F,
    #           size = 2,
    #           vjust = 0,
    #           hjust = 0) +
    scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                         name = "Scaled expression") +
    scale_x_discrete(expand = expansion(0, c(0,1))) +
    scale_y_discrete(expand = expansion(0, c(0,1)), 
                     position = "right") +
    theme_void() +
    theme(axis.text.y = element_text(#position = "right",
                                     size = 5,
                                     vjust = 0.5, 
                                     hjust = 0),
          legend.position = "right") #+
  #  coord_flip()

  #plot_heat_zscore

dat_sp <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 



sp_plot <- 
  dat_sp %>% 
  filter(dataset_id == g_dataset_id) %>%
  mutate(cluster = as.character(cluster)) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order]))) %>% 
  ggplot(aes(fill= specificity_category, y=n, x=cluster)) + 
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = gene_category_pal) +
  theme_tracks +
  scale_x_discrete(expand = expansion(0,c(0,1))) +
  scale_y_continuous(expand = expansion(0)) +
  ylab("Proportion")

n_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  group_by(cluster) %>% 
  summarise(n_genes = n_distinct(gene))   %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust$labels) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust$labels[row_hclust$order]))) %>% 
  arrange(annotation) %>% 
  ggplot(aes(annotation,n_genes)) +
  geom_bar(stat = "identity")+
  theme_tracks +
  scale_x_discrete(expand = expansion(0,c(0,1))) 


# plot <- 
heat <- plot_heat_zscore 

# 
plot_cluster <-
  plot_cluster_1 / plot_cluster_2 / plot_cluster_3 +
  plot_layout(heights = c(0.25,1.2,1.2))


#    a <- 
plot_cluster_1 / n_genes / plot_tau / sp_plot / plot_cluster_2 / plot_cluster_3 / heat / plot_dendrogram +
  plot_layout(heights = c(1, 1, 1, 1, 2, 2, 9, 1), nrow = 8, 
              guides = 'collect' )

#plot_dendrogram / heat / plot_cluster / n_genes / sp_plot / plot_tau 

ggsave(savepath(paste(g_dataset_id, "complete_heatmap.pdf", sep = "_")),
       height = 10,
       width = 10)  



```

### Fig 5 - tissue
```{r}

theme_tracks <- 
  theme_classic() +
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank(),
            axis.title.x = element_blank(),
            legend.position = "right")

dat <- 
  heatmap_data_scaled_cluster %>%
  filter(type == "consensus",
         dataset_id == "tissue")

g_dataset_id <- unique(dat$dataset_id)  

g_heatmap_type <- "consensus"

ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  group_by(dataset_id, ensg_id) %>% 
  mutate(value_max_scale = value / max(value, na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(dataset_id,sample,cluster) %>% 
  mutate(avg_value_max_scale = mean(value_max_scale)) %>% 
  ungroup() %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_max_scale) %>% 
  distinct() %>% 
  spread(sample, avg_value_max_scale) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")


d <- dendro_data(row_hclust, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), size = 0.3) + 
  #coord_flip() + 
  scale_y_reverse(expand = expansion(0)) + #c(0.2, 0)) +
  scale_x_reverse(expand = expansion(0,c(0,1))) +
  theme_dendro()

to_plot_cluster <- 
  cluster_pal_sp %>% 
  rename(cluster_color = color) %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster,Specificity,Function,cluster_color, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  mutate(annotation = factor(annotation, 
                             levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
  arrange(annotation)

plot_cluster_1 <- 
  to_plot_cluster %>% 
  ggplot(aes(x = annotation, 1, fill = cluster_color, label = full_annotation)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  geom_text(aes(y = 0.5, label=cluster, angle = 0), size = 1.75, color = "black",
            angle = 90,
            hjust = 0) +
  # geom_text(data = . %>% 
  #             mutate(y = 1 + rnorm(nrow(.), sd = 0.1)),
  #           aes(y = y, label=cluster, angle = 0), size = 1.75, color = "white") +
  scale_fill_identity() +
  #theme(#axis.text.x = element_text(angle = -90), 
  #     legend.position = "top",
  #    axis.text.x = element_text(size = 6, hjust = 0.5, angle = -90)
  #   ) +
  coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0, c(0,1)))+
  ylab("Cluster") +
  theme(axis.text.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x.bottom = element_blank(),
        axis.title.y.left = element_blank())

plot_cluster_2 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Specificity", x = annotation, label = Specificity)) + 
  geom_tile(color = "white", show.legend = F, fill = "#EEEBEB") +
  theme_void() +
  geom_text(aes(label=Specificity, angle = 90),  color = "black", size = 1.75) +
  scale_y_discrete(position = "left", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0, c(0,1))) 


plot_cluster_3 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Function", x = annotation, label = Function)) + 
  geom_tile(color = "white", show.legend = F, fill = "#EEEBEB") +
  theme_void() +
  geom_text(aes(label=Function, angle = 90), size = 1.75, color = "black") +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(0,c(0,1))) 

plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_max_scale) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order])),
         sample = factor(sample, 
                         col_hclust$labels[col_hclust$order])) %>% 
  select(-annotation)

plot_tau <-
  gene_consensus_tau %>%
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == g_dataset_id) %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust$labels) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust$labels[row_hclust$order]))) %>%
  group_by(annotation) %>%
  mutate(avg_tau = mean(tau_score)) %>%
  ungroup() %>%
  arrange(annotation) %>%
  ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_tracks +
  coord_flip() +
  scale_fill_viridis_c(begin = 1, end = 0) +
  scale_y_discrete(expand = expansion(0, c(0,1))) +
  scale_x_continuous(expand = expansion(0)) +
  xlab("Tau score")
###

max_clusters <-
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  nrow()

plot_samples_data <- 
  tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                          levels = (col_hclust$labels[col_hclust$order]))) %>% 
  arrange(samples) %>% 
  mutate(y = unclass(samples),
         x = max_clusters+1,
         xmin = x - 0.5,
         xmax = x + 0.5,
         ymin = y - 0.5, 
         ymax = y + 0.5) %>% 
         # x = number_of_clusters + 1)
  left_join(colors_consensus %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(-dataset_id),
            by = c("samples" = "sample"))
###
plot_sample <-
  tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                          levels = (col_hclust$labels[col_hclust$order]))) %>% 
  arrange(samples) %>% 
  ggplot(aes("Sample", y = samples, fill = samples, label = samples)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  #geom_text(size = 2, color = "white") +
  scale_fill_manual(values = colors_consensus %>% 
                      filter(dataset_id == g_dataset_id) %>% 
                      select(-dataset_id) %>%  
                      deframe()) +
  theme(#axis.text.x = element_text(angle = -90), 
    legend.position = "top",
    axis.text.y = element_text(size = 4.5, hjust = 0)
  ) +
  #coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0, c(0,1))) 


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(cluster, sample, fill = avg_value_max_scale)) +
  geom_tile_rast() +
  geom_rect(data = plot_samples_data,
            ymin = plot_samples_data$ymin,
            ymax = plot_samples_data$ymax,
            xmin = plot_samples_data$xmin,
            xmax = plot_samples_data$xmax,
            fill = plot_samples_data$color,
            color = "black",
            inherit.aes = F) +
    # geom_text(data = plot_samples_data,
    #           aes(y = x+3,
    #               x = y,
    #               label = samples),
    #           inherit.aes = F,
    #           size = 2,
    #           vjust = 0,
    #           hjust = 0) +
    scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                         name = "Scaled expression") +
    scale_x_discrete(expand = expansion(0, c(0,1))) +
    scale_y_discrete(expand = expansion(0, c(0,1)), 
                     position = "right") +
    theme_void() +
    theme(axis.text.y = element_text(#position = "right",
                                     size = 5,
                                     vjust = 0.5, 
                                     hjust = 0),
          legend.position = "right") #+
  #  coord_flip()

  #plot_heat_zscore

dat_sp <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 



sp_plot <- 
  dat_sp %>% 
  filter(dataset_id == g_dataset_id) %>%
  mutate(cluster = as.character(cluster)) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order]))) %>% 
  ggplot(aes(fill= specificity_category, y=n, x=cluster)) + 
  geom_bar(position="fill", stat="identity")+
  scale_fill_manual(values = gene_category_pal) +
  theme_tracks +
  scale_x_discrete(expand = expansion(0,c(0,1))) +
  scale_y_continuous(expand = expansion(0)) +
  ylab("Proportion")

n_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  group_by(cluster) %>% 
  summarise(n_genes = n_distinct(gene))   %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust$labels) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust$labels[row_hclust$order]))) %>% 
  arrange(annotation) %>% 
  ggplot(aes(annotation,n_genes)) +
  geom_bar(stat = "identity")+
  theme_tracks +
  scale_x_discrete(expand = expansion(0,c(0,1))) 


# plot <- 
heat <- plot_heat_zscore 

# 
plot_cluster <-
  plot_cluster_1 / plot_cluster_2 / plot_cluster_3 +
  plot_layout(heights = c(0.25,1.2,1.2))


#    a <- 

plot_cluster_1 / n_genes / plot_tau / sp_plot / plot_cluster_2 / plot_cluster_3 / heat / plot_dendrogram +
  plot_layout(heights = c(1, 1, 1, 1, 2, 2, 6, 1), nrow = 8, 
              guides = 'collect' )

plot_dendrogram / heat / plot_cluster / n_genes / sp_plot / plot_tau 

ggsave(savepath(paste(g_dataset_id, "complete_heatmap_3.pdf", sep = "_")),
       height = 10,
       width = 11)  



```

## SUMMARY EXPRESSION

```{r}
dat <- 
  heatmap_data_scaled_cluster %>% 
  filter(dataset_id == "singlecell",
         type == "consensus") %>%
  select(cluster, sample, avg_value_scaled) %>% 
  distinct() %>% 
  #arrange(cluster)
  group_by(cluster) %>% 
  mutate(total = sum(avg_value_scaled)) %>% 
  ungroup() %>% 
  mutate(avg_exp_contribution = avg_value_zscore / total * 100) %>% 
  arrange(-avg_exp_contribution) 
  

dat %>%   
  ggplot(aes(x = cluster, y = avg_exp_contribution, group = sample, fill = sample)) +
  geom_bar(position = "stack", stat = "identity",  color = "white", size = 0.2,
           show.legend = F) +
  coord_flip() +
  #geom_text(aes(label = cluster), data =. %>% filter(GeneFrac > 0.5), size = 2, color = "white")+
  #scale_fill_manual(values = pal) +
  theme_simple +
  theme(legend.position = "top")


#####


theme_tracks <- 
  theme_classic() +
  theme(axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(size = 6),
        legend.position = "top")

theme_tracks_2 <- 
  theme_classic() +
  theme(axis.title.y = element_blank(),
        axis.text.x = element_text(size = 6),
        legend.position = "top")



dat <- heatmap_data_scaled_cluster %>%
  filter(type == "consensus",
         dataset_id == "singlecell")

g_dataset_id <- unique(dat$dataset_id)  
g_heatmap_type <- "consensus"

ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()

g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(sample, avg_value_zscore) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 

row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")

g_cluster_data_wide <- 
  expression_data$singlecell_consensus %>%
  gather(sample, ntpm, -1) %>% 
  inner_join(clustering_data %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  group_by(ensg_id) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T),
         ntpm = ifelse(!is.finite(ntpm), 
                       0, 
                       ntpm)) %>% 
  group_by(cluster, sample) %>% 
  summarise(ntpm = mean(ntpm)) %>% 
  group_by(cluster) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T)) %>%
  arrange(cluster, -ntpm)  %>% 
  spread(sample, ntpm) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 

g_cluster_data_wide <- 
  expression_data$singlecell_consensus %>%
  gather(sample, ntpm, -1) %>% 
  inner_join(clustering_data %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  group_by(ensg_id) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T),
         ntpm = ifelse(!is.finite(ntpm), 
                       0, 
                       ntpm)) %>% 
  group_by(cluster, sample) %>% 
  summarise(ntpm = mean(ntpm)) %>% 
  group_by(cluster) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T)) %>%
  arrange(cluster, -ntpm) %>%
  left_join(cluster_annotation %>% 
              filter(dataset_id =="singlecell") %>% 
              mutate(ann = paste(cluster, full_annotation, sep = "_")) %>% 
              select(cluster,ann)) %>% 
  ungroup() %>% 
  select(-cluster) %>% 
  spread(sample,ntpm) %>% 
  column_to_rownames("ann")
  # left_join(consensus_palette %>% 
  #             enframe("sample", "color")) %>% 
  # ungroup() %>% 
  # mutate(id = paste(cluster, row_number())) %>% 
  # 
  # mutate(id = factor(id, id)) %>% 
  # cluster_long_data()

dendro_data <- 
  g_cluster_data_wide %>% 
  dist(method = "euclidean") %>% 
  hclust(method = "ward.D2")

row_hclust <- 
  dendro_data %>% 
  with(labels[order])

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist(method = "euclidean") %>% 
  hclust(method = "ward.D2") %>% 
  with(labels[order])

d <- dendro_data(dendro_data, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), size = 0.3) + 
  coord_flip() + 
  scale_y_reverse(expand = expansion(0)) + #c(0.2, 0)) +
  scale_x_continuous(expand = expansion(c(0.01,0.02))) +
  theme_dendro()

to_plot_cluster <- 
  cluster_pal_sp %>% 
  rename(cluster_color = color) %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster,Specificity,Function,cluster_color, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  mutate(annotation = factor(annotation, 
                             levels = rev(row_hclust)))   %>% 
  arrange(annotation)

# plot_cluster_1 <- 
#   to_plot_cluster %>% 
#   ggplot(aes(x ="Cluster", y = annotation, fill = cluster_color, label = full_annotation)) + 
#   geom_tile_rast(color = "black", show.legend = F) +
#   theme_void() +
#   geom_text(aes(label=cluster, angle = 90), size = 1.5, color = "white") +
#   scale_fill_identity() +
#   coord_equal() +
#   scale_y_discrete(position = "right", expand = expansion(0))  +
#   scale_x_discrete(expand = expansion(c(0,0.015)))+
#   ylab("Cluster") +
#   theme(axis.text.x = element_blank(),
#         panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         axis.ticks = element_blank(),
#         axis.title.x.bottom = element_blank(),
#         axis.title.y.left = element_blank())

# plot_cluster_2 <- 
#   to_plot_cluster %>% 
#   arrange(annotation) %>% 
#   ggplot(aes("Specificity", y = annotation, label = full_annotation)) + 
#   geom_tile(color = "white", show.legend = F, fill = "grey80") +
#   theme_void() +
#   geom_text(aes(label=full_annotation, angle = 0),  color = "black", size = 1.5) +
#   scale_x_discrete(position = "left", expand = expansion(0))  +
#   scale_y_discrete(expand = expansion(c(0,0.015)))

# plot_data <- 
#   g_cluster_data %>% 
#   select(cluster, sample, avg_value_zscore) %>% 
#   left_join(ann %>% 
#               select(-full_annotation)) %>% 
#   distinct() %>% 
#   mutate(cluster = factor(annotation, 
#                           rev(row_hclust$labels[row_hclust$order])),
#          sample = factor(sample, 
#                          col_hclust$labels[col_hclust$order])) %>% 
#   select(-annotation)

plot_tau <-
  gene_consensus_tau %>%
  left_join(clustering_data) %>% 
  left_join(cluster_annotation) %>%
  filter(!is.na(cluster)) %>% 
  filter(dataset_id == g_dataset_id) %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust))) %>%
  group_by(annotation) %>%
  mutate(avg_tau = mean(tau_score)) %>%
  ungroup() %>%
  arrange(annotation) %>%
  ggplot(aes( tau_score,annotation,  fill = avg_tau)) +
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_tracks +
#  coord_flip() +
  scale_fill_viridis_c(begin = 1, end = 0) +
  scale_y_discrete(expand = expansion(c(0,0.02))) +
  scale_x_continuous(expand = expansion(0)) +
  xlab("Tau score")



dat_sp <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 

sp_plot <- 
  dat_sp %>% 
  filter(dataset_id == g_dataset_id) %>%
  mutate(cluster = as.character(cluster)) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust))) %>% 
  ggplot(aes(fill= specificity_category, x=n, y=cluster)) + 
  geom_bar(position="fill", stat="identity", show.legend = F)+
  scale_fill_manual(values = gene_category_pal) +
  theme_tracks +
  scale_y_discrete(expand = expansion(c(0,0.02))) +
  scale_x_continuous(expand = expansion(0)) +
  ylab("Proportion")

n_genes_data <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  group_by(cluster) %>% 
  summarise(n_genes = n_distinct(gene))   %>%
  left_join(ann) %>% 
  filter(annotation %in% row_hclust) %>%
  mutate(annotation = factor(annotation,
                             rev(row_hclust))) %>% 
  arrange(annotation) 

n_genes <- 
  n_genes_data %>% 
  mutate(cluster = factor(cluster, levels = n_genes_data$cluster)) %>% 
  ggplot(aes(n_genes,cluster)) +
  geom_bar(stat = "identity")+
  theme_tracks_2
  # theme(panel.grid.major = element_blank(),
  #       panel.grid.minor = element_blank(),
  #       axis.title.x.bottom = element_blank(),
  #       axis.title.y.left = element_blank())

consensus_palette <- 
  colors_consensus %>% 
  select(sample, color) %>% 
  deframe()

plot_data <- 
  expression_data$singlecell_consensus %>%
  gather(sample, ntpm, -1) %>% 
  inner_join(clustering_data %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  group_by(ensg_id) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T),
         ntpm = ifelse(!is.finite(ntpm), 
                       0, 
                       ntpm)) %>% 
  group_by(cluster, sample) %>% 
  summarise(ntpm = mean(ntpm)) %>% 
  group_by(cluster) %>% 
  mutate(ntpm = ntpm / sum(ntpm, na.rm = T)) %>%
  arrange(cluster, -ntpm) %>% 
  left_join(consensus_palette %>% 
              enframe("sample", "color")) %>% 
  ungroup() %>% 
  mutate(id = paste(cluster, row_number())) %>% 

  mutate(id = factor(id, id)) %>% 
  cluster_long_data()

plot_exp <- 
  plot_data %>% 
  mutate(cluster = factor(cluster, levels = rev(levels(plot_data$cluster)))) %>% 
  ggplot(aes(ntpm, cluster, group = id, fill = color)) +
  geom_col(show.legend = F, 
           color = "white") +
  geom_text(data = . %>% 
              mutate(label = ifelse(ntpm > 0.1, 
                                    as.character(sample),
                                    NA)),
            aes(label = label),
            position = position_stack(vjust = 0.5),
            color = "white") +
  scale_fill_identity() +
  scale_x_continuous(expand = expansion(0)) +
 # scale_y_reverse()+
  theme_bw() +
  theme_tracks


(plot_dendrogram  | n_genes | plot_tau | sp_plot | plot_exp) +
  plot_layout(widths = c(1,1.5,1.5,1.5,7))

# (plot_dendrogram | plot_cluster_1 | plot_cluster_2 | plot_exp | plot_tau | sp_plot | n_genes) +
#   plot_layout(widths = c(1,1,2,5,2,2,2))

ggsave(savepath("cluster expression contribution plot.pdf"),
                width = 8, height = 10)

ggsave(savepath("cluster_summary.pdf"),
                width = 10, height = 12)

plot_tau
ggsave(savepath("tau_legend.pdf"))
```


```{r}

plot_dendrogram | plot_cluster_1  |plot_cluster_2 | plot_tau | sp_plot | n_genes 

plot_cluster <-
  plot_cluster_1 / plot_cluster_2 / plot_cluster_3 +
  plot_layout(heights = c(0.25,1.2,1.2))

plot_dendrogram / heat / plot_cluster / n_genes / sp_plot / plot_tau +
  plot_layout(heights = c(1,9,3,1, 1, 1), nrow = 6, 
              guides = 'collect' )
```

## Barplot - singlecell

```{r}

dat <- 
  heatmap_data_scaled_cluster %>% 
  filter(type == "consensus",
         dataset_id == "singlecell") 

g_dataset_id <- unique(dat$dataset_id)  


ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(sample, avg_value_zscore) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")

plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_scaled) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order])),
         sample = factor(sample, 
                         col_hclust$labels[col_hclust$order])) %>% 
  select(-annotation)


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
  geom_tile_rast() +
  scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                       name = "Z-score") +
  theme_void() +
  theme(axis.text.x = element_text(angle = -90,
                                   hjust = 0.5, 
                                   size = 6),
        legend.position = "right") +
  coord_flip()
```

# 4. Cluster integration - ORA
```{r}

# Format clustering results as database
database_terms <- 
  clustering_data  %>% 
  left_join(annotation_data %>% 
              group_by(dataset_id, cluster) %>% 
              summarise(annotation = paste(Specificity, Function, sep = " - "))) %>% 
  rename(id = dataset_id, 
         ensg_id = gene,
         term = annotation, 
         term_id = cluster)


# Perform overrepresentation analysis 
ora_file <- "data/processed/ORA_clusters_2.tsv"

worker_cluster <- new_cluster(n = 5)
cluster_library(worker_cluster, c("dplyr",
                                  "tidyverse"))
cluster_copy(worker_cluster, c("enricher"))


if(file.exists(ora_file)) {
  enrichment_data <- 
    read_tsv(ora_file)
  
} else {
  database_enrichment_res <- 
    database_terms %>% 
    group_by(id) %>% 
    do({
      # For each database
      database <- .
      
      term2gene <- 
        database %>% 
        select(term_id, ensg_id)
      
      cluster_copy(worker_cluster, c("term2gene"))
      
      # For 
      clustering_data %>% 
        group_by(dataset_id) %>% 
        
        do({
          g_clustering_data <- .
          
          g_clustering_data %>% 
            group_by(cluster) %>% 
            partition(worker_cluster) %>%
            do({
              g_data <- .
              
              pull(g_data, gene) %>% 
                enricher(maxGSSize = Inf, 
                         universe = unique(g_clustering_data$gene),
                         TERM2GENE = term2gene) %>% 
                as_tibble()
            }) %>% 
            ungroup() %>% 
            collect()
          
        }) %>% 
        ungroup() 
      
    }) %>% 
    ungroup()
  
  enrichment_data <- 
    database_enrichment_res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  write_tsv(enrichment_data, ora_file)
}

rm(worker_cluster)

```

## Bubble plot - ORA 
```{r}

plot_data <-
  enrichment_data %>%
  mutate(cluster = as.character(cluster),
         ID = as.character(ID)) %>% 
  filter(!(id == dataset_id)) %>% 
  # filter(dataset_id == "tissue") %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, full_annotation), 
            by = c("id" = "dataset_id", "ID" = "cluster")) %>%
  select(-Description) %>% 
  rename(Description = full_annotation) %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, full_annotation)) %>%
  unite(cluster, dataset_id, cluster, full_annotation) %>% 
  unite(ID, id, ID, Description) %>% 
  select(cluster, ID, odds_ratio) %>% 
  group_by_all() %>% 
  mutate(capped_odds_ratio = min(c(odds_ratio,
                                   50))) %>% 
  ungroup() 

cluster_levels <- 
  clustering_data %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  arrange(dataset_id, as.numeric(cluster)) %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, full_annotation), sep = " ") %>% 
  unite(cluster, dataset_id, cluster, full_annotation)

plot_size_range <- c(1, 4)

plot_legend_settings <- 
  tibble(odds_ratio_str = c(1, 10, 20, 30, 40, ">50"),
         y = 1:6,
         odds_ratio = c(1, 10, 20, 30, 40, 50)) 

plot_legend <-
  plot_legend_settings %>% 
  ggplot(aes(1, y, 
             size = odds_ratio,
             fill = odds_ratio,
             label = odds_ratio_str)) +
  geom_point(shape = 21,
             show.legend = F) +
  geom_text(size = 4, 
            hjust = 0,
            nudge_x = 0.1) +
  annotate("text", x = 1, y = 7, label = "Odds ratio",
           fontface = "bold", hjust = 0) +
  scale_x_continuous(limits = c(0, 2)) +
  scale_y_continuous(limits = c(0, 7)) +
  scale_fill_gradient(name = "Odds ratio",
                      low = "white", high = "orangered",
                      breaks = plot_legend_settings$odds_ratio,
                      limits = range(plot_legend_settings$odds_ratio)) + 
  scale_size_continuous(name = "Odds ratio", 
                        range = plot_size_range, 
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) +
  theme_void()

plot_clustering <- 
  plot_data %>% 
  select(cluster, ID, odds_ratio) %>% 
  spread(ID, odds_ratio, fill = 0) %>% 
  column_to_rownames("cluster") %>%
  list(tissue = t(.), 
       cluster = .) %>%
  map(. %>% 
        dist(method = "binary") %>% 
        hclust(method = "ward.D2"))

plot_order <- 
  list(cluster = unique(c(with(plot_clustering$cluster,
                               labels[order]),
                          cluster_levels$cluster)),
       ID = with(plot_clustering$tissue,
                 labels[order]))

plot <-
  plot_data %>%
  ungroup() %>% 
  mutate(cluster = factor(cluster,
                          plot_order$cluster),
         ID = factor(ID,
                     plot_order$ID)) %>%
  ggplot(aes(ID, cluster, 
             size = capped_odds_ratio, 
             fill = capped_odds_ratio)) +
  geom_point(data = expand_grid(cluster = plot_order$cluster,
                                ID = plot_order$ID) %>%
               mutate(cluster = factor(cluster, unique(cluster)),
                      ID = factor(ID, unique(ID))),
             fill = NA,
             size = NA) +
  geom_point(shape = 21,
             show.legend = F) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5, size = 6),
        legend.position = "right",
        axis.text.y = element_text(size = 6)) +
  # coord_fixed() +
  scale_fill_gradient(name = "Odds ratio",
                      low = "white", high = "orangered",
                      breaks = plot_legend_settings$odds_ratio,
                      limits = range(plot_legend_settings$odds_ratio)) + 
  scale_size_continuous(name = "Odds ratio", 
                        range = plot_size_range, 
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) +
  theme(axis.title = element_blank()) + 
  coord_fixed()

ggsave(savepath("Buble_heatmap_all_overlap.pdf"),
       plot = plot,
       width = 35, height = 35)




```

## Network - ORA 
```{r}
# 
# enrichment_data %>% 
#   filter(!(id == dataset_id)) %>% 
#   filter(cluster < ID) %>% 
#   arrange(-odds_ratio) %>% 
#   mutate(n = row_number()) %>% 
#   ggplot(aes(odds_ratio, n)) +
#   geom_line()
# 
# enrichment_data %>% 
#   filter(!(id == dataset_id)) %>% 
#   ggplot(aes(odds_ratio)) +
#   geom_density()
# 
# enrichment_data %>% 
#   filter(!(id == dataset_id)) %>% 
#   ggplot(aes(-log10(p.adjust))) +
#   geom_density()


ora_distances <- 
  enrichment_data %>% 
  filter(!(id == dataset_id)) %>%
  filter(dataset_id != "brain",
         id != "brain") %>% 
  mutate(cluster = as.character(cluster),
         ID = as.character(ID)) %>% 
  left_join(annotation_data, 
            by = c("id" = "dataset_id", "ID" = "cluster")) %>% 
  mutate(cluster1 = paste0(id, "_", ID, "_", Specificity, " - ", Function)) %>% 
  select(-ngenes, -reliability , -Specificity, -Function)  %>% 
  left_join(annotation_data, 
            by = c("dataset_id" = "dataset_id", "cluster" = "cluster")) %>% 
  mutate(cluster2 = paste0(dataset_id, "_", cluster, "_", Specificity, " - ", Function)) %>%
  select(-ngenes, -reliability , -Specificity, -Function) %>% 
  select(cluster1, cluster2, odds_ratio) %>% 
  pivot_wider(names_from = cluster2, 
              values_from = odds_ratio, values_fill = 0) 

bubble_dist <- 
  ora_distances %>% 
  gather(key = cluster2, value = dist, -cluster1)#%>% 
# mutate(dist = 1-dist) 

# bubble_dist %>% 
#   ggplot(aes(dist)) +
#   geom_density()

# bubble_dist %>% 
#   filter(cluster1 != cluster2) %>% 
#   group_by(cluster1) %>% 
#   top_n(1, dist) %>% 
#   arrange(-dist) %>%
#   ggplot(aes(dist)) +
#   geom_histogram(bins = 1000)

bubble_nn_data <- 
  bubble_dist %>%
  filter(dist > 5) %>% 
  group_by(cluster1) %>%
  top_n(5, -dist) %>%
  arrange(cluster1)


bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))

#bubble_graph %>% 
#  graph_component_count(type = "weak")

# bubble_graph %>% 
#   ggraph('fabric', sort.by = node_rank_fabric()) + 
#   geom_node_range(colour = 'grey') + 
#   geom_edge_span(end_shape = 'square') + 
#   coord_fixed() +
#   theme_void()

bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')


bubble_graph_layout %>% 
  ggraph() + 
  geom_edge_link(color = "gray") +
  geom_node_point(aes(color = dataset_id),
                  size = 3) + 
  # geom_node_text(aes(label = full_annotation),
  #                size = 2) +
  
  theme_void()

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_ORA_net.html"))


plot <-
  bubble_graph_layout %>%
  mutate(dataset_id = case_when(dataset_id == "tissue" ~ "Tissue",
                                dataset_id == "singlecell" ~ "Single cell type",
                                dataset_id == "celline" ~ "Cell line",
                                dataset_id == "blood" ~ "Immune cell")) %>% 
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 2,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = new_dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_ORA_net.html"))

ggsave(savepath("ORA_net.pdf"))




sc_tissue_cor_graph <-
  bubble_nn_data %>%
  #rename(d_cluster = cluster) %>% 
  as_tbl_graph(directed = F) %>%#
  # left_join(bubble_nn_data %>%
  #             select(1:2) %>%
  #             distinct() %>%
  #             gather(type, name) %>%
  #           distinct(),
  #           by = "name") %>%
  mutate(cluster = group_louvain(weights = dist) %>%
           as.character())

#set.seed(1)
set.seed(13)
graph_plot <- 
  sc_tissue_cor_graph %>%
  mutate(dataset_id = case_when(grepl("blood", name) ~ "Immune cell",
                                grepl("tissue", name) ~ "Tissue",
                                grepl("singlecell", name) ~ "Single cell type",
                                grepl("celline", name) ~ "Cell line")) %>% 
  create_layout(layout = 'fr',
                weights = dist) 

graph_plot %>%
  #mutate(cluster = as.numeric(cluster)) %>% 
  ggraph() +
  ggalt::geom_encircle(aes(x, y,
                           fill = as.factor(as.numeric(cluster))),
                       color = NA,
                       alpha = 0.2,
                       s_shape=0.5,
                       expand = 0.01) +
  geom_edge_link(aes(color = dist)) +
  geom_node_point(aes(color = dataset_id),
                  show.legend = F,
                  size = 3) +
  geom_node_text(aes(label = name),
                 size = 2) +
  # scale_size_continuous(range = c(0.5, 2)) +
  scale_edge_color_gradient(low = "white", high = "gray",
                            limits = 0:1) +
  scale_color_manual(values =  new_dataset_palette) +
  theme_void() +
  coord_fixed()

ggsave(savepath("ORA_network_clusters.pdf"))

```
### Tests - ORA network

```{r}

ora_distances <- 
  enrichment_data %>% 
  filter(!(id == dataset_id)) %>%
  filter(dataset_id != "brain",
         id != "brain") %>% 
  filter(cluster < ID) %>% 
  mutate(cluster = as.character(cluster),
         ID = as.character(ID)) %>% 
  left_join(annotation_data, 
            by = c("id" = "dataset_id", "ID" = "cluster")) %>% 
  mutate(cluster1 = paste0(id, "_", ID, "_", Specificity, " - ", Function)) %>% 
  select(-ngenes, -reliability , -Specificity, -Function)  %>% 
  left_join(annotation_data, 
            by = c("dataset_id" = "dataset_id", "cluster" = "cluster")) %>% 
  mutate(cluster2 = paste0(dataset_id, "_", cluster, "_", Specificity, " - ", Function)) %>% 
  select(-ngenes, -reliability , -Specificity, -Function) %>% 
  select(cluster1, cluster2, odds_ratio, p.adjust) 

#%>% 
# pivot_wider(names_from = cluster2, 
#            values_from = odds_ratio, values_fill = 0) 


#bubble_dist <- 
# ora_distances %>% 
#gather(key = cluster2, value = dist, -cluster1)#%>% 
# mutate(dis

ora_distances %>% 
  ggplot(aes(x = p.adjust)) +
  geom_density() +
  theme_bw()

bubble_nn_data <- 
  ora_distances %>%
  filter(p.adjust < 0.001) %>%
  group_by(cluster1) %>%
  top_n(3, p.adjust) %>%
  arrange(cluster1)

##########

bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))


bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')

edges_data <- 
  get_edges()(bubble_graph_layout) %>% 
  as_tibble() 

nodes_data <-
  get_nodes()(bubble_graph_layout) %>% 
  as_tibble() %>% 
  left_join(cluster_annotation %>% 
              mutate(name = paste(dataset_id, cluster, full_annotation, sep = "_")))
#left_join(bubble_nn_data, by = c("node1.name" = "cluster1", "node2.name" = "cluster2"))

plot_palette <- c("tissue" = "#0083C4", "blood" = "#CF161A", "singlecell" = "#6AA692", "celline" = "#97CF16") #"singlecell" = "#6AA692",

plot <-
  bubble_graph_layout %>%
  ggraph() +
  # as_tibble() %>% 
  # ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  # geom_edge_diagonal(data = edges_data,
  #              aes(width = odds_ratio)) +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               #size = c(0.5,1),
               color = "grey20",
               inherit.aes = F) +
  # geom_point(size = 5) +
  # geom_text(size = 3,
  #           color = "black") +
  geom_node_point(aes(color = dataset_id), size = 5) +
  geom_node_text(aes(label = name), size = 2) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette) +
  scale_size_continuous(range=c(0.5,2)) #+
#scale_edge_width(range = c(0.5,3))
plot

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_ORA.html"))




bubble_graph_layout %>%
  ggraph() +
  # as_tibble() %>% 
  # ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  # geom_edge_diagonal(data = edges_data,
  #              aes(width = odds_ratio)) +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               #size = c(0.5,1),
               color = "grey30",
               # alpha = 0.2,
               inherit.aes = F) +
  # geom_point(size = 5) +
  # geom_text(size = 3,
  #           color = "black") +
  geom_node_point(aes(color = dataset_id), size = 4, alpha = 0.9) +
  # geom_node_text(aes(label = name), size = 1.5) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette) +
  scale_size_continuous(range=c(0.5,2)) +
  geom_text_repel(data = nodes_data,
                  aes(x,y, label= (paste(cluster, full_annotation, sep = "_"))),
                  max.overlaps =20,
                  size = 1.2,
                  show.legend = F,
                  inherit.aes = F)



ggsave(savepath("ORA_net.pdf"))



##############

#cytoscape net


# Cluster size
genes_per_cluster <- clustering %>% 
  group_by(value) %>% 
  count()
# Clustering network
to_network <- 
  ora_distances %>% 
  
  mutate(cluster = as.numeric(cluster)) %>% 
  filter(adj_p < 0.01) %>% 
  select(cluster,enhanced_tissues,odds_ratio) %>% 
  left_join(genes_per_cluster, by= c("cluster" = "value"))
network <- to_network %>%
  left_join(tissue_colors %>%  enframe(), by = c("enhanced_tissues" = "name")) %>% 
  rename(tissue_color = value,
         n_genes = n,
         tissue = enhanced_tissues)
# Add annotation
cluster_annotation <- read_excel(path = "20210426_annotation.xlsx", sheet = "cluster_info")
network_annotated <- network %>% 
  left_join(annotation %>% select(cluster,Max)) %>% 
  rename(annotation = Max) %>% 
  mutate (n_genes = sqrt(n_genes)) %>% 
  filter(odds_ratio > 2)
node_annotation <-
  network_annotated %>% 
  select(cluster,tissue,annotation) %>% 
  gather(type, name, cluster, tissue) %>% 
  mutate(label = ifelse(type == "cluster",
                        annotation, 
                        name)) %>% 
  select(shared_name=name,name=label)



network_annotated <- 
  enrichment_data %>% 
  filter(!(id == dataset_id)) %>%
  filter(dataset_id != "brain",
         id != "brain") %>% 
  #filter(cluster < ID) %>% 
  mutate(odds_ratio = case_when(cluster >= ID ~ 0, 
                                TRUE ~ odds_ratio)) %>% 
  mutate(cluster = as.character(cluster),
         ID = as.character(ID)) %>% 
  left_join(annotation_data, 
            by = c("id" = "dataset_id", "ID" = "cluster")) %>% 
  rename(id1 = id) %>% 
  mutate(cluster1 = paste0(ID, "_", Specificity, " - ", Function)) %>% 
  select(-ngenes, -reliability , -Specificity, -Function)  %>% 
  left_join(annotation_data, 
            by = c("dataset_id" = "dataset_id", "cluster" = "cluster")) %>% 
  mutate(cluster2 = paste0(cluster, "_", Specificity, " - ", Function)) %>% 
  rename(id2 = dataset_id) %>% 
  select(-ngenes, -reliability , -Specificity, -Function) %>% 
  select(cluster1, id1, cluster2, id2, odds_ratio, p.adjust) %>% 
  left_join(dataset_palette %>% 
              enframe(),
            by = c("id1" = "name")) %>% 
  rename(color1 = value)%>% 
  left_join(dataset_palette %>% 
              enframe(),
            by = c("id2" = "name")) %>% 
  rename(color2 = value) %>% 
  filter(p.adjust < 0.001) %>%
  group_by(cluster1) %>%
  top_n(3, p.adjust) 


write_csv(network_annotated, file = savepath("network_annotated_REDUNDANT_2.csv"))
#write_csv(node_annotation, file = "node_annotation.csv")






################
### Low specificity

bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))%>% 
  mutate(specificity = case_when(grepl("Low", name) ~ "Low",
                                 TRUE ~ "High"))


set.seed(13)
bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')

edges_data <- 
  get_edges()(bubble_graph_layout) %>% 
  as_tibble() 

nodes_data <-
  get_nodes()(bubble_graph_layout) %>% 
  as_tibble() %>% 
  left_join(cluster_annotation %>% 
              mutate(name = paste(dataset_id, cluster, full_annotation, sep = "_")))

bubble_graph_layout %>%
  ggraph() +
  # as_tibble() %>% 
  # ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  # geom_edge_diagonal(data = edges_data,
  #              aes(width = odds_ratio)) +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               #size = c(0.5,1),
               color = "grey30",
               # alpha = 0.2,
               inherit.aes = F) +
  # geom_point(size = 5) +
  # geom_text(size = 3,
  #           color = "black") +
  geom_node_point(aes(color = specificity), size = 4, alpha = 0.9) +
  # geom_node_text(aes(label = name), size = 1.5) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = c("High" = "#63A59F", "Low" = "#9C3F5D")) +
  scale_size_continuous(range=c(0.5,2)) +
  geom_text_repel(data = nodes_data,
                  aes(x,y, label= (paste(cluster, full_annotation, sep = "_"))),
                  max.overlaps =20,
                  size = 1.2,
                  show.legend = F,
                  inherit.aes = F)

ggsave(savepath("ORA_net_specificity.pdf"))


## Specificity

bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>%
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F)) %>% 
  left_join(cluster_annotation)  

set.seed(13)

bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')

edges_data <- 
  get_edges()(bubble_graph_layout) %>% 
  as_tibble() 

nodes_data <-
  get_nodes()(bubble_graph_layout) %>% 
  as_tibble() %>% 
  left_join(cluster_annotation %>% 
              mutate(name = paste(dataset_id, cluster, full_annotation, sep = "_")))

a <- bubble_graph_layout %>%
  ggraph() +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               color = "grey30",
               inherit.aes = F) +
  geom_node_point(aes(color = Specificity), size = 4, alpha = 0.9, show.legend = F) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = plot_pal) +
  scale_size_continuous(range=c(0.5,2)) +
  geom_text_repel(data = nodes_data,
                  aes(x,y, label= (paste(cluster, full_annotation, sep = "_"))),
                  max.overlaps =20,
                  size = 2,
                  show.legend = F,
                  inherit.aes = F)

ggsave(savepath("ORA_net_specificity_tissuecolor.pdf"))

library(cowplot)
p <- bubble_graph_layout %>%
  ggraph() +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               color = "grey30",
               inherit.aes = F,
               show.legend = F) +
  geom_node_point(aes(color = Specificity), size = 4, alpha = 0.9,
                  show.legend = F) +
  scale_color_manual(values = plot_pal) +
  scale_size_continuous(range=c(0.5,2)) +
  theme_void

plot <- bubble_graph_layout %>%
  ggraph() +
  geom_segment(data = edges_data,
               aes(x = x,
                   y = y,
                   xend = xend,
                   yend = yend,
                   size = odds_ratio),
               color = "grey30",
               inherit.aes = F) +
  geom_node_point(aes(color = Specificity), size = 4, alpha = 0.9) +
  scale_color_manual(values = plot_pal) +
  scale_size_continuous(range=c(0.5,2))

a <- get_legend(plot)

ggdraw(plot_grid(plot_grid(p, a),
                 rel_widths=c(4, 2),
                 rel_heights = c(4,1)))

ggdraw(plot_grid(plot_grid(p, NULL, ncol=1),
                 plot_grid( a, ncol=1),
                 rel_widths=c(1, 0.2)))

ggsave(savepath("ORA_net_specificity_all.pdf"))


```


## Network - correlation expression

### All clusterings

```{r}
consensus_data <- 
  heatmap_data_scaled %>% 
  filter(type == "consensus") 

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id!= "brain") %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)


consensus_data %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    
    clustering <-
      clust_mapping %>% 
      left_join(clustering_data) %>% 
      filter(dataset_id == dataset) %>% 
      select(-dataset_id)
    
    heatmap_data <- 
      consensus_data %>% 
      filter(dataset_id == dataset) %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
    
    cluster_corr <- 
      heatmap_data %>% 
      ungroup() %>% 
      column_to_rownames("annotation") %>% 
      t() %>% 
      cor(method = "spearman") %>%
      as.data.frame() %>% 
      rownames_to_column("cluster1") %>% 
      as_tibble() %>% 
      gather(cluster2, correlation, -1) 
    
    bubble_nn_data <- 
      cluster_corr %>%
      filter(correlation > 0.6) %>% 
      filter(cluster1 != cluster2) %>% 
      group_by(cluster1) %>% 
      top_n(3, correlation) %>% 
      ungroup() %>% 
      arrange(correlation)
    
    
    bubble_graph <- 
      bubble_nn_data %>% 
      as_tbl_graph() %>% 
      left_join(as_tibble(.) %>% 
                  separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                           sep = "_",
                           remove = F))
    
    
    
    bubble_graph_layout <- 
      bubble_graph %>% 
      create_layout(layout = 'kk')
  )

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5, show.legend = F) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath(paste(dataset,"interactive_network_correlation06_top3.html", sep = "_")))

ggsave(plot = plot, filename = savepath(paste(dataset,"network_correlation06_top3.pdf", sep = "_")))
  })

```


### Individual

```{r}

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id!= "brain") %>% 
  mutate(annotation = paste(dataset_id, cluster, ngenes, full_annotation, sep = "_")) %>%
  select(dataset_id,ngenes,  cluster, annotation) %>% 
  left_join(umap_centers %>% 
              mutate(cluster = as.character(cluster)))

heatmap_data_scaled %>% 
  filter(type == "consensus",
         dataset_id != "brain") %>%
  group_by(dataset_id) %>% 
  do({
    dat <- . 
    dataset <- unique(dat$dataset_id)
    
    clustering <-
      clust_mapping %>% 
      left_join(clustering_data) %>% 
      filter(dataset_id == dataset) %>% 
      select(-dataset_id)
    
    heatmap_data <- 
      dat %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
    
    cluster_corr <- 
      heatmap_data %>% 
      ungroup() %>% 
      column_to_rownames("annotation") %>% 
      t() %>% 
      cor(method = "spearman") %>%
      as.data.frame() %>% 
      rownames_to_column("cluster1") %>% 
      as_tibble() %>% 
      gather(cluster2, correlation, -1) 
    
    bubble_nn_data <- 
      cluster_corr %>%
      filter(correlation > 0.6
      ) %>% 
      filter(cluster1 != cluster2) %>% 
      group_by(cluster1) %>% 
      top_n(3, correlation) %>% 
      ungroup() %>% 
      arrange(correlation)
    
    
    bubble_graph <- 
      bubble_nn_data %>% 
      as_tbl_graph() %>% 
      left_join(as_tibble(.) %>% 
                  separate(name, into = c("dataset_id", "cluster", "ngenes", "full_annotation"),
                           sep = "_",
                           remove = F))
    
    
    
    bubble_graph_layout <- 
      bubble_graph %>% 
      create_layout(layout = 'fr')
    
    
    bubble_graph_layout %>%
      ggraph() +
      geom_edge_link(color = "gray") +
      geom_node_point(aes(color = dataset_id),
                      show.legend = F, 
                      size = 3) +
      theme_void()
    
    plot <-
      bubble_graph_layout %>%
      as_tibble() %>% 
      ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
      geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                     as_tibble(),
                   aes(x = x,
                       y = y, 
                       xend = xend, 
                       yend = yend),
                   size = 0.2,
                   inherit.aes = F) +
      geom_point(size = 5, color = dataset_palette[dataset]) +
      geom_text(size = 3,
                color = "black") +
      theme_void() +
      coord_fixed() +
      #      scale_color_manual(values = )+
      geom_text(size = 3,
                color = "black") 
    
    
    
    plot <-
      bubble_graph_layout %>%
      as_tibble() %>%
      mutate(ngenes = as.numeric(ngenes)) %>% 
      ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
      geom_point(aes(size = ngenes), color = dataset_palette[dataset]) +
      #  new_scale() + 
      geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                     as_tibble(),
                   aes(x = x,
                       y = y, 
                       size = correlation,
                       xend = xend, 
                       yend = yend),
                   color = "grey50",
                   inherit.aes = F) +
      scale_size_continuous(range=c(0.5,2)) +
      theme_void() +
      coord_fixed() +
      #      scale_color_manual(values = )+
      geom_text_repel(size = 3,
                      color = "black") +
      geom_text(data = bubble_graph_layout %>%
                  as_tibble(),
                aes(x, y, label = cluster), 
                size = 3,
                color = "white") 
    
    
    
    ggsave(plot = plot, filename = savepath(paste(dataset, "cor_network_cor50_top3.pdf", sep = "_")))
  })


```

### Single cell
```{r}
consensus_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "singlecell", 
         type == "consensus") 

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id!= "brain") %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)



dat <- consensus_data

clustering <-
  clust_mapping %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id != "brain") %>% 
  select(-dataset_id)

heatmap_data <- 
  dat %>% 
  select(ensg_id, sample, value_zscore) %>% 
  left_join(clustering, by = c("ensg_id" = "gene")) %>% 
  na.omit() %>% 
  group_by(sample, annotation) %>% 
  summarise(avg_value_zscore = mean(value_zscore)) %>% 
  spread(sample, avg_value_zscore)

cluster_corr <- 
  heatmap_data %>% 
  ungroup() %>% 
  column_to_rownames("annotation") %>% 
  t() %>% 
  cor(method = "spearman") %>%
  as.data.frame() %>% 
  rownames_to_column("cluster1") %>% 
  as_tibble() %>% 
  gather(cluster2, correlation, -1) 

bubble_nn_data <- 
  cluster_corr %>%
  filter(correlation > 0.8) %>% 
  filter(cluster1 != cluster2) %>% 
  group_by(cluster1) %>% 
  top_n(5, correlation) %>% 
  ungroup() %>% 
  arrange(correlation)


bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))



bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'kk')


bubble_graph_layout %>%
  ggraph() +
  geom_edge_link(color = "gray") +
  geom_node_point(aes(color = dataset_id),
                  size = 3) +
  theme_void()

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_network_correlation_singlecellspace_07_top3.html"))

ggsave(plot = plot, filename = savepath("interactive_network_correlation_singlecellspace_07_top3.pdf"))

```


### Tissue 

```{r}

tissue_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "tissue",
         type == "region") 

datasets <- c("tissue", "singlecell", "blood", "celline")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

tissue_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    tissue_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

tissue_cor <- 
  tissue_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>% 
  column_to_rownames("annotation") %>% 
  t() %>% 
  cor(method = "spearman") %>%
  as.data.frame() %>% 
  rownames_to_column("cluster1") %>% 
  as_tibble() %>% 
  gather(cluster2, correlation, -1) #%>% 
#      filter(correlation > 0.5) 

tissue_cor %>% 
  ggplot(aes(correlation)) +
  geom_density()



########

bubble_nn_data <- 
  tissue_cor %>%
  filter(correlation > 0.8) %>% 
  group_by(cluster1) %>%
  top_n(3, correlation) %>%
  arrange(cluster1)


bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))


bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'kk')


bubble_graph_layout %>% 
  ggraph() + 
  geom_edge_link(color = "gray") +
  geom_node_point(aes(color = dataset_id),
                  size = 3) +   
  theme_void()

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("tissue_network_3_08.html"))

```



# 5 Protein classes
## Prepare gene lists
### All
```{r}
mem_sec <- read_tsv("data/gene_lists/mem_sec_20090.txt")
essential_1 <- read_tsv("data/gene_lists/crispr_1_celline_more5.txt")
essential_2 <- read_tsv("data/gene_lists/crispr_90.txt")
drug_targets <- read_tsv("data/gene_lists/FDA_approved_drugtargets.txt")
transcription_factors<- read_tsv("data/gene_lists/transcription_factors.txt")
ribosomal_proteins <- read_tsv("data/gene_lists/ribosomal_proteins.txt")
mitochondrial_proteins <- read_tsv("data/gene_lists/mitochondrial_proteins.txt")
cd_markers <- read_tsv("data/gene_lists/CDmarkers.txt")
gpcr_olfactory <- read_tsv("data/gene_lists/GPCR_olfactory.txt")
gpcr_not_olfactory <- read_tsv("data/gene_lists/GPCR_not_olfactory.txt")
transporters <- read_tsv("data/gene_lists/transporters.txt")
essential_2_50_90 <- read_tsv("data/gene_lists/essential_exp2crispr50plus90.txt")
essential_3_10_90 <- read_tsv("data/gene_lists/essential_exp3crispr10plus90.txt")
non_essential <- read_tsv("data/gene_lists/nonessential_nocrispr05_1_no_expsets.txt")

protein_classes <- 
  mem_sec %>% 
  select(gene = ensg_id, term_id = class) %>% 
  full_join(essential_1 %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "essential_1")) %>% 
  full_join(essential_2 %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "essential_2")) %>% 
  full_join(drug_targets %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "drug_targets")) %>% 
  full_join(transcription_factors %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "transcription_factors"))  %>% 
  full_join(ribosomal_proteins %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "ribosomal_proteins"))  %>% 
  full_join(mitochondrial_proteins %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "mitochondrial_proteins")) %>% 
  full_join(cd_markers %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "cd_markers")) %>% 
  full_join(gpcr_olfactory %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "gpcr_olfactory")) %>% 
  full_join(gpcr_not_olfactory %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "gpcr_not_olfactory")) %>% 
  full_join(transporters %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "transporters")) %>% 
  full_join(essential_2_50_90 %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "essential_2_50_90")) %>% 
  full_join(essential_3_10_90 %>% 
              select(gene =ensg_id ) %>% 
              mutate(term_id = "essential_3_10_90")) %>% 
  full_join(non_essential %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "non_essential")) %>% 
  mutate(db_dataset_id = "protein_classes")
              
```           


### Åsa

```{r}

hpa_hk <- read_tsv("data/gene_lists/HK_2352_HPA_singlecell_SD1_MFC2_ensg.txt") 
eisen_hk <- read_tsv("data/gene_lists/HK_3537_of_3804_Eisenberg_ensg.txt")
hrt_hk <- read_tsv("data/gene_lists/HK_2142_of_2176_HRT_ensg.txt")
#uniprot_mitocarta <- read_tsv("data/gene_lists/.txt")
mitocarta_mito <- read_tsv("data/gene_lists/1244_mito_mitocarta.txt")
uniprot_mito <- read_tsv("data/gene_lists/1235_mito_uniprot.txt")
hpa_mito <- read_tsv("data/gene_lists/1139_mito_HPA_ICC.txt")
ribosomal <- read_tsv("data/gene_lists/82_ribosomal_largesmall_ensg.txt")
uniprot_mitocarta <- 
  intersect(uniprot_mito %>% deframe(), mitocarta_mito %>% deframe())


protein_classes_A <- 
  hpa_hk %>% 
  select(gene = x) %>%
  mutate(term_id = "hpa_hk") %>% 
  full_join(drug_targets %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "drug_targets")) %>% 
  full_join(gpcr_olfactory %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "gpcr_olfactory")) %>% 
  full_join(mitocarta_mito %>% 
              select(gene = x) %>% 
              mutate(term_id = "mitocarta_mito")) %>% 
  full_join(uniprot_mito %>% 
              select(gene = x) %>% 
              mutate(term_id = "uniprot_mito")) %>% 
  full_join(eisen_hk %>% 
              select(gene = x) %>% 
              mutate(term_id = "eisen_hk")) %>% 
  full_join(hrt_hk %>% 
              select(gene = x) %>% 
              mutate(term_id = "hrt_hk")) %>% 
  full_join(hpa_mito %>% 
              select(gene = x) %>% 
              mutate(term_id = "hpa_mito")) %>% 
  full_join(gpcr_not_olfactory %>% 
              select(gene = ensg_id) %>% 
              mutate(term_id = "gpcr_not_olfactory")) %>% 
  full_join(ribosomal %>% 
              select(gene = x) %>% 
              mutate(term_id = "ribosomal")) %>% 
  full_join(tibble(gene = uniprot_mitocarta,
              term_id = "uniprot_mitocarta"))

```

# ORA
 
## All

```{r}

enrichment_file <-  "data/processed/enrichment_all_classes_final.tsv"


if(file.exists(enrichment_file)) {
  enrichment_data <- 
    read_tsv(enrichment_file)
  
} else {
  
  ORA_data <-
    clustering_data
  
  
  ORA_settings <-
    expand_grid(dataset_id = clustering_data %>% 
                  filter(dataset_id != "brain") %>% 
                  pull(dataset_id) %>% 
                  unique() ,
                db_dataset_id = "protein_classes") 
  
  
  spec_ORA_res <-
    ORA_settings %>%
    group_by_all() %>%
    do({
      settings <<- .
      
      database <-
        ORA_data %>%
        filter(dataset_id == settings$dataset_id) %>%
        select(term_id = cluster,
               gene)
      gene_associations <-
        protein_classes %>% 
        select(partition = term_id, gene)
      
      universe <- database %>% pull(gene)
      
      outdata <-
        gene_associations %>%
        group_by(partition) %>% 
        do({
          g_data <<- .
          
          pull(g_data, gene) %>%
            enricher(maxGSSize = Inf,
                     universe = universe,
                     TERM2GENE = database) %>%
            as_tibble()
        }) %>%
        ungroup() 
      
    }) %>%
    ungroup()
  
  # Bubble plot
  
  enrichment_data <- 
    spec_ORA_res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  write_tsv(enrichment_data, enrichment_file)
}

enrichment_data_all <- enrichment_data
```


## Åsa

```{r}

enrichment_file <-  "data/processed/enrichment_all_classes_final.tsv"


if(file.exists(enrichment_file)) {
  enrichment_data <- 
    read_tsv(enrichment_file)
  
} else {
  
  ORA_data <-
    clustering_data
  
  
  ORA_settings <-
    expand_grid(dataset_id = clustering_data %>% 
                  filter(dataset_id != "brain") %>% 
                  pull(dataset_id) %>% 
                  unique() ,
                db_dataset_id = "protein_classes") 
  
  
  spec_ORA_res <-
    ORA_settings %>%
    group_by_all() %>%
    do({
      settings <<- .
      
      database <-
        ORA_data %>%
        filter(dataset_id == settings$dataset_id) %>%
        select(term_id = cluster,
               gene)
      gene_associations <-
        protein_classes_A %>% 
        select(partition = term_id, gene)
      
      universe <- database %>% pull(gene)
      
      outdata <-
        gene_associations %>%
        group_by(partition) %>% 
        do({
          g_data <<- .
          
          pull(g_data, gene) %>%
            enricher(maxGSSize = Inf,
                     universe = universe,
                     TERM2GENE = database) %>%
            as_tibble()
        }) %>%
        ungroup() 
      
    }) %>%
    ungroup()
  
  # Bubble plot
  
  enrichment_data <- 
    spec_ORA_res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  write_tsv(enrichment_data, enrichment_file)
}

enrichment_data_some <- enrichment_data

```

### Compare

```{r}


enrichment_data_all %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "ribosomal_proteins")

enrichment_data_some %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "ribosomal")

test %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "ribosomal")

test %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "drug_targets") %>% 
  arrange(p.adjust)

enrichment_data_all %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "mitochondrial_proteins")

mitochondrial_proteins

enrichment_data_some %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "mitochondrial_proteins")

ribosomal
ribosomal_proteins


enrichment_data_all %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "mitochondrial_proteins")

enrichment_data_some %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "uniprot_mitocarta")

test %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(Description == "uniprot_mitocarta")

enrichment_data_some %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(partition == "uniprot_mitocarta") %>% 
  arrange(p.adjust)

enrichment_data_all %>% 
  filter(dataset_id == "singlecell",
         partition == "drug_targets")
```

### Conclusions

```{r}

enrichment_data_some %>% 
  filter(dataset_id=="singlecell",
         partition =="drug_targets")

enrichment_data_some %>% 
  filter(dataset_id=="singlecell",
         partition =="gpcr_not_olfactory")

enrichment_data_some %>% 
  filter(dataset_id=="singlecell",
         partition =="gpcr_olfactory")

test %>% 
  filter(dataset_id=="singlecell",
         Description =="gpcr_not_olfactory")

```

## UMAPs

```{r}

clusters_to_umap <- 
  enrichment_data_some %>% 
  filter(dataset_id =="singlecell",
         partition %in% c("ribosomal", "uniprot_mitocarta", "drug_targets", "gpcr_olfactory", "gpcr_not_olfactory")) %>% 
  select(partition, ID)

umap_palette <- 
  tibble(classes = c("ribosomal", "uniprot_mitocarta", "drug_targets", 
                     "gpcr_olfactory", "gpcr_not_olfactory"),
         colors = c("#E28547",
                    "#DB5F5B",
                    "#846FAA",
                    "#E88471",
                    "#CF597E")) %>% 
  deframe()

class <- "gpcr_not_olfactory"

OR_clusters <- 
  clusters_to_umap %>% 
  filter(partition == class) %>% 
  pull(ID)

umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% OR_clusters),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = umap_palette[class],
               alpha = 0.7)+ 
  geom_point(data = protein_classes_A %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == class) %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = umap_palette[class]) +
  coord_fixed()+
  theme_void() +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% OR_clusters), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% OR_clusters), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath(paste(class, "umap_singlecell_annotation.pdf", sep = "")),
       height = 5, 
       width = 5)


clusters_mitochondiral <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "mitochondrial_proteins") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_mitochondiral),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#DB5F5B",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "mitochondrial_proteins") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#DB5F5B") +
  theme_void() +
  coord_fixed()+
   geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_mitochondiral), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_mitochondiral), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_mitochondrial_annotations_singlecell.pdf"))

clusters_ribosomal <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "ribosomal_proteins") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_ribosomal),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#E28547",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "ribosomal_proteins") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#E28547") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_ribosomal), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_ribosomal_annotations_singlecell.pdf")


clusters_gpcr_not_olfactory <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "gpcr_not_olfactory") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_gpcr_not_olfactory),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#CF597E",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "gpcr_not_olfactory") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#CF597E") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_not_olfactory), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_not_olfactory), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_gpcr_not_olfactory_annotations_singlecell.pdf"))


clusters_gpcr_olfactory <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "gpcr_olfactory") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_gpcr_olfactory),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#E88471",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "gpcr_olfactory") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#E88471") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_olfactory), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_olfactory), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_gpcr_olfactory_annotations_singlecell.pdf"))

```



# - ####################
## Radar plots - single cell

### Prepare single cell data

```{r}

raw_data <-
  readRDS("data/processed/combined_HPA_expression_data.RDS")

consensus_data <- 
  raw_data[which(grepl("consensus$", names(raw_data)))] %>% 
  set_names(gsub("_consensus", "", names(.)))

```

### Hierarchical clustering single cell

```{r}

consensus_clust_cor_average <- 
  consensus_data %>% 
  map(. %>% 
        column_to_rownames("ensg_id") %>% 
        cor(method = "spearman", use = "pairwise.complete.obs") %>% 
        {1 - .} %>% 
        as.dist() %>% 
        hclust(method = "average"))


consensus_clust_cor_ward <- 
  consensus_data %>% 
  map(. %>% 
        column_to_rownames("ensg_id") %>% 
        cor(method = "spearman", use = "pairwise.complete.obs") %>% 
        {1 - .} %>% 
        as.dist() %>% 
        hclust(method = "ward.D2"))

consensus_clust_labelorder <- 
  list(cor_average = consensus_clust_cor_average,
       cor_ward = consensus_clust_cor_ward) %>% 
  map(. %>%
        map(. %>% 
              with(labels[order])))

consensus_clust_all_plot_order <- 
  unlist(consensus_clust_labelorder$cor_average) 

tissue_region_clust_cor_ward <- 
  raw_data$tissue_region %>% 
  column_to_rownames("ensg_id") %>% 
  cor(method = "spearman", use = "pairwise.complete.obs") %>% 
  {1 - .} %>% 
  as.dist() %>% 
  hclust(method = "ward.D2")

tissue_region_clust_cor_average <- 
  raw_data$tissue_region %>% 
  column_to_rownames("ensg_id") %>% 
  cor(method = "spearman", use = "pairwise.complete.obs") %>% 
  {1 - .} %>% 
  as.dist() %>% 
  hclust(method = "average")

tissue_region_clust_labelorder <- 
  list(cor_average = tissue_region_clust_cor_average,
       cor_ward = tissue_region_clust_cor_ward) %>% 
  map(. %>%
        with(labels[order]))

```

### Ribosomal proteins

```{r}

ribosomal <-
  read_tsv("data/gene_lists/172_ribosomal_proteins_type.txt")

g_heatmap_type <- "consensus"

dat <-
  heatmap_data_scaled %>% 
  filter(type == "consensus",
         dataset_id == "singlecell") %>% 
  filter(ensg_id %in% ribosomal$ensembl_gene_id)

plot_dat <-
  dat %>% 
  select(-type) %>% 
  left_join(ribosomal %>% 
              rename(ensg_id = ensembl_gene_id)) %>% 
  
  arrange(cluster)

plot_ann <-
  plot_dat %>% 
  select(ensg_id, cluster,type) %>% 
  distinct() %>% 
  column_to_rownames("ensg_id")

plot_dat %>% 
  select(ensg_id,sample,value_zscore) %>% 
  spread(sample,value_zscore) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(annotation_row = plot_ann,
           cluster_rows = T,
           show_rownames = F,
           clustering_method = "ward.D2")

plot_dat %>% 
  select(ensg_id,sample,value_scaled) %>% 
  spread(sample,value_scaled) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(annotation_row = plot_ann,
           cluster_rows = T,
           show_rownames = F,
           clustering_method = "ward.D2")


### Cluter order

plot_dat <-
  dat %>% 
  select(-type) %>% 
  left_join(ribosomal %>% 
              rename(ensg_id = ensembl_gene_id)) %>% 
  arrange(type)
 # arrange(as.numeric(cluster))

plot_ann <-
  plot_dat %>% 
  select(ensg_id, cluster,type) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == "singlecell")) %>% 
  mutate(cluster = paste(cluster, full_annotation, sep = "_")) %>% 
  select(ensg_id, cluster, type) %>% 
  distinct() %>% 
  column_to_rownames("ensg_id")

lev <-
  plot_ann %>% 
  as_tibble(rownames = "gene") 

plot_ann <-
  plot_ann %>% 
  mutate(type = factor(type, levels = c("cellular", "mitochondrial", "other"))) %>% 
  arrange(type)
 # mutate(cluster = factor(cluster, levels = unique(lev$cluster)))

plot_dat %>% 
  mutate(ensg_id = factor(ensg_id, levels = lev$gene)) %>% 
  arrange(ensg_id) %>% 
  select(ensg_id,sample,value_zscore) %>% 
  spread(sample,value_zscore) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(annotation_row = plot_ann,
           #cluster_rows = F,
           show_rownames = F,
           clustering_method = "ward.D2")

plot_dat %>% 
  select(ensg_id,sample,value_scaled) %>% 
  spread(sample,value_scaled) %>% 
  column_to_rownames("ensg_id") %>% 
  pheatmap(annotation_row = plot_ann,
           cluster_rows = T,
           show_rownames = F,
           clustering_method = "ward.D2")


####
g_dataset_id <- unique(dat$dataset_id)  


ann <- 
  cluster_annotation %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_"))

clustered_genes <- 
  clustering_data %>% 
  filter(dataset_id == g_dataset_id) %>% 
  pull(gene)

g_cluster_data <- 
  heatmap_data_scaled_cluster %>% 
  filter(dataset_id == g_dataset_id,
         type == g_heatmap_type) %>% 
  filter(ensg_id %in% clustered_genes) %>% 
  na.omit()


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(sample, avg_value_zscore) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == g_dataset_id) %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")


d <- dendro_data(row_hclust, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend), size = 0.3) + 
  #coord_flip() + 
  scale_y_continuous(expand = expansion(0)) + #c(0.2, 0)) +
  scale_x_reverse(expand = expansion(c(0.01,0.02))) +
  theme_dendro()

to_plot_cluster <- 
  cluster_pal_sp %>% 
  rename(cluster_color = color) %>% 
  filter(dataset_id == g_dataset_id) %>% 
  select(cluster,Specificity,Function,cluster_color, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  mutate(annotation = factor(annotation, 
                             levels = rev(row_hclust$labels[row_hclust$order])))   %>% 
  arrange(annotation)

plot_cluster_1 <- 
  to_plot_cluster %>% 
  ggplot(aes("Cluster", x = annotation, fill = cluster_color, label = full_annotation)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  geom_text(aes(label=cluster, angle = 90), size = 1.5, color = "white") +
  scale_fill_identity() +
  coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(c(0,0.015)))+
  ylab("Cluster") +
  theme(axis.text.x = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x.bottom = element_blank(),
        axis.title.y.left = element_blank())

plot_cluster_2 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Specificity", x = annotation, label = Specificity)) + 
  geom_tile(color = "white", show.legend = F, fill = "grey80") +
  theme_void() +
  geom_text(aes(label=Specificity, angle = 90),  color = "black", size = 1.5) +
  scale_y_discrete(position = "left", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(c(0,0.015)))

plot_cluster_3 <- 
  to_plot_cluster %>% 
  arrange(annotation) %>% 
  ggplot(aes("Function", x = annotation, label = Function)) + 
  geom_tile(color = "white", show.legend = F, fill = "grey80") +
  theme_void() +
  geom_text(aes(label=Function, angle = 90), size = 1.5, color = "black") +
  scale_y_discrete(position = "right", expand = expansion(0))  +
  scale_x_discrete(expand = expansion(c(0,0.015)))

plot_sample <-
  tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                          levels = (col_hclust$labels[col_hclust$order]))) %>% 
  arrange(samples) %>% 
  ggplot(aes("Sample", y = samples, fill = samples, label = samples)) + 
  geom_tile_rast(color = "black", show.legend = F) +
  theme_void() +
  scale_fill_manual(values = colors_consensus %>% 
                      filter(dataset_id == g_dataset_id) %>% 
                      select(-dataset_id) %>%  
                      deframe()) +
  theme(legend.position = "top",
    axis.text.y = element_text(size = 4.5, hjust = 0)
  ) +
  coord_equal() +
  scale_y_discrete(position = "right", expand = expansion(0)) 

plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  left_join(ann %>% 
              select(-full_annotation)) %>% 
  distinct() %>% 
  mutate(cluster = factor(annotation, 
                          rev(row_hclust$labels[row_hclust$order])),
         sample = factor(sample, 
                         col_hclust$labels[col_hclust$order])) %>% 
  select(-annotation)


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
  geom_tile_rast() +
  scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                       name = "Z-score") +
  theme_void() +
  theme(axis.text.x = element_blank(),
        legend.position = "right") +
  coord_flip()


heat <- plot_heat_zscore + plot_sample

plot_cluster <-
  plot_cluster_1 / plot_cluster_2 / plot_cluster_3 +
  plot_layout(heights = c(0.25,1.2,1.2))


plot_dendrogram / heat / plot_cluster / n_genes / sp_plot / plot_tau +
  plot_layout(heights = c(1,9,3,1, 1, 1), nrow = 6, 
              guides = 'collect' )


ggsave(savepath(paste(g_dataset_id, "complete_heatmap.pdf", sep = "_")),
       height = 10,
       width = 10)  
    

```


### Radar plots 

```{r}

gene_classes_pal <-
  c("membrane" = "#6DB9C6", 
  "intracellular" = "#FCAC3B",
  "membrane/secreted" = "#CF5734",
  "secreted" =  "#CE70A4",
  "drug_targets" = "#846FAA",
  "essential_1" = "#01A087",
  "essential_2" = "#008280",
  "transcription_factors" = "#4A609D",
  "ribosomal_proteins" = "#E28547",
  "mitochondrial_proteins" = "#DB5F5B",
  "gpcr_not_olfactory" = "#CF597E",
  "cd_markers" = "#9CCB86",
  "transporters" = "#42B7B9",
  "gpcr_olfactory" = "#E88471",
  "essential_2_50_90" = "#01A087",
  "essential_3_10_90" = "#008280",
  "non_essential" = "grey")

to_radar <- 
  consensus_data$singlecell %>% 
  column_to_rownames("ensg_id") %>% 
  scale_data(zscore_scale = TRUE) %>% 
  as_tibble(rownames = "gene") %>% 
  gather(sc_type,exp, -gene) %>%
  left_join(protein_classes %>% 
              select(-db_dataset_id)) %>%
  group_by(sc_type, term_id) %>% 
  summarise(avg_exp = mean(exp))


to_radar %>% 
  mutate(sc_type = factor(sc_type, levels = consensus_clust_all_plot_order)) %>% 
  arrange(sc_type) %>% 
  ggplot(aes(sc_type, avg_exp, group = term_id, color = term_id)) +
  #geom_point()+
  geom_line() +
  scale_color_manual(values = gene_classes_pal) +
  theme_simple +
  theme(axis.text.x = element_text(angle = 90))

to_radar


####
consensus_data$singlecell %>% 
  select(1,2,3) %>% 
 # gather(sc_type,exp, -ensg_id) %>% 
  column_to_rownames("ensg_id") %>% 
  scale_data(max_scale = T)


scaled_consensus_sc <- 
  consensus_data$singlecell %>% 
   column_to_rownames("ensg_id") %>% 
 # scale_data(zscore_scale     = TRUE) %>% 
  scale_data(max_scale  = TRUE) %>% 
    as_tibble(rownames = "gene") #%>% 
  
  
avg_expresion_classes <- 
  scaled_consensus_sc %>% 
  gather(sc_type, exp, -gene) %>% 
  filter(!is.na(exp)) %>% 
  left_join(protein_classes %>% 
              select(-db_dataset_id)) %>%
  group_by(sc_type, term_id) %>% 
  summarise(avg_exp = mean(exp))


avg_expresion_classes %>% 
  mutate(sc_type = factor(sc_type, levels = consensus_clust_all_plot_order)) %>% 
  arrange(sc_type) %>% 
  ggplot(aes(sc_type, avg_exp, group = term_id, color = term_id)) +
  #geom_point()+
  geom_line() +
  scale_color_manual(values = gene_classes_pal) +
  theme_simple +
  theme(axis.text.x = element_text(angle = 90))

avg_expresion_classes %>% 
  arrange(-avg_exp) 

library(ggradar)
ggradar

max_min <- 
  avg_expresion_classes %>% 
 select(sc_type) %>% 
  distinct() %>% 
  mutate(Max = 0.6,
         Min = 0) %>% 
  column_to_rownames("sc_type") %>% 
  t() %>% 
  as_tibble(rownames = "term_id")

max_min %>% 
  bind_rows(avg_expresion_classes %>% 
  ungroup() %>% 
  spread(sc_type, avg_exp)) %>% 
  column_to_rownames("term_id") %>% 
  radarchart(group.coloe = gene_classes_pal)
  
  library(fmsb)

classes <- c("cd_markers", "essential_2_50_90", "essential_3_10_90", "intracellular", "membrane", "secreted","mitochondrial_proteins", "ribosomal_proteins", "transcription_factors")
avg_expresion_classes %>% 
  filter(term_id %in% classes ) %>% 
  mutate(sc_type = factor(sc_type, levels = labels_))
  ungroup() %>% 
  spread(sc_type, avg_exp) %>% 
  #column_to_rownames("term_id") %>% 
  ggradar(grid.max = 0.6,
           # Polygons
  group.line.width = 1, 
  x.centre.range	= TRUE,
  group.point.size = 3,
  # Background and grid lines
  group.colours = gene_classes_pal[classes],
  background.circle.colour = "white",
  gridline.mid.colour = "grey") #+
#  facet_wrap(~term_id)


p1 <- 
  avg_expresion_classes %>% 
  mutate(sc_type = factor(sc_type, levels = consensus_clust_all_plot_order)) %>% 
  filter(term_id %in% classes) %>% 
  ungroup() %>% 
  ggplot(aes(sc_type, avg_exp, group = term_id, color = term_id)) +
  #geom_point()+
  geom_line() +
  scale_color_manual(values = gene_classes_pal[classes]) +
  theme_simple +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Single cell")


avg_expresion_classes %>% 
  ungroup() %>% 
  spread(sc_type, avg_exp) %>% 
  #column_to_rownames("term_id") %>% 
  ggradar(grid.max = 0.6,
          axis.label.size	= 4, 
           # Polygons
  group.line.width = 1, 
  group.point.size = 3,
  # Background and grid lines
  group.colours = gene_classes_pal,
  background.circle.colour = "white",
  gridline.mid.colour = "grey") 

ggradar()

##TISSUE

scaled_consensus_tissue <- 
  consensus_data$tissue %>% 
   column_to_rownames("ensg_id") %>% 
  #scale_data(zscore_scale     = TRUE) %>% 
  scale_data(max_scale = TRUE) %>% 
    as_tibble(rownames = "gene") #%>% 
  
  
avg_expresion_classes_tissue <- 
  scaled_consensus_tissue %>% 
  gather(tissue, exp, -gene) %>% 
  filter(!is.na(exp)) %>% 
  left_join(protein_classes %>% 
              select(-db_dataset_id)) %>%
  group_by(tissue, term_id) %>% 
  summarise(avg_exp = mean(exp))

p2 <- 
  avg_expresion_classes_tissue %>% 
    mutate(tissue = factor(tissue, levels = consensus_clust_all_plot_order)) %>% 

  filter(term_id %in% classes) %>% 
  ungroup() %>% 
  ggplot(aes(tissue, avg_exp, group = term_id, color = term_id)) +
  #geom_point()+
  geom_line() +
  scale_color_manual(values = gene_classes_pal[classes]) +
  theme_simple +
  theme(axis.text.x = element_text(angle = 90)) +
  ggtitle("Tissue")

p1 / p2

```



## ORA
```{r}


#enrichment_file <-  "data/processed/enrichment_protein_classes_extended.tsv"
enrichment_file <-  "data/processed/enrichment_protein_classes_extended_20220209.tsv"


if(file.exists(enrichment_file)) {
  enrichment_data <- 
    read_tsv(enrichment_file)
  
} else {
  
  ORA_data <-
    clustering_data
  
  
  ORA_settings <-
    expand_grid(dataset_id = clustering_data %>% 
                  filter(dataset_id != "brain") %>% 
                  pull(dataset_id) %>% 
                  unique() ,
                db_dataset_id = "protein_classes") 
  
  
  spec_ORA_res <-
    ORA_settings %>%
    group_by_all() %>%
    do({
      settings <<- .
      
      gene_associations <-
        ORA_data %>%
        filter(dataset_id == settings$dataset_id) %>%
        select(partition = cluster,
               gene)
      database <-
        protein_classes %>% 
        select(term_id, gene)
      
      universe <- gene_associations %>% pull(gene)
      
      outdata <-
        gene_associations %>%
        group_by(partition) %>% 
        do({
          g_data <<- .
          
          pull(g_data, gene) %>%
            enricher(maxGSSize = Inf,
                     universe = universe,
                     TERM2GENE = database) %>%
            as_tibble()
        }) %>%
        ungroup() 
      
    }) %>%
    ungroup()
  
  # Bubble plot
  
  enrichment_data <- 
    spec_ORA_res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  write_tsv(enrichment_data, enrichment_file)
}

```

## Barplot
```{r}
enrichment_data %>% 
  rename(cluster = partition) %>% 
  left_join(cluster_annotation) %>% 
  mutate(annotation = paste (cluster, full_annotation, sep = "_")) %>% 
  filter(dataset_id == "singlecell",
         !ID %in% c("intracellular", "membrane", "membrane/secreted", "secreted")) %>% 
  select(dataset_id, ID, full_annotation, p.adjust, odds_ratio) %>% 
  ggplot(aes(full_annotation, odds_ratio, fill = ID)) + 
  geom_bar( stat="identity") +
  facet_wrap(~ID, scales = "free", ncol = 2) +
  theme_bw() +
  coord_flip()

ggsave(savepath("enrichments_proteinclasses.pdf"), 
       width = 7,
       height = 20)




clas <- 
  gpcr_olfactory %>%  pull(ensg_id)


# 807 / 812
dat <- clustering_data %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(gene %in% clas) %>% 
  inner_join(cluster_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  group_by(dataset_id, annotation) %>% 
  summarise(n = n_distinct(gene)) %>% 
  ungroup() %>% 
  arrange(-n)



dat %>% 
  mutate(annotation = factor(annotation, levels = dat$annotation)) %>% 
  ggplot(aes(x = dataset_id, y = n, fill = annotation)) + 
  geom_bar(stat = "identity", show.legend = F, color = "white") +
  geom_text(data = dat %>% 
              arrange(n) %>% 
              mutate(n_cum = cumsum(n)) %>% tail(10), aes(dataset_id, n_cum, label = annotation))


# All

dat <- 
  clustering_data %>% 
  filter(dataset_id == "singlecell") %>% 
  left_join(protein_classes %>%  select(-db_dataset_id)) %>% 
  inner_join(cluster_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  group_by(dataset_id, term_id, annotation) %>% 
  summarise(n = n_distinct(gene)) %>% 
  ungroup() %>% 
  arrange(-n)





dat %>% 
  left_join(cluster_color_dict %>% 
              left_join(cluster_annotation) %>% 
              ungroup() %>% 
              filter(dataset_id == "singlecell") %>% 
              mutate(annotation = paste(cluster, full_annotation, sep ="_")) %>% 
              select(annotation, cluster_color)) %>% 
  filter(!term_id %in% c("intracellular", "membrane","membrane/secreted")) %>% 
  # mutate(annotation = factor(annotation, levels = dat$annotation)) %>% 
  ggplot(aes(x = term_id, y = n, fill = cluster_color, label = annotation)) + 
  geom_bar(stat = "identity", show.legend = F, color = "white") +
  coord_flip() +
  theme_bw() +
  #geom_text_repel() +
  scale_fill_identity()#+
#geom_text(data = dat %>% 
#arrange(n) %>% 
# mutate(n_cum = cumsum(n)) %>% tail(10), aes(term_id, n_cum, label = annotation)) 

```


## Bubble plot
```{r}

bubble_plot <- function(res) {
  
  res <- spec_ORA_res
  enrichment_data <- 
    res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  plot_data <-
    enrichment_data %>%
    mutate(cluster = as.character(partition),
           ID = as.character(ID)) %>% 
    select(-partition) %>% 
    left_join(cluster_annotation %>%
                select(dataset_id, cluster, full_annotation)) %>%
    select(-Description) %>% 
    rename(Description = full_annotation) %>% 
    # left_join(cluster_annotation %>% 
    #             select(dataset_id, cluster, full_annotation)) %>%
    unite(cluster, cluster, Description) %>% 
    #  unite(ID, id, ID, Description) %>% 
    select(dataset_id, cluster, ID, odds_ratio) %>% 
    group_by_all() %>% 
    mutate(capped_odds_ratio = min(c(odds_ratio,
                                     50))) %>% 
    ungroup() 
  
  cluster_levels <- 
    clustering_data %>% 
    select(dataset_id, cluster) %>% 
    distinct() %>% 
    arrange(dataset_id, as.numeric(cluster)) %>% 
    left_join(cluster_annotation %>% 
                select(dataset_id, cluster, full_annotation), sep = " ") %>% 
    unite(cluster,cluster, full_annotation)
  
  plot_size_range <- c(1, 4)
  
  plot_legend_settings <- 
    tibble(odds_ratio_str = c(1, 10, 20, 30, 40, ">50"),
           y = 1:6,
           odds_ratio = c(1, 10, 20, 30, 40, 50)) 
  
  plot_legend <-
    plot_legend_settings %>% 
    ggplot(aes(1, y, 
               size = odds_ratio,
               fill = odds_ratio,
               label = odds_ratio_str)) +
    geom_point(shape = 21,
               show.legend = F) +
    geom_text(size = 4, 
              hjust = 0,
              nudge_x = 0.1) +
    annotate("text", x = 1, y = 7, label = "Odds ratio",
             fontface = "bold", hjust = 0) +
    scale_x_continuous(limits = c(0, 2)) +
    scale_y_continuous(limits = c(0, 7)) +
    scale_fill_gradient(name = "Odds ratio",
                        low = "white", high = "orangered",
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) + 
    scale_size_continuous(name = "Odds ratio", 
                          range = plot_size_range, 
                          breaks = plot_legend_settings$odds_ratio,
                          limits = range(plot_legend_settings$odds_ratio)) +
    theme_void()
  
  plot_clustering <- 
    plot_data %>% 
    filter(dataset_id == "singlecell") %>% 
    select(cluster, ID, odds_ratio) %>% 
    spread(ID, odds_ratio, fill = 0) %>% 
    column_to_rownames("cluster") %>%
    list(tissue = t(.), 
         cluster = .) %>%
    map(. %>% 
          dist(method = "binary") %>% 
          hclust(method = "ward.D2"))
  
  cluster_levels <-
    cluster_levels %>% 
    filter(dataset_id == "singlecell")
  
  plot_order <- 
    list(cluster = unique(c(with(plot_clustering$cluster,
                                 labels[order]),
                            cluster_levels$cluster)),
         ID = with(plot_clustering$tissue,
                   labels[order]))
  
  
  # plot <-
  plot_data %>%
    ungroup() %>% 
    filter(dataset_id == "singlecell") %>% 
    # mutate(cluster = factor(cluster,
    #                         plot_order$cluster),
    #        ID = factor(ID,
    #                    plot_order$ID)) %>%
    ggplot(aes(ID, cluster, 
               size = capped_odds_ratio, 
               fill = capped_odds_ratio)) +
    geom_point(data = expand_grid(cluster = plot_order$cluster,
                                  ID = plot_order$ID),# %>%
               # mutate(cluster = factor(cluster, unique(cluster)),
               #      ID = factor(ID, unique(ID))),
               fill = NA,
               size = NA) +
    geom_point(shape = 21,
               show.legend = F) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5, size = 6),
          legend.position = "right",
          axis.text.y = element_text(size = 6)) +
    # coord_fixed() +
    scale_fill_gradient(name = "Odds ratio",
                        low = "white", high = "orangered",
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) + 
    scale_size_continuous(name = "Odds ratio", 
                          range = plot_size_range, 
                          breaks = plot_legend_settings$odds_ratio,
                          limits = range(plot_legend_settings$odds_ratio)) +
    theme(axis.title = element_blank()) + 
    #coord_fixed() +
    coord_flip()#+
  #facet_grid(~dataset_id, scales = "free") #, nrow = 1, scales = "free
  #  facet_wrap (~ID, scales = "free") #, nrow = 1, scales = "free
  
  # ggsave(savepath("Buble_heatmap_lowspecificity_proteinclasses.pdf"))
  #     plot = plot,
  #    width = 15, height = 15)
}

bubble_plot(spec_ORA_res)
```

## Violin
```{r}

# Violin
class_pal <- c("membrane" = "#6DB9C6",
               "intracellular" = "#FCAC3B",
               "secreted" = 	"#CE70A4",
               "membrane/secreted" = "#CF5734",
               "essential_1" = "#01A087", 
               "essential_2" =  "#008280",
               "drug_targets" = "#ACB4CC",
               "transcription_factors" = "#1E5E93",
               "ribosomal_proteins" = "#E15138",
               "mitochondrial_proteins" = "#E9CA57")



consensus_tau %>% 
  # inner_join(current_genes) %>% 
  # filter(grepl("consensus", dataset_id),
  #        dataset_id != "brain_consensus") %>% 
  inner_join(protein_classes %>% 
               mutate(type = case_when(term_id == "membrane" ~ "location",
                                       term_id == "intracellular" ~ "location",
                                       term_id == "secreted" ~ "location",
                                       term_id == "membrane/secreted" ~ "location",
                                       term_id == "essential_1" ~ "importat",
                                       term_id == "essential_2" ~ "importat",
                                       term_id == "drug_targets" ~ "importat")))%>% 
  # filter(term_id != "membrane/secreted",
  #       term_id != "intracellular")) %>% 
  ggplot(aes (x = term_id, y = tau_score, group = term_id, fill = term_id)) +
  geom_violin(draw_quantiles = 0.5) +
  theme_bw() +
  facet_wrap(type~dataset_id, ncol = 4, scales = "free_x", labeller = global_labeller) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = class_pal) +
  ylab("Tau score") +
  xlab("") #+
theme(strip.text.x = element_text(size=13, face="bold", color="red"))


pal1 <-  c("membrane" = "#6DB9C6",
           "intracellular" = "#FCAC3B",
           "secreted" = 	"#CE70A4",
           "membrane/secreted" = "#CF5734")
pal2 <- c("essential_1" = "#01A087", 
          "essential_2" =  "#008280",
          "drug_targets" = "#ACB4CC")

p1 <- 
  consensus_tau %>% 
  inner_join(protein_classes %>% 
               filter(term_id %in% c("membrane","intracellular", "secreted", "membrane/secreted" )) %>% 
               mutate(type = case_when(term_id == "membrane" ~ "location",
                                       term_id == "intracellular" ~ "location",
                                       term_id == "secreted" ~ "location",
                                       term_id == "membrane/secreted" ~ "location"))) %>% 
  ggplot(aes (x = term_id, y = tau_score, group = term_id, fill = term_id)) +
  geom_violin(draw_quantiles = 0.5) +
  theme_bw() +
  facet_wrap(~dataset_id, ncol = 4, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = pal1) +
  ylab("Tau score") +
  xlab("")

p2 <- 
  consensus_tau %>% 
  inner_join(protein_classes %>% 
               filter(term_id %in% c("essential_1","essential_2", "drug_targets" )) %>% 
               mutate(type = case_when(term_id == "essential_1" ~ "importat",
                                       term_id == "essential_2" ~ "importat",
                                       term_id == "drug_targets" ~ "importat")))%>% 
  # filter(term_id != "membrane/secreted",
  #       term_id != "intracellular")) %>% 
  ggplot(aes (x = term_id, y = tau_score, group = term_id, fill = term_id)) +
  geom_violin(draw_quantiles = 0.5) +
  theme_bw() +
  facet_wrap(~dataset_id, ncol = 4, scales = "free_x") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_fill_manual(values = pal2) +
  ylab("Tau score") +
  xlab("")


p1 / p2 #+
plot_layout(guides = "collect")

ggsave(savepath("tau_geneclasses.pdf"))
```

##UMAP

```{r}
#UMAPS
library("ggsci")
mypal <-  pal_npg("nrc", alpha = 0.7)(6)

umap_data %>%
  left_join(protein_classes) %>% 
  mutate(gene_color = case_when(term_id == "membrane" ~ mypal[1],
                                term_id == "intracellular" ~ mypal[2],
                                term_id == "secreted" ~ mypal[3],
                                term_id == "drug_targets" ~ mypal[4],
                                term_id == "essential_1" ~ mypal[5],
                                term_id == "essential_2" ~ mypal[6],
                                TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color)) +
  geom_point_rast(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_grid(~dataset_id)
#
mypal <-  pal_npg("nrc", alpha = 0.7)(6)

umap_data %>%
  left_join(protein_classes) %>% 
  mutate(gene_color = case_when(term_id == "membrane" ~ mypal[1],
                                term_id == "intracellular" ~ mypal[2],
                                term_id == "secreted" ~ mypal[3],
                                term_id == "drug_targets" ~ mypal[4],
                                term_id == "essential_1" ~ mypal[5],
                                term_id == "essential_2" ~ mypal[6],
                                TRUE ~ "grey"))
umap_data %>% 
  left_join(protein_classes) %>% 
  mutate(gene_color = case_when(term_id == "membrane" ~ "#EE2C68",
                                TRUE ~ "grey"),
         type = "membrane") %>%
  # full_join(umap_data %>% 
  #             left_join(protein_classes) %>% 
  #             mutate(gene_color = case_when(term_id == "intracellular" ~ mypal[2],
  #                                           TRUE ~ "grey"),
  #                    type = "intracellular")) %>%
  full_join(umap_data %>% 
              left_join(protein_classes) %>% 
              mutate(gene_color = case_when(term_id == "secreted" ~ "#008699",
                                            TRUE ~ "grey"),
                     type = "secreted"))  %>%
  full_join(umap_data %>% 
              left_join(protein_classes) %>% 
              mutate(gene_color = case_when(term_id == "drug_targets" ~ mypal[1],
                                            TRUE ~ "grey"),
                     type = "drug_targets")) %>%
  full_join(umap_data %>% 
              left_join(protein_classes) %>% 
              mutate(gene_color = case_when(term_id == "essential_1" ~ mypal[2],
                                            TRUE ~ "grey"),
                     type = "essential_1")) %>%
  full_join(umap_data %>% 
              left_join(protein_classes) %>% 
              mutate(gene_color = case_when(term_id == "essential_2" ~ mypal[3],
                                            TRUE ~ "grey"),
                     type = "essential_2")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color)) +
  geom_point_rast(size = 0.01) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_grid(type~dataset_id)

ggsave(savepath("umap_protein_classes.pdf"))
```


## Random
```{r}

sc_clusters <- 
  enrichment_data %>%  
  filter(dataset_id == "singlecell", 
         Description == "drug_targets") %>% 
  pull(partition)

sc_genes <-
  clustering_data %>%
  filter(dataset_id == "singlecell") %>%
  filter(cluster %in% sc_clusters) %>% 
  pull(gene)

cluster_colors <- 
  colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(87) %>% 
  enframe() %>% 
  mutate(name = as.character(name)) %>% 
  rename(cluster = name,
         color = value) %>% 
  filter(cluster %in% sc_clusters)

row_data <- 
  drug_targets %>% 
  filter(ensg_id %in% sc_genes) %>% 
  left_join(clustering_data %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  select(ensg_id, cluster, annotation) %>% 
  left_join(cluster_colors)

colors_annot <- 
  list(cluster = row_data %>% 
         filter(cluster %in% sc_clusters) %>% 
         select(annotation, color) %>%
         distinct() %>% 
         deframe(), 
       sample = sensus %>% 
         filter(dataset_id == "singlecell") %>% 
         select(-dataset_id) %>% 
         deframe())

dat <- 
  expression_data_scaled %>% 
  filter(dataset_id == "singlecell",
         type == "consensus",
         ensg_id %in% row_data$ensg_id) %>% 
  select(ensg_id, sample, value_zscore) %>% 
  distinct() %>% 
  spread(key = sample, value = value_zscore) %>% 
  left_join(row_data %>% 
              select(ensg_id, annotation)) %>% 
  arrange(annotation) %>% 
  select(-annotation) %>% 
  column_to_rownames("ensg_id") 

dat%>% 
  pheatmap(clustering_method = "ward.D2",
           #  color = viridis(20, direction = -1, option = "B"),
           cluster_rows = F,
           show_rownames = F,
           # annotation_col = data.frame(sample = colnames(dat)) %>% 
           #  set_rownames(colnames(dat)),
           annotation_row = row_data %>% 
             select(ensg_id, annotation) %>% 
             rename(cluster = annotation) %>% 
             column_to_rownames("ensg_id"),
           annotation_colors = colors_annot,
           annotation_legend = )


colors_consensus %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(sample %in% colnames(dat))


diff()
select(-dataset_id) %>% 
  deframe()
```

## ORA - gene classes
```{r}
plot_data <-
  enrichment_data %>%
  mutate(cluster = as.character(partition),
         ID = as.character(ID)) %>% 
  select(-partition) %>% 
  left_join(cluster_annotation %>%
              select(dataset_id, cluster, full_annotation)) %>%
  select(-Description) %>% 
  rename(Description = full_annotation) %>% 
  # left_join(cluster_annotation %>% 
  #             select(dataset_id, cluster, full_annotation)) %>%
  unite(cluster, cluster, Description) %>% 
  #  unite(ID, id, ID, Description) %>% 
  select(dataset_id, cluster, ID, odds_ratio) %>% 
  group_by_all() %>% 
  mutate(capped_odds_ratio = min(c(odds_ratio,
                                   50))) %>% 
  ungroup() 

cluster_levels <- 
  clustering_data %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  arrange(dataset_id, as.numeric(cluster)) %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, full_annotation), sep = " ") %>% 
  unite(cluster,cluster, full_annotation)

plot_clustering <- 
  plot_data %>% 
  # filter(dataset_id == "singlecell") %>% 
  select(cluster, ID, odds_ratio) %>% 
  spread(ID, odds_ratio, fill = 0) %>% 
  column_to_rownames("cluster") %>%
  list(tissue = t(.), 
       cluster = .) %>%
  map(. %>% 
        dist(method = "binary") %>% 
        hclust(method = "ward.D2"))

# cluster_levels <-
#   cluster_levels %>% 
#   filter(dataset_id == "singlecell")

plot_order <- 
  list(partition = unique(c(with(plot_clustering$cluster,
                                 labels[order]),
                            cluster_levels$cluster)),
       ID = with(plot_clustering$tissue,
                 labels[order]))


plot_data_ordered_all <- 
  enrichment_data %>%  
  mutate(partition = as.character(partition)) %>% 
  inner_join(cluster_annotation %>% 
               mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
               select(dataset_id, partition = cluster, annotation)) %>% 
  rename(cluster = partition) %>% 
  rename(partition = annotation) %>% 
  mutate(partition = factor(partition, plot_order$partition),
         ID = factor(ID, plot_order$ID)) %>% #,
  #dataset_id = factor(dataset_id, rev(plot_datasets)),
  #  db_dataset_id = factor(db_dataset_id, rev(plot_datasets))) %>% 
  arrange(odds_ratio) 


# p1 <- 
p_celline <- 
  plot_data_ordered_all %>%
  filter(dataset_id == "celline") %>% 
  mutate(ID_color = case_when(ID == "membrane" ~ "#6DB9C6",
                              ID == "intracellular" ~ "#FCAC3B",
                              ID == "membrane/secreted" ~ "#CF5734",
                              ID == "secreted" ~  "#CE70A4",
                              ID == "drug_targets" ~ "#846FAA",
                              ID == "essential_1" ~ "#01A087",
                              ID == "essential_2" ~ "#008280",
                              ID == "transcription_factors" ~ "#4A609D",
                              ID == "ribosomal_proteins" ~ "#E28547",
                              ID == "mitochondrial_proteins" ~ "#DB5F5B",
                              ID == "gpcr_not_olfactory" ~ "#CF597E",
                              ID == "cd_markers" ~ "#9CCB86",
                              ID == "transporters" ~ "#42B7B9",
                              ID == "gpcr_olfactory" ~ "#E88471",
                              ID ==  "essential_2_50_90" ~ "#0F1F15",
                              ID == "essential_3_10_90" ~ "#1A321D",
                              ID == "non_essential" ~ "grey")) %>% 
  filter(!ID %in% c("membrane", "intracellular", "membrane/secreted", "secreted")) %>%
  group_by_all() %>% 
  mutate(log10_odds_ratio = log10(odds_ratio)) %>% 
  #  filter(ID %in% c("essential_1", "essential_2", "drug_targets")) %>%
  # filter(ID %in% c("membrane", "intracellular", "secreted")) %>%
  
  left_join(cluster_color_dict) %>% 
  # select(dataset_id, db_dataset_id, partition) %>%
  # distinct() %>%
  # filter(dataset_id == "tissue") %>%
  # complete(partition, nesting(db_dataset_id, dataset_id)) %>% View
  # filter(complete.cases(.))
  # group_by(dataset_id)
  ggplot(aes(ID, partition, size = (log10_odds_ratio),
             color = log10_odds_ratio)) +
  geom_point() +
  # geom_tile(data = . %>% 
  #             select(dataset_id, cluster_color, partition) %>% 
  #             distinct(),
  #           aes(0, partition, fill = cluster_color),
  #           show.legend = F,
  #           inherit.aes = F,
  #           color = "black")  +
  geom_tile(data = . %>% 
              select(db_dataset_id, ID, ID_color) %>% 
              distinct(),
            aes(ID, 0, fill = ID_color),
            show.legend = F,
            inherit.aes = F,
            color = "black")  +
  scale_fill_identity() +
  facet_grid(db_dataset_id ~dataset_id ,
             space = "free",
             scales = "free") +
  scale_color_gradient(high = "orangered", 
                       low = "lightgray") +
  # scale_fill_manual(values = consensus_palette) +
  scale_size_continuous(range = c(0.5,4)) +
  labs(y = "Cluster",
       x = "Gene class") +#,
  # coord_flip() +
  # title = "Statistical significant overlap in specificity classification",
  #subtitle = "All VS All") +
  # coord_fixed() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, 
                                   size = 7,
                                   vjust = 0.5),
        axis.text.y = element_text(size = 7 ))# +
#  coord_flip()

pdf("ORA.pdf",
    height = 20,
    width = 15)
(p_singlecell | p_tissue) / (p_celline | p_blood)

dev.off()
ggsave(savepath("ORA_gen_classes_extended_singlecell.png"))
ggsave(savepath("ORA_gen_classes_extended_tissue.png"))

# 
# ggsave(savepath("ORA_gen_classes_singlecell_int_noclustann.pdf"))
# ggsave(savepath("leg.pdf"))
# 
# ggsave(savepath("ORA_targets_Essential.pdf"))
# 
# ggsave(savepath("ORA_location.pdf"))
```

## Heatmaps - gene classes
```{r}
plots <- 
  protein_classes %>%
  filter(!term_id %in% c("membrane", "intracellular", "membrane/secreted", "secreted", "gpcr_olfactory")) %>% 
  pull(term_id) %>% 
  unique() %>% 
  lapply(function(x) {
    
    dat <- 
      expression_data_scaled %>% 
      filter(dataset_id == "singlecell",
             type == "consensus") %>% 
      left_join(protein_classes, by = c("ensg_id" = "gene")) %>% 
      filter(term_id == x) 
    
    dat_wide <- 
      dat %>% 
      select(ensg_id, sample, value_zscore) %>% 
      spread(sample, value_zscore) %>% 
      column_to_rownames("ensg_id") 
    
    
    ann <-
      dat %>% 
      select(ensg_id, cluster) %>% 
      distinct() %>% 
      left_join(cluster_annotation %>%
                  filter(dataset_id == "singlecell") %>%
                  select(cluster, full_annotation) %>%
                  mutate(annotation = paste(cluster, full_annotation, sep = "_")) )
    
    
    row_hclust <- 
      dat_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    col_hclust <- 
      dat_wide %>%
      t() %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    
    d <- dendro_data(col_hclust, type = "rectangle")
    
    plot_dendrogram <- 
      ggplot(segment(d)) + 
      geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
      #coord_flip() + 
      scale_y_continuous(expand = c(0.2, 0)) +
      scale_x_continuous(expand = expansion(0.01)) +
      theme_dendro()
    
    plot_sample <-
      tibble(samples = factor(rev(col_hclust$labels[col_hclust$order]),
                              levels = (col_hclust$labels[col_hclust$order]))) %>% 
      arrange(samples) %>% 
      ggplot(aes("Sample", x = samples, fill = samples, label = samples)) + 
      geom_tile_rast(color = "white", show.legend = F) +
      theme_void() +
      #geom_text(size = 2, color = "white") +
      scale_fill_manual(values = colors_consensus %>% 
                          filter(dataset_id == "singlecell") %>% 
                          select(-dataset_id) %>%  
                          deframe()) +
      theme(#axis.text.x = element_text(angle = -90), 
        legend.position = "top",
        axis.text.y = element_text(size = 6, hjust = 0.5)
      ) +
      coord_equal() +
      scale_y_discrete(position = "right", expand = expansion(0)) 
    
    color_dict <- 
      cluster_annotation  %>%
      filter(dataset_id == "singlecell") %>% 
      mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
      select(cluster, annotation) %>% 
      distinct() %>% 
      arrange(as.numeric(cluster)) %>%
      mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(68)) 
    
    plot_data <- 
      dat %>% 
      select(ensg_id, sample, value_zscore) %>% 
      # left_join(ann %>% 
      #             select(-full_annotation)) %>% 
      distinct() %>% 
      mutate(ensg_id = factor(ensg_id, 
                              rev(row_hclust$labels[row_hclust$order])),
             sample = factor(sample, 
                             col_hclust$labels[col_hclust$order])) #%>% 
    #    select(-annotation)
    #
    
    plot_heat_zscore <- 
      plot_data %>% 
      ggplot(aes(sample, ensg_id, fill = value_zscore)) +
      geom_tile_rast() +
      scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                           name = "Z-score") +
      theme_void() +
      theme(axis.text.x = element_text(angle = -90,
                                       hjust = 0, 
                                       size = 6),
            legend.position = "right")
    
    
    #plot <- 
    plot_dendrogram / plot_sample / plot_heat_zscore +
      plot_layout(heights = c(1, 0.5, 10), ncol = 1)  + 
      plot_annotation(title = x)
    
  })


pdf(savepath("heatmaps_classes.pdf"))
plots
dev.off()
```





## Violin plot - gene classes

## DRUG TARGET

```{r}
drug_targets <- 
  protein_classes %>% 
  filter(term_id == "drug_targets") %>% 
  filter(gene %in% unique(clustering_data %>% 
                            filter(dataset_id == "tissue") %>% 
                            pull(gene))) %>% 
  pull(gene) %>% 
  unique()


# Number of genes
enrichment_data %>% 
  filter(dataset_id =="singlecell",
         ID == "drug_targets") %>%
  pull(Count) %>% 
  sum()
#232 genes

# Number of clusters
enrichment_data %>% 
  filter(dataset_id =="singlecell",
         ID == "drug_targets") %>% 
  pull(partition) %>% 
  length()
# clusters

cluster_annotation %>% 
  filter(dataset_id == "singlecell",
         cluster %in% as.character(enrichment_data %>% 
  filter(dataset_id =="singlecell",
         ID == "drug_targets") %>% 
  pull(partition) )) 

#Hepatocytes (2), Neurons (2), Adypocytes and endothelial cells, intestinal endocrine cels, stromal cells and smooth muscle cells

# Most significant
enrichment_data %>% 
  filter(dataset_id =="singlecell",
         ID == "drug_targets") %>% 
  arrange(qvalue) %>% 
  select(qvalue,partition) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == "singlecell") %>% 
              mutate(partition = as.numeric(cluster)))


# In general
clustering_data %>% 
  left_join(cluster_annotation) %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(gene %in% drug_targets) %>% 
  group_by(cluster,Specificity,Function) %>% 
  summarise(n = n_distinct(gene)) %>% 
  arrange(-n)


drugs_protein_class <- 
  drug_targets %>% 
  enframe() %>% 
  rename(gene = value) %>% 
  left_join(protein_classes %>% 
  filter(term_id %in% c("membrane","intracellular","secreted")))


clustering_data %>% 
  filter(dataset_id =="singlecell") %>% 
  filter(cluster %in% c("8","21","2","15"),
         gene %in% drug_targets) %>% 
  left_join(drugs_protein_class) %>%
  group_by(cluster) %>% 
  summarise(total = n_distinct(gene),gene,term_id) %>% 
  ungroup() %>% 
  group_by(cluster,term_id) %>% 
  summarise(n = n_distinct(gene),total) %>% 
  ungroup() %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id =="singlecell") %>% 
              select(cluster, full_annotation)) %>% 
  mutate(frac = n/total) %>% 
  distinct()
```

### Drugs

```{r}

drug <- 
  read_csv("data/gene_lists/pharmacologically_active.csv")

map_uniprot_ensembl <-
  read_tsv("data/gene_lists/ensg_enst_uniprot.txt")

drugs_targets <- 
  drug %>% 
  select(uniprot_id = `UniProt ID`, drug_id = `Drug IDs`, Species) %>% 
  filter(Species == "Humans") %>% 
  select(-Species) %>% 
  left_join(map_uniprot_ensembl %>% 
              select(-enst_id,-uniprot_db)) %>% 
  distinct()%>% 
  separate_rows(drug_id, sep = "; ")

clustering_data %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(gene %in% drug_targets$ensg_id) %>% 
  pull(gene) %>% unique() %>% length()

drugs_targets %>% 
  pull(ensg_id) %>% 
  unique() %>% 
  length()

clustering_data %>% 
  filter(dataset_id =="singlecell") %>% 
  filter(cluster %in% c("8","21","2","15"),
         gene %in% drug_targets)  %>% 
  left_join(drugs_targets %>% 
              rename(gene = ensg_id) %>% 
              select(-uniprot_id) %>% 
              unique()) %>% 
  group_by(cluster, drug_id) %>% 
  summarise(n = n_distinct(gene)) %>% 
  arrange(-n) %>% 
 # View()
  filter(cluster %in% c("2","15"))


cluster_annotation %>% 
  filter(dataset_id =="singlecell",
         cluster %in% c("21","8")) 


clustering_data %>% 
  filter(dataset_id =="singlecell") %>% 
  filter(cluster %in% c("8","21","2","15"),
         gene %in% drug_targets)  %>% 
  left_join(drugs_targets %>% 
              rename(gene = ensg_id) %>% 
              select(-uniprot_id) %>% 
              unique()) %>% 
  group_by(cluster, gene) %>% 
  summarise(n = n_distinct(drug_id)) %>% 
  arrange(-n) 

```


## Barplot with protein classes

```{r}

```


## Lineplot with selected protein classes

```{r}
#Average expression in different cell types / clusters

```


## ORA - cutoffs

```{r}


#enrichment_file <-  "data/processed/enrichment_protein_classes_extended.tsv"
enrichment_file <-  "data/processed/enrichment_protein_classes_20220428_cutoff_3.tsv"


if(file.exists(enrichment_file)) {
  enrichment_data <- 
    read_tsv(enrichment_file)
  
} else {
  
  ORA_data <-
    clustering_data
  
  
  ORA_settings <-
    expand_grid(dataset_id = clustering_data %>% 
                  filter(dataset_id != "brain") %>% 
                  pull(dataset_id) %>% 
                  unique() ,
                db_dataset_id = "protein_classes") 
  
  
  spec_ORA_res <-
    ORA_settings %>%
    group_by_all() %>%
    do({
      settings <<- .
      
      gene_associations <-
        ORA_data %>%
        filter(dataset_id == settings$dataset_id) %>%
        select(partition = cluster,
               gene)
      database <-
        protein_classes %>% 
        select(term_id, gene)
      
      universe <- gene_associations %>% pull(gene)
      
      outdata <-
        gene_associations %>%
        group_by(partition) %>% 
        do({
          g_data <<- .
          
          pull(g_data, gene) %>%
            enricher(maxGSSize = Inf,
                     universe = universe,
                     pAdjustMethod = "BH",
                     #qvalueCutoff = 0.1,
                     TERM2GENE = database) %>%
            as_tibble()
        }) %>%
        ungroup() 
      
    }) %>%
    ungroup()
  
  # Bubble plot
  
  enrichment_data <- 
    spec_ORA_res %>%  
    # filter(id != dataset_id) %>% 
    mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
             as.numeric(gsub(".*\\/", "", GeneRatio)),
           BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
             as.numeric(gsub(".*\\/", "", BgRatio)),
           odds_ratio = GeneFrac / BgFrac) 
  
  write_tsv(enrichment_data, enrichment_file)
}

enrichment_data %>% 
  filter(dataset_id =="singlecell",
         Description == "ribosomal_proteins")

```


## UMAPS - gene classes
```{r}
pal1 <-  c("membrane" = "#6DB9C6",
           "intracellular" = "#FCAC3B",
           "secreted" = 	"#CE70A4",
           "membrane/secreted" = "#CF5734")
pal2 <- c("essential_1" = "#01A087", 
          "essential_2" =  "#008280",
          "drug_targets" = "#846FAA")
umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id != "brain") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_point(data = protein_classes %>% 
               left_join(umap_data) %>% 
               filter(dataset_id != "brain",
                      term_id == "essential_2"),
             size = 0.1,
             aes(UMAP_1_scaled , UMAP_2_scaled, color = term_id, group = term_id)) +
  theme_void() +
  coord_fixed()+
  facet_wrap(~dataset_id, ncol = 4)

umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id != "brain") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_point(data = protein_classes %>% 
               left_join(umap_data) %>% 
               filter(dataset_id != "brain"),
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled, color = term_id, group = term_id)) +
  theme_void() +
  coord_fixed()+
  scale_color_manual(values = class_pal)+
  facet_wrap(term_id~dataset_id, ncol = 4)


p1 <- 
  umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id != "brain") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_point(data = protein_classes %>% 
               left_join(umap_data) %>% 
               filter(dataset_id != "brain",
                      term_id %in% c("essential_1", "essential_2", "drug_targets")),
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled, color = term_id, group = term_id)) +
  theme_void() +
  coord_fixed()+
  scale_color_manual(values = pal2)+
  facet_wrap(term_id~dataset_id, ncol = 4)

p1

ggsave(savepath("essential_drugs_umap.pdf"))

p2 <- 
  umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id != "brain") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_point(data = protein_classes %>% 
               left_join(umap_data) %>% 
               filter(dataset_id != "brain",
                      term_id %in% c("membrane", "intracellular", "secreted", "membrane/secreted")),
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled, color = term_id, group = term_id)) +
  theme_void() +
  coord_fixed()+
  scale_color_manual(values = pal1)+
  facet_wrap(term_id~dataset_id, ncol = 4)


p2
ggsave(savepath("distribution_umap.pdf"))



####
clusters_drugs <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "drug_targets") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()

umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_drugs),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#846FAA",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "drug_targets") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#846FAA") +
  coord_fixed()+
  theme_void() +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_drugs), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_drugs), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_drug_targets_singlecell_annotation.pdf"))



clusters_essential1 <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "essential_1") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()

umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_essential1),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#01A087",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "essential_1") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#01A087") +
  theme_void() +
  coord_fixed() +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_essential1), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_essential1_singlecell_annotation.pdf"))



clusters_essential2 <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "essential_2") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()

umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_essential2),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#008280",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "essential_1") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#008280") +
  theme_void() +
  coord_fixed()+
  scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_essential2), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_essential2_annotations_singlecell.pdf"))

clusters_mitochondiral <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "mitochondrial_proteins") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_mitochondiral),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#DB5F5B",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "mitochondrial_proteins") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#DB5F5B") +
  theme_void() +
  coord_fixed()+
   geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_mitochondiral), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_mitochondiral), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_mitochondrial_annotations_singlecell.pdf"))

clusters_ribosomal <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "ribosomal_proteins") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_ribosomal),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#E28547",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "ribosomal_proteins") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#E28547") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_ribosomal), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_ribosomal_annotations_singlecell.pdf"))

clusters_tf <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "transcription_factors") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_tf),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#4A609D",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "transcription_factors") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#4A609D") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_tf), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_transcription_factors_annotations_singlecell.pdf"))



clusters_gpcr_not_olfactory <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "gpcr_not_olfactory") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_gpcr_not_olfactory),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#CF597E",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "gpcr_not_olfactory") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#CF597E") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_not_olfactory), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_not_olfactory), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_gpcr_not_olfactory_annotations_singlecell.pdf"))


clusters_gpcr_olfactory <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "gpcr_olfactory") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_gpcr_olfactory),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#E88471",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "gpcr_olfactory") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#E88471") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_olfactory), 
            aes(x, y, label = Specificity),
            fontface = "bold",
            hjust =0,
            vjust= 0,
            inherit.aes = F,
            size = 3) +
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_gpcr_olfactory), 
            aes(x, y, label = Function),
            inherit.aes = F,
            hjust =0,
            vjust= 1,
            size = 3)

ggsave(savepath("umap_gpcr_olfactory_annotations_singlecell.pdf"))


clusters_cd <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "cd_markers") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_cd),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#9CCB86",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "cd_markers") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#9CCB86") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_cd), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_cd_annotations_singlecell.pdf"))


clusters_transp <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "transporters") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()


umap_polygons %>% 
  mutate(cluster = as.character(cluster)) %>% 
  left_join(annotation_data) %>%
  filter(dataset_id == "singlecell") %>% 
  ggplot(aes(X,Y, group = polygon_id )) +
  geom_polygon(fill = "grey80")+ 
  geom_polygon(data = . %>% 
                 filter(cluster %in% clusters_transp),
               aes(X,Y, group = polygon_id),
               inherit.aes = F,
               fill = "#42B7B9",
               alpha = 0.7)+ 
  geom_point(data = protein_classes %>%
               left_join(umap_data) %>%
               filter(dataset_id == "singlecell",
                      term_id == "transporters") %>% 
               left_join(clustering_data %>% 
                           filter(dataset_id == "singlecell")) ,#%>% 
             # filter(cluster %in% clusters),
             inherit.aes = F,
             size = 0.01,
             aes(UMAP_1_scaled , UMAP_2_scaled), color = "#42B7B9") +
  theme_void() +
  coord_fixed()+
  # scale_color_manual(values = pal1)+
  geom_text(data = umap_centers %>%
              mutate(cluster = as.character(cluster)) %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell") %>% 
              filter(cluster %in% clusters_transp), 
            aes(x, y, label = full_annotation),
            inherit.aes = F,
            size = 3)

ggsave(savepath("umap_transp_annotations_singlecell.pdf"))


ID == "gpcr_not_olfactory" ~ "#CF597E",
ID == "cd_markers" ~ "#9CCB86",
ID == "transporters" ~ "#42B7B9",
ID == "gpcr_olfactory" ~ "#E88471"))

plot_data_ordered_all %>%
  filter(dataset_id == "singlecell") %>% 
  mutate(ID_color = case_when(ID == "membrane" ~ "#6DB9C6",
                              ID == "intracellular" ~ "#FCAC3B",
                              ID == "membrane/secreted" ~ "#CF5734",
                              ID == "secreted" ~  "#CE70A4",
                              ID == "drug_targets" ~ "#846FAA",
                              ID == "essential_1" ~ "#01A087",
                              ID == "essential_2" ~ "#008280",
                              ID == "transcription_factors" ~ "#4A609D",
                              ID == "ribosomal_proteins" ~ "#E28547",
                              ID == "mitochondrial_proteins" ~ "#DB5F5B"))

```


## Heatmap gene classes
```{r}

sc_genes <- 
  clustering_data %>% 
  filter(dataset_id == "singlecell") %>% 
  pull(gene)

cluster_colors <- 
  colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(68) %>% 
  enframe() %>% 
  mutate(name = as.character(name)) %>% 
  rename(cluster = name,
         color = value) %>% 
  mutate(cluster = as.character(cluster))

row_data <- 
  essential_2 %>% 
  filter(ensg_id %in% sc_genes) %>% 
  left_join(clustering_data %>% 
              left_join(cluster_annotation) %>% 
              filter(dataset_id == "singlecell"),
            by = c("ensg_id" = "gene")) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  select(ensg_id, cluster, annotation) %>% 
  left_join(cluster_colors)

colors_annot <- 
  list(cluster = row_data %>% 
         select(annotation, color) %>%
         distinct() %>% 
         deframe(), 
       sample = colors_consensus %>% 
         filter(dataset_id == "singlecell") %>% 
         select(-dataset_id) %>% 
         deframe())

clusters <- 
  enrichment_data %>% 
  filter(dataset_id == "singlecell",
         ID == "essential_2") %>% 
  pull(partition) %>% 
  as.numeric() %>% 
  unique()

dat <- 
  expression_data_scaled %>% 
  filter(dataset_id == "singlecell",
         type == "consensus",
         ensg_id %in% essential_2$ensg_id) %>% 
  select(ensg_id, sample, value_zscore) %>% 
  distinct() %>% 
  spread(key = sample, value = value_zscore) %>% 
  left_join(row_data %>% 
              select(ensg_id, cluster)) %>% 
  arrange(as.numeric(cluster)) %>% 
  filter(cluster %in% clusters) %>% 
  select(-cluster) %>% 
  column_to_rownames("ensg_id") 

dat%>% 
  pheatmap(clustering_method = "ward.D2",
           #  color = viridis(20, direction = -1, option = "B"),
           cluster_rows = F,
           show_rownames = F,
           annotation_col = data.frame(sample = colnames(dat)) %>% 
             set_rownames(colnames(dat)),
           annotation_row = row_data %>% 
             select(ensg_id, annotation) %>% 
             rename(cluster = annotation) %>% 
             column_to_rownames("ensg_id"),
           annotation_colors = colors_annot,
           annotation_legend = F)


colors_consensus %>% 
  filter(dataset_id == "singlecell") %>% 
  filter(sample %in% colnames(dat))


diff()
select(-dataset_id) %>% 
  deframe()


```



## Data
```{r}


protein_class %>% pull(class) %>% unique()

#"Mitochondrial proteins
# Transcription factors
# Ribosomal proteins
# "Mitochondrial proteins,Transcription factors
# Mitochondrial proteins,Ribosomal proteins

ribosomal_proteins <- 
  protein_class %>% 
  filter(class == "Ribosomal proteins") %>% 
  pull(ensg_id)

classes <- c("Ribosomal proteins", "Transcription factors", "Mitochondrial proteins")
umap_data %>%
  left_join(protein_class, by = c("gene" = "ensg_id")) %>% 
  mutate(gene_color = case_when(class == "Ribosomal proteins" ~ "blue",
                                class == "Transcription factors" ~ "red",
                                #class == "Mitochondrial proteins" ~ "#CD6839",
                                TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color, group = gene_color)) +
  geom_point(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_wrap(~dataset_id, ncol = 5)

ggsave(savepath("umap_protein_classes_mitochondrialproteins.pdf"))

umap_polygons

```


## ORA - protein classes
```{r}
database_terms <- 
  protein_class %>% 
  rename(term_id = class) %>% 
  mutate(id = "protein_class")

low_specificity_data <- 
  annotation_data %>%  
  filter(grepl("Low", Specificity)) %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  left_join(clustering_data) #%>% 
#group_by(gene) %>% 
#summarise(cluster = paste(dataset_id, cluster)) %>% 
#ungroup()


database_enrichment_res <- 
  database_terms %>% 
  group_by(id) %>% 
  do({
    database <- .
    
    term2gene <- 
      database %>% 
      select(term_id, ensg_id)
    
    # For 
    low_specificity_data %>% 
      group_by(dataset_id) %>% 
      
      do({
        g_clustering_data <- .
        
        g_clustering_data %>% 
          group_by(cluster) %>% 
          do({
            g_data <- .
            
            pull(g_data, gene) %>% 
              enricher(maxGSSize = Inf, 
                       universe = unique(g_clustering_data$gene),
                       TERM2GENE = term2gene) %>% 
              as_tibble()
          }) %>% 
          ungroup() 
      }) %>% 
      ungroup() 
    
  }) %>% 
  ungroup()

enrichment_data <- 
  database_enrichment_res %>%  
  # filter(id != dataset_id) %>% 
  mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
           as.numeric(gsub(".*\\/", "", GeneRatio)),
         BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
           as.numeric(gsub(".*\\/", "", BgRatio)),
         odds_ratio = GeneFrac / BgFrac) 


## Bubble plot
plot_data <-
  enrichment_data %>%
  mutate(cluster = as.character(cluster),
         ID = as.character(ID)) %>% 
  filter(!(id == dataset_id)) %>% 
  # filter(dataset_id == "tissue") %>% 
  left_join(cluster_annotation %>%
              filter(grepl("Low", Specificity)) %>% 
              select(dataset_id, cluster, full_annotation), 
            by = c("id" = "dataset_id", "ID" = "cluster")) %>%
  select(-Description) %>% 
  rename(Description = full_annotation) %>% 
  left_join(cluster_annotation %>% 
              select(dataset_id, cluster, full_annotation)) %>%
  unite(cluster, dataset_id, cluster, full_annotation) %>% 
  unite(ID, id, ID, Description) %>% 
  select(cluster, ID, odds_ratio) %>% 
  group_by_all() %>% 
  mutate(capped_odds_ratio = min(c(odds_ratio,
                                   50))) %>% 
  ungroup() 

cluster_levels <- 
  plot_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  arrange(as.numeric(cluster)) %>% 
  left_join(cluster_annotation %>% 
              mutate(annotation = paste(cluster, full_annotation), sep = "_")) %>% 
  unite(cluster, dataset_id, cluster, full_annotation)


plot_clustering <- 
  plot_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(cluster, ID, odds_ratio) %>% 
  spread(ID, odds_ratio, fill = 0) %>% 
  column_to_rownames("cluster") %>%
  list(tissue = t(.), 
       cluster = .) %>%
  map(. %>% 
        dist(method = "binary") %>% 
        hclust(method = "ward.D2"))

plot_order <- 
  list(cluster = unique(c(with(plot_clustering$cluster,
                               labels[order]),
                          cluster_levels$cluster)))



plot_size_range <- c(1, 4)

plot_legend_settings <- 
  tibble(odds_ratio_str = c(1, 10, 20, 30, 40, ">50"),
         y = 1:6,
         odds_ratio = c(1, 10, 20, 30, 40, 50)) 

plot_legend <-
  plot_legend_settings %>% 
  ggplot(aes(1, y, 
             size = odds_ratio,
             fill = odds_ratio,
             label = odds_ratio_str)) +
  geom_point(shape = 21,
             show.legend = F) +
  geom_text(size = 4, 
            hjust = 0,
            nudge_x = 0.1) +
  annotate("text", x = 1, y = 7, label = "Odds ratio",
           fontface = "bold", hjust = 0) +
  scale_x_continuous(limits = c(0, 2)) +
  scale_y_continuous(limits = c(0, 7)) +
  scale_fill_gradient(name = "Odds ratio",
                      low = "white", high = "orangered",
                      breaks = plot_legend_settings$odds_ratio,
                      limits = range(plot_legend_settings$odds_ratio)) + 
  scale_size_continuous(name = "Odds ratio", 
                        range = plot_size_range, 
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) +
  theme_void()

plot_clustering <- 
  plot_data %>% 
  filter(dataset_id == "singlecell") %>% 
  select(cluster, ID, odds_ratio) %>% 
  spread(ID, odds_ratio, fill = 0) %>% 
  column_to_rownames("cluster") %>%
  list(tissue = t(.), 
       cluster = .) %>%
  map(. %>% 
        dist(method = "binary") %>% 
        hclust(method = "ward.D2"))

plot_order <- 
  list(cluster = unique(c(with(plot_clustering$cluster,
                               labels[order]),
                          cluster_levels$cluster)),
       ID = with(plot_clustering$tissue,
                 labels[order]))

plot <-
  plot_data %>%
  ungroup() %>% 
  mutate(cluster = factor(cluster,
                          plot_order$cluster),
         ID = factor(ID,
                     plot_order$ID)) %>%
  ggplot(aes(ID, cluster, 
             size = capped_odds_ratio, 
             fill = capped_odds_ratio)) +
  geom_point(data = expand_grid(cluster = plot_order$cluster,
                                ID = plot_order$ID) %>%
               mutate(cluster = factor(cluster, unique(cluster)),
                      ID = factor(ID, unique(ID))),
             fill = NA,
             size = NA) +
  geom_point(shape = 21,
             show.legend = F) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5, size = 6),
        legend.position = "right",
        axis.text.y = element_text(size = 6)) +
  # coord_fixed() +
  scale_fill_gradient(name = "Odds ratio",
                      low = "white", high = "orangered",
                      breaks = plot_legend_settings$odds_ratio,
                      limits = range(plot_legend_settings$odds_ratio)) + 
  scale_size_continuous(name = "Odds ratio", 
                        range = plot_size_range, 
                        breaks = plot_legend_settings$odds_ratio,
                        limits = range(plot_legend_settings$odds_ratio)) +
  theme(axis.title = element_blank()) + 
  coord_fixed()

ggsave(savepath("Buble_heatmap_lowspecificity_proteinclasses.pdf"),
       plot = plot,
       width = 15, height = 15)

```



## Funtions in other clusters
```{r}


testis_genes <- annotation_data %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id == "tissue", 
         Specificity == "Testis") %>% 
  pull(gene)

umap_data %>%
  # left_join(annotation_, by = c("gene" = "ensg_id")) %>% 
  mutate(gene_color = case_when(#class == "Ribosomal proteins" ~ "blue",
    #  class == "Transcription factors" ~ "red",
    gene %in% testis_genes ~ plot_pal["Testis"],
    TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color, group = gene_color)) +
  geom_point(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_wrap(~dataset_id, ncol = 5)

brain_genes <- annotation_data %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id == "tissue", 
         Specificity == "Brain") %>% 
  pull(gene)

umap_data %>%
  # left_join(annotation_, by = c("gene" = "ensg_id")) %>% 
  mutate(gene_color = case_when(#class == "Ribosomal proteins" ~ "blue",
    #  class == "Transcription factors" ~ "red",
    gene %in% brain_genes ~ plot_pal["Brain"],
    TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color, group = gene_color)) +
  geom_point(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_wrap(~dataset_id, ncol = 5)

skin_genes <- annotation_data %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id == "tissue", 
         Specificity == "Skin") %>% 
  pull(gene)

umap_data %>%
  # left_join(annotation_, by = c("gene" = "ensg_id")) %>% 
  mutate(gene_color = case_when(#class == "Ribosomal proteins" ~ "blue",
    #  class == "Transcription factors" ~ "red",
    gene %in% skin_genes ~ plot_pal["Skin"],
    TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color, group = gene_color)) +
  geom_point(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void() +
  facet_wrap(~dataset_id, ncol = 5)

spermatid_genes <- annotation_data %>% 
  left_join(clustering_data) %>% 
  filter(dataset_id == "singlecell", 
         grepl("permatid", Specificity)) %>% 
  pull(gene)

umap_data %>%
  filter(dataset_id == "singlecell") %>% 
  # left_join(annotation_, by = c("gene" = "ensg_id")) %>% 
  mutate(gene_color = case_when(#class == "Ribosomal proteins" ~ "blue",
    #  class == "Transcription factors" ~ "red",
    gene %in% spermatid_genes ~ plot_pal["Testis"],
    TRUE ~ "grey"))%>% 
  #mutate(class = case_when(class %in% classes ~ class,
  #                        TRUE ~ "others")) %>% 
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = gene_color, group = gene_color)) +
  geom_point(size = 0.1) +
  scale_color_identity() +
  coord_fixed() +
  theme_void()# +
facet_wrap(~dataset_id, ncol = 5)


ggsave(savepath("ex_UMAP.png"))


```


# 6 Low specificity clusters
## Comparison UMAPs
```{r}

plots <- 
  clustering_data %>% 
  pull(dataset_id) %>% 
  unique() %>% 
  lapply(function(id){
    
    clusters <- clustering_data %>% 
      left_join(annotation_data) %>% 
      filter(dataset_id ==  id ,
             grepl("Low", Specificity)) %>% 
      pull(cluster) %>% unique()
    cluster_colors <- data.frame(cluster = clusters,
                                 color =  tableau_seq_gradient_pal("Blue")(seq(0, 1, length = length(clusters))))
    
    umap_all <- clustering_data %>% 
      left_join(annotation_data) %>% 
      filter(dataset_id == id) %>% 
      inner_join(cluster_colors) %>% 
      mutate(cluster_color = case_when(is.na(color) ~ "#C8C8C8",
                                       TRUE ~ color))  
    
    
    gene_dict <- 
      umap_all %>%
      select(gene, cluster_color)
    
    umap_data %>% 
      left_join(gene_dict) %>%
      mutate(cluster_color = case_when(is.na(cluster_color) ~ "#C8C8C8",
                                       TRUE ~ cluster_color))  %>% 
      ggplot(aes(UMAP_1_scaled, UMAP_2_scaled, color = cluster_color, group = cluster_color)) +
      geom_point(size = 0.01) +
      scale_color_identity() +
      coord_fixed() +
      theme_void() +
      facet_wrap(~dataset_id, ncol = 5)
    
  })

plots[[3]] /  plots[[2]] / plots[[4]] / plots[[5]] / plots[[1]]

ggsave(savepath("low_specificity_distribution.pdf"))
```

## UMAPs 
```{r}

annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(umap_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#2A428C",
                                   TRUE ~ "#CBD4EF"))%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(size = 0.05, color = "grey80") +
  facet_grid(~dataset_id) + 
  coord_fixed() +
  scale_color_identity() +
  theme_void() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  != "brain") %>% 
                 mutate(cluster_sp = case_when(grepl("Low", Specificity) ~ "Non-specific",
                                               TRUE ~ "Specific")),
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), fill = as.factor(cluster_sp)),
               color = "black") +
  scale_fill_manual(values = cluster_sp_pal) 

ggsave(savepath("UMAPs_lowspecificity.pdf"))

# With annotations
a <- 
  annotation_data %>% 
  mutate(cluster_sp = case_when(grepl("Low", Specificity) ~ "Low",
                                TRUE ~ "High")) %>% 
  left_join(umap_centers %>% 
              mutate(cluster = as.character(cluster))) %>% 
  filter(cluster_sp == "Low") %>% 
  filter(dataset_id  != "brain") 


annotation_data %>% 
  left_join(clustering_data) %>% 
  left_join(umap_data) %>% 
  filter(dataset_id  != "brain") %>% 
  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#2A428C",
                                   TRUE ~ "#CBD4EF"))%>%
  ggplot(aes(UMAP_1_scaled, UMAP_2_scaled)) +
  geom_point(size = 0.05, color = "grey80") +
  facet_wrap(~dataset_id, ncol = 2) + 
  coord_fixed() +
  scale_color_identity() +
  theme_void() +
  geom_polygon(data = umap_polygons %>% 
                 mutate(cluster = as.character(cluster)) %>% 
                 left_join(annotation_data) %>% 
                 filter(dataset_id  != "brain") %>% 
                 mutate(cluster_sp = case_when(grepl("Low", Specificity) ~ "Non-specific",
                                               TRUE ~ "Specific")),
               aes(X,Y, group = paste(cluster, sub_cluster, landmass), 
                   fill = as.factor(cluster_sp)),
               alpha = 0.8,
               color = "black") +
  #scale_fill_identity() +
  scale_fill_manual(values = cluster_sp_pal) + 
  geom_text(data = a, aes(x,y, label = Function), inherit.aes = F)

ggsave(savepath("UMAPs_lowspecificity_annotations.pdf"))

#Orange/blue colors 
#  mutate(cluster_color = case_when(grepl("Low", Specificity) ~ "#2A428C",
#                                  TRUE ~ "#CBD4EF")
```

## Venn diagram
```{r}
low_specificity_genes <-
  clustering_data %>%
  left_join(annotation_data) %>%
  filter(grepl("Low", Specificity)) %>%
  select(dataset_id, gene)

low_specificity_genes %>%
  group_by(dataset_id) %>%
  summarise(n = n_distinct(gene))

library(venn)

to_venn <- low_specificity_genes %>%
  group_by(dataset_id) %>%
  group_split(.keep = F) %>%
  set_names(unique(low_specificity_genes$dataset_id))


# 
# Venn diagram?
library(ggvenn)

x <- list(blood = to_venn$blood$gene,
          #brain = to_venn$brain$gene,
          celline = to_venn$celline$gene,
          tissue = to_venn$tissue$gene,
          singlecell = to_venn$singlecell$gene)

colors <- 
  dataset_palette %>% 
  enframe() %>% 
  mutate(name = factor(name, levels = names(x))) %>% 
  na.omit() %>% 
  arrange(name)  

ggvenn(x,
       fill_color = colors$value,
       set_name_size = 4)

ggsave(savepath("venn_4groups.pdf"))

## Venn diagram including all 5 groups

```
## Barplot - Low specificity genes
```{r}

# Genes, low specificity genes and common genes
annotation_data %>%  
  left_join(clustering_data) %>% 
  #  filter(dataset_id != "brain") %>% 
  select(dataset_id, gene, Specificity) %>% 
  group_by(dataset_id) %>% 
  mutate(total_genes = n_distinct(gene)) %>% 
  filter(grepl("Low", Specificity)) %>% 
  group_by(dataset_id) %>% 
  mutate(low_specificity_genes = n_distinct(gene), total_genes)%>%
  ungroup() %>% 
  group_by(gene) %>% 
  summarise(n = n_distinct(dataset_id), total_genes, low_specificity_genes, dataset_id) %>% 
  ungroup() %>%
  filter(n == 5) %>% 
  group_by(dataset_id) %>% 
  summarise(common = n_distinct(gene), total_genes, low_specificity_genes) %>% 
  distinct() %>%
  mutate(genes = total_genes - low_specificity_genes,
         low_specificity_genes = low_specificity_genes - common) %>% 
  select(-total_genes) %>% 
  gather(condition, value, common:genes) %>% 
  mutate(condition = factor(condition, levels = (c("genes", "low_specificity_genes", "common")))) %>% 
  ggplot(aes(fill = condition, y = value, x = dataset_id)) +
  geom_bar(poistion = "stack", stat = "identity") +
  theme_simple +
  scale_fill_manual(values = c("genes" = "grey", "low_specificity_genes" = "#45A4A7", "common" = "#692140"))+
  geom_text(data = .  %>% 
              group_by(dataset_id) %>%
              mutate(csum = cumsum(value)),
            aes(x = dataset_id, y = csum, label = value), size = 3, color = "black")

ggsave(savepath("low_specificity_genes.pdf"))

specific_genes <- 
  annotation_data %>%  
  left_join(clustering_data) %>% 
  select(dataset_id, gene, Specificity) %>% 
  group_by(dataset_id) %>% 
  filter(!grepl("Low", Specificity)) %>% 
  group_by(dataset_id) %>% 
  summarise(freq = n_distinct(gene)) %>% 
  mutate(n = 0)

#p1 <- 
annotation_data %>% 
  left_join(clustering_data) %>% 
  select(dataset_id, gene, Specificity) %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  filter(grepl("Low", Specificity)) %>% 
  group_by(dataset_id) %>% 
  ungroup() %>% 
  group_by(gene) %>% 
  summarise(n = n_distinct(dataset_id), dataset_id, gene) %>% 
  ungroup() %>%
  group_by(dataset_id, n) %>% 
  summarise(freq = n_distinct(gene)) %>% 
  # mutate(n = as.factor(n)) %>% 
  ungroup() %>%   
  full_join(specific_genes %>% 
              filter(dataset_id != "brain")) %>% 
  group_by(dataset_id) %>%
  arrange(-n) %>% 
  #  arrange(-n) %>% 
  mutate(label_y = cumsum(freq) - 0.5 * freq) %>%
  mutate(n = as.character(n)) %>% 
  mutate(n = case_when(n == "0" ~ "Specific genes", 
                       TRUE ~ n)) %>% 
  mutate(n = factor(n, levels = rev(c("4","3","2","1","Specific genes")))) %>% 
  ggplot(aes(fill = n, y = freq, x = dataset_id)) +
  scale_fill_manual(values = c("#DFA371" , colorRampPalette(c("#9DBABF", "#023A58"))(6)[-2])) + 
  geom_bar(poistion = "stack", stat = "identity") +
  theme_simple +
  geom_text(aes(y = label_y, label = freq), colour = "white", size = 3) +
  #ggtitle("All genes") +
  ylab("Frequency") +
  xlab("Dataset")


p2 <- annotation_data %>%  
  left_join(clustering_data) %>% 
  select(dataset_id, gene, Specificity) %>% 
  group_by(dataset_id) %>% 
  filter(grepl("Low", Specificity)) %>% 
  group_by(dataset_id) %>% 
  ungroup() %>% 
  group_by(gene) %>% 
  summarise(n = n_distinct(dataset_id), dataset_id, gene) %>% 
  ungroup() %>%
  group_by(dataset_id, n) %>% 
  summarise(freq = n_distinct(gene)) %>% 
  # mutate(n = as.factor(n)) %>% 
  ungroup() %>% 
  group_by(dataset_id) %>% 
  arrange(-n) %>% 
  mutate(label_y = cumsum(freq) - 0.5 * freq) %>% 
  mutate(n = as.character(n)) %>% 
  ggplot(aes(fill = n, y = freq, x = dataset_id)) +
  geom_bar(poistion = "stack", stat = "identity") +
  scale_fill_manual(values = colorRampPalette(c("#9DBABF", "#023A58"))(6)[-1]) + 
  #  scale_fill_manual(values = colorRampPalette(c("grey", "grey20"))(5)) + 
  theme_simple +
  geom_text(aes(y = label_y, label = freq), colour = "white") +
  ggtitle("Genes in Low Specificity clusters")


p1 + p2
p1
ggsave(savepath("specificity_distribution.pdf"))
ggsave(savepath("specificity_distribution.png"))


```


## Upset plot - Low specificity genes
```{r}

annotation_status <- 
  annotation_data %>% 
  mutate(specificity_status = case_when(#grepl("Low", Specificity) ~ "Low specificity"),
    str_detect(Specificity, "Low") ~ "Low specificity", 
    TRUE ~ "Specific"))

p <- clustering_data %>%
  left_join(annotation_status) %>%
  filter(dataset_id != "brain") %>% 
  group_by(gene, specificity_status) %>%
  summarise(datasets = list(sort(dataset_id))) %>%
  # mutate(datasets)
  group_by(specificity_status, datasets) %>%
  count() %>%
  group_by(datasets) %>%
  mutate(tot_n = sum(n)) %>%
  ungroup() %>%
  arrange(tot_n) %>%
  filter(specificity_status == "Low specificity") %>%
  group_by_all() %>%
  mutate(n_dat = length(datasets[[1]])) %>%
  ungroup() %>%
  mutate(n_dat = as.character(n_dat)) %>% 
  ggplot(aes(datasets, n, fill = n_dat)) +
  geom_col(show.legend = F) +
  scale_x_upset(n_intersections = 30) +
  facet_grid(~n_dat, scales = "free_x", space = "free_x") + 
  #facet_wrap(~ n_dat,scales = "free_x", nrow = 1) +
  theme_simple +
  #geom_text(label = n) +
  # ggtitle("Low specificity genes") +
  geom_text(aes(label=n), position=position_dodge(width=0.9), vjust=-0.25, size = 2.5)+    
  theme(panel.spacing = unit(1.5, "cm")) +
  # scale_fill_viridis()
  scale_fill_manual(values = colorRampPalette(c("#9DBABF", "#023A58"))(6)[-2]) 

#library(viridis)
p

ggsave(savepath("upsetplot_lowspecificity.png"))

# 
# clustering_data %>%
#   left_join(annotation_status) %>%
#   select(dataset_id, gene, cluster, function_status, specificity_status) %>%
#   group_by(gene, specificity_status) %>%
#   count() %>%
#   group_by(specificity_status, n) %>%
#   count() %>%
#   filter(specificity_status == "Low specificity") %>%
#   ggplot(aes(n, nn, fill = n, label = nn)) +
#   geom_col() +
#   geom_text(position = position_stack(),
#             vjust = 0) +
#   scale_fill_gradient(low = "gray80", high = "gray20") +
#   labs(x = "Number of datasets gene is in low specificity clustering") +
#   theme_bw()
# plot_data


# Old trial
library(UpSetR)
upset(fromList(x), order.by = "freq", nintersects = 100)

ggsave(savepath("upset_lowspecificity.pdf"))

## Upset plot all genes
y <- list(blood = clustering_data %>% filter(dataset_id == "blood") %>%  pull(gene),
          brain = clustering_data %>% filter(dataset_id == "brain") %>%  pull(gene),
          celline = clustering_data %>% filter(dataset_id == "celline") %>%  pull(gene),
          tissue = clustering_data %>% filter(dataset_id == "tissue") %>%  pull(gene),
          singlecell = clustering_data %>% filter(dataset_id == "singlecell") %>%  pull(gene))

ggvenn(y)

upset(fromList(y), order.by = "freq", nintersects = 100)

ggsave(savepath("upset_all.pdf"))


z <- list(blood = clustering_data %>% filter(dataset_id == "blood") %>%  pull(gene),
          #  brain = clustering_data %>% filter(dataset_id == "brain") %>%  pull(gene),
          celline = clustering_data %>% filter(dataset_id == "celline") %>%  pull(gene),
          tissue = clustering_data %>% filter(dataset_id == "tissue") %>%  pull(gene),
          singlecell = clustering_data %>% filter(dataset_id == "singlecell") %>%  pull(gene))

ggvenn(z)
ggsave(savepath("venn_diagram.pdf"))
```


## Analysis of common genes
```{r}
# Excluding brean / not?

common_genes <- 
  clustering_data %>% 
  #filter(dataset_id != "brain") %>% 
  group_by(gene) %>% 
  mutate(n = n_distinct(dataset_id)) %>% 
  ungroup() %>% 
  #filter(n == 4) %>% 
  filter(n == 5) %>% 
  select(gene) %>% 
  distinct()

common_genes_low <- 
  annotation_data %>%  
  left_join(clustering_data) %>% 
  select(dataset_id, gene, Specificity) %>% 
  #filter(dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  mutate(total_genes = n_distinct(gene)) %>% 
  filter(grepl("Low", Specificity)) %>% 
  group_by(dataset_id) %>% 
  mutate(low_specificity_genes = n_distinct(gene), total_genes)%>%
  ungroup() %>% 
  group_by(gene) %>% 
  summarise(n = n_distinct(dataset_id), total_genes, low_specificity_genes, dataset_id) %>% 
  ungroup() %>%
  select(gene, n) %>% 
  unique() %>% 
  #filter(n == 4) %>%
  filter(n== 5) %>% 
  select(-n)

#write_tsv(common_genes_low, savepath("common_genes_low.tsv"))

# Enrichment - BP, MF, CC
GO_erncihemnts <-
  data.frame(ontology = c("BP", "MF", "CC")) %>% 
  group_by_all() %>% 
  do ({
    GO <- .$ontology
    term2gene <<- 
      GOterms %>%
      mutate(GO_domain = case_when(GO_domain == "cellular_component" ~ "CC",
                                   GO_domain == "molecular_function" ~ "MF",
                                   GO_domain == "biological_process" ~ "BP")) %>% 
      rename(term_id = GO_accession) %>%
      filter(GO_domain == GO) %>% 
      select(term_id, ensg_id)
    
    res <- enricher(common_genes_low$gene, universe = common_genes$gene, TERM2GENE =term2gene )
    
    res %>%  
      as_tibble()
    
  })


enrichment_res <- 
  GO_erncihemnts %>% 
  mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
           as.numeric(gsub(".*\\/", "", GeneRatio)),
         BgFrac = as.numeric(gsub("\\/.*", "", BgRatio)) /
           as.numeric(gsub(".*\\/", "", BgRatio)),
         odds_ratio = GeneFrac / BgFrac)  


# plots
GO_plots <-
  c("BP", "MF", "CC") %>% 
  lapply(function(GO) {
    
    GO_erncihemnts  %>% 
      filter(ontology == GO) %>% 
      left_join(dict, by = c("ID" = "term_id")) %>% 
      arrange(-p.adjust) %>%
      distinct() %>% 
      mutate(GO_term_name = factor(GO_term_name, levels = GO_term_name)) %>% 
      ggplot(aes(x = GO_term_name, y = -log10(p.adjust))) +
      coord_flip()+ 
      geom_bar(stat="identity", fill = ontology_pal[GO]) +
      theme_simple + 
      theme(axis.text = element_text(size = 10, colour="black")) +
      ggtitle(GO)
  })


GO_plots[[1]] + GO_plots[[2]] + GO_plots[[3]]

ggsave(savepath("common_genes_GO.pdf"))



# Simplify terms
GO_sim <-
  lapply(c("BP" ="BP" ,
           "CC" = "CC" , 
           "MF" = "MF"),
         function(ont_) {
           GO_terms <-
             GO_erncihemnts %>% 
             rename(id = ontology) %>% 
             filter(id == ont_) %>% 
             pull(ID) %>% 
             unique()
           
           calculateSimMatrix(GO_terms, 
                              orgdb = "org.Hs.eg.db",
                              ont = str_extract(ont_, "BP|CC|MF"),
                              method = "Wang")
         })


GO_sim_terms <- 
  GO_sim %>% 
  map(. %>% 
        colnames() %>% 
        enframe()) %>% 
  bind_rows() %>% 
  pull(value)


simplified_GO_res <- 
  enrichment_res %>%
  filter(ID %in% GO_sim_terms) %>% 
  mutate(GeneFrac = as.numeric(gsub("\\/.*", "", GeneRatio)) /
           as.numeric(gsub(".*\\/", "", GeneRatio))) %>% 
  group_by(ontology) %>% 
  filter(n_distinct(ID) >= 2) %>% 
  do({
    g_data <<- .
    
    g_terms <- 
      g_data$ID[which(g_data$ID %in% colnames(GO_sim[[unique(g_data$ontology)]]))]
    
    sim_mat <- 
      GO_sim[[unique(g_data$ontology)]][g_terms,
                                        g_terms]
    
    sim_mat %>%
      reduceSimMatrix(setNames(-log10(g_data$p.adjust), g_data$ID),
                      threshold=0.7,
                      orgdb="org.Hs.eg.db") %>%
      as_tibble()
    
    
  }) %>% 
  ungroup()


# Generate treemap

simplified_GO_res %>% 
  left_join(enframe(ontology_pal,
                    "ontology", 
                    "color"),
            by = "ontology") %>% 
  group_by(parent) %>% 
  mutate(nn = n_distinct(go),
         color2 = spread_colors(unique(color), n_distinct(go), colorrange = 0.2)) %>% 
  ggplot(aes(area = score, subgroup = parentTerm)) +
  
  geom_treemap(aes(fill = color2), 
               color = "black",
               show.legend = T) +
  geom_treemap_subgroup_border(color = "black") +
  
  geom_treemap_text(aes(label = term),
                    colour = "black", 
                    place = "centre",
                    alpha = 0.4,
                    grow = TRUE) +
  
  geom_treemap_subgroup_text(place = "centre", 
                             grow = T, 
                             reflow = T,
                             alpha = 1, 
                             colour = "white", 
                             fontface = "bold",
                             min.size = 0) +
  
  scale_fill_identity() +
  theme_void() 

ggsave(savepath("treemap_commonlowgenes.png"))             

```




## Summary plot - single cell
```{r}

id <- "singlecell"

annotation <- 
  tau_scores %>% 
  filter(dataset_id == "singlecell_consensus") %>% 
  left_join(cluster_memberships$singlecell %>% 
              mutate(cluster = as.character(cluster)) %>% 
              inner_join(clustering_data %>%  
                           filter(dataset_id == "singlecell")) %>% 
              select(-dataset_id)) %>% 
  na.omit() %>% 
  group_by(cluster) %>% 
  summarise (avg_tau = mean(tau_score),
             avg_membership = mean(membership)) #%>% 
#column_to_rownames("cluster")


heatmap_data_scaled_cluster %>% 
  filter(dataset_id == "singlecell",
         type == "consensus") %>% 
  select(cluster, sample, avg_value_zscore) %>%
  distinct() %>% 
  spread(sample, avg_value_zscore, fill = 0)

dat <- 
  gene_classification %>% 
  mutate(id = gsub("specificity_","",id)) %>% 
  rename(dataset_id = id)%>% 
  select(dataset_id, ensg_id, specificity_category) %>% 
  inner_join(clustering_data %>% 
               rename(ensg_id = gene)) %>% 
  filter(dataset_id == "singlecell") %>% 
  group_by(dataset_id, cluster, specificity_category) %>% 
  summarise(n = n_distinct(ensg_id)) %>% 
  mutate(cluster = as.numeric(cluster),
         specificity_category = factor(specificity_category, 
                                       levels = c("Tissue enriched", "Group enriched", "Tissue enhanced", "Low tissue specificity", "Not detected"))) 


barplot <- 
  dat %>% 
  ggplot(aes(x = as.factor(cluster), y = n, fill = specificity_category)) +
  geom_bar(poistion = "stack", stat = "identity") +
  scale_fill_manual(values = gene_category_pal) +
  geom_text(data = dat %>% 
              group_by(dataset_id, cluster) %>% 
              summarise(cum = sum(n)),
            aes(x = cluster, y = cum + 10, label = cum),
            size = 2,
            show.legend = F,
            inherit.aes = F#,
            # position = "center"
  ) +
  ylab("Number of genes") +
  xlab("Cluster") +
  coord_flip()+
  theme_classic()


########################### HEATMAP


heatmap_palette <- 
  colorRampPalette(c("white", "orangered"))(100)
# 
# heatmap_data <-
#   readRDS("data/processed/combined_HPA_expression_data.RDS")
# 
# heatmap_data_scaled <- 
#   heatmap_data %>%
#   map(. %>% 
#         gather(sample, value, -1) %>% 
#         group_by(ensg_id) %>% 
#         mutate(value_scaled = value / max(value),
#                value_zscore = (value - mean(value, na.rm = T)) / 
#                  sd(value, na.rm = T)) %>% 
#         ungroup()) %>% 
#   bind_rows(.id = "id") %>% 
#   separate(id, into = c("dataset_id", "type")) %>% 
#   inner_join(clustering_data %>% 
#                select(dataset_id, gene, cluster),
#              by = c("dataset_id",
#                     "ensg_id" = "gene"))


heatmap_data_scaled_cluster %>% 
  group_by(dataset_id, type, sample, cluster) %>% 
  mutate(avg_value_scaled = mean(value_scaled),
         avg_value_zscore = mean(value_zscore)) %>% 
  ungroup() %>% 
  group_by(dataset_id, type) %>% 
  do({
    g_cluster_data <<- .
    
    g_dataset_id <- unique(g_cluster_data$dataset_id)
    
    g_heatmap_type <- unique(g_cluster_data$heatmap_type)
    
    
    g_cluster_data_wide <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      distinct() %>% 
      spread(sample, avg_value_zscore) %>% 
      column_to_rownames("cluster") 
    
    gene_hclust <- 
      g_cluster_data_wide %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    sample_hclust <- 
      g_cluster_data_wide %>%
      t() %>% 
      dist() %>% 
      hclust(method = "ward.D2")
    
    plot_data <- 
      g_cluster_data %>% 
      select(cluster, sample, avg_value_zscore) %>% 
      distinct() %>% 
      mutate(cluster = factor(cluster, 
                              rev(gene_hclust$labels[gene_hclust$order])),
             sample = factor(sample, 
                             sample_hclust$labels[sample_hclust$order])) 
    
    plot_confidence <- 
      annotation %>%
      #filter(dataset_id == g_dataset_id) %>% 
      filter(cluster %in% gene_hclust$labels) %>% 
      #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
      mutate(cluster = factor(cluster, 
                              rev(gene_hclust$labels[gene_hclust$order]))) %>% 
      ggplot(aes("Confidence", cluster, fill = avg_membership)) + 
      geom_tile_rast() +
      theme_void() +
      scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
                          
                          limits = c(0.2, 1), # before limit to 0.5
                          breaks = c(0.5, 0.75, 1),
                          name = "Confidence") +
      theme(axis.text.x = element_text(angle = -90, face = "bold"), 
            legend.position = "left")
    
    plot_tau <- 
      annotation %>%
      #filter(dataset_id == g_dataset_id) %>% 
      filter(cluster %in% gene_hclust$labels) %>% 
      #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
      mutate(cluster = factor(cluster, 
                              rev(gene_hclust$labels[gene_hclust$order]))) %>% 
      ggplot(aes("Confidence", cluster, fill = avg_tau )) + 
      geom_tile_rast() +
      theme_void() +
      scale_fill_gradient(low = "#ABD0AD", high = "#17491A",
                          limits = c(0.2, 1), # before limit to 0.5
                          breaks = c(0.5, 0.75, 1),
                          name = "Tau") +
      theme(axis.text.x = element_text(angle = -90, face = "bold"), 
            legend.position = "left")
    
    
    plot_heat_zscore <- 
      plot_data %>% 
      ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
      geom_tile_rast() +
      scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                           name = "Z-score") +
      theme_void() +
      theme(axis.text.x = element_text(angle = -90,
                                       hjust = 0, 
                                       size = 6),
            legend.position = "top")
    
    
    column_width <- (1/53)
    plot_n <- length(sample_hclust$labels)
    plot_scaling_factor <- column_width * plot_n
    
    plot_widths <- 
      c(3, 2,  plot_n) %>% 
      {. * column_width} %>% 
      {. / max(.)}
    
    #plot_width <- 
    # 1 + 1 + 4 * plot_scaling_factor
    
    p1 <- 
      plot_confidence + plot_tau + plot_heat_zscore +
      plot_layout(widths = c(1,1,5)) #, guides = 'collect' 
    
    ggsave(savepath(paste(g_dataset_id, g_heatmap_type, "heatmap.pdf", sep = "_")), 
           plot = p1,  
           width = plot_width, 
           height = 5)
    
    
    tibble()
  }) %>% 
  ungroup() 

```



```{r}
ann <- 
  cluster_annotation %>% 
  filter(dataset_id == "blood") %>% 
  select(cluster, full_annotation) %>% 
  mutate(annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-full_annotation) 



g_cluster_data <<- .

g_dataset_id <- unique(g_cluster_data$dataset_id)

g_heatmap_type <- unique(g_cluster_data$type)


g_cluster_data_wide <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  spread(sample, avg_value_zscore) %>% 
  left_join(cluster_annotation %>% 
              filter(dataset_id == "blood") %>% 
              select(cluster, full_annotation)) %>% 
  mutate(a = paste(cluster, full_annotation, sep = "_")) %>% 
  select(-cluster, - full_annotation) %>% 
  column_to_rownames("a") 


row_hclust <- 
  g_cluster_data_wide %>% 
  dist() %>% 
  hclust(method = "ward.D2")

col_hclust <- 
  g_cluster_data_wide %>%
  t() %>% 
  dist() %>% 
  hclust(method = "ward.D2")

ggdendrogram(row_hclust, rotate = T, size = 2) + 
  coord_flip()


dhc <- as.dendrogram(model)
# Rectangular lines
d <- dendro_data(row_hclust, type = "rectangle")

plot_dendrogram <- 
  ggplot(segment(d)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
  coord_flip() + 
  scale_y_reverse(expand = c(0.2, 0)) +
  theme_dendro()



plot_cluster <- 
  ann  %>% 
  arrange(as.numeric(cluster)) %>% 
  mutate(cluster_color = colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(max(as.numeric(ann$cluster)))) %>% 
  ungroup() %>% 
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order])))   %>% 
  arrange(cluster) %>% 
  ggplot(aes("Cluster", annotation, fill = cluster_color)) + 
  geom_tile_rast(color = "white") +
  theme_void() +
  scale_fill_identity() +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "left",
        axis.text.y = element_text(size = 6, hjust = 1)) +
  coord_equal()


plot_data <- 
  g_cluster_data %>% 
  select(cluster, sample, avg_value_zscore) %>% 
  distinct() %>% 
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order])),
         sample = factor(sample, 
                         sample_hclust$labels[sample_hclust$order])) 

plot_avg_confidence <- 
  annotation %>%
  #filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% gene_hclust$labels) %>% 
  #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order]))) %>% 
  ggplot(aes("Confidence", cluster, fill = avg_membership)) + 
  geom_tile_rast() +
  theme_void() +
  scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
                      
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "Confidence") +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "top")

plot_confidence <- 
  cluster_memberships[[g_dataset_id]] %>%
  mutate(cluster = as.character(cluster)) %>% 
  inner_join(clustering_data %>% 
               filter(dataset_id == g_dataset_id)) %>% 
  filter(cluster %in% gene_hclust$labels) %>% 
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order]))) %>% 
  group_by(cluster) %>% 
  mutate(avg_membership = mean(membership)) %>% 
  ungroup() %>% 
  arrange(cluster) %>% 
  ggplot(aes( membership,cluster,  fill = avg_membership)) + 
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_minimal() + 
  theme( axis.text.y = element_blank(),
         axis.title.y = element_blank()) +
  scale_fill_gradient(low = "#D1EEEA", high = "#2A5674",
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "avg_membership") +
  theme(legend.position = "top")
#+
#  theme(axis.title.x = element_text(angle = -90, face = "bold", hjust = 0.5), 
#       legend.position = "right")

plot_avg_tau <- 
  annotation %>%
  #filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% gene_hclust$labels) %>% 
  #filter(cluster == unique(g_cluster_data$cluster)) %>% #-> addition to filter memberships for other clusters
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order]))) %>% 
  ggplot(aes("Confidence", cluster, fill = avg_tau )) + 
  geom_tile_rast() +
  theme_void() +
  scale_fill_gradient(low = "#ABD0AD", high = "#17491A",
                      limits = c(0.2, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "Tau") +
  theme(axis.text.x = element_text(angle = -90, face = "bold"), 
        legend.position = "left")


plot_tau <- 
  all_tau %>% 
  filter(dataset_id == g_dataset_id) %>% 
  filter(cluster %in% gene_hclust$labels) %>% 
  mutate(cluster = factor(cluster, 
                          rev(gene_hclust$labels[gene_hclust$order]))) %>% 
  group_by(cluster) %>% 
  mutate(avg_tau = mean(tau_score)) %>% 
  ungroup() %>% 
  arrange(cluster) %>% 
  ggplot(aes( tau_score,cluster,  fill = avg_tau)) + 
  geom_violin(draw_quantiles = 0.5, scale = "width") +
  theme_minimal() + 
  theme( axis.text.y = element_blank(),
         axis.title.y = element_blank()) +
  scale_fill_gradient(low = "#FEDEBE", high = "#B84A00",
                      limits = c(0.4, 1), # before limit to 0.5
                      breaks = c(0.5, 0.75, 1),
                      name = "avg_tau") +
  theme(legend.position = "top")


plot_heat_zscore <- 
  plot_data %>% 
  ggplot(aes(sample, cluster, fill = avg_value_zscore)) +
  geom_tile_rast() +
  scale_fill_gradient2(low = "#4575B4", high = "#D73027", mid = "#FFFFFF",
                       name = "Z-score") +
  theme_void() +
  theme(axis.text.x = element_text(angle = -90,
                                   hjust = 0, 
                                   size = 6),
        legend.position = "top")


column_width <- (1/53)
plot_n <- length(sample_hclust$labels)
plot_scaling_factor <- column_width * plot_n

plot_widths <- 
  c(3, 2,  plot_n) %>% 
  {. * column_width} %>% 
  {. / max(.)}

#plot_width <- 
# 1 + 1 + 4 * plot_scaling_factor

p1 <- 
  plot_confidence + plot_tau + plot_heat_zscore +
  plot_layout(widths = c(1,1,5)) #, guides = 'collect' 

plot_dendrogram + plot_cluster + plot_heat_zscore + plot_confidence + plot_tau +
  plot_layout(widths = c(1,0.5,3,1,1), nrow = 1)


```



#-

# Test - Network (datatset centered)

### Tissue space

```{r}

# All clusterings in tissue space
clust_mapping <- 
  cluster_annotation  %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

tissue_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "tissue")

tissue_heatmap <- 
  clustering_data %>% 
  filter(dataset_id != "brain") %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    tissue_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(tissue_heatmap)[-2],
             tissue = colnames(tissue_heatmap)[-2])

tissue_colors <- read_tsv("data/meta/hpa_tissue_colors.tsv")
tissue_mapping <- read_tsv("data/meta/tissue_mapping.tsv")


pal <- list("dataset" = dataset_palette,
            "tissue" = tissue_palette %>%
              filter(tissue %in% colnames(tissue_heatmap)[-2]) %>%
              deframe())

tissue_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 4,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_col = annotation_col,
           annotation_colors = pal,
           annotation_legend = F)

```

### Tissue space - Single cell & tissue clusterings 
```{r}

datasets <- c("tissue", "singlecell")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

tissue_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    tissue_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(tissue_heatmap)[-2],
             tissue = colnames(tissue_heatmap)[-2])


pal <- list("dataset" = dataset_palette,
            "tissue" = tissue_palette %>%
              filter(tissue %in% colnames(tissue_heatmap)[-2]) %>%
              deframe())

tissue_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 6,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_col = annotation_col,
           annotation_colors = pal,
           annotation_legend = F)

```



### Single cell space

```{r}

singlecell_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "singlecell",
         type == "consensus") 

datasets <- c("tissue", "singlecell")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

singlecell_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    singlecell_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  filter(dataset_id %in% datasets) %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(singlecell_heatmap)[-2],
             tissue = colnames(singlecell_heatmap)[-2])


pal <- list("dataset" = dataset_palette)

singlecell_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 6,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_colors = pal,
           annotation_legend = F)

```



### Single cell space - Single cell & tissue clusterings 

```{r}

singlecell_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "singlecell",
         type == "consensus") 

datasets <- c("tissue", "singlecell", "blood", "celline")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

singlecell_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    singlecell_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  filter(dataset_id %in% datasets) %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(singlecell_heatmap)[-2],
             tissue = colnames(singlecell_heatmap)[-2])


pal <- list("dataset" = dataset_palette)

singlecell_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 4,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_colors = pal,
           annotation_legend = F)

```



### Cell lines space

```{r}

cellines_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "celline",
         type == "consensus") 

datasets <- c("blood", "celline", "tissue", "singlecell")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

cellines_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    cellines_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  filter(dataset_id %in% datasets) %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(cellines_heatmap)[-2],
             tissue = colnames(cellines_heatmap)[-2])


pal <- list("dataset" = dataset_palette)

cellines_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 4,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_colors = pal,
           annotation_legend = F)

```



### Single cell space - Cellines & blood clusterings 

```{r}

cellines_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "celline",
         type == "consensus") 

datasets <- c("blood", "celline")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

cellines_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    cellines_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  filter(dataset_id %in% datasets) %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(cellines_heatmap)[-2],
             tissue = colnames(cellines_heatmap)[-2])


pal <- list("dataset" = dataset_palette)

cellines_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 6,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_colors = pal,
           annotation_legend = F)

```



### Blood space

```{r}

blood_data <- 
  heatmap_data_scaled %>% 
  filter(dataset_id == "blood",
         type == "consensus") 

datasets <- c("blood", "celline", "tissue", "singlecell")

clust_mapping <- 
  cluster_annotation  %>% 
  filter(dataset_id %in% datasets) %>% 
  mutate(annotation = paste(dataset_id, cluster, full_annotation, sep = "_")) %>%
  select(dataset_id, cluster, annotation)

blood_heatmap <- 
  clustering_data %>% 
  filter(dataset_id %in% datasets) %>% 
  group_by(dataset_id) %>% 
  do ({
    dat <- .
    dataset <- unique(dat$dataset_id)
    clustering <-
      dat %>% 
      left_join(clust_mapping) %>% 
      select(-dataset_id)
    
    blood_data %>% 
      select(ensg_id, sample, value_zscore) %>% 
      left_join(clustering, by = c("ensg_id" = "gene")) %>% 
      na.omit() %>% 
      group_by(sample, annotation) %>% 
      summarise(avg_value_zscore = mean(value_zscore)) %>% 
      spread(sample, avg_value_zscore)
  })

annotation_row <- 
  clust_mapping %>% 
  filter(dataset_id %in% datasets) %>% 
  select(dataset_id, annotation) %>% 
  rename(dataset = dataset_id) %>% 
  column_to_rownames("annotation")

annotation_col <-
  data.frame(row.names = colnames(blood_heatmap)[-2],
             tissue = colnames(blood_heatmap)[-2])


pal <- list("dataset" = dataset_palette)


blood_heatmap %>% 
  ungroup() %>% 
  select(-dataset_id) %>%
  column_to_rownames("annotation") %>% 
  pheatmap(clustering_method = "ward.D2",
           color = viridis(20, direction = -1, option = "B"),
           fontsize_row = 4,
           fontsize_col = 6, 
           annotation_row = annotation_row,
           annotation_colors = pal,
           annotation_legend = F)

```


# Test- Semantic similarity (functional distance)

```{r}

d <- godata('org.Hs.eg.db', ont="BP", computeIC=FALSE) # Get GO database(BP)

go_bp <- 
  enrichment_data %>% 
  filter(test_description == "GO analysis Biological Process") 

semsim_file <- "data/processed/semantic_similarities.tsv"

if(file.exists(semsim_file)) {
  semantic_similarities <- 
    read_tsv(semsim_file)
  
} else {
  semantic_similarities <- 
    go_bp %>% 
    select(dataset_id, cluster)  %>% 
    distinct() %>% 
    tidyr::expand(nesting(dataset_id_1 = dataset_id, cluster_1 = cluster),
                  nesting(dataset_id_2 = dataset_id, cluster_2 = cluster)) %>% 
    group_by_all() %>% 
    do({
      dat <<- .
      value <- mgoSim(go_bp %>%  filter(dataset_id == dat$dataset_id_1, cluster == dat$cluster_1) %>%  pull(ID), 
                      go_bp %>%  filter(dataset_id == dat$dataset_id_2, cluster == dat$cluster_2) %>%  pull(ID), 
                      semData=d, 
                      measure="Wang")
      data.frame(cluster_i = dat$cluster_1, cluster_j = dat$cluster_2, value = value)
    })
  write_tsv(semantic_similarities, "data/processed/semantic_similarities.tsv")
  
}

# Heatmap all clusters (with dataset label)
clust_annotation <- 
  annotation_data %>% 
  select(dataset_id, cluster, Specificity, Function) %>% 
  group_by(dataset_id, cluster) %>% 
  summarize(annotation = paste0(cluster, "_", Specificity, " - ", Function)) %>% 
  ungroup() %>% 
  select(-cluster) %>% 
  column_to_rownames("annotation")


annotation_colors <- list(dataset_id = dataset_palette)


a <- annotation_data %>% 
  select(dataset_id, cluster, Specificity, Function) %>% 
  group_by(dataset_id, cluster) %>% 
  summarize(annotation = paste0(cluster, "_", Specificity, " - ", Function))

pdf(savepath("semsim_allclusters.pdf"))
semantic_similarities %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
  ungroup() %>% 
  select(-dataset_id_1, -dataset_id_2, -cluster_i, -cluster_j, -cluster_1, -cluster_2) %>% 
  rename(cluster_1 = annotation.x, cluster_2 = annotation.y) %>% 
  spread(key = cluster_2, value = value) %>% 
  column_to_rownames("cluster_1") %>% 
  pheatmap(clustering_method = "ward.D2", 
           fontsize = 4, 
           annotation_row = clust_annotation,
           annotation_col = clust_annotation, 
           annotation_colors = annotation_colors,
           fontsize_col = 1,
           fontsize_row = 1)



dev.off()

pdf(savepath("semsim_allclusters_nobrain.pdf"))

semantic_similarities %>% 
  filter(dataset_id_1 != "brain",
         dataset_id_2 != "brain") %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
  ungroup() %>% 
  select(-dataset_id_1, -dataset_id_2, -cluster_i, -cluster_j, -cluster_1, -cluster_2) %>% 
  rename(cluster_1 = annotation.x, cluster_2 = annotation.y) %>% 
  spread(key = cluster_2, value = value) %>% 
  column_to_rownames("cluster_1") %>% 
  pheatmap(clustering_method = "ward.D2", 
           fontsize = 4, 
           annotation_row = clust_annotation,
           annotation_col = clust_annotation, 
           annotation_colors = annotation_colors,
           fontsize_col = 2,
           fontsize_row = 2)

dev.off()

## Per dataset
datasets <- clustering_data %>%  pull(dataset_id) %>% unique()

datasets %>% 
  lapply(function(x) {
    
    pdf(savepath(paste(x, "heatmap.pdf", sep = "_")))
    
    semantic_similarities %>%
      filter(dataset_id_1 == x,
             dataset_id_2 == x) %>% 
      mutate(cluster_1 = as.character(cluster_1),
             cluster_2 = as.character(cluster_2)) %>% 
      inner_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
      inner_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
      ungroup() %>% 
      select(-dataset_id_1, -dataset_id_2, -cluster_i, -cluster_j, -cluster_1, -cluster_2) %>% 
      rename(cluster_1 = annotation.x, cluster_2 = annotation.y) %>% 
      spread(key = cluster_2, value = value) %>% 
      column_to_rownames("cluster_1") %>% 
      pheatmap(clustering_method = "ward.D2", 
               fontsize = 5) 
    dev.off()
    
  })

# Explore cluster pairs with similarity = 1

int <- semantic_similarities %>% 
  filter (value == 1) %>% 
  filter(cluster_1 != cluster_2)

int %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) 


semantic_similarities %>% 
  filter (value >0.5) %>% 
  filter(cluster_1 != cluster_2) %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
  spread(annotation.y, value)


## Dendrogram - SemSim
cluster_heatmap <- 
  semantic_similarities %>% 
  filter(dataset_id_1 != "brain",
         dataset_id_2 != "brain") %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(a, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(a, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
  ungroup() %>% 
  select(-dataset_id_1, -dataset_id_2, -cluster_i, -cluster_j, -cluster_1, -cluster_2) %>% 
  rename(cluster_1 = annotation.x, cluster_2 = annotation.y) %>% 
  spread(key = cluster_2, value = value) %>% 
  column_to_rownames("cluster_1") %>% 
  pheatmap(clustering_method = "ward.D2", 
           fontsize = 4, 
           annotation_row = clust_annotation,
           annotation_col = clust_annotation, 
           annotation_colors = annotation_colors,
           fontsize_col = 2,
           fontsize_row = 2)

library(ggdendro)
library(dendextend)
dend <- ggdendrogram(cluster_heatmap$tree_row)
ggd1 <- as.dendrogram(cluster_heatmap$tree_row)
ddata <- dendro_data(ggd1, type="rectangle")

ggplot(segment(ddata)) + 
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(aes(x = x, y = y, label = label, angle = -90, hjust = 0), size = 1, data= label(ddata)) +
  scale_y_continuous(expand = c(0.3, 0))+
  theme_dendro() #+ coord_polar(theta="x")

ddata <- dendro_data(dhc, type = "rectangle")

p <- ggplot(segment(ddata)) + 
  geom_segment(aes(x = x, y = y, xend = xend, yend = yend)) + 
  coord_flip() + 
  scale_y_reverse(expand = c(0.2, 0)) +
  theme_dendro()


## Network - SemSim

bubble_dist <- 
  semantic_similarities %>% 
  mutate(cluster_1 = as.character(cluster_1),
         cluster_2 = as.character(cluster_2)) %>% 
  left_join(cluster_annotation, by = c("dataset_id_1" = "dataset_id", "cluster_1" = "cluster")) %>% 
  left_join(cluster_annotation, by = c("dataset_id_2" = "dataset_id", "cluster_2" = "cluster")) %>% 
  ungroup() %>% 
  select( -cluster_j, -cluster_i) %>% 
  rename(dist = value,
         full_annotation_1 = full_annotation.x,
         full_annotation_2 = full_annotation.y) %>% 
  unite(cluster1, dataset_id_1, cluster_1, full_annotation_1) %>% 
  unite(cluster2, dataset_id_2, cluster_2, full_annotation_2) %>% 
  mutate(dist = 1-dist)

bubble_dist %>% 
  ggplot(aes(dist)) +
  geom_density()

bubble_dist %>% 
  filter(cluster1 != cluster2) %>% 
  group_by(cluster1) %>% 
  top_n(1, -dist) %>% 
  arrange(-dist) %>% 
  View
ggplot(aes(dist)) +
  geom_histogram(bins = 100)

bubble_nn_data <- 
  bubble_dist %>%
  filter(dist < 0.5) %>% 
  group_by(cluster1) %>%
  top_n(5, -dist) %>%
  arrange(cluster1)


bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))
bubble_graph %>% 
  ggraph('fabric', sort.by = node_rank_fabric()) + 
  geom_node_range(colour = 'grey') + 
  geom_edge_span(end_shape = 'square') + 
  coord_fixed() +
  theme_void()

bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')


bubble_graph_layout %>% 
  ggraph() + 
  geom_edge_link(color = "gray") +
  geom_node_point(aes(color = dataset_id),
                  size = 3) + 
  theme_void()

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive semsim net.html"))

```

# Test - Cluster overlap - jaccard index

```{r}

comb <- 
  annotation_data %>% 
  select(dataset_id, cluster) %>% 
  unique()

overlap_data <-
  clustering_data %>% 
  left_join(annotation_data) %>% 
  mutate(annotation = paste(Specificity, Function, sep = " - ")) %>% 
  select(-reliability , -Specificity, -Function)

overlap_file <- "data/processed/overlap_results.xlsx"

if(file.exists(overlap_file)) {
  overlap_results <- 
    read_xlsx(overlap_file)
  
} else {
  overlaps <- 
    tidyr::expand(comb,
                  nesting(dataset_id, cluster),
                  nesting(dataset_id_2 = dataset_id, cluster_2 = cluster))   %>% 
    filter(dataset_id != dataset_id_2)  %>% 
    group_by_all() %>% 
    do({
      c_comb <- . 
      cluster_i <- 
        overlap_data %>%  
        filter (dataset_id == c_comb$dataset_id, 
                cluster == c_comb$cluster)
      cluster_j <- 
        overlap_data %>% 
        filter(dataset_id == c_comb$dataset_id_2, 
               cluster ==c_comb$cluster_2)
      
      intersection_clusters <- length(intersect(cluster_i$gene, cluster_j$gene))
      union_clusters <- length(union(cluster_i$gene, cluster_j$gene))
      
      overlap_coefficient <- 
        intersection_clusters / min(unique(cluster_i$ngenes),unique(cluster_j$ngenes))
      
      jaccard_index <- 
        intersection_clusters / union_clusters
      
      data.frame(dataset_i = c_comb$dataset_id, 
                 cluster_i = c_comb$cluster, 
                 annotation_i = unique(cluster_i$annotation),
                 dataset_j = c_comb$dataset_id_2, 
                 cluster_j = c_comb$cluster_2,
                 annotation_j = unique(cluster_j$annotation),
                 intersection = intersection_clusters,
                 union = union_clusters,
                 overlap_coefficient = overlap_coefficient,
                 jaccard_index = jaccard_index)
    })
  overlap_results <- 
    overlaps %>% 
    ungroup %>% 
    select(-dataset_id, -cluster, -dataset_id_2, -cluster_2) %>% 
    arrange(-jaccard_index)
  
  writexl::write_xlsx(overlap_results, overlap_file)
  
}

most_similar <- 
  overlap_results %>% 
  filter(dataset_i != "brain", 
         dataset_j != "brain") %>% 
  group_by(dataset_i, cluster_i) %>% 
  top_n(1, jaccard_index) %>% 
  arrange(dataset_i, as.numeric(cluster_i))


## Network - cluster overlap

jaccard_distances <- 
  overlap_results  %>%
  filter(dataset_i != "brain",
         dataset_j != "brain") %>% 
  mutate(cluster1 = paste(dataset_i, cluster_i, annotation_i, sep = "_"),
         cluster2 = paste(dataset_j, cluster_j, annotation_j, sep = "_")) %>% 
  select(cluster1, cluster2, jaccard_index) %>% 
  pivot_wider(names_from = cluster2, 
              values_from = jaccard_index, values_fill = 0) 

bubble_dist <- 
  jaccard_distances %>% 
  gather(key = cluster2, value = dist, -cluster1)%>% 
  mutate(dist = 1-dist) 


bubble_dist %>% 
  ggplot(aes(dist)) +
  geom_density()

bubble_dist %>% 
  filter(cluster1 != cluster2) %>% 
  group_by(cluster1) %>% 
  top_n(1, -dist) %>% 
  arrange(-dist) %>% 
  # View
  ggplot(aes(dist)) +
  geom_histogram(bins = 100)

bubble_nn_data <- 
  bubble_dist %>%
  filter(dist > 1) %>% 
  group_by(cluster1) %>%
  top_n(5, -dist) %>%
  arrange(cluster1)


bubble_graph <- 
  bubble_nn_data %>% 
  as_tbl_graph() %>% 
  left_join(as_tibble(.) %>% 
              separate(name, into = c("dataset_id", "cluster", "full_annotation"),
                       sep = "_",
                       remove = F))
bubble_graph %>% 
  ggraph('fabric', sort.by = node_rank_fabric()) + 
  geom_node_range(colour = 'grey') + 
  geom_edge_span(end_shape = 'square') + 
  coord_fixed() +
  theme_void()

bubble_graph_layout <- 
  bubble_graph %>% 
  create_layout(layout = 'fr')


bubble_graph_layout %>% 
  ggraph() + 
  geom_edge_link(color = "gray") +
  geom_node_point(aes(color = dataset_id),
                  size = 3) + 
  theme_void()

plot <-
  bubble_graph_layout %>%
  as_tibble() %>% 
  ggplot(aes(x, y, label = full_annotation, color = dataset_id)) +
  geom_segment(data = get_edges()(bubble_graph_layout) %>% 
                 as_tibble(),
               aes(x = x,
                   y = y, 
                   xend = xend, 
                   yend = yend),
               size = 0.2,
               inherit.aes = F) +
  geom_point(size = 5) +
  geom_text(size = 3,
            color = "black") +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_ jaccard_net.html"))

```



# Test - GO UMAP

### Biological processes (BP)

```{r}

#Read data
GO <- 
  enrichment_data %>%
  filter(test_type == "GO_BP_original") %>% 
  select(dataset_id,
         cluster,
         GOID = ID) %>% 
  filter(dataset_id != "brain") %>% 
  unite(cluster, dataset_id, cluster, sep = "_")

GO_sparse <-
  GO %>%
  mutate(value = 1) %>% 
  pivot_wider(names_from = GOID, 
              values_from = value, values_fill = 0)
GO_pca <- 
  GO_sparse %>% 
  column_to_rownames("cluster") %>% 
  pca_calc(npcs = 50)

set.seed(42)
GO_umap <- 
  GO_pca$scores %>%
  as_tibble() %>%
  mutate(cluster = GO_sparse$cluster) %>% 
  select(c(1:50,"cluster")) %>% 
  umap_calc(n_neigh = 5, row_names = "cluster")

features_annotation <- 
  annotation_data %>% 
  mutate(features = paste(dataset_id, cluster, sep = "_"),
         annotation = paste(cluster, Specificity, Function, sep = "_")) %>% 
  select(dataset_id, features, annotation)

lab_data <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  group_by(dataset_id,annotation) %>% 
  summarise(V1 = mean(V1),
            V2 = mean(V2))

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text_repel(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
                  size = 0.8,
                  max.overlaps = 40) +
  scale_color_manual(values = dataset_palette)

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
            size = 1) +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_semsim_UMAP.html"))

ggsave(savepath("semsim_UMAP_nobrain.pdf"))

```
### All (BP, MF, CC)

```{r}

#Read data

assays <- c("GO_BP_original", "GO_MF_original", "GO_CC_original")
GO <- 
  enrichment_data %>%
  filter(test_type %in% assays) %>% 
  select(dataset_id,
         cluster,
         GOID = ID) %>% 
  filter(dataset_id != "brain") %>% 
  unite(cluster, dataset_id, cluster, sep = "_")

GO_sparse <-
  GO %>%
  mutate(value = 1) %>% 
  pivot_wider(names_from = GOID, 
              values_from = value, values_fill = 0)
GO_pca <- 
  GO_sparse %>% 
  column_to_rownames("cluster") %>% 
  pca_calc(npcs = 50)

set.seed(42)
GO_umap <- 
  GO_pca$scores %>%
  as_tibble() %>%
  mutate(cluster = GO_sparse$cluster) %>% 
  select(c(1:50,"cluster")) %>% 
  umap_calc(n_neigh = 5, row_names = "cluster")

features_annotation <- 
  annotation_data %>% 
  mutate(features = paste(dataset_id, cluster, sep = "_"),
         annotation = paste(cluster, Specificity, Function, sep = "_")) %>% 
  select(dataset_id, features, annotation)

lab_data <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  group_by(dataset_id,annotation) %>% 
  summarise(V1 = mean(V1),
            V2 = mean(V2))

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text_repel(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
                  size = 0.8,
                  max.overlaps = 40) +
  scale_color_manual(values = dataset_palette)

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
            size = 1) +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_semsim_UMAP_allGO.html"))

ggsave(savepath("semsim_UMAP_nobrain_allGO.pdf"))
```

### All terms

```{r}

#Read data

GO <- 
  enrichment_data %>%
  #  filter(test_type %in% assays) %>% 
  select(dataset_id,
         cluster,
         GOID = ID) %>% 
  filter(dataset_id != "brain") %>% 
  unite(cluster, dataset_id, cluster, sep = "_")

GO_sparse <-
  GO %>%
  unique() %>% 
  mutate(value = 1) %>% 
  pivot_wider(names_from = GOID, 
              values_from = value, values_fill = 0)
GO_pca <- 
  GO_sparse %>% 
  column_to_rownames("cluster") %>% 
  pca_calc(npcs = 50)

set.seed(42)
GO_umap <- 
  GO_pca$scores %>%
  as_tibble() %>%
  mutate(cluster = GO_sparse$cluster) %>% 
  select(c(1:50,"cluster")) %>% 
  umap_calc(n_neigh = 5, row_names = "cluster")

features_annotation <- 
  annotation_data %>% 
  mutate(features = paste(dataset_id, cluster, sep = "_"),
         annotation = paste(cluster, Specificity, Function, sep = "_")) %>% 
  select(dataset_id, features, annotation)

lab_data <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  group_by(dataset_id,annotation) %>% 
  summarise(V1 = mean(V1),
            V2 = mean(V2))

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text_repel(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
                  size = 0.8,
                  max.overlaps = 40) +
  scale_color_manual(values = dataset_palette)

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
            size = 3) +
  #                  size = 1) +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_semsim_UMAP_all_terms.html"))

ggsave(savepath("semsim_UMAP_nobrain_all_terms.pdf"))

```

### Overlap data

```{r}

#Read data

GO <- 
  enrichment_data %>%
  #  filter(test_type %in% assays) %>% 
  select(dataset_id,
         cluster,
         GOID = ID) %>% 
  filter(dataset_id != "brain") %>% 
  unite(cluster, dataset_id, cluster, sep = "_")

GO_sparse <-
  GO %>%
  unique() %>% 
  mutate(value = 1) %>% 
  pivot_wider(names_from = GOID, 
              values_from = value, values_fill = 0)
GO_pca <- 
  GO_sparse %>% 
  column_to_rownames("cluster") %>% 
  pca_calc(npcs = 50)

set.seed(42)
GO_umap <- 
  GO_pca$scores %>%
  as_tibble() %>%
  mutate(cluster = GO_sparse$cluster) %>% 
  select(c(1:50,"cluster")) %>% 
  umap_calc(n_neigh = 5, row_names = "cluster")

features_annotation <- 
  annotation_data %>% 
  mutate(features = paste(dataset_id, cluster, sep = "_"),
         annotation = paste(cluster, Specificity, Function, sep = "_")) %>% 
  select(dataset_id, features, annotation)

lab_data <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  group_by(dataset_id,annotation) %>% 
  summarise(V1 = mean(V1),
            V2 = mean(V2))

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text_repel(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
                  size = 0.8,
                  max.overlaps = 40) +
  scale_color_manual(values = dataset_palette)

plot <- 
  GO_umap %>%
  left_join(features_annotation) %>% 
  rename(cluster = features) %>% 
  ggplot(aes(V1,V2, group = cluster, color = dataset_id)) +
  geom_point(size = 2) + 
  theme_simple +
  geom_text(inherit.aes = F, data = lab_data, aes(V1, V2, label = annotation),
            size = 3) +
  #                  size = 1) +
  coord_fixed() +
  scale_color_manual(values = dataset_palette)

plot %>% 
  ggplotly() %>% 
  as_widget() %>% 
  htmlwidgets::saveWidget(savepath("interactive_semsim_UMAP_all_terms.html"))

ggsave(savepath("semsim_UMAP_nobrain_all_terms.pdf"))

```


## Test - UMAP from combined dataset expression
```{r}

all_data <-
  readRDS("data/processed/combined_HPA_expression_data.RDS")

all_data <-
  lapply(1:nrow(dataset_metadata),
         function(i) {
           id_ <- paste(dataset_metadata$dataset_id[i],
                        dataset_metadata$type[i],
                        sep = "_")
           all_data[[id_]]
         }) %>%
  set_names(dataset_metadata$dataset_id)

all_data <- all_data[!sapply(all_data,is.null)] 

all_genes_in_data <-
  all_data %>% 
  map(. %>% 
        select(1)) %>% 
  bind_rows() %>% 
  distinct() %>% 
  pull(ensg_id)

gene_max_exp <- 
  all_data %>% 
  map(. %>%
        column_to_rownames("ensg_id") %>% 
        apply(MARGIN = 1,
              max) %>% 
        enframe("ensg_id", "max_exp")) %>% 
  bind_rows(.id = "dataset_id")

expressed_genes <- 
  gene_max_exp %>% 
  filter(max_exp >= 1) %>% 
  select(1, 2)

common_genes <- 
  expressed_genes %>% 
  group_by(ensg_id) %>% 
  summarise(n = n_distinct(dataset_id)) %>% 
  filter(n == 5) %>% 
  pull(ensg_id)


all_data_umap <-
  all_data %>%
  map(. %>%
        gather(sample_id, tmm, -1)) %>%
  bind_rows(.id = "dataset_id") %>%
  inner_join(expressed_genes) %>%
  filter(ensg_id %in% common_genes) %>%
  ungroup() %>%
  select(-dataset_id) %>%
  unique() %>%
  spread(sample_id, tmm, -ensg_id)


all_data_umap <- 
  all_data$blood %>% 
  inner_join(all_data$celline) %>% 
  inner_join(all_data$tissue) %>% 
  inner_join(all_data$singlecell) %>% 
  filter(ensg_id %in% common_genes) 

scaled_data <- 
  scale_data(df = all_data_umap %>%
               gather(sample_id, tmm, -1),
             col_value = "tmm",
             col_gene = "ensg_id", 
             col_sample = "sample_id",
             log_transform = F, 
             scaling = "zscore")

pca_data <- 
  scaled_data %>%
  spread(sample_id, exp) %>% 
  column_to_rownames("ensg_id") %>%
  calculate_pca(npcs = 100)

ncomp <- 
  pca_data$sdev[(pca_data$sdev)^2 >= 1] %>% 
  tail(1) %>%  
  enframe () %$% 
  name

ncomp <- as.numeric(gsub("PC", "", ncomp))

if (pca_data$stats[ncomp, ]$R2cum < 0.8) {
  ncomp <- pca_data$stats %>% 
    filter(R2cum > 0.8) %>% 
    pull(PC) %>% 
    head(1)
}

plot <- 
  pca_data$stats %>%
  ggplot(aes(PC,R2cum)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  theme_bw() +
  geom_vline(xintercept = ncomp, linetype = "dashed") +
  annotate("text",
           x = ncomp,
           y = 0.55,
           label = paste0("PC ", ncomp,
                          "\nR2 = ", round(pca_data$stats[ncomp, ]$R2cum, 3)),
           hjust = 1,
           vjust = 0)

umap_data_all <- 
  pca_data$scores %>% 
  as.data.frame() %>% 
  select(1:ncomp) %>% 
  rownames_to_column("ensg_id") %>% 
  umap_calc(row_names = "ensg_id", n_neigh = 15, n_comp = 2)


plot_data <- 
  clustering_data %>% 
  filter(dataset_id == "singlecell")
umap_data_all %>% 
  left_join(plot_data, by = c("features" = "gene")) %>% 
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(show.legend = F, size = 0.5) +
  coord_fixed() +
  theme_simple +
  scale_color_manual(values =  colorRampPalette(ggthemes::tableau_color_pal(
    palette = "Classic Cyclic")(13))(max(as.numeric(plot_data$cluster))))

umap_data_all %>% 
  left_join(clustering_data %>% 
              filter(dataset_id != "brain"),
            by = c("features" = "gene")) %>% 
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(show.legend = F, size = 0.05) +
  coord_fixed() +
  theme_simple +
  facet_grid(~dataset_id) +
  scale_color_manual(values =  colorRampPalette(ggthemes::tableau_color_pal(
    palette = "Classic Cyclic")(13))(87))


ggsave(savepath("umap_all.pdf"))

```

## Test - Select components 
```{r}
all_data <-
  readRDS("data/processed/combined_HPA_expression_data.RDS")

all_data <-
  lapply(1:nrow(dataset_metadata),
         function(i) {
           id_ <- paste(dataset_metadata$dataset_id[i],
                        dataset_metadata$type[i],
                        sep = "_")
           all_data[[id_]]
         }) %>%
  set_names(dataset_metadata$dataset_id)

all_data <- all_data[!sapply(all_data,is.null)] 

all_genes_in_data <-
  all_data %>% 
  map(. %>% 
        select(1)) %>% 
  bind_rows() %>% 
  distinct() %>% 
  pull(ensg_id)

gene_max_exp <- 
  all_data %>% 
  map(. %>%
        column_to_rownames("ensg_id") %>% 
        apply(MARGIN = 1,
              max) %>% 
        enframe("ensg_id", "max_exp")) %>% 
  bind_rows(.id = "dataset_id")

expressed_genes <- 
  gene_max_exp %>% 
  filter(max_exp >= 1) %>% 
  select(1, 2)

common_genes <- 
  expressed_genes %>% 
  group_by(ensg_id) %>% 
  summarise(n = n_distinct(dataset_id)) %>% 
  filter(n == 5) %>% 
  pull(ensg_id)


all_data_pca <-
  all_data %>%
  map(. %>%
        gather(sample_id, tmm, -1)) %>%
  bind_rows(.id = "dataset_id") %>%
  inner_join(expressed_genes) %>%
  filter(ensg_id %in% common_genes) %>%
  ungroup() %>%
  unique() %>%
  group_by(dataset_id) %>% 
  do({
    dat <- .
    
    scaled_data <- 
      scale_data(df = dat %>% select(-dataset_id),
                 col_value = "tmm",
                 col_gene = "ensg_id", 
                 col_sample = "sample_id",
                 log_transform = F, 
                 scaling = "zscore")
    
    pca_data <- 
      scaled_data %>%
      spread(sample_id, exp) %>% 
      column_to_rownames("ensg_id") %>%
      calculate_pca(npcs = 100)
    
    ncomp <- 
      pca_data$sdev[(pca_data$sdev)^2 >= 1] %>% 
      tail(1) %>%  
      enframe () %$% 
      name
    
    ncomp <- as.numeric(gsub("PC", "", ncomp))
    
    if (pca_data$stats[ncomp, ]$R2cum < 0.8) {
      ncomp <- pca_data$stats %>% 
        filter(R2cum > 0.8) %>% 
        pull(PC) %>% 
        head(1)
    }
    
    plot <- 
      pca_data$stats %>%
      ggplot(aes(PC,R2cum)) +
      geom_point() +
      geom_line() +
      theme_bw() +
      theme_bw() +
      geom_vline(xintercept = ncomp, linetype = "dashed") +
      annotate("text",
               x = ncomp,
               y = 0.55,
               label = paste0("PC ", ncomp,
                              "\nR2 = ", round(pca_data$stats[ncomp, ]$R2cum, 3)),
               hjust = 1,
               vjust = 0)
    
    ggsave(savepath(paste(unique(dat$dataset_id), "PCA.pdf", sep = "_")))
    
    pca_data$scores %>% 
      as.data.frame() %>% 
      rownames_to_column("ensg_id") %>% 
      as_tibble()
  })


to_umap <- 
  all_data_pca %>% 
  select(c(1:22)) %>% 
  ungroup() %>% 
  gather(key = PC, value, PC1:PC20) %>% 
  mutate(key = paste(dataset_id, PC, sep = "_")) %>% 
  select(ensg_id, key, value) %>% 
  spread(key, value, -1)
umap_calc(row_names = "ensg_id", n_neigh = 15, n_comp = 2)


to_umap_pca <- 
  to_umap %>%       
  column_to_rownames("ensg_id") %>%
  calculate_pca(npcs = 100)

ncomp <- 
  to_umap_pca$sdev[(to_umap_pca$sdev)^2 >= 1] %>% 
  tail(1) %>%  
  enframe () %$% 
  name

ncomp <- as.numeric(gsub("PC", "", ncomp))

if (to_umap_pca$stats[ncomp, ]$R2cum < 0.8) {
  ncomp <- to_umap_pca$stats %>% 
    filter(R2cum > 0.8) %>% 
    pull(PC) %>% 
    head(1)
}

plot <- 
  to_umap_pca$stats %>%
  ggplot(aes(PC,R2cum)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  theme_bw() +
  geom_vline(xintercept = ncomp, linetype = "dashed") +
  annotate("text",
           x = ncomp,
           y = 0.55,
           label = paste0("PC ", ncomp,
                          "\nR2 = ", round(to_umap_pca$stats[ncomp, ]$R2cum, 3)),
           hjust = 1,
           vjust = 0)

ggsave(savepath(paste(unique(dat$dataset_id), "PCA.pdf", sep = "_")))



umap_data <- 
  to_umap_pca$scores %>%
  as.data.frame() %>% 
  rownames_to_column("ensg_id") %>% 
  as_tibble() %>% 
  select(c(1:32)) %>% 
  umap_calc(row_names = "ensg_id", n_neigh = 15)


plot_data <- 
  clustering_data %>% 
  filter(dataset_id == "tissue")
umap_data %>% 
  left_join(plot_data, by = c("features" = "gene")) %>% 
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(show.legend = F, size = 0.5) +
  coord_fixed() +
  theme_simple +
  scale_color_manual(values =  colorRampPalette(ggthemes::tableau_color_pal(
    palette = "Classic Cyclic")(13))(max(as.numeric(plot_data$cluster))))


color_dict_cluster <- 
  clustering_data %>% 
  select(-gene) %>% 
  unique() %>% 
  arrange(as.numeric(cluster)) %>% 
  group_by(dataset_id) %>%
  do({
    dat <- .
    n_clusters <- max(as.numeric(dat %>%  pull(cluster)))
    pal <- colorRampPalette(ggthemes::tableau_color_pal(palette = "Classic Cyclic")(13))(n_clusters)
    
    dat %>%  mutate(color_pal = pal)
  })

umap_data %>% 
  left_join(clustering_data %>% 
              filter(dataset_id != "brain"),
            by = c("features" = "gene")) %>% 
  left_join(color_dict_cluster) %>% 
  ggplot(aes(V1, V2, color = color_pal)) +
  geom_point(show.legend = F, size = 0.05) +
  coord_fixed() +
  theme_simple +
  facet_grid(~dataset_id) +
  scale_color_identity()


ggsave(savepath("umap_all_equal_31C.pdf"))



################## Clustered

umap_data %>% 
  left_join(cluster_res %>% 
              rename(cluster = value) %>%  
              mutate (cluster = as.character(cluster)), 
            by = c("features" = "gene")) %>% 
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(show.legend = F, size = 0.5) +
  coord_fixed() +
  theme_simple +
  scale_color_manual(values =  colorRampPalette(ggthemes::tableau_color_pal(
    palette = "Classic Cyclic")(13))(max(as.numeric(30))))


```

## Test - MOFA
```{r}
library(MOFA2)

# NOT POSSIBLE!! WE NEED SAME SAMPLES - different assays

mofa <- 
  all_data %>%
  map(. %>%
        gather(sample_id, tmm, -1)) %>%
  bind_rows(.id = "dataset_id") %>%
  inner_join(expressed_genes) %>% 
  rename(sample = sample_id, value = tmm, view = dataset_id, feature = ensg_id) %>%
  mutate(group = "group1") %>% 
  create_mofa_from_df()

mofa <- 
  all_data %>%
  map(. %>%
        gather(sample_id, tmm, -1)) %>%
  bind_rows(.id = "dataset_id") %>%
  inner_join(expressed_genes) %>% 
  group_by(dataset_id) %>% 
  group_split(.keep = F) %>% 
  set_names(c("immuncells", "brain", "cellines", "singlecell", "tissue")) %>% 
  map(. %>% 
        spread(sample_id, tmm, -1) %>% 
        column_to_rownames("ensg_id") %>% 
        as.matrix()) %>% 
  create_mofa()
# Example file
#file <- system.file("extdata", "test_data.RData", package = "MOFA2")
#load(file)

plot_data_overview(mofa)
data_opts <- get_default_data_options(mofa)

# Model optiona
model_opts <- get_default_model_options(mofa)
model_opts$num_factors <- 15
model_opts

# Training options
train_opts <- get_default_training_options(mofa)
train_opts$convergence_mode <- "slow"
train_opts$seed <- 42

train_opts

# Train the MOFA model
mofa <- prepare_mofa(mofa,
                     data_options = data_opts,
                     model_options = model_opts,
                     training_options = train_opts
)

# Correlation between factors
plot_factor_cor(mofa)

# Plo variance decomposition
# variance decomposition by ffactor 
plot_variance_explained(mofa, max_r2=15)

# Total variance explained per view
plot_variance_explained(mofa, plot_total = T)[[2]]

library(MOFAdata)
data("CLL_data")

```

## Test - Genes classified in same cluster
```{r}

library(factoextra)
library(FactoMineR)

res <- 
  cluster_annotation %>% 
  mutate(full_annotation = paste(cluster, full_annotation, sep = "_")) %>% 
  left_join(clustering_data) %>% 
  select(dataset_id, full_annotation, gene) %>% 
  spread(key = dataset_id, value = full_annotation) %>% 
  na.omit() %>% 
  column_to_rownames("gene") %>% 
  MCA()

fviz_mca(res)
fviz_screeplot(res, addlabels = TRUE, ylim = c(0, 50))



cluster_annotation %>% 
  left_join(clustering_data) %>% 
  select(dataset_id, Specificity, gene) %>% 
  spread(key = dataset_id, value = Specificity) %>% 
  na.omit() %>% 
  select(-brain) %>% 
  mutate(comb = paste(singlecell, tissue, celline, blood,  sep = " - ")) %>% 
  group_by(comb) %>% 
  summarise(n = n_distinct(gene)) %>% 
  arrange(-n) 


cluster_annotation %>% 
  left_join(clustering_data) %>% 
  select(dataset_id, Specificity, gene) %>% 
  spread(key = dataset_id, value = Specificity) %>% 
  na.omit() %>% 
  select(-brain, -celline, -blood) %>% 
  mutate(comb = paste(singlecell, tissue, sep = " - ")) %>% 
  group_by(comb) %>% 
  summarise(n = n_distinct(gene)) %>% 
  arrange(-n) %>% 
  View



cluster_annotation %>% 
  left_join(clustering_data) %>% 
  select(dataset_id, Specificity, gene) %>% 
  spread(key = dataset_id, value = Specificity) %>% 
  na.omit() %>% 
  select(-brain, -tissue, -singlecell) %>% 
  mutate(comb = paste(celline, blood, sep = " - ")) %>% 
  group_by(comb) %>% 
  summarise(n = n_distinct(gene)) %>% 
  arrange(-n) %>% 
  View
# UMAP / PCA with categorical variables

# Sparse matrix

umap_res <- 
  clustering_data %>% 
  mutate(cluster) %>% 
  mutate(id = paste(dataset_id, cluster, sep = "_")) %>% 
  select(gene, id) %>% 
  mutate(value = 1)%>% 
  pivot_wider(names_from = id, 
              values_from = value, values_fill = 0) %>% 
  umap_calc(row_names = "gene", n_neigh = 15)

umap_res %>% 
  left_join(clustering_data %>% 
              filter(dataset_id == "blood"),
            by = c("features" = "gene")) %>% 
  ggplot(aes(V1,V2, color = cluster)) +
  geom_point()



## Categorical clustering

library(cluster)

set.seed(40)

## Per specificity

annotated_genes <- 
  annotation_data %>% 
  left_join(clustering_data) %>%
  filter(dataset_id != "brain") %>% 
  mutate(annotation = paste(cluster, Specificity, sep = "_")) %>% 
  select(dataset_id, gene, annotation) %>% 
  spread(dataset_id, annotation) %>% 
  na.omit()

diss <- 
  annotated_genes %>% 
  mutate(blood = factor(blood, levels = unique(annotated_genes$blood)),
         celline = factor(celline, levels = unique(annotated_genes$celline)),
         singlecell = factor(singlecell, levels = unique(annotated_genes$singlecell)),
         tissue = factor(tissue, levels = unique(annotated_genes$tissue)))%>% 
  column_to_rownames("gene") %>% 
  cluster::daisy(metric = "gower")


library(flashClust)

res <- flashClust(diss, method = "ward", members = NULL)

k <- 30
cluster_res <- res %>% cutree(k) %>% 
  dplyr::as_tibble(rownames = "gene")

annotated_genes %>%  left_join(cluster_res) %>% 
  arrange(-value) %>%  View

```

