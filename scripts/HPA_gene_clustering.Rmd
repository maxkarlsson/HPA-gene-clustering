---
title: "HPA gene clustering"
author: "Max J Karlsson & Mar√≠a Bueno Alvez"
date: "08/06/2021"
output: pdf_document
editor_options: 
  chunk_output_type: console
---

# Setup
```{r setup, include=FALSE}
library(vroom)
library(tidyverse)
library(magrittr)
library(pbapply)
library(uwot)
library(igraph)
library(edgebundle)
library(viridis)
library(pcaMethods)
library(factoextra)
library(Seurat)
library(uwot)
library(plotly)
library(htmlwidgets)
library(aricode)
library(clValid)
library(infotheo)
library(ggheatmap)
library(multidplyr)
library(clue)
library(ggalluvial)



source("scripts/functions_preprocessing.R")
source("scripts/functions_dimensionalityreduction.R")
source("scripts/functions_clustering.R")
source("scripts/functions_evaluation.R")
source("scripts/cluster rasterizer.R")
source("scripts/generate_gene_clusters.R")
source("scripts/functions_utility.R")
source("scripts/functions_classification.R")

```



## Read metadata
```{r}

dataset_metadata <- read_csv("run_settings/20210914_settings.csv")

all_data_meta <- 
  readRDS("data/processed/all_cluster_data_metadata_mockup2.rds")$all_data_meta %>% 
  filter(dataset_id %in% dataset_metadata$dataset_id)

```

## Read data
```{r}

all_data <- 
  readRDS("data/processed/all_cluster_data_mockup2.rds") %>% 
  {.[which(names(.) %in% dataset_metadata$dataset_id)]}

all_genes_in_data <-
  all_data %>% 
  map(. %>% 
        select(1)) %>% 
  bind_rows() %>% 
  distinct() %>% 
  pull(ensg_id)

```

## Read database data

```{r}

# GO annotation
GOterms <- 
  vroom("data/meta/Ensembl103 GO terms.txt") %>% 
  select(ensg_id = 1, 
         gene_name = 2, 
         GO_accession = 3, 
         GO_domain = 4, 
         GO_term_name = 5, 
         GO_term_evidence = 6) %>% 
  filter(ensg_id %in% all_genes_in_data)

db_terms <- read_tsv("data/database_terms.tsv")
  
```

## Settings

```{r}

run_settings <- 
  list(final_consensus_resolutions = 
         list("blood" = 5,
              "brain" = 5,
              "celline_consensus" = 5,
              "singlecell" = 5,
              "tissue" = 5),
       screening_reslutions = seq.int(0.1, 13, by = 0.1))


#saveRDS(run_settings, ".rds")

```


## Color data 

```{r}

dataset_palette <- c("tissue" = "#0083C4", "singlecell" = "#6AA692", "brain" = "#FFDD00", "celline" = "#97CF16", 
                     "celline_consensus" = "#97CF16", "blood" = "#CF161A", "blood_consensus" = "#CF161A")
   
```

## File structure
```{r}

file_structure <-
  create_folder_structure(dataset_id = dataset_metadata$dataset_id,
                          dataset_run_id = dataset_metadata$version,
                          main_folder = "results/Clustering results", # CHANGE TO AVOID SPACES
                          folders = c("svg" = "svg",
                                      "data" = "data",
                                      "treemap" = "svg/treemap",
                                      "heatmap" = "svg/heatmap",
                                      "PCA" = "PCA",
                                      "distance" = "distance",
                                      "graph" = "graph",
                                      "UMAP" = "UMAP",
                                      "enrichment" = "enrichment",
                                      "clustering" = "clustering",
                                      "evaluation" = "evaluation"))

saveRDS(file_structure, "run_settings/file_structure.rds")
```


# Clustering
## Screening clustering
```{r}

# Define which genes are expressed per dataset
gene_max_exp <- 
  all_data %>% 
  map(. %>%
        column_to_rownames("ensg_id") %>% 
        apply(MARGIN = 1,
              max) %>% 
        enframe("ensg_id", "max_exp")) %>% 
  bind_rows(.id = "dataset_id")

expressed_genes <- 
  gene_max_exp %>% 
  filter(max_exp >= 1) %>% 
  select(1, 2)

# Prepare cluster for parallelization
cluster <- new_cluster(n = 6)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "factoextra",
                           "pcaMethods",
                           "Seurat",
                           "magrittr",
                           "cluster",
                           "clValid",
                           "vroom")) 
cluster_copy(cluster, c("HPA_gene_clustering", 
                        "generate_savefile", 
                        "scale_data",
                        "calculate_pca",
                        "calculate_distance",
                        "cluster_genes", 
                        "file_structure"))
####
# (scaling,
#   distance_metric,
#   npcs,
#   log_transform,

t <- Sys.time()
all_data_cluster <- 
  all_data %>% 
  map(. %>% 
        gather(sample_id, tmm, -1)) %>% 
  bind_rows(.id = "dataset_id") %>% 
  inner_join(expressed_genes) %>% 
  group_by(dataset_id) %>%      
  partition(cluster) %>% 
  do({
    g_data <- .
  
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_cluster <- 
      paste(file_structure[[g_dataset_id]]$clustering, "screening_clustering.tsv", sep = "/")
    
    if(file.exists(savefile_cluster)) {
      cluster_res <-
        read_tsv(savefile_cluster)  %>% 
  spread(seed, cluster, sep = "_")
        
    } else {
      savefile_pca = paste(file_structure[[g_dataset_id]]$PCA, "PCA.rds", sep = "/")
      savefile_pca_plot = paste(file_structure[[g_dataset_id]]$PCA, "PCA_plot.pdf", sep = "/")
      savefile_dist = paste(file_structure[[g_dataset_id]]$distance, "distances.rds", sep = "/")
      savefile_neighbors = paste(file_structure[[g_dataset_id]]$graph, "neighbors.rds", sep = "/")
      savefile_data = paste(file_structure[[g_dataset_id]]$data, "data.tsv", sep = "/")
      
      write_tsv(g_data, savefile_data)
      
      cluster_res <-
        HPA_gene_clustering(g_data,
                            col_value = "tmm",
                            col_gene = "ensg_id",
                            col_sample = "sample_id",
                            savefile_pca = savefile_pca,
                            savefile_pca_plot = savefile_pca_plot,
                            savefile_dist = savefile_dist,
                            savefile_neighbors = savefile_neighbors,
                            scaling = "zscore",
                            distance_metric = "spearman",
                            clustering_method = "louvain",
                            seed = 1:100,
                            resolution = seq.int(1, 9.1, by = 0.2), #0.1, 13
                            npcs = 100,
                            log_transform = F) 
      
      cluster_res <- 
        cluster_res$cluster_data %>% 
        mutate(cluster = as.character(cluster + 1))%>%
        group_by(resolution, seed) %>%
        mutate(k = n_distinct(cluster)) %>%
        ungroup() %>%
        group_by(resolution) %>%
        mutate(resolution_k = ceiling(median(k))) %>%
        ungroup() %>%
        filter(resolution_k >= 30,
               resolution_k <= 110) %>%
        select(-k, -resolution_k) %>%
        spread(seed, cluster, sep = "_")
      
      write_tsv(cluster_res, savefile_cluster)
    }
    
    cluster_res
    
  }) %>%
  collect() %>% 
  ungroup()

rm(cluster)
Sys.time() - t
# 
# blood <- vroom("results/Clustering results/blood testv4/clustering/screening_clustering.csv")
#   
# brain <- vroom("results/Clustering results/brain testv4/clustering/screening_clustering.csv")
# tissue <- vroom("results/Clustering results/tissue testv4/clustering/screening_clustering.csv")
# celline <- vroom("results/Clustering results/celline_consensus testv4/clustering/screening_clustering.csv")
# singlecell <- vroom("results/Clustering results/singlecell testv4/clustering/screening_clustering.csv")
# 
# singlecell_w <-
#   singlecell %>%
#   group_by(resolution, seed) %>%
#   mutate(k = n_distinct(cluster)) %>%
#   ungroup() %>%
#   group_by(resolution) %>%
#   mutate(resolution_k = ceiling(median(k))) %>%
#   ungroup() %>%
#   filter(resolution_k >= 30,
#          resolution_k <= 110) %>%
#   select(-k, -resolution_k) %>%
#   spread(seed, cluster, sep = "_")
# 
# write_tsv(singlecell_w, "results/Clustering results/singlecell testv4/clustering/screening_clustering.tsv")

```

## Select resolution range
```{r}

data_cluster <-
  all_data_cluster %>% 
  group_by(dataset_id,resolution, seed) %>% 
  mutate(k = n_distinct(cluster)) %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  mutate(resolution_k = ceiling(median(k))) %>% 
  ungroup() %>% 
  filter(resolution_k >= 30,
         resolution_k <= 110)

### Plot resolution - k range
data_cluster %>% 
  select(dataset_id, resolution, resolution_k) %>% 
  distinct() %>% 
  ggplot(aes(resolution, resolution_k, color = dataset_id)) +
  geom_point() +
  theme_bw() +
  facet_grid(~dataset_id) +
  scale_color_manual(values = dataset_palette)

```

## Consensus clustering 
```{r}
cluster <- new_cluster(n = 5)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr",
                           "clue")) 
cluster_copy(cluster, c("find_consensus", 
                        "to_cluster",
                        "file_structure"))

# For all datasets
all_clusters_consensus <- 
  data_cluster %>% 
  select(-k, -resolution_k) %>% 
  spread(seed, cluster, sep = "_") %>%  
  group_by(dataset_id) %>% 
  partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_cluster <- 
      paste(file_structure[[g_dataset_id]]$clustering, "screening_consensus.tsv", sep = "/")
   # savefile_cluster_mapping <- 
   #   paste(file_structure[[g_dataset_id]]$clustering, "cluster_mapping_screening_consensus.csv", sep = "/")
    
    if(file.exists(savefile_cluster)) {
      consensus <-
        read_tsv(savefile_cluster)
      
    } else {
      
      consensus <- 
        g_data %>% 
        group_by(resolution) %>% 
        #partition(cluster) %>% 
        do({
          dat <- .
          
          ensemble <- lapply(c(1:100), function(x)
            dat %>% 
              select(gene, paste("seed_", x, sep = "")) %>% 
              deframe() %>% 
              as.cl_partition
          ) %>% 
            as.cl_ensemble()
          
          num_clusters <- lapply(c(1:100), function(x)
            dat %>% 
              pull(paste("seed_", x, sep = "")) %>% 
              max()) 
          
          k <- as.numeric(num_clusters) %>% 
            #  quantile(0.25) %>%  
            median() %>% 
            floor()
          
          set.seed(1)
          
          cons_clustering <- cl_consensus(ensemble, 
                                          method = "SE", 
                                          control = list(k = k, 
                                                         nruns = 1, 
                                                         verbose = FALSE)) 
          final_clustering <- 
            cl_class_ids(cons_clustering) %>% 
            enframe(name = "gene", value ="cluster")
          
          empty_clusters <- 
            final_clustering %>% 
            group_by(cluster) %>% 
            mutate(size = n_distinct(gene)) %>% 
            filter(size < 5) %>% 
            select(-size) %>% 
            mutate(cluster = as.numeric(cluster)) 
          
          if(dim(empty_clusters)[1] != 0) {
            to_rename <- 
              empty_clusters %>% 
              group_by(gene) %>% 
              do({
                current <- .
                
                probabilities <- 
                  cons_clustering$.Data[,] %>% 
                  as_tibble(rownames = "gene") %>% 
                  filter(gene == current$gene) %>% 
                  select(-gene) %>% 
                  gather(cluster,probability) %>% 
                  arrange(-probability) %>% 
                  mutate(cluster = as.numeric(sub("V", "", cluster)))
                data.frame(gene = current$gene, 
                           new_cluster = probabilities[[2,1]])
              })
            
            final_clustering_corrected <- 
              final_clustering %>% 
              mutate(cluster = as.numeric(cluster)) %>% 
              left_join(to_rename) %>% 
              mutate(new_cluster = if_else(is.na(new_cluster), cluster, new_cluster))
            
            
            mapping_table <- 
              final_clustering_corrected %>% 
              select(new_cluster) %>% 
              distinct() %>% 
              arrange(new_cluster) %>% 
              rownames_to_column("renumbered_cluster")
            
            final_clustering <- 
              final_clustering_corrected %>% 
              left_join(mapping_table) %>% 
              select(-new_cluster) %>% 
              rename(cons_cluster = cluster,
                     cluster = renumbered_cluster) %>% 
              mutate(cluster = as.character(cluster),
                     cons_cluster = as.character(cons_cluster))
            
          } else {
            final_clustering <- final_clustering %>% 
              mutate(cluster = as.character(cluster), 
                     cons_cluster = cluster)
          }
          
          final_clustering
        }) %>% 
         #collect() %>% 
        ungroup()
      
      write_csv(consensus, savefile_cluster)
      
      consensus
    }
    
  }) %>%  
   collect() %>% 
  ungroup()

rm(cluster)



##############
blood <- read_csv("results/Clustering results/brain testv4/clustering/screening_clustering.csv")

blood %>%
  group_by(resolution, seed, cluster) %>%
  summarize(size = n_distinct(gene)) %>%
  ungroup() %>%
  group_by(resolution, seed) %>%
  summarize(min_size = min(size),
            k = n_distinct(cluster)) %>%
  ungroup() %>%
  filter(k > 30,
         k < 110) %>%
  ggplot(aes(resolution, min_size)) +
  geom_point() +
  theme_bw()

### Select resolution range

blood_selection <- 
  blood %>% 
  group_by(resolution, seed) %>% 
  mutate(k = n_distinct(cluster)) %>% 
  ungroup() %>% 
  group_by(resolution) %>% 
  mutate(resolution_k = ceiling(median(k))) %>% 
  ungroup() %>% 
  filter(resolution_k >= 30,
         resolution_k <= 110)

blood_selction_w <- 
  blood_selection %>% 
  select(-k, -resolution_k) %>% 
  spread(seed, cluster, sep = "_")



### Consensus

cluster <- new_cluster(n = 5)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr",
                           "clue")) 
cluster_copy(cluster, c("find_consensus", 
                        "to_cluster",
                        "file_structure"))

# For all datasets
t <- Sys.time()

blood_selction_consenus <- 
  blood_selction_w %>% 
  filter(resolution %in% c("1.3", "1.5")) %>% 
  group_by(resolution) %>% 
  partition(cluster) %>% 
  do({
    dat <- .
    
    ensemble <- lapply(c(1:100), function(x)
      dat %>% 
        select(gene, paste("seed_", x, sep = "")) %>% 
        deframe() %>% 
        as.cl_partition
    ) %>% 
      as.cl_ensemble()
    
    num_clusters <- lapply(c(1:100), function(x)
      dat %>% 
        pull(paste("seed_", x, sep = "")) %>% 
        max()) 
    
    k <- as.numeric(num_clusters) %>% 
    #  quantile(0.25) %>%  
      median() %>% 
      floor()
    
    set.seed(1)
    
    cons_clustering <- cl_consensus(ensemble, 
                                    method = "SE", 
                                    control = list(k = k, 
                                                   nruns = 1, 
                                                   verbose = FALSE)) 
    final_clustering <- 
      cl_class_ids(cons_clustering) %>% 
      enframe(name = "gene", value ="cluster")
    
    empty_clusters <- 
      final_clustering %>% 
      group_by(cluster) %>% 
      mutate(size = n_distinct(gene)) %>% 
      filter(size < 5) %>% 
      select(-size) %>% 
      mutate(cluster = as.numeric(cluster)) 
    
    if(dim(empty_clusters)[1] != 0) {
      to_rename <- 
        empty_clusters %>% 
        group_by(gene) %>% 
        do({
          current <- .
          
          probabilities <- 
            cons_clustering$.Data[,] %>% 
            as_tibble(rownames = "gene") %>% 
            filter(gene == current$gene) %>% 
            select(-gene) %>% 
            gather(cluster,probability) %>% 
            arrange(-probability) %>% 
            mutate(cluster = as.numeric(sub("V", "", cluster)))
          data.frame(gene = current$gene, 
                     new_cluster = probabilities[[2,1]])
        })
      
      final_clustering_corrected <- 
        final_clustering %>% 
        mutate(cluster = as.numeric(cluster)) %>% 
        left_join(to_rename) %>% 
        mutate(new_cluster = if_else(is.na(new_cluster), cluster, new_cluster))
      
      
      mapping_table <- 
        final_clustering_corrected %>% 
        select(new_cluster) %>% 
        distinct() %>% 
        arrange(new_cluster) %>% 
        rownames_to_column("renumbered_cluster")
      
      final_clustering <- 
        final_clustering_corrected %>% 
        left_join(mapping_table) %>% 
        select(-new_cluster) %>% 
        rename(cons_cluster = cluster,
               cluster = renumbered_cluster) %>% 
        mutate(cluster = as.character(cluster),
               cons_cluster = as.character(cons_cluster))
      
    } else {
      final_clustering <- final_clustering %>% 
        mutate(cluster = as.character(cluster), 
               cons_cluster = cluster)
    }
    
    final_clustering
  }) %>% 
  collect() %>% 
  ungroup()
  
  Sys.time() - t

  
  
final_clustering %>% 
  group_by(cluster) %>% 
  summarize(size = n_distinct(gene)) %>% 
  arrange(size)





################
cluster <- new_cluster(n = 5)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr",
                           "clue")) 
cluster_copy(cluster, c("find_consensus", 
                        "to_cluster",
                        "file_structure"))

# For all datasets
all_clusters_consensus <- 
  data_cluster %>% 
  group_by(dataset_id) %>% 
  #partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_cluster <- 
      paste(file_structure[[g_dataset_id]]$clustering, "screening_consensus.csv", sep = "/")
   # savefile_cluster_mapping <- 
   #   paste(file_structure[[g_dataset_id]]$clustering, "cluster_mapping_screening_consensus.csv", sep = "/")
    
    if(file.exists(savefile_cluster)) {
      consensus <-
        read_csv(savefile_cluster)
      
    } else {
      
      consensus <- 
        g_data %>% 
        group_by(resolution) %>% 
        #partition(cluster) %>% 
        do({
          data <- .
          cons <- find_consensus(data, id = "seed", runs = 5)
          # resolution <- unique(data$resolution)
          # write_csv(cons$mapping_table, paste("resolution", resolution, savefile_cluster_mapping))
          
          cons$consensus_clustering
        }) %>% 
       # collect() %>% 
        ungroup()
            
      write_csv(consensus, savefile_cluster)
      
      consensus
    }
    
  }) %>%  
 # collect()

rm(cluster)

# 


```

# UMAP
## Read graphs
```{r}

all_data_graphs <- 
  file_structure %>% 
  map(function(x)x$graph) %>% 
  lapply(function(filename_) readRDS(paste(filename_, "neighbors.rds", sep = "/")))
```
## Generate UMAP
```{r}

graph_umaps <- 
  names(all_data_graphs) %>% 
  set_names(., .) %>% 
  pblapply(function(dataset_id_) {
    
    graph_ <- all_data_graphs[[dataset_id_]]
    
    savefile_UMAP <- 
      paste(file_structure[[dataset_id_]]$UMAP, "UMAP.tsv", sep = "/")
    
    if(file.exists(savefile_UMAP)) {
      UMAP_res <-
        read_tsv(savefile_UMAP)
      
    } else {
      
      UMAP_res <- 
        graph_$snn %>% 
        RunUMAP(umap.method = "umap-learn") %>% 
        {.@cell.embeddings} %>% 
        as_tibble(rownames = "gene") 
      
      
      UMAP_res_scaled <- 
        UMAP_res %>% 
        gather(UMAP, UMAP_value, UMAP_1, UMAP_2) %>% 
        mutate(UMAP_value = scales::rescale(UMAP_value, c(-1, 1))) %>% 
        group_by(UMAP) %>% 
        mutate(UMAP_value = UMAP_value - mean(range(UMAP_value))) %>% 
        ungroup() %>%
        spread(UMAP, UMAP_value)  
      
      UMAP_res <- 
        UMAP_res %>% 
        left_join(UMAP_res_scaled,
                  by = "gene", 
                  suffix = c("", "_scaled"))
      
      
      write_tsv(UMAP_res, savefile_UMAP)
    }
    
    
  }) %>% 
  bind_rows(.id = "dataset_id")

```



# Evaluation
## ARI
```{r Retrieve partitions for ARI}
ARI_res <- 
  data_cluster %>% 
  group_by(dataset_id) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_ARI <- 
      paste(file_structure[[g_dataset_id]]$evaluation, "ARI.tsv", sep = "/")
    
    if(file.exists(savefile_ARI)) {
      ARI_scores <-
        read_tsv(savefile_ARI)
        
    } else {
      
      g_data <- blood_selection 
      
      ARI_scores <- 
        g_data %>% 
        group_by(resolution) %>% 
        do({
          dat <<- .
          
          combn(1:max(dat$seed), m=2) %>% 
            t() %>% 
            as_tibble() %>% 
            set_names(c("seed1", "seed2")) %>% 
            group_by_all() %>% 
            mutate(ARI = ARI(dat %>% filter(seed == seed1) %>% select(gene,cluster) %>%  deframe(), 
                             dat %>%  filter(seed == seed2) %>% select(gene,cluster) %>%  deframe()))
          
        }) %>% 
        ungroup()
      
      write_tsv(ARI_scores, savefile_ARI)
    }
    
    ARI_scores
  })

```


## MI
```{r Evaluation based on Mutual Information}

MI_GOterms <- 
  GOterms %>%
  filter(!is.na(GO_accession),
         !is.na(GO_domain)) %>%
  distinct() %>% 
  group_by(GO_accession) %>% 
  mutate(n_genes = n_distinct(ensg_id)) %>% 
  ungroup() %>% 
  filter(n_genes <= 500, 
          n_genes >= 10) %>% 
  select(ensg_id,GO_accession,GO_domain)

t <- Sys.time()
worker_cluster <- new_cluster(n = 6)
cluster_library(worker_cluster, c("dplyr",
                                  "tidyverse",
                                  "infotheo"))
cluster_copy(worker_cluster, c("MI_GOterms",
                               "calculate_MI",
                               "file_structure"))
MI_res_consensus <-
  all_clusters_consensus %>%
  group_by(dataset_id) %>%
  partition(worker_cluster) %>%
  do({
    g_data <- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_MIGO <- 
      paste(file_structure[[g_dataset_id]]$evaluation, "MI_GO.tsv", sep = "/")
    
    if(file.exists(savefile_MIGO)) {
      MI_scores <-
        read_tsv(savefile_MIGO)
        
    } else {
      
      MI_scores <- 
        g_data %>% 
        group_by(resolution) %>% 
        
        do({
          g_data <- .
          select(g_data, gene, cluster) %>%
            calculate_MI(., MI_GOterms, nrep = 300)
        }) %>% 
        ungroup()
      
      write_tsv(MI_scores, savefile_MIGO)
    }
    
    MI_scores
  }) %>%
  ungroup() %>%
  collect()
rm(worker_cluster)
gc()

Sys.time() - t

```

```{r Evaluation based on Mutual Information}
# REACTOME

MI_Rterms <- 
  db_terms %>%
  filter(id == "reactome") %>% 
  filter(!is.na(term_id)) %>%
  distinct() %>% 
  group_by(term_id) %>% 
  mutate(n_genes = n_distinct(ensg_id)) %>% 
  ungroup() %>% 
  filter(n_genes <= 500, 
          n_genes >= 10) %>% 
  select(ensg_id,term_id)

t <- Sys.time()
worker_cluster <- new_cluster(n = 6)
cluster_library(worker_cluster, c("dplyr",
                                  "tidyverse",
                                  "infotheo"))
cluster_copy(worker_cluster, c("MI_Rterms",
                               "calculate_MI",
                               "file_structure"))
MI_R_consensus <-
  all_clusters_consensus %>%
  group_by(dataset_id) %>%
  partition(worker_cluster) %>%
  do({
    g_data <- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_MIreactome <- 
      paste(file_structure[[g_dataset_id]]$evaluation, "reactome_GO.csv", sep = "/")
    
    if(file.exists(savefile_MIreactome)) {
      MI_scores <-
        read_csv(savefile_MIreactome)
        
    } else {
      
      MI_scores <- 
        g_data %>% 
        group_by(resolution) %>% 
        
        do({
          g_data <- .
          select(g_data, gene, cluster) %>%
            calculate_MI(., MI_Rterms, nrep = 300)
        }) %>% 
        ungroup()
      
      write_csv(MI_scores, savefile_MIreactome)
    }
    
    MI_scores
  }) %>%
  ungroup() %>%
  collect()
rm(worker_cluster)
gc()

Sys.time() - t

#9.25

g_data <- final_clustering
 

MI_R <-
  blood_selection %>% 
  filter(seed == 1) %>% 
  select(resolution, gene, cluster) %>%
  mutate(cluster = as.character(cluster)) %>%
  group_by(resolution) %>% 
  do({
      calculate_MI_reactome(., MI_Rterms, nrep = 300)
  })

MI_GO <-
  blood_selection %>% 
  filter(seed == 1) %>% 
  select(resolution, gene, cluster) %>%
  mutate(cluster = as.character(cluster)) %>%
  group_by(resolution) %>% 
  do({
      calculate_MI(., MI_GO, nrep = 300)
  })

MI_R %>% 
  ggplot(aes(resolution, z_score)) +
  geom_point()

clust <- blood_selction_consenus %>% filter(resolution == "1.3")
genes <- clust$gene

tissue_terms <- 
  read_tsv("data/meta/consensus_all_category_92.tsv") %>% 
  filter(ensg_id %in% genes) %>%
  separate_rows("enhanced_tissues", sep = ',') %>%
  select(ensg_id,enhanced_tissues) %>%
  remove_missing() %>% 
  rename(term_id = enhanced_tissues)

MI_tissue <-
  blood_selection %>% 
  filter(seed == 1) %>% 
  select(resolution, gene, cluster) %>%
  mutate(cluster = as.character(cluster)) %>%
  group_by(resolution) %>% 
  do({
      calculate_MI_reactome(., tissue_terms, nrep = 300)
  })

 calculate_MI_reactome(clust, tissue_terms, nrep = 300)
 
 MI_tissue %>% 
   ggplot(aes(resolution, z_score)) +
   geom_point()

```


## UMAP - cluster dispersion
```{r}
cluster <- new_cluster(n = 5)

cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr")) 
cluster_copy(cluster, c("file_structure"))

intracluster_distances <- 
  graph_umaps %>% 
  select(-UMAP_1, -UMAP_2) %>% 
  left_join(all_clusters_consensus)%>% 
  group_by(dataset_id) %>% 
  partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    intracluster_dist_file <- 
      paste(file_structure[[g_dataset_id]]$evaluation, "intracluster_distances.tsv", sep = "/")
    
    if(file.exists(intracluster_dist_file)) {
      gene_distances <-
        read_tsv(intracluster_dist_file)
      
    } else {
      
      gene_distances <- 
        g_data %>% 
        group_by(resolution) %>% 
        do({
          dat <<- .
          dat %>% 
            group_by(dataset_id,resolution,cluster) %>% 
            do({
              dat <- .
              dat %>% 
                select(gene,UMAP_1_scaled,UMAP_2_scaled) %>%
                column_to_rownames("gene") %>% 
                dist() %>%
                as.matrix() %>% 
                as_tibble(rownames = "gene1") %>% 
                gather(gene2,dist,-1) %>% 
                filter(gene1 < gene2) %>% 
                summarise(dist = mean(dist), 
                          n_genes = n_distinct(dat$gene))
            })
          
          
          
        }) %>% 
        ungroup()
      
      write_tsv(gene_distances, intracluster_dist_file)
    }
    
    gene_distances %>% 
      group_by(dataset_id,resolution) %>% 
      mutate(total_genes = sum(n_genes)) %>% 
      ungroup() %>% 
      mutate(weighted_dist = dist * n_genes / total_genes) %>%  
      group_by(dataset_id, resolution) %>% 
      mutate(avg_weighted_dist = sum(weighted_dist),
             min_size = min(n_genes),
             max_size = max(n_genes),
             avg_size = mean(n_genes)) %>% 
      ungroup()
    
  }) %>% 
  collect() 

rm(cluster)

#9.06

```
 
## Visualize clustering results
```{r}

resolution_umaps <- 
  names(all_data_graphs) %>% 
  set_names(., .) %>% 
  pblapply(function(dataset_id_) {
    
    umap <- 
      graph_umaps %>% 
      select(-UMAP_1, -UMAP_2) %>% 
      left_join(all_clusters_consensus) %>% 
      filter(dataset_id == dataset_id_)  %>% 
      left_join(intracluster_distances %>% 
                  as_tibble() %>% 
                  filter(dataset_id == dataset_id_) %>% 
              select(dataset_id,resolution, cluster,weighted_dist))
    
    savefile_consensus_UMAP <- 
      paste(file_structure[[dataset_id_]]$evaluation, "consensus_clustering_UMAP.pdf", sep = "/")
    
    if(file.exists(savefile_consensus_UMAP)) {
      break
      
    } else {
      
      pdf(savefile_consensus_UMAP)
      
      plots <- 
        lapply(unique(umap$resolution), function(r) {
          umap %>% 
            filter(resolution == r) %>% 
            arrange(weighted_dist) %>% 
            mutate(cluster = factor(cluster, unique(cluster))) %>% 
            ggplot(aes(x = UMAP_1_scaled, y = UMAP_2_scaled, color = cluster)) +
            geom_hex(data = graph_umaps %>% 
                       filter(dataset_id == dataset_id_), 
                     aes(x = UMAP_1_scaled, y = UMAP_2_scaled), 
                     fill = "grey", 
                     inherit.aes = F,
                     bins = 100) +
            geom_point(size = 0.1, show.legend = F) +
            coord_fixed()+
            facet_wrap(~cluster) +
            theme_void() +
            theme(panel.spacing = unit(0, "mm")) +
            ggtitle(paste(dataset_id_, "dataset: resolution", r))
        })
      
      plots
      dev.off()
    }
  })


    
```



## Summarize evaluation
```{r}

a <- intracluster_distances %>% 
  as_tibble() %>% 
  filter(dataset_id == "blood") %>% 
  select(resolution, avg_weighted_dist) %>% 
  distinct() 

b <- a %>% 
  mutate(index = c(1:length(a$resolution)))

d1 <- diff(b$avg_weighted_dist)
k <- which.max(abs(diff(d1) / diff(b$avg_weighted_dist[-1])))

d1 <- diff(b$avg_weighted_dist)                # first derivative
d2 <- diff(d1) / diff(b$avg_weighted_dist[-1]) # second derivative

knee <- (d2)/((1+(d1)^2)^1.5)
which.min(knee)

```

```{r}
# filt_res <- 
#   data_cluster %>%  
#   select(dataset_id, resolution, resolution_k) %>% 
#   distinct()

p1 <- intracluster_distances %>% 
  as_tibble() %>% 
 # inner_join(filt_res) %>% 
  select(dataset_id,resolution,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = avg_weighted_dist, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +  
  facet_grid(~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette) +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())
  
p2 <- intracluster_distances %>% 
  as_tibble() %>% 
  #inner_join(filt_res) %>% 
  select(dataset_id,resolution, min_size) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = min_size, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +  
  facet_grid(~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
  

p3 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI))%>% 
     # inner_join(filt_res) %>% 
  ggplot(aes(x = resolution, y = ARI_CV, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  scale_color_manual(values = dataset_palette)+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
  
  
p4 <- MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()  %>% 
      #inner_join(filt_res) %>% 
  ggplot(aes(x = resolution, y = avg_MI_zscore, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  scale_color_manual(values = dataset_palette)+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())

p5 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI)) %>% 
  left_join(MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()) %>% 
 # inner_join(filt_res) %>%
  ungroup() %>% 
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_MI_zscore) %>% 
  ggplot(aes(x = resolution, y = value, group = metric, color = metric)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.5,
              color = "black") +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        strip.background = element_blank(),
        strip.text = element_blank())
  
p6 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI)) %>% 
  left_join(MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()) %>% 
  #inner_join(filt_res) %>%
  ungroup() %>% 
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_MI_zscore) %>% 
  group_by(dataset_id, resolution) %>% 
  mutate(avg_value = mean(value)) %>% 
  ggplot(aes(x = resolution, y = avg_value, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.5,
              color = "black") +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  theme(
        strip.background = element_blank(),
        strip.text = element_blank()) +
    scale_color_manual(values = dataset_palette)

p1 / p2 / p3 / p4 / p5 / p6 +
  plot_layout(heights = unit(c(2.5, 2.5, 2.5, 2.5, 2.5, 2.5), "cm"),guides = "collect")


p1 / p2 / p5 / p6+
  plot_layout(heights = unit(c(2.5, 2.5, 2.5, 2.5), "cm"),guides = "collect")
####
p3_2 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_sd = sd(ARI),
            ARI_avg = mean(ARI),
            ARI_CV = sd(ARI) / mean(ARI))%>% 
      inner_join(filt_res) %>% 
  gather(metric, value, ARI_sd:ARI_CV) %>% 
  ggplot(aes(x = resolution_k, y = value, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_grid(metric~dataset_id,scales = "free_y") +
  theme_bw()+
  scale_color_manual(values = dataset_palette)+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())
  
  
p4_2 <- MI_res_consensus %>% 
      inner_join(filt_res) %>% 
  ggplot(aes(x = resolution_k, y = z_score, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_grid(GO_domain~dataset_id, scales = "free_y") +
  theme_bw()+
  scale_color_manual(values = dataset_palette)+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

p1 / p2 / p3_2/ p4_2 / p6+
  plot_layout(heights = unit(c(2, 2, 6, 6, 2), "cm"),guides = "collect")


p4_3 <- MI_res_consensus %>% 
      inner_join(filt_res) %>% 
  ggplot(aes(x = resolution_k, y = z_score, group = GO_domain, color = GO_domain)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_grid(~dataset_id, scales = "free_y") +
  theme_bw()+
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank())

p1 / p2 / p3_2/ p4_3 / p6+
  plot_layout(heights = unit(c(2, 2, 6, 2, 2), "cm"),guides = "collect")


###
p6 <- ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI)) %>% 
  left_join(MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = (zscore - mean(zscore)) / sd(zscore)) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()) %>% 
  inner_join(filt_res) %>%
  ungroup() %>% 
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  (ARI_CV - mean(ARI_CV)) / sd(ARI_CV),
         avg_MI_zscore =  (avg_MI_zscore - mean(avg_MI_zscore)) / sd(avg_MI_zscore)) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_weighted_dist) %>% 
  ggplot(aes(x = resolution, y = value, group = metric, color = metric)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()
  
  
p5 / p6

## ZSCORES

p1 <- eval_gene_distances %>% 
  inner_join(filt_res) %>% 
  select(dataset_id,resolution,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = avg_weighted_dist, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +  
  facet_grid(~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  
p2 <- eval_gene_distances %>% 
  inner_join(filt_res) %>% 
  select(dataset_id,resolution, min_size) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = min_size, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +  
  facet_grid(metric~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  
  
p3 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI))%>% 
  ggplot(aes(x = resolution, y = ARI_CV, color = dataset_id)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  scale_color_manual(values = dataset_palette)
  
  
p4 <- MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()  %>% 
  ggplot(aes(x = resolution, y = avg_MI_zscore, color = dataset_id)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()+
  scale_color_manual(values = dataset_palette)

p5 <-  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI)) %>% 
  left_join(MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()) %>% 
  inner_join(filt_res) %>%
  ungroup() %>% 
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_weighted_dist) %>% 
  ggplot(aes(x = resolution, y = value, group = metric, color = metric)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()
  
  
p1 / p2 / p3 / p4 / p5 +
  plot_layout(heights = unit(c(2.5, 2.5, 2.5, 2.5), "cm"))

####






filt_res <- 
  data_cluster %>%  
  select(dataset_id, resolution, resolution_k) %>% 
  distinct()

all_metrics <- 
  ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_CV = sd(ARI) / mean(ARI)) %>% 
  left_join(MI_res_consensus %>% 
              select(-MI, -mean_MI, -sd_MI) %>% 
              group_by(dataset_id,GO_domain) %>% 
              mutate(z_score = scales::rescale(z_score, to = c(0,1))) %>% 
              ungroup() %>% 
              group_by(dataset_id, resolution) %>% 
              mutate(avg_MI_zscore = mean(z_score)) %>% 
              select(-GO_domain, -z_score) %>% 
              distinct()) %>% 
  left_join(intracluster_distances %>% 
              as_tibble() %>% 
              select(dataset_id, resolution, avg_weighted_dist) %>% 
              distinct()) %>% 
    inner_join(filt_res) 

all_metrics %>%
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_weighted_dist =  scales::rescale(avg_weighted_dist, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_weighted_dist) %>% 
  ggplot(aes(x = resolution, y = value, group = metric, color = metric)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()

avg_plot <- 
  all_metrics %>%
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_weighted_dist =  scales::rescale(avg_weighted_dist, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_weighted_dist) %>% 
  group_by(dataset_id,resolution) %>% 
  mutate(avg_score = mean(value)) %>%
  ungroup() %>% 
  select(-value) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution_k, y = avg_score, group = metric, color = metric)) +
  geom_point() +
  geom_smooth(method = "loess", 
              span = 0.5) +
  facet_wrap(~dataset_id, ncol=5) +
  theme_bw()



# Ranking
all_metrics %>%
  group_by(dataset_id) %>% 
  mutate(ARI_CV =  scales::rescale(ARI_CV, to = c(1,0)),
         avg_weighted_dist =  scales::rescale(avg_weighted_dist, to = c(1,0)),
         avg_MI_zscore =  scales::rescale(avg_MI_zscore, to = c(0,1))) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_CV:avg_weighted_dist) %>% 
  group_by(dataset_id,resolution) %>% 
  mutate(avg_score = mean(value)) %>%
  ungroup() %>% 
  group_by(dataset_id) %>% 
  top_n(avg_score, n = 1) %>% 
  spread(key = metric, value = value)

#Cluster sizes
intracluster_distances %>% 
  as_tibble() %>% 
  select(dataset_id, resolution, cluster, n_genes, min_size, max_size) %>% 
  arrange(n_genes)
  ggplot(aes(x = resolution, y = n_genes, group = resolution)) +
  geom_violin() +
  facet_wrap(~dataset_id, ncol = 5)


ARI_res %>% 
  inner_join(filt_res) %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_mean = mean(ARI),
            ARI_sd = sd(ARI),
            CV = ARI_sd / ARI_mean,
            resolution_k) %>% 
  gather(metric, value, ARI_mean:CV) %>% 
  ggplot(aes(x = resolution_k, y = value)) +
  geom_point() +
  geom_smooth(method = "loess", 
              span = 0.25) +
  facet_grid(metric~dataset_id, scale = "free")



p1 <- ARI_res %>% 
  ungroup() %>% 
  inner_join(filt_res) %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_mean = mean(ARI),
            ARI_sd = sd(ARI),
            CV = ARI_sd / ARI_mean) %>% 
  ungroup() %>% 
  gather(metric, value, ARI_mean:CV) %>% 
  ggplot(aes(resolution, value, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_grid(metric~dataset_id, scales = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)  #+
# ggtitle("Replicate clustering stability")

p2 <- MI_res_consensus %>%
  inner_join(filt_res) %>% 
  ggplot(aes(resolution, z_score, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_grid(GO_domain ~ dataset_id, scales = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)

p3 <- eval_gene_distances %>% 
  inner_join(filt_res) %>% 
  select(dataset_id,resolution,avg_weighted_dist, min_size) %>% 
  gather(metric, value, avg_weighted_dist:min_size) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = value, color = dataset_id)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +  
  facet_grid(metric~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)


p1 / p2 / p3 +
  plot_layout(heights = unit(c(7.5, 7.5, 5), "cm"))









########## 
p1 <- ARI_res %>% 
  ungroup() %>% 
  group_by(dataset_id, resolution) %>% 
  summarise(ARI_mean = mean(ARI),
            ARI_sd = sd(ARI),
            CV = ARI_sd / ARI_mean) %>% 
  ungroup() %>% 
  ggplot(aes(resolution, CV)) +
  geom_point() +
  geom_smooth() +
  facet_wrap(~dataset_id, ncol = 5)

  ggplot(aes(resolution, ARI, color = dataset_id, group = dataset_id)) +
  geom_point(data = . %>% 
               group_by(dataset_id, resolution) %>%
               summarise(ARI = mean(ARI))) +
  # geom_boxplot(aes(group = resolution), color = "black") +
  # geom_line(color = "black") + 
  geom_segment(data = ARI_res %>% 
                 group_by(dataset_id, resolution) %>% 
                 summarise(ARI_mean = mean(ARI),
                           ARI_sd = sd(ARI)) %>% 
                 ungroup() %>% 
                 mutate(min_y = ARI_mean - 2*ARI_sd,
                        max_y = ARI_mean + 2*ARI_sd) %>% 
                 distinct(),
               aes(x = resolution, xend = resolution,
                   y = min_y, yend = max_y)) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol = 6)  +
  theme_bw() +
  scale_color_manual(values = dataset_palette)  #+
 # ggtitle("Replicate clustering stability")

p2 <- MI_res_consensus %>%
  ggplot(aes(resolution, z_score, color = GO_domain)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +
  facet_grid( ~ dataset_id, scales = "free_y") + # GO_domain
  theme_bw() #+
  #ggtitle("Mutual information")


p3 <- eval_gene_distances %>% 
  select(-dist,-n_genes,-total_genes, -weighted_dist, -avg_weighted_dist) %>% 
  select(-cluster) %>% 
  distinct() %>% 
  gather(metric, value, min_size, max_size, avg_size) %>% 
  ggplot(aes(x = resolution, y = value, color = metric)) +
  geom_point() +
  geom_smooth() +
  theme_bw() +
  facet_grid(~dataset_id)

p4 <- eval_gene_distances %>% 
  select(dataset_id,resolution,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = avg_weighted_dist, color = dataset_id)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +  
  facet_grid(~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  
p1 / p2 / p3 / p4

## Resolutions SEPARATED

p1 <- ARI_res %>% 
  
  ggplot(aes(resolution, ARI, color = dataset_id, group = dataset_id)) +
  geom_point(data = . %>% 
               group_by(dataset_id, resolution) %>%
               summarise(ARI = mean(ARI))) +
  # geom_boxplot(aes(group = resolution), color = "black") +
  # geom_line(color = "black") + 
  geom_segment(data = ARI_res %>% 
                 group_by(dataset_id, resolution) %>% 
                 summarise(ARI_mean = mean(ARI),
                           ARI_sd = sd(ARI)) %>% 
                 ungroup() %>% 
                 mutate(min_y = ARI_mean - 2*ARI_sd,
                        max_y = ARI_mean + 2*ARI_sd),
               aes(x = resolution, xend = resolution,
                   y = min_y, yend = max_y)) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol = 6)  +
  theme_bw() +
  scale_color_manual(values = dataset_palette)  #+
 # ggtitle("Replicate clustering stability")

p2 <- MI_res_consensus %>%
  ggplot(aes(resolution, z_score, color = GO_domain)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +
  facet_grid(GO_domain ~ dataset_id, scales = "free") + # GO_domain
  theme_bw() #+
  #ggtitle("Mutual information")


p3 <- eval_gene_distances %>% 
  select(-dist,-n_genes,-total_genes, -weighted_dist, -avg_weighted_dist) %>% 
  select(-cluster) %>% 
  distinct() %>% 
  gather(metric, value, min_size, max_size, avg_size) %>% 
  ggplot(aes(x = resolution, y = value, color = metric)) +
  geom_point() +
  geom_smooth() +
  theme_bw() +
  facet_grid(metric~dataset_id, scale = "free")

p4 <- eval_gene_distances %>% 
  select(dataset_id,resolution,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = resolution, y = avg_weighted_dist, color = dataset_id)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +  
  facet_grid(~dataset_id, scale = "free_y") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  


p1 / p2 / p3 / p4 +
  plot_layout(heights = unit(c(2.5, 7.5, 7.5, 2.5), "cm"))


## Number of clusters

num_clusters <- 
  eval_gene_distances %>% 
  select(dataset_id, resolution,cluster) %>% 
  group_by(dataset_id,resolution) %>% 
  summarize(k = n_distinct(cluster)) 

num_clusters %>% 
  ggplot(aes(resolution, k, color = dataset_id)) +
  geom_point(show.legend = F) +
  facet_grid(~dataset_id) +
  theme_bw() +
  scale_color_manual(values = dataset_palette)

#write_csv(num_clusters, "num_clusters.csv")

p1 <- ARI_res %>% 
  left_join(num_clusters) %>% 
  group_by(dataset_id, resolution) %>%
  mutate(k= median(k)) %>% 
  summarise(ARI = mean(ARI), k) %>% 
  distinct() %>% 
  ggplot(aes(k, ARI, color = dataset_id, group = dataset_id)) +
  geom_point() + 
  geom_segment(data = ARI_res %>% 
                 left_join(num_clusters) %>% 
                 group_by(dataset_id, resolution) %>% 
                   mutate(k= median(k)) %>% 
                 summarise(ARI_mean = mean(ARI),
                           ARI_sd = sd(ARI),
                           k) %>% 
                 ungroup() %>% 
                 mutate(min_y = ARI_mean - 2*ARI_sd,
                        max_y = ARI_mean + 2*ARI_sd),
               aes(x = k, xend = k,
                   y = min_y, yend = max_y)) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol = 6, scale = "free_x")  +
  theme_bw() +
  scale_color_manual(values = dataset_palette)  #+
# ggtitle("Replicate clustering stability")

p2 <- MI_res_consensus %>%
  left_join(num_clusters) %>% 
  ggplot(aes(k, z_score, color = GO_domain)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +
  facet_grid( ~ dataset_id, scales = "free_x") + # GO_domain
  theme_bw() #+
  #ggtitle("Mutual information")


p3 <- eval_gene_distances %>% 
  left_join(num_clusters) %>% 
  select(-dist,-n_genes,-total_genes, -weighted_dist, -avg_weighted_dist) %>% 
  select(-cluster) %>% 
  distinct() %>% 
  gather(metric, value, min_size, max_size, avg_size) %>% 
  ggplot(aes(x = k, y = value, color = metric)) +
  geom_point() +
  geom_smooth() +
  theme_bw() +
  facet_grid(~dataset_id, scale = "free_x")

p4 <- eval_gene_distances %>% 
  left_join(num_clusters) %>% 
  select(dataset_id,k,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = k, y = avg_weighted_dist, color = dataset_id)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +  
  facet_grid(~dataset_id, scale = "free_x") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  

p1 / p2 / p3 / p4





## Number of clusters - SEPARATED

num_clusters <- 
  eval_gene_distances %>% 
  select(dataset_id, resolution,cluster) %>% 
  group_by(dataset_id,resolution) %>% 
  summarize(k = n_distinct(cluster)) 

p1 <- ARI_res %>% 
  left_join(num_clusters) %>% 
  group_by(dataset_id, resolution) %>%
  mutate(k= median(k)) %>% 
  summarise(ARI = mean(ARI), k) %>% 
  distinct() %>% 
  ggplot(aes(k, ARI, color = dataset_id, group = dataset_id)) +
  geom_point() + 
  geom_segment(data = ARI_res %>% 
                 left_join(num_clusters) %>% 
                 group_by(dataset_id, resolution) %>% 
                   mutate(k= median(k)) %>% 
                 summarise(ARI_mean = mean(ARI),
                           ARI_sd = sd(ARI),
                           k) %>% 
                 ungroup() %>% 
                 mutate(min_y = ARI_mean - 2*ARI_sd,
                        max_y = ARI_mean + 2*ARI_sd),
               aes(x = k, xend = k,
                   y = min_y, yend = max_y)) +
  geom_smooth(method = "loess", 
              span = 0.25,
              color = "black") +
  facet_wrap(~dataset_id, ncol = 6, scale = "free_x")  +
  theme_bw() +
  scale_color_manual(values = dataset_palette)  #+
# ggtitle("Replicate clustering stability")

p2 <- MI_res_consensus %>%
  left_join(num_clusters) %>% 
  ggplot(aes(k, z_score, color = GO_domain)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +
  facet_grid(GO_domain ~ dataset_id, scales = "free") + # GO_domain
  theme_bw() #+
  #ggtitle("Mutual information")


p3 <- eval_gene_distances %>% 
  left_join(num_clusters) %>% 
  select(-dist,-n_genes,-total_genes, -weighted_dist, -avg_weighted_dist) %>% 
  select(-cluster) %>% 
  distinct() %>% 
  gather(metric, value, min_size, max_size, avg_size) %>% 
  ggplot(aes(x = k, y = value, color = metric)) +
  geom_point() +
  geom_smooth() +
  theme_bw() +
  facet_grid(metric~dataset_id, scale = "free")

p4 <- eval_gene_distances %>% 
  left_join(num_clusters) %>% 
  select(dataset_id,k,avg_weighted_dist) %>% 
  distinct() %>% 
  ggplot(aes(x = k, y = avg_weighted_dist, color = dataset_id)) +
  geom_point() +
  geom_smooth(method = "loess",
              span = 0.25) +  
  facet_grid(~dataset_id, scale = "free_x") +
  theme_bw() +
  scale_color_manual(values = dataset_palette)
  

p1 / p2 / p3 / p4 +
  plot_layout(heights = unit(c(2.5, 7.5, 7.5, 2.5), "cm"))




###################

# Change UMAP step in the pipeline to add evaluation
umaps_scaled_clusterings <- 
  all_graph_umap_data_scaled %>% 
  left_join(all_data_cluster %>% 
  filter(dataset_id %in% c("blood", "brain", "singlecell", "tissue", "celline_consensus")))

umap_dist <- 
  umaps_scaled_clusterings %>% 
  group_by(dataset_id,resolution,cluster,seed) %>% 
  do({
    dat <<- .
    
    dat %>% 
      select(gene,UMAP_1,UMAP_2) %>%
      column_to_rownames("gene") %>% 
      dist() %>%
      as.matrix() %>% 
      as_tibble(rownames = "gene1") %>% 
      gather(gene2,dist,-1) %>% 
      filter(gene1 < gene2) %>% 
      summarise(dist = mean(dist), 
                n_genes = n_distinct(dat$gene))
  })

plot_data <- 
  umap_dist %>% 
  group_by(dataset_id,resolution) %>% 
  mutate(total_genes = sum(n_genes)) %>% 
  ungroup() %>% 
  mutate(weighted_dist = dist * n_genes / total_genes)
  
plot_data %>% 
  group_by(dataset_id,resolution) %>% 
  summarise(mean_dist = mean(dist, na.rm = T), 
            max_dist = max(dist, na.rm = T),
            intracluster_dist = sum(weighted_dist, na.rm = T)) %>% 
  gather(metric, value, mean_dist, max_dist, intracluster_dist) %>% 
  ggplot(aes(x = resolution, y = value)) +
  geom_point() +
  geom_smooth() +
  facet_grid(metric ~ dataset_id, scale = "free_y")

plot_data %>% 
  group_by(dataset_id,resolution) %>% 
  summarise(mean_dist = mean(dist, na.rm = T), 
            max_dist = max(dist, na.rm = T),
            intracluster_dist = sum(weighted_dist, na.rm = T)) %>% 
  ggplot(aes(mean_dist, intracluster_dist, color = dataset_id)) +
  geom_point() +
  geom_abline() +
  coord_fixed()


# Evaluation summary (stability, number of clusters, MI, UMAP)
all_data_cluster %>% 
  group_by(dataset_id, resolution) %>%  
  summarize(k = max(cluster)) %>% 
  left_join(ARI_res %>% select(-seed1,-seed2)) %>% 
  gather(key="measure", value = "value", -dataset_id, -resolution) %>%
  distinct() %>% 
  full_join(all_data_cluster_MI %>% 
              select(-MI,-mean_MI,-sd_MI, -seed) %>% 
              mutate(GO_domain = paste("MI_", GO_domain, "")) %>% 
              rename(measure = GO_domain,
                     value = z_score)) %>% 
  # Manually filter current datasets
  filter(dataset_id %in% c("blood", "brain", "celline_consensus", "singlecell", "tissue")) %>% 
  ggplot(aes(x = resolution, y = value, color = dataset_id)) +
  geom_point(size = 0.5) +
  geom_smooth() +
  theme_bw() +
  facet_grid(measure~dataset_id, scales = "free_y") +
  scale_color_manual(values = dataset_palette) 

ggsave("eval_MI_BP_MF_CC_allseeds_HPAcolors.pdf",
       width = 10, height = 10)

```




# Final clustering
## Manual selection & run seeds
```{r}
# Prepare cluster for parallelization
cluster <- new_cluster(n = 6)

cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "factoextra",
                           "pcaMethods",
                           "Seurat",
                           "magrittr",
                           "cluster",
                           "clValid")) 
cluster_copy(cluster, c("HPA_gene_clustering", 
                        "generate_savefile", 
                        "scale_data",
                        "calculate_pca",
                        "calculate_distance",
                        "cluster_genes", 
                        "run_settings",
                        "file_structure"))
t <- Sys.time()

final_clusterings <- 
  all_data %>% 
  map(. %>% 
        gather(sample_id, tmm, -1)) %>% 
  bind_rows(.id = "dataset_id") %>% 
  inner_join(expressed_genes) %>% 
  group_by(dataset_id) %>%      
  partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_cluster <- 
      paste(file_structure[[g_dataset_id]]$clustering, "final_clustering.csv", sep = "/")
    
    if(file.exists(savefile_cluster)) {
      cluster_res <-
        read_csv(savefile_cluster)
        
    } else {
      savefile_pca = paste(file_structure[[g_dataset_id]]$PCA, "PCA.rds", sep = "/")
      savefile_pca_plot = paste(file_structure[[g_dataset_id]]$PCA, "PCA_plot.pdf", sep = "/")
      savefile_dist = paste(file_structure[[g_dataset_id]]$distance, "distances.rds", sep = "/")
      savefile_neighbors = paste(file_structure[[g_dataset_id]]$graph, "neighbors.rds", sep = "/")
      
      
      cluster_res <-
        HPA_gene_clustering(g_data,
                            col_value = "tmm",
                            col_gene = "ensg_id",
                            col_sample = "sample_id",
                            savefile_pca = savefile_pca,
                            savefile_pca_plot = savefile_pca_plot,
                            savefile_dist = savefile_dist,
                            savefile_neighbors = savefile_neighbors,
                            scaling = "zscore",
                            distance_metric = "spearman",
                            clustering_method = "louvain",
                            seed = 1:100,
                            resolution = run_settings$final_consensus_resolutions[[g_dataset_id]],
                            npcs = 100,
                            log_transform = F) 
      
      cluster_res <- 
        cluster_res$cluster_data %>% 
        mutate(cluster = as.character(cluster + 1))
      
      write_csv(cluster_res, savefile_cluster)
    }
    
    cluster_res
    
  }) %>%
  collect() %>% 
  ungroup()

rm(cluster)
Sys.time() - t

```


## Consensus clustering
```{r}
cluster <- new_cluster(n = 5)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr",
                           "clue")) 
cluster_copy(cluster, c("find_consensus", 
                        "to_cluster",
                        "run_settings",
                        "file_structure"))

t <- Sys.time()
# For all datasets
final_clusterings_consensus <- 
  final_clusterings %>% 
  group_by(dataset_id) %>% 
  partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_cluster <- 
      paste(file_structure[[g_dataset_id]]$clustering, "final_consensus.csv", sep = "/")
    savefile_membership_matrix <- 
      paste(file_structure[[g_dataset_id]]$clustering, "cluster_membership.csv", sep = "/")
    savefile_cluster_mapping <- 
      paste(file_structure[[g_dataset_id]]$clustering, "cluster_mapping_final_consensus.csv", sep = "/")
    
    if(file.exists(savefile_cluster)) {
      consensus <-
        read_csv(savefile_cluster)
      
    } else {
      
      consensus <- 
        g_data %>% 
        find_consensus(., id = "seed", runs = 5, get_membership = T) 
      
      write_csv(consensus$consensus_clustering, savefile_cluster)
      write_csv(consensus$mapping_table, savefile_cluster_mapping)
      write_csv(consensus$membership_matrix, savefile_membership_matrix)
      
      consensus <- consensus$consensus_clustering
    }
    consensus
  }) %>% 
  ungroup() %>% 
  collect()

rm(cluster)
Sys.time() - t


final_clusterings_consensus %>% 
  group_by(dataset_id,cluster) %>% 
  summarize(a = n_distinct(gene)) %>% 
  arrange(a)

```

## Generate hulls
```{r}

umap_clusteirng <- 
  graph_umaps %>% 
  select(-UMAP_1,- UMAP_2) %>% 
  left_join(final_clusterings_consensus %>%  
              select(-cluster_cons))

cluster <- new_cluster(n = 5)
cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "magrittr",
                           "fpc",
                           "concaveman",
                           "sf")) 
cluster_copy(cluster, c("generate_cluster_hulls", 
                        "file_structure",
                        "get_density"))

# For all datasets
graph_umaps_hulls <- 
  umap_clusteirng %>% 
  group_by(dataset_id) %>% 
  partition(cluster) %>% 
  do({
    g_data <<- .
    
    g_dataset_id <- 
      unique(g_data$dataset_id)
    
    savefile_UMAP_hulls <- 
      paste(file_structure[[g_dataset_id]]$UMAP, "UMAP_hulls.csv", sep = "/")
    
    if(file.exists(savefile_UMAP_hulls)) {
      UMAP_hulls <-
        read_csv(savefile_UMAP_hulls)
      
    } else {
      
      UMAP_hulls <- 
        g_data %$%
        generate_cluster_hulls(UMAP_1_scaled,
                               UMAP_2_scaled, 
                               element_id = gene,
                               cluster_membership = factor(cluster), 
                               bandwidth_fct = 5,
                               n = 1000)
      
      hulls <- UMAP_hulls$hulls 
      write_csv(hulls, savefile_UMAP_hulls)
    }
  }) %>% 
  ungroup() %>% 
  collect()

rm(cluster)


graph_umaps_hulls %>% 
  filter(density_type == "primary secondary") %>%
  ggplot(aes(X,Y, group = paste(cluster, sub_cluster, landmass), fill = as.factor(cluster))) +
  geom_polygon(show.legend = F,
               color = "black") +
  theme_bw() +
  facet_grid(~dataset_id) +
  coord_fixed()

ggsave(run_id_savename("UMAP scaled hulls.pdf"),
       width = 8, height = 5)

```















# UMAP
## Read graphs
```{r}

all_data_graphs <- 
  file_structure %>% 
  map(function(x)x$graph) %>% 
  lapply(function(filename_) readRDS(paste(filename_, "neighbors.rds", sep = "/")))
```
## Generate UMAP


```{r}
UMAP_file <- 
  paste0("data/processed/", run_id, "_UMAPs.rds")

if(file.exists(UMAP_file)) {
  all_graph_umaps <- 
    readRDS(UMAP_file)
} else {
  
  all_graph_umaps <- 
    all_data_graphs[-5]%>% # cell line graph - ERROR
    pblapply(function(graph_) {
      graph_$snn %>% 
        RunUMAP(umap.method = "umap-learn") %>% 
        {.@cell.embeddings} %>% 
        as_tibble(rownames = "gene") 
    }) %>% 
    bind_rows(.id = "dataset_id")
  
  saveRDS(all_graph_umaps, UMAP_file)
}

final_cluster <- all_consensus %>% 
  filter(dataset_id != "celline") #resolution == 4, seed == 1
  

all_graph_umap_data <- 
  all_graph_umaps %>% 
  left_join(final_cluster) 

all_graph_umaps <- 
    all_data_graphs[[5]]$snn %>% 
        RunUMAP(umap.method = "umap-learn") %>% 
        {.@cell.embeddings} %>% 
        as_tibble(rownames = "gene") 


all_graph_umap_data %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = as.factor(cluster))) +
  geom_point(show.legend = F,
             size = 0.1) +
  facet_grid(~dataset_id) +
  coord_fixed() +
  theme_bw() + 
  scale_color_manual(values = cluster_palette75) +
ggsave(run_id_savename("UMAP.pdf"),
       width = 8, height = 5)

# Scale and center UMAP coordinates:
all_graph_umap_data_scaled <- 
  all_graph_umaps %>% 
  gather(UMAP, UMAP_value, UMAP_1, UMAP_2) %>% 
  group_by(dataset_id) %>% 
  mutate(UMAP_value = scales::rescale(UMAP_value, c(-1, 1))) %>% 
  group_by(dataset_id, UMAP) %>% 
  mutate(UMAP_value = UMAP_value - mean(range(UMAP_value))) %>% 
  ungroup() %>%
  spread(UMAP, UMAP_value)

all_graph_umap_data_scaled %>% 
  ggplot(aes(UMAP_1, UMAP_2, color = as.factor(cluster))) +
  geom_point(show.legend = F,
             size = 0.1) +
  facet_grid(resolution~dataset_id) +
  coord_fixed() +
  theme_bw() + 
  scale_color_manual(values = cluster_palette100)
ggsave(run_id_savename("UMAP scaled.pdf"),
       width = 8, height = 5)


all_graph_umap_data_scaled %>% 
  ggplot(aes(UMAP_1, UMAP_2)) +
  geom_hex(aes(fill = stat(log10(count))),
           bins = 100) +
  facet_grid(~dataset_id) +
  coord_fixed() +
  theme_bw() + 
  scale_fill_viridis()


all_graph_umap_data_scaled %>% 
  ggplot(aes(UMAP_1, UMAP_2)) +
  geom_density_2d_filled(aes(fill = ifelse(unclass(..level..) < 5, 
                                           NA, 
                                           ..level..)), 
                         bins = 100, n = 100, 
                         h = 0.004) +
  facet_grid(~dataset_id) +
  coord_fixed() +
  theme_void() +
  scale_fill_viridis(name = "%", 
                     na.value = NA)

all_graph_umap_data_scaled %>% 
  ggplot(aes(UMAP_1, UMAP_2)) +
  geom_density_2d_filled(aes(fill = ifelse(unclass(..level..) < 5, 
                                           NA, 
                                           ..level..)), 
                         bins = 100, n = 100, 
                         h = 0.004 * 20) +
  facet_grid(~dataset_id) +
  coord_fixed() +
  theme_void() +
  scale_fill_viridis(name = "%", 
                     na.value = NA)

```


## Generate hulls

```{r}

UMAP_hull_file <- 
  paste0("data/processed/", run_id, "_UMAP_hulls.rds")

if(file.exists(UMAP_hull_file)) {
  all_graph_umap_hulls <- 
    readRDS(UMAP_hull_file)
} else {
  
  all_graph_umap_hulls <- 
    all_graph_umap_data_scaled %>% 
    select(dataset_id) %>% 
    distinct() %>% 
    # slice(6) %>% 
    # slice(1, 4, 6) %>% 
    pull(dataset_id) %>%
    set_names(., .) %>% 
    pblapply(function(dataset_id_) {
      all_graph_umap_data_scaled %>% 
        filter(dataset_id == dataset_id_) %$%
        generate_cluster_hulls(UMAP_1,
                               UMAP_2, 
                               element_id = gene,
                               cluster_membership = factor(cluster), 
                               bandwidth_fct = 5,
                               n = 1000)
    })
  
  saveRDS(all_graph_umap_hulls, UMAP_hull_file)
}

all_graph_umap_hull_data <- 
  all_graph_umap_hulls %>% 
  map(. %$% 
        hulls) %>% 
  bind_rows(.id = "dataset_id")


rm(all_graph_umap_hulls)
gc()
# all_graph_umap_hull_data %>% 
#   filter(density_type == "primary secondary") %>% 
#   select(1, 2, 3, 4, 5) %>% 
#   distinct()

all_graph_umap_hull_data %>% 
  filter(density_type == "primary secondary") %>%
  ggplot(aes(X,Y, group = paste(cluster, sub_cluster, landmass), fill = cluster)) +
  geom_polygon(show.legend = F,
               color = "black") +
  theme_bw() +
  facet_grid(~dataset_id) +
  coord_fixed()
ggsave(run_id_savename("UMAP scaled hulls.pdf"),
       width = 8, height = 5)


# Save
# all_graph_umap_hull_data %>% 
#   filter(density_type == "primary secondary") %>% 
#   unite(polygon_id, cluster, sub_cluster, landmass, remove = F) %>% 
#   select(polygon_id, cluster, UMAP1 = X, UMAP2 = Y) %>% 
#   write_csv(run_id_savename("UMAP draft polygon coordinates.csv"))
#   
# 
# cluster_hulls$data %>% 
#   select(ensg_id = element_id, 
#          UMAP1 = V1, 
#          UMAP2 = V2,
#          cluster) %>% 
#   write_csv(run_id_savename("UMAP draft gene coordinates.csv"))

```


## plots
```{r}

graph_umap_data %>% 
  ggplot(aes(V1, V2, color = factor(cluster))) +
  geom_point(size = 0.1) +
  scale_color_manual(values = cluster_palette) +
  theme_bw() +
  coord_fixed()

example_genes <- 
  data_cluster$cluster_data %>% 
  filter(resolution == 2,
         cluster == 14,
         seed == 1) %>%
  head(30) %>% 
  pull(gene)

data_cluster$neighbors$nn[example_genes, example_genes] %>% 
  {. + t(.)} %>%
  as.matrix() %>% 
  pheatmap(cluster_rows = F,
           cluster_cols = F,
           color = c("white", "gray", "black"))


graph_umap_edges <- 
  data_cluster$neighbors$snn %>%
  elongate_sparsemat() %>% 
  left_join(graph_umap_data,
            by= c("id1" = "gene")) %>% 
  left_join(graph_umap_data,
            by= c("id2" = "gene", "resolution", "seed"),
            suffix = c("1", "2")) %>%
  mutate(dist = sqrt(((V12 - V11) ^ 2) + 
                       ((V22 - V21) ^ 2))) %>%
    filter(id1 < id2)
  
# 
# graph_umap_edges %>% 
#   select(matches("V\\d\\d")) %>% 
#   as.data.frame() 
graph_umap_edges_filtered <- 
  graph_umap_edges %>% 
  # filter(value1 != value2) %>%
  filter(x > 0.25,
         dist > 0.01,
         cluster1 != cluster2)

graph_umap_edges_filtered %>%
  
  
  ggplot(aes(x = V11, xend = V12,
             y = V21, yend = V22)) +
  geom_segment() +
  geom_point(data = graph_umap_data,
             aes(V1, V2, color = factor(cluster)),
             size = 0.1,
             inherit.aes = F) +
  scale_color_manual(values = cluster_palette) +
  theme_bw()


g <- 
  graph_umap_edges_filtered %>% 
                      select(1,2) %>% 
  as.matrix() %>%
  graph_from_edgelist(directed = F)



xy <-
  V(g)$name %>% 
  enframe("i", "gene") %>% 
  left_join(graph_umap_data) %>%
  select(V1, V2) %>%
  as.matrix()


# fbundle <- 
#   edge_bundle_force(g,
#                     xy,
#                     compatibility_threshold = 0.1)

fbundle <- 
  edge_bundle_hammer(g,
                     xy, 
                     decay = 1,
                     bw = 0.075) %>%
  as_tibble() %>% 
  # filter(group == 1) %>% 
  left_join(graph_umap_edges_filtered %>% 
              mutate(group = row_number()) %>% 
              select(group, id1, id2, cluster1, cluster2)) %>% 
  left_join(cluster_palette_tbl,
            by = c("cluster1" = "cluster")) %>%
  left_join(cluster_palette_tbl,
            by = c("cluster2" = "cluster"),
            suffix = c("1", "2")) %>%
  mutate(color = mix_colors(color1, color2, mix = index))

fbundle %>%
  
  ggplot() +
  geom_point(data = graph_umap_data,
             aes(V1, V2, color = factor(cluster)),
             size = 0.1,
             inherit.aes = F) +
  geom_path(aes(x,y,group = group),
            show.legend = FALSE,
            alpha = 0.3)+
  
  
  scale_color_manual(values = cluster_palette) +
  theme_bw() +
  coord_fixed()

fbundle %>%
  
  ggplot() +
  geom_point(data = graph_umap_data %>% 
               mutate(cluster = as.character(cluster)) %>%
               left_join(cluster_palette_tbl),
             aes(V1, V2, color = color),
             size = 0.1,
             inherit.aes = F) +
  geom_path(aes(x,y,
                group = group, 
                color = color),
            show.legend = FALSE)+
  
  scale_color_identity() +
  # scale_color_manual(values = cluster_palette) +
  theme_bw() +
  coord_fixed()

fbundle %>%
  mutate(bundle = paste(cluster1, cluster2)) %>%
  filter(bundle %in% sample(unique(bundle), 20)) %>%
  # filter(value1 == 12, 
  #        value2 == 28) %>% 
  ggplot(aes(x, y)) +
  geom_path(aes(group = group, 
                color = color),
            size = 2,
            show.legend = FALSE)+
  
  scale_color_identity() +
  facet_wrap(~bundle) +
  theme_bw()

  

# Calculate distance
distance_data <- 
  data_cluster$pca_data$scores %>%
  calculate_distance(distance_metric = "pearson") %>%
  {
    genes <- rownames(.)
    as.matrix(.) %>%
      set_colnames(genes) %>%
      set_rownames(genes)
  } %>%
  as.dist()

# Calculate neighbor graph
neighbors <-
  FindNeighbors(
    distance_data,
    k.param = 200,
    compute.SNN = TRUE,
    prune.SNN = 1/15,
    nn.method = "annoy", 
    annoy.metric = "euclidean"
  )

set.seed(42)
graph_umap2 <- 
  neighbors$snn %>%
  {. + t(.)} %>%
  umap(n_neighbors = 15)

graph_umap2_data <- 
  graph_umap2 %>% 
  as_tibble() %>% 
  mutate(gene = rownames(data_cluster$neighbors$nn)) %>% 
  left_join(data_cluster$cluster_data %>% 
              filter(resolution == 2, seed == 1)) 

graph_umap2_data %>% 
  ggplot(aes(V1, V2, color = factor(cluster))) +
  geom_point(size = 0.1) +
  scale_color_manual(values = cluster_palette) +
  theme_bw()


cluster_hulls <- 
  graph_umap2_data %$%
  generate_cluster_hulls(V1,
                         V2, 
                         element_id = gene,
                         cluster_membership = factor(cluster), 
                         n = 500)

cluster_hulls$data %>% 
  ggplot(aes(V1, V2, color = sub_type)) +
  geom_point(size = 0.1) + 
  theme_bw()




p1 <-
  cluster_hulls$data %>% 
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(size = 0.1, 
             show.legend = F) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = cluster_palette) +
  ggtitle("All points")

p2 <-
  cluster_hulls$data %>% 
  filter(sub_type != "outlier") %>%
  ggplot(aes(V1, V2, color = cluster)) +
  geom_point(size = 0.1, 
             show.legend = F) +
  theme_void() +
  coord_fixed() +
  scale_color_manual(values = cluster_palette) +
  ggtitle("No outliers")

p3 <- 
  cluster_hulls$hulls %>% 
  filter(density_type == "primary secondary") %>%
  ggplot(aes(X, Y, fill = cluster, group = paste(cluster, sub_cluster, landmass))) +
  geom_polygon(color = "black", 
               show.legend = F,
               size = 0.1) +
  geom_text(data = . %>% 
              filter(sub_cluster == 1) %>% 
              group_by(cluster) %>%
              summarise(X = mean(X), 
                        Y = mean(Y)),
            aes(X, Y, label = cluster),
            inherit.aes = F) +
  theme_void() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.spacing = unit(0, "mm")) +
  coord_fixed() +
  scale_fill_manual(values = cluster_palette) +
  ggtitle("Complete hull")


p4 <- 
  cluster_hulls$hulls %>% 
  filter(density_type == "primary") %>%
  ggplot(aes(X, Y, fill = cluster, group = paste(cluster, sub_cluster, landmass))) +
  geom_polygon(color = "black", 
               show.legend = F,
               size = 0.1) +
  theme_void() + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        panel.spacing = unit(0, "mm")) +
  coord_fixed() +
  scale_fill_manual(values = cluster_palette) +
  ggtitle("Mainland hull")


p1 | p2 | p3 | p4


cluster_hulls$data %>% 
  # filter(sub_type != "outlier") %>%
  left_join(ensg_exp_palette,
            by = c("element_id" = "ensg_id")) %>% 
  ggplot(aes(V1, V2, color = color)) +
  geom_point(size = 0.1, 
             show.legend = F) +
  theme_void() +
  coord_fixed() +
  scale_color_identity() +
  ggtitle("No outliers")


plot_data <- 
  cluster_hulls$data %>% 
  filter(sub_type != "outlier") %>%
  left_join(ensg_exp_palette,
            by = c("element_id" = "ensg_id")) 

plot_range <- 
  range(c(plot_data$V1, plot_data$V2))

plot_n <- 300

pixel_width <- diff(plot_range) / plot_n

plot_coords <- 
  seq(plot_range[1],
      plot_range[2],
      length.out = plot_n) %>% 
  crossing(V1 = ., 
           V2 = .) %>%
  mutate(V1_start = V1 - pixel_width / 2,
         V1_end = V1 + pixel_width / 2,
         V2_start = V2 - pixel_width / 2,
         V2_end = V2 + pixel_width / 2)
  

plot_pixels <- 
  plot_coords %>% 
  group_by_all() %>% 
  do({
    pixel <<- .
    plot_data %>% 
      filter(V1 >= pixel$V1_start,
             V1 < pixel$V1_end,
             V2 >= pixel$V2_start,
             V2 < pixel$V2_end) %>% 
      summarise(red = mean(red),
                green = mean(green),
                blue = mean(blue)) 
  }) %>% 
  ungroup() %>% 
  mutate(red = ifelse(is.finite(red),
                      red,
                      255),
         green = ifelse(is.finite(green),
                        green,
                        255),
         blue = ifelse(is.finite(blue),
                       blue,
                       255))
  
plot_pixels %>% 
  mutate(color = rgb(red, green, blue, maxColorValue = 255)) %>%
  ggplot(aes(V1, V2, fill = color)) +
  geom_tile() +
  theme_void() +
  coord_fixed() +
  scale_fill_identity()

plot_span <- pixel_width/4
red_function <- 
  loess(red ~ V1:V2, data = plot_pixels, span = plot_span)
blue_function <- 
  loess(blue ~ V1:V2, data = plot_pixels, span = plot_span)
green_function <- 
  loess(green ~ V1:V2, data = plot_pixels, span = plot_span)

plot_predict <- 
  seq(plot_range[1],
      plot_range[2],
      length.out = 500) %>% 
  crossing(V1 = ., 
           V2 = .)

plot_canvas <- 
  plot_predict %>% 
  mutate(red = predict(red_function, newdata = .),
         blue = predict(blue_function, newdata = .),
         green = predict(green_function, newdata = .)) %>% 
  mutate_at(c("red", "green", "blue"), function(x) {ifelse(x > 255, 255, x)}) %>%
  mutate_at(c("red", "green", "blue"), function(x) {ifelse(x < 0, 0, x)}) %>%
  filter(complete.cases(.)) %>%
  mutate(color = rgb(red, green, blue, maxColorValue = 255))

plot_canvas %>%
  ggplot(aes(V1, V2, fill = color)) +
  geom_tile() +
  theme_void() +
  coord_fixed() +
  scale_fill_identity()



# ---- tissue contr plots -----


tissue_contr_data <-
  data %>% 
  group_by(ensg_id) %>% 
  mutate(tmm = tmm / sum(tmm)) %>% 
  ungroup()

plots <- 
  lapply(unique(sort(tissue_contr_data$celltype)),
         function(tis_) {
           cluster_hulls$data %>% 
             left_join(tissue_contr_data %>% 
                         filter(celltype == tis_),
                       by = c("element_id" = "ensg_id")) %>%
             ggplot(aes(V1, V2, color = tmm)) +
             geom_point(size = 0.1, 
                        show.legend = F) +
             theme_void() +
             coord_fixed() +
             scale_color_gradient(low = "lightgray", high = "red") +
             ggtitle(tis_)
         })



wrap_plots(plots)

```


### color space

```{r}

shared_colorspace_facet_plot <- 
  function(data, V1, V2, point_id, facet_id, ref_id) {
    plot_data <- 
      data %>% 
      rename(V1 = V1, 
             V2 = V2,
             point_id = point_id, 
             facet_id = facet_id) 
    
    
    ref_palette <- 
      plot_data %>% 
      filter(facet_id == ref_id) %>% 
      mutate(r = scales::rescale(V1, c(0,1)),
             g = scales::rescale(V2, c(0,1)),
             b = 0.5,
             color = rgb(r, g, b)) %>% 
      select(point_id, color)
    
    plot_data %>% 
      left_join(ref_palette,
                by = "point_id") %>% 
      mutate(color = ifelse(is.na(color), 
                            "darkgray", 
                            color))
  
    }

plot_data <- 
  all_graph_umaps %>% 
  select(dataset_id) %>% 
  distinct() %>% 
  group_by(dataset_id) %>% 
  do({
    shared_colorspace_facet_plot(data = all_graph_umap_data_scaled,
                             V1 = "UMAP_1",
                             V2 = "UMAP_2",
                             point_id = "gene",
                             facet_id = "dataset_id",
                             ref_id = .$dataset_id)
  }) %>% 
  ungroup()
  

plot_data %>% 
  ggplot(aes(V1, V2, color = color)) +
  geom_point(size = 0.1) +
  theme_bw() +
  coord_fixed() +
  facet_grid(dataset_id~facet_id) +
  scale_color_identity()


plot_data %>% 
  group_by(dataset_id, 
           facet_id) %>% 
  
  do({
    g_data <- .
    g_data %$% 
      makeHexData(x = V1, 
                  y = V2, 
                  z = color, 
                  bins = 50, color_mean)
  }) %>% 
  ggplot(aes(x = x, y = y, fill = z, group = paste(dataset_id, facet_id))) +
  geom_hex(stat = "identity") +
  facet_grid(dataset_id~facet_id) +
  theme_bw() +
  coord_fixed() +
  scale_fill_identity()

```

## 3D

```{r}
# ----- 3D UMAP -----
graph_umap_3d <- 
  data_cluster$neighbors$nn %>%
  {. + t(.)} %>%
  umap(n_components = 3)

umap_3d %>% 
  as_tibble() %>% 
  mutate(gene = rownames(data_cluster$pca_data$scores)) %>% 
  left_join(data_cluster$cluster_data %>% 
              filter(resolution == 2, seed == 1)) %>%
  plot_ly(x = ~V1, 
          y = ~V2,
          z = ~V3,
          color = ~cluster,
          colors = cluster_palette, 
          size = 0.1)

# umap_3d %>% 
#   as_tibble() %>% 
#   mutate(gene = rownames(data_cluster$pca_data$scores)) %>% 
#   left_join(data_cluster$cluster_data %>% 
#               filter(resolution == 2, seed == 1)) %>%
#   plot_ly(x = ~V1, 
#           y = ~V2,
#           z = ~V3,
#           color = ~gene,
#           colors = set_names(ensg_exp_palette$color,
#                              ensg_exp_palette$ensg_id), 
#           size = 0.1,
#           showscale=FALSE) %>% 
#   add_trace(showlegend = FALSE)
#   add_trace(showscale = FALSE)

# graph_umap_3d <- 
#     data_cluster$neighbors$nn %>%
#     {. + t(.)} %>%
#     umap(n_components = 3, n_neighbors = 15)
  
p <- 
  graph_umap_3d %>% 
  as_tibble() %>% 
  mutate(gene = rownames(data_cluster$pca_data$scores)) %>% 
  left_join(data_cluster$cluster_data %>% 
              filter(resolution == 2, seed == 1)) %>%
  mutate(cluster = factor(cluster)) %>%
  plot_ly(x = ~V1, 
          y = ~V2,
          z = ~V3,
          color = ~cluster,
          colors = set_names(cluster_palette,
                             0:(length(cluster_palette) - 1)), 
          size = 0.1)

p

saveWidgetFix(p, "results/3d_umap.html", selfcontained = T, libdir = "lib")

tissue_contr_data <-
  data %>% 
  group_by(ensg_id) %>% 
  mutate(tmm = tmm / sum(tmm))



gene_info92 <- read_tsv("data/meta/geninfo_92.tsv")

data %>%
  inner_join(data_cluster$cluster_data %>% 
               filter(resolution == 2, seed == 1) %>% 
               filter(cluster == 43),
             by = c("ensg_id" = "gene")) %>%
  left_join(gene_info92) %>%
  select(celltype, tmm, gene_name) %>%
  spread(celltype, tmm) %>% 
  column_to_rownames("gene_name") %>% 
  {log10(. + 1)} %>%
  pheatmap()

data_cluster$cluster_data %>% 
  filter(resolution == 2, seed == 1) %>% 
  filter(cluster == 43) %>%
  left_join(gene_info92,
            by = c("gene" = "ensg_id")) %>%
  pull(gene_name) %>% 
  paste(collapse = "\n") %>% 
  cat()

tissue_contr_data$celltype %>% unique
graph_umap_3d %>% 
  as_tibble() %>% 
  mutate(gene = rownames(data_cluster$pca_data$scores)) %>% 
  left_join(data_cluster$cluster_data %>% 
              filter(resolution == 0.6, seed == 1)) %>%
  left_join(tissue_contr_data %>% 
              filter(celltype == "testis"),
            by = c("gene" = "ensg_id")) %>%
  plot_ly(x = ~V1, 
          y = ~V2,
          z = ~V3,
          name = ~cluster,
          color = ~tmm,
          # colors = cluster_palette, 
          size = 0.1)


```

# Annotation report

## Settings

```{r}

# The annotation report will be separately made for each cluster and dataset.
# This table contains a unique ID for each combination of dataset and cluster. 
# If we write code starting from this table, we can control all output easily. 
annotation_report_settings <- 
  final_cluster %>%
  filter(dataset_id %in% c("blood_consensus", "tissue")) %>% 
  select(dataset_id, cluster) %>% 
  distinct() %>% 
  arrange(dataset_id, cluster) %>% 
  mutate(settings_id = row_number()) 



dataset_metadata %>% 
  write_csv("results/Annotation reports/dataset metadata.csv")

```

## Save clustering

```{r}

annotation_report_clustering <- 
  annotation_report_settings %>% 
  select(dataset_id) %>% 
  distinct() %>% 
  left_join(final_cluster) %>% 
  select(dataset_id, gene, cluster)


for(dataset_ in unique(annotation_report_clustering$dataset_id)) {
  annotation_report_clustering %>% 
    filter(dataset_id == dataset_) %>% 
    select(-dataset_id) %>% 
    write_csv(paste0("results/Annotation reports/clustering results/annotation_clustering ", dataset_, ".csv"))
}
```


## Save UMAPs

```{r}

annotation_report_UMAP <- 
  annotation_report_settings %>% 
  select(dataset_id) %>% 
  distinct() %>% 
  left_join(all_graph_umap_data) %>% 
  select(dataset_id, gene, UMAP_1, UMAP_2)

for(dataset_ in unique(annotation_report_UMAP$dataset_id)) {
  annotation_report_UMAP %>% 
    filter(dataset_id == dataset_) %>% 
    select(-dataset_id) %>% 
    write_csv(paste0("results/Annotation reports/UMAP/annotation_UMAP_coords ", dataset_, ".csv"))
}

```


## General clustering metrics

```{r}

annotation_report_general <- 
  annotation_report_settings %>% 
  select(dataset_id) %>% 
  distinct() %>% 
  left_join(final_cluster) %>% 
  group_by(dataset_id, cluster) %>% 
  summarise(n_genes = n_distinct(gene)) %>% 
  ungroup()

write_csv(annotation_report_general,
          "results/Annotation reports/clustering info.csv")

```


## Expression per cluster

```{r Tissue expression per cluster (pheatmaps)}

# Annotation heatmaps are generated using ggheatmap, as ggplot are easier to handle than pheatmaps

annotation_report_heatmaps <- 
  unique(annotation_report_settings$dataset_id) %>% 
  set_names(., .) %>% 
  pblapply(function(dataset_) {
    
    cat(paste0(dataset_, "\n"))
    plot_data <- 
      all_data[[dataset_]] %>% 
      inner_join(expressed_genes %>% 
                   filter(dataset_id == dataset_) %>% 
                   select(ensg_id),
                 by = "ensg_id") %>% 
      left_join(final_cluster %>% 
                  filter(dataset_id == dataset_) %>% 
                  select(gene, cluster),
                by = c("ensg_id" = "gene")) %>% 
      select(ensg_id, cluster, everything())
    
    plot_settings <- 
      annotation_report_settings %>% 
      filter(dataset_id == dataset_)
    
    plot_settings$cluster %>%
      as.character() %>% 
      set_names(., .) %>% 
      lapply(function(cluster_) {
        cat(paste0("  ", cluster_, "\n"))
        plot_data %>%
          filter(cluster == cluster_) %>% 
          select(-cluster) %>% 
          column_to_rownames("ensg_id") %>%
          apply(MARGIN = 1,
                function(x) x / max(x, na.rm = T)) %>% 
          t() %>% 
          ggheatmap(hclust_method = "ward.D2", 
                    cluster_rows = T, 
                    cluster_cols = T, 
                    color = viridis(20, direction = -1, option = "B"),
                    text_angle_cols = 90, 
                    text_just_cols = c(1, 0.5), 
                    text_show_rows = F, 
                    legendName = "Relative\nexpression")
          # pheatmap(clustering_method = "ward.D2", 
          #          color = 
          #          show_rownames = F,border_color = NA, fontsize = 8)
      })
    
  })

for(dataset_ in names(annotation_report_heatmaps)) {
  
  for(cluster_ in names(annotation_report_heatmaps[[dataset_]])) {
    savename <- 
      paste("results/Annotation reports/expression heatmaps/annotation_exp_heatmap", dataset_, cluster_)
    
    ggsave(annotation_report_heatmaps[[dataset_]][[cluster_]], 
           file = paste0(savename, ".png"), 
           width = 6, height = 5, dpi = 300)
    
    ggsave(annotation_report_heatmaps[[dataset_]][[cluster_]], 
           file = paste0(savename, ".pdf"), 
           width = 6, height = 5)
    
  }
}



```




# Old

## Connectivity & Average Silhouette 
```{r Evaluation (connectivity, dunn, asw, BHI, BP_enriched, time)}





connectivity_file <- 
  paste0("data/processed/", run_id, "_connectivity.rds")
# silhouette_file <- 
#   paste0("data/processed/", run_id, "_silhouette.rds")

# Prepare cluster for parallelization
cluster <- new_cluster(n = 6)

cluster_library(cluster, c("dplyr",
                           "tidyverse",
                           "clValid",
                           "cluster"))

cluster_copy(cluster, c("connectivity_file",
                        "all_data_dists_filenames",
                        "all_data_cluster"))

Sys.time()

if(file.exists(connectivity_file)) {
  all_data_cluster_connectivity <- 
    readRDS(connectivity_file)
} else {
  
  
  all_data_cluster_connectivity <- 
    all_data_cluster %>% 
    group_by(dataset_id) %>% 
    partition(cluster) %>% 
    do({
      g_data <<- .
      g_dataset_id <- 
        unique(g_data$dataset_id)
      
      cat(paste("Running dataset:", g_dataset_id, "\n"))
      
      
      connectivity_dataset_file <-
        connectivity_file %>% 
        gsub(".rds$", "", .) %>% 
        paste0("_", g_dataset_id, ".rds") 
      
      
      if(file.exists(connectivity_dataset_file)) {
        cat(paste("  Files already present.\n"))
      
        g_res <- 
          readRDS(connectivity_dataset_file)
      } else {
        
        cat(paste("  Calculating metrics.\n"))
        
        
        temp_distan <- 
          readRDS(all_data_dists_filenames[g_dataset_id])
        
        g_res <- 
          g_data %>% 
          group_by(resolution, seed) %>% 
          summarise(connectivity = connectivity(distance = temp_distan, 
                                                cluster = cluster),
                    avg_silhouette_width = silhouette(dist = temp_distan, 
                                                      x = cluster) %>% 
                      summary() %>% 
                      {.$avg.width})
        # dunn = dunn(distance = temp_distan, 
        #             cluster = value))
        
        saveRDS(g_res, connectivity_dataset_file)
        
        
      }
      
      g_res
    }) %>% 
    collect() %>% 
    ungroup()
  
  
  saveRDS(all_data_cluster_connectivity, 
          connectivity_file)
}

Sys.time()


# if(file.exists(silhouette_file)) {
#   all_data_cluster_silhouette <- 
#     readRDS(silhouette_file)
# } else {
#   
#   all_data_cluster_silhouette <- 
#     all_data_cluster %>% 
#     group_by(dataset_id) %>% 
#     do({
#       g_data <<- .
#       
#       temp_distan <- 
#         readRDS(all_data_dists_filenames[unique(g_data$dataset_id)])
#       
#       
#       g_data %>% 
#         filter(resolution == 1, 
#                seed == 1) %>% 
#         group_by(resolution, seed) %>% 
#         summarise(silhouette = silhouette(dist = temp_distan, 
#                                           x = .$value) %>% 
#                     summary() %>% 
#                     {.$avg.width})
#           
#         })
#       
#       
#       a
#       
#       silhouette = silhouette(dist = d, 
#                               x = value)
#     })
#   
# 
#   
#   saveRDS(all_data_cluster_connectivity, 
#           silhouette_file)
# }


all_data_cluster_connectivity %>%
  gather(metric, value, connectivity, avg_silhouette_width) %>% 
  ggplot(aes(resolution, value, color = dataset_id)) +
  geom_point() +
  geom_smooth() +
 # scale_x_log10() +
  facet_grid(metric ~ dataset_id, scales = "free_y") +
  theme_bw() +
  ggtitle("Connectivity and Silhouette index")



all_data_cluster_connectivity %>% 
  left_join(all_data_cluster %>% 
              group_by(dataset_id,resolution, seed) %>% 
              mutate(k = max(cluster) + 1) %>% 
              select(-gene,-cluster) %>% 
              distinct) %>% 
  gather(metric, value, connectivity, avg_silhouette_width) %>% 
  ggplot(aes(k, value, color = as.factor(resolution))) +
  geom_point() +
  geom_smooth() +
  facet_grid(metric ~ dataset_id, scales = "free_y") +
  theme_bw() +
  ggtitle("Connectivity and Silhouette index")

```
